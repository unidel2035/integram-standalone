import{_ as ye,y as D,u as xe,c as b,A as l,a as n,h as O,w as x,K as ee,L as te,D as oe,d,I as V,J as ae,O as le,o as u,b as he,f as H,t as I,C as be,j as E,g as Re,F as De,r as Ie,aR as Se}from"./index-D6FYndJO.js";import{i as J}from"./integramService-BbyM5pB3.js";import{l as R}from"./logger-CLWPjr6Q.js";import{I as ke}from"./IntegramBreadcrumb-DEnfToFO.js";import"./integramApiClient-C3_j8SPw.js";import"./index-B9ygI19o.js";import"./unifiedAuthService-xCuNj-Bd.js";const Ce={__name:"IntegrationReportPage",setup(ne,{expose:a}){a();const T=ee(),e=te(),m=oe(),z=d(!1),P=d(!1),f=d([]),r=d(null),p=d(null),g=d(null),B=d(!1),N=d(!1),U=d(null),j=d(null),c=d(null),i=d(null),w=d(1),h=d(20),v=d(0),S=d(1),L=d(!1),F=d(!1),k=d(!0),A=V(()=>T.params.database||"my"),re=V(()=>{var o;const t=[{label:"Отчёты",to:r.value?`/integram/${A.value}/report`:void 0}];return r.value&&((o=p.value)!=null&&o.report_name)&&t.push({label:p.value.report_name}),t}),ie=V(()=>[{label:"Открыть",icon:"pi pi-eye",command:()=>{c.value&&K(c.value.id)}},{label:"Редактировать",icon:"pi pi-pencil",command:()=>{c.value&&e.push(`/integram/${A.value}/object/${c.value.id}?edit=1`)}},{separator:!0},{label:"Копировать ID",icon:"pi pi-copy",command:()=>{c.value&&(navigator.clipboard.writeText(String(c.value.id)),m.add({severity:"success",summary:"Скопировано",detail:`ID ${c.value.id} скопирован`,life:2e3}))}},{label:"Копировать название",icon:"pi pi-copy",command:()=>{c.value&&(navigator.clipboard.writeText(c.value.name||""),m.add({severity:"success",summary:"Скопировано",detail:"Название скопировано",life:2e3}))}},{separator:!0},{label:"Удалить",icon:"pi pi-trash",class:"text-red-500",command:()=>{c.value&&W(c.value)}}]),se=V(()=>[{label:"Копировать строку",icon:"pi pi-copy",command:()=>{if(i.value){const t=Object.values(i.value).join("	");navigator.clipboard.writeText(t),m.add({severity:"success",summary:"Скопировано",detail:"Строка скопирована в буфер",life:2e3})}}},{label:"Копировать как JSON",icon:"pi pi-file",command:()=>{i.value&&(navigator.clipboard.writeText(JSON.stringify(i.value,null,2)),m.add({severity:"success",summary:"Скопировано",detail:"JSON скопирован в буфер",life:2e3}))}},{separator:!0},{label:"Экспорт в Excel",icon:"pi pi-download",command:()=>{Q()}}]);function ce(t){c.value=t.data,U.value.show(t.originalEvent)}function de(t){i.value=t.data,j.value.show(t.originalEvent)}function W(t){confirm(`Удалить отчет "${t.name}" (ID: ${t.id})?`)&&Y(t.id)}async function Y(t){try{await J.deleteObject(t),m.add({severity:"success",summary:"Удалено",detail:`Отчет #${t} удален`,life:3e3}),C(w.value,h.value,!1)}catch(o){m.add({severity:"error",summary:"Ошибка",detail:"Не удалось удалить отчет: "+o.message,life:5e3})}}ae(async()=>{T.params.reportId&&T.params.reportId!=="undefined"?(r.value=T.params.reportId,await G()):await C()}),le(()=>{window.removeEventListener("scroll",X)});async function C(t=1,o=h.value,M=!1){M||(z.value=!0),g.value=null;try{const s=await J.getObjects(22,{pg:t,LIMIT:o});if(s&&s.object){const _=s.object.map(y=>({id:y.id,name:y.val||`Отчет #${y.id}`,created_at:y.created_at||null,updated_at:y.updated_at||null}));M&&L.value?_.length===0?k.value=!1:(f.value=[...f.value,..._],_.length<o&&(k.value=!1)):(f.value=_,k.value=_.length>=o),s.current_page!==void 0?w.value=s.current_page:w.value=t,s.total_objects!==void 0?v.value=s.total_objects:s.count!==void 0?v.value=s.count:s.total!==void 0?v.value=s.total:f.value.length<o?v.value=(t-1)*o+f.value.length:v.value=f.value.length*2,s.total_pages!==void 0?S.value=s.total_pages:o>0&&v.value>0?S.value=Math.ceil(v.value/o):f.value.length>=o?S.value=t+1:S.value=t,R.info(`Loaded ${f.value.length} reports from type 22 objects (page ${t}, LIMIT ${o}, total ${v.value})`)}else R.warn("No reports found in type 22 objects"),f.value=[],v.value=0,S.value=1}catch(s){R.error("Failed to load reports:",s),m.add({severity:"error",summary:"Ошибка",detail:"Не удалось загрузить список отчетов: "+s.message,life:5e3}),f.value=[],v.value=0,S.value=1}finally{z.value=!1}}function ue(t){const o=t.page+1;h.value=t.rows,C(o,t.rows,!1)}function me(){L.value=!L.value,L.value?(w.value=1,k.value=!0,C(1,h.value,!1),window.addEventListener("scroll",X)):(window.removeEventListener("scroll",X),C(w.value,h.value,!1))}function X(){if(!L.value||F.value||!k.value||r.value)return;const t=200,o=window.scrollY||document.documentElement.scrollTop,M=window.innerHeight;document.documentElement.scrollHeight-o-M<t&&q()}async function q(){if(F.value||!k.value)return;F.value=!0;const t=w.value+1;try{await C(t,h.value,!0),w.value=t}catch(o){console.error("Failed to load more reports:",o)}finally{F.value=!1}}async function G(){if(!r.value){m.add({severity:"warn",summary:"Предупреждение",detail:"ID отчета не указан",life:3e3});return}P.value=!0,g.value=null;const t=performance.now();try{const o=await J.executeReport(r.value,{}),s=performance.now()-t;if(o){R.info("Report response:",o);let _=[],y=[];if(Array.isArray(o))o.length>0&&(_=Object.keys(o[0]),y=o),R.info(`Direct array response detected. Rows: ${y.length}, Columns: ${_.join(", ")}`);else if(o.columns&&o.data)_=o.columns,y=o.data.map(ge=>{const $={};return _.forEach((_e,we)=>{$[_e]=ge[we]}),$}),R.info(`Legacy format detected. Rows: ${y.length}, Columns: ${_.join(", ")}`);else throw R.warn("Unexpected report response format:",o),new Error("Неподдерживаемый формат ответа от сервера. Ожидается массив объектов или {columns, data}");p.value={report_name:o.report_name||`Отчет #${r.value}`,columns:_,rows:y,total_rows:y.length,execution_time_ms:o.execution_time_ms||s},R.info(`Report ${r.value} executed successfully`,p.value),m.add({severity:"success",summary:"Успех",detail:`Отчет выполнен. Получено строк: ${y.length}`,life:3e3})}else throw new Error("Пустой ответ от сервера")}catch(o){R.error(`Failed to execute report ${r.value}:`,o),g.value=o.message||"Не удалось выполнить отчет",m.add({severity:"error",summary:"Ошибка",detail:g.value,life:5e3})}finally{P.value=!1}}function pe(t){K(t.data.id)}function K(t){r.value=t,p.value=null,g.value=null,e.push({name:"Integram Report",params:{reportId:t}}),G()}function ve(){r.value=null,p.value=null,g.value=null,e.push({name:"Integram Report"})}function Q(){if(!p.value||!p.value.rows||p.value.rows.length===0){m.add({severity:"warn",summary:"Предупреждение",detail:"Нет данных для экспорта",life:3e3});return}const t=window.XLSX;if(!t){m.add({severity:"error",summary:"Ошибка",detail:"Библиотека XLSX не загружена",life:3e3});return}try{const o=p.value.rows,M=t.utils.json_to_sheet(o),s=t.utils.book_new();t.utils.book_append_sheet(s,M,"Report");const _=`report_${r.value}_${new Date().toISOString().split("T")[0]}.xlsx`;t.writeFile(s,_),m.add({severity:"success",summary:"Экспорт",detail:"Отчет экспортирован в Excel",life:3e3})}catch(o){R.error("Failed to export to Excel:",o),m.add({severity:"error",summary:"Ошибка",detail:"Не удалось экспортировать отчет: "+o.message,life:5e3})}}function fe(t){if(!t)return"-";try{return new Date(t).toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}catch{return t}}const Z={route:T,router:e,toast:m,loading:z,executingReport:P,reports:f,selectedReportId:r,reportData:p,reportError:g,showFilters:B,compactMode:N,reportListMenuRef:U,reportDataMenuRef:j,selectedContextReport:c,selectedContextRow:i,currentPage:w,pageSize:h,totalRecords:v,totalPages:S,infiniteScrollEnabled:L,loadingMore:F,hasMoreData:k,database:A,breadcrumbItems:re,reportListMenuItems:ie,reportDataMenuItems:se,onReportListContextMenu:ce,onReportDataContextMenu:de,confirmDeleteReport:W,deleteReport:Y,loadReportList:C,onPageChange:ue,toggleInfiniteScroll:me,handleWindowScroll:X,loadMoreReports:q,executeReport:G,onReportSelect:pe,selectReport:K,closeReport:ve,exportToExcel:Q,formatDate:fe,ref:d,computed:V,onMounted:ae,onUnmounted:le,get useRoute(){return ee},get useRouter(){return te},get useToast(){return oe},get integramService(){return J},get logger(){return R},IntegramBreadcrumb:ke};return Object.defineProperty(Z,"__isScriptSetup",{enumerable:!1,value:!0}),Z}},Me={class:"integram-report-page"},Ee={class:"mb-3"},Te={class:"flex align-items-center justify-content-between"},Le={class:"flex gap-2 align-items-center ml-auto"},Pe={key:0,class:"text-center p-5"},je={key:1,class:"text-center p-5"},Fe={class:"flex justify-content-between align-items-center"},Oe={class:"font-bold"},Ve={key:0,class:"text-sm text-500"},ze={key:1,class:"text-sm text-500"},Be={key:0},Ne={key:1},Ue={key:3,class:"mt-3 text-center py-3"},Xe={class:"flex align-items-center justify-content-between"},He={class:"flex align-items-center gap-2"},Je={class:"flex gap-2 align-items-center ml-auto"},Ae={key:0,class:"text-center p-5"},Ge={key:1,class:"p-5"},Ke={class:"flex gap-1 align-items-center"},We={class:"flex justify-content-between align-items-center"},Ye={class:"font-bold"},qe={class:"text-sm text-500"},Qe={key:3,class:"text-center p-5"};function Ze(ne,a,T,e,m,z){const P=D("Toast"),f=D("ContextMenu"),r=D("Button"),p=D("ProgressSpinner"),g=D("Column"),B=D("DataTable"),N=D("Card"),U=D("Message"),j=D("InputText"),c=xe("tooltip");return u(),b("div",Me,[l(P),l(f,{ref:"reportListMenuRef",model:e.reportListMenuItems},null,8,["model"]),l(f,{ref:"reportDataMenuRef",model:e.reportDataMenuItems},null,8,["model"]),n("div",Ee,[l(e.IntegramBreadcrumb,{items:e.breadcrumbItems},null,8,["items"])]),e.selectedReportId?(u(),O(N,{key:1},{title:x(()=>{var i;return[n("div",Xe,[n("div",He,[E(l(r,{icon:"pi pi-arrow-left",onClick:e.closeReport,outlined:"",rounded:"",size:"small"},null,512),[[c,"Назад",void 0,{bottom:!0}]]),n("span",null,I(((i=e.reportData)==null?void 0:i.report_name)||(e.selectedReportId?`Отчет #${e.selectedReportId}`:"Отчет")),1)]),n("div",Je,[E(l(r,{icon:"pi pi-filter",onClick:a[1]||(a[1]=w=>e.showFilters=!e.showFilters),size:"small",rounded:"",severity:e.showFilters?"info":"secondary",outlined:!e.showFilters},null,8,["severity","outlined"]),[[c,e.showFilters?"Скрыть фильтры":"Показать фильтры",void 0,{bottom:!0}]]),E(l(r,{icon:"pi pi-arrows-h",onClick:a[2]||(a[2]=w=>e.compactMode=!e.compactMode),size:"small",rounded:"",outlined:""},null,512),[[c,e.compactMode?"Обычный":"Компактный",void 0,{bottom:!0}]]),E(l(r,{icon:"pi pi-download",onClick:e.exportToExcel,size:"small",rounded:"",severity:"success",outlined:"",disabled:!e.reportData||!e.reportData.rows||e.reportData.rows.length===0},null,8,["disabled"]),[[c,"Excel",void 0,{bottom:!0}]]),E(l(r,{icon:"pi pi-refresh",onClick:e.executeReport,size:"small",rounded:"",loading:e.executingReport,outlined:""},null,8,["loading"]),[[c,"Обновить",void 0,{bottom:!0}]])])])]}),content:x(()=>[e.executingReport&&!e.reportData?(u(),b("div",Ae,[l(p),a[8]||(a[8]=n("p",{class:"mt-3"},"Выполнение отчета...",-1))])):e.reportError?(u(),b("div",Ge,[l(U,{severity:"error",closable:!1},{default:x(()=>[H(I(e.reportError),1)]),_:1})])):e.reportData&&e.reportData.rows?(u(),O(B,{key:2,value:e.reportData.rows,size:e.compactMode?"small":"normal",showGridlines:"",stripedRows:"",loading:e.executingReport,paginator:e.reportData.rows.length>20,rows:20,rowsPerPageOptions:[20,50,100],responsiveLayout:"scroll",onRowContextmenu:e.onReportDataContextMenu,contextMenu:""},{footer:x(()=>{var i;return[n("div",We,[n("div",Ye," Всего строк: "+I(e.reportData.total_rows),1),n("div",qe," Время выполнения: "+I((i=e.reportData.execution_time_ms)==null?void 0:i.toFixed(2))+" мс ",1)])]}),default:x(()=>[(u(!0),b(De,null,Ie(e.reportData.columns,(i,w)=>(u(),O(g,{key:w,field:i,header:i,sortable:!0},Se({_:2},[e.showFilters?{name:"filter",fn:x(({filterModel:h})=>[n("div",Ke,[l(j,{modelValue:h.from,"onUpdate:modelValue":v=>h.from=v,placeholder:"От",size:"small",class:"p-column-filter",style:{width:"50px"}},null,8,["modelValue","onUpdate:modelValue"]),a[9]||(a[9]=n("span",null,"-",-1)),l(j,{modelValue:h.to,"onUpdate:modelValue":v=>h.to=v,placeholder:"До",size:"small",class:"p-column-filter",style:{width:"50px"}},null,8,["modelValue","onUpdate:modelValue"])])]),key:"0"}:void 0]),1032,["field","header"]))),128))]),_:1},8,["value","size","loading","paginator"])):(u(),b("div",Qe,[...a[10]||(a[10]=[n("i",{class:"pi pi-inbox text-6xl text-400 mb-3"},null,-1),n("p",{class:"text-xl text-500"},"Нет данных для отображения",-1)])]))]),_:1})):(u(),O(N,{key:0},{title:x(()=>[n("div",Te,[a[3]||(a[3]=n("span",null,"Отчеты",-1)),n("div",Le,[E(l(r,{icon:e.infiniteScrollEnabled?"pi pi-arrows-v":"pi pi-list",size:"small",outlined:!e.infiniteScrollEnabled,rounded:"",onClick:e.toggleInfiniteScroll,class:Re({"button-on":e.infiniteScrollEnabled})},null,8,["icon","outlined","class"]),[[c,e.infiniteScrollEnabled?"Infinite Scroll (вкл)":"Обычная пагинация",void 0,{bottom:!0}]]),E(l(r,{icon:"pi pi-refresh",onClick:a[0]||(a[0]=i=>e.loadReportList(1,e.pageSize,!1)),loading:e.loading,outlined:"",rounded:"",size:"small"},null,8,["loading"]),[[c,"Обновить",void 0,{bottom:!0}]])])])]),content:x(()=>[e.loading&&e.reports.length===0?(u(),b("div",Pe,[l(p),a[4]||(a[4]=n("p",{class:"mt-3"},"Загрузка списка отчетов...",-1))])):!e.loading&&e.reports.length===0?(u(),b("div",je,[...a[5]||(a[5]=[n("i",{class:"pi pi-file text-6xl text-400 mb-3"},null,-1),n("p",{class:"text-xl text-500"},"Отчеты не найдены",-1)])])):(u(),O(B,{key:2,value:e.reports,paginator:!e.infiniteScrollEnabled,rows:e.pageSize,totalRecords:e.totalRecords,lazy:!e.infiniteScrollEnabled,loading:e.loading,stripedRows:"",showGridlines:"",responsiveLayout:"scroll",onRowClick:e.onReportSelect,onRowContextmenu:e.onReportListContextMenu,onPage:e.onPageChange,rowsPerPageOptions:[10,20,50,100],class:"cursor-pointer",contextMenu:""},{footer:x(()=>[n("div",Fe,[n("div",Oe," Всего отчетов: "+I(e.infiniteScrollEnabled?e.reports.length:e.totalRecords),1),e.infiniteScrollEnabled?(u(),b("div",ze,[e.hasMoreData?(u(),b("span",Be,"Прокрутите для загрузки...")):(u(),b("span",Ne,[...a[6]||(a[6]=[n("i",{class:"pi pi-check-circle mr-1"},null,-1),H("Все данные загружены",-1)])]))])):(u(),b("div",Ve," Страница "+I(e.currentPage)+" из "+I(e.totalPages),1))])]),default:x(()=>[l(g,{field:"id",header:"ID",sortable:"",style:{width:"100px"}}),l(g,{field:"name",header:"Название",sortable:""}),l(g,{field:"created_at",header:"Создан",sortable:"",style:{width:"200px"}},{body:x(({data:i})=>[H(I(e.formatDate(i.created_at)),1)]),_:1}),l(g,{field:"updated_at",header:"Обновлен",sortable:"",style:{width:"200px"}},{body:x(({data:i})=>[H(I(e.formatDate(i.updated_at)),1)]),_:1}),l(g,{header:"Действия",style:{width:"150px"}},{body:x(({data:i})=>[l(r,{label:"Открыть",icon:"pi pi-eye",size:"small",onClick:be(w=>e.selectReport(i.id),["stop"]),outlined:""},null,8,["onClick"])]),_:1})]),_:1},8,["value","paginator","rows","totalRecords","lazy","loading"])),e.infiniteScrollEnabled&&e.loadingMore?(u(),b("div",Ue,[l(p,{style:{width:"30px",height:"30px"}}),a[7]||(a[7]=n("span",{class:"ml-2 text-color-secondary"},"Загрузка...",-1))])):he("",!0)]),_:1}))])}const it=ye(Ce,[["render",Ze],["__scopeId","data-v-96aa848b"],["__file","/home/hive/integram-standalone/src/views/pages/Integram/IntegrationReportPage.vue"]]);export{it as default};
