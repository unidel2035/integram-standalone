import{a as e}from"./index-CcrxTH1M.js";import{X as t,r as a,J as o}from"./index-DSwq2M__.js";import{u as r}from"./unifiedAuthService-6fZILgG8.js";let l=0;const n=new Map,s=(e,t,a)=>(n.set(a,{show:e,hide:t}),()=>n.delete(a)),i=e=>{n.forEach(t=>{e?t.show():t.hide()})},u=(e=null)=>{const t=localStorage.getItem("apiBase"),a=e||localStorage.getItem("db")||"a2025";if("localhost"===t)return`http://localhost/${a}/`;let o=t;if(!o){const e=window.location.hostname,t=window.location.protocol;if(o=e,e.match(/^\d+\.\d+\.\d+\.\d+$/)||"localhost"===e)return`${t}//${o}/${a}/`;o=e}return`https://${o}/${a}/`},d=e.create({baseURL:u(),timeout:5e6,headers:{"Content-Type":"application/json"}});var c;d.interceptors.request.use(e=>{e.baseURL=u(e.targetDatabase);const{token:t,db:a}={token:localStorage.getItem("token"),db:localStorage.getItem("db")||"a2025"},o=e.baseURL||"";let r=a.toLowerCase();try{const e=new URL(o).pathname.split("/").filter(e=>e.length>0);e.length>0&&(r=e[0].toLowerCase())}catch{const e=o.match(/\/([^/]+)\/?$/);e&&(r=e[1].toLowerCase())}const n=a.toLowerCase(),s=r.toLowerCase();return"my"===n?"my"===s?t&&(e.headers["X-Authorization"]=t):t&&(e.headers.my=t):t&&(e.headers["X-Authorization"]=t),t&&(!(t.length>8)||(t.substring(0,4),t.substring(t.length-4))),e.params||(e.params={}),e.url&&e.url.includes("/report")?e.params.JSON_RICH=!0:e.params.JSON_RICH||(e.params.JSON_KV=!0),e.data instanceof FormData&&(e.headers["Content-Type"]="multipart/form-data"),l++,1===l&&i(!0),e},e=>(l=Math.max(0,l-1),0===l&&i(!1),window.errorHandler&&window.errorHandler.handle(e,{source:"axios2-request"}),Promise.reject(e))),d.interceptors.response.use(async e=>{if(l=Math.max(0,l-1),0===l&&i(!1),(e.config.url||"").includes("/object/")&&e.data)try{const t=e.data;e.data={status:200,response:t}}catch(t){e.data.response||(e.data={status:200,response:e.data})}return e},e=>{var t,a,o,r,n;if(l=Math.max(0,l-1),0===l&&i(!1),e.response&&401===e.response.status){const r=(null==(t=e.config)?void 0:t.url)||"";(r.includes("/auth")||r.includes("/user")||r.includes("/login"))&&(localStorage.removeItem("token"),localStorage.removeItem("_xsrf"),localStorage.removeItem("integram_session"),window.errorHandler&&window.errorHandler.handle(new Error("Сессия истекла. Пожалуйста, войдите в систему заново."),{source:"axios2-auth-expired",url:null==(a=e.config)?void 0:a.url,method:null==(o=e.config)?void 0:o.method}))}return window.errorHandler&&window.errorHandler.handle(e,{source:"axios2-response",url:null==(r=e.config)?void 0:r.url,method:null==(n=e.config)?void 0:n.method}),Promise.reject(e)}),(c=d).interceptors.request.use(e=>e,e=>Promise.reject(e)),c.interceptors.response.use(e=>e,e=>Promise.reject(e));const m=5242880;function g(e){return e?new Blob([e]).size:0}function f(){let e=0;try{const t=localStorage.getItem("session_timestamp");if(t&&Date.now()-parseInt(t)>6048e5){const a=localStorage.getItem("integram_session");a&&(e+=g(a),localStorage.removeItem("integram_session")),e+=g(t),localStorage.removeItem("session_timestamp")}if(!t&&localStorage.getItem("unified_auth_session_id")){const t=localStorage.getItem("unified_auth_session_id");e+=g(t),localStorage.removeItem("unified_auth_session_id")}const a=[];for(let e in localStorage)localStorage.hasOwnProperty(e)&&e.startsWith("test_")&&a.push(e);a.forEach(t=>{const a=localStorage.getItem(t);e+=g(a)+g(t),localStorage.removeItem(t)}),a.length}catch(t){}return e}function v(e,t){try{const a="string"==typeof t?t:String(t),o=function(){let e=0;try{for(let t in localStorage)localStorage.hasOwnProperty(t)&&(e+=g(localStorage[t]),e+=g(t))}catch(t){}return e}(),r=o+(g(a)+g(e));return r>4194304&&((r/m*100).toFixed(1),f()),localStorage.setItem(e,a),!0}catch(a){if("QuotaExceededError"===a.name){f();try{return localStorage.setItem(e,"string"==typeof t?t:String(t)),!0}catch(o){return function(){let e=0;const t={};try{for(let a in localStorage)if(localStorage.hasOwnProperty(a)){const o=g(localStorage[a])+g(a);e+=o,t[a]=o}}catch(a){}(e/1024).toFixed(2),(e/m*100).toFixed(1),Object.entries(t).sort(([,e],[,t])=>t-e).map(([e,t])=>({key:e,sizeKB:(t/1024).toFixed(2),sizeBytes:t}))}(),!1}}return!1}}function h(e){try{return localStorage.getItem(e)}catch(t){return null}}function S(e){try{return localStorage.removeItem(e),!0}catch(t){return!1}}const _=t("auth",()=>{const t=a(null),l=a(null),n=a(null),s=a(null),i=a(null),u=a("my"),d=a(window.location.hostname),c=a(null),m=a(null),g=a(null),f=a(null),_=a(null),y=a(null),p=a(null),I=a(null),w=a(!1),k=a(null),x=o(()=>!!l.value||r.isAuthenticated()),b=o(()=>!!c.value),A=o(()=>!!_.value);async function T(){if(r.isAuthenticated())try{const e=await r.getAllTokens(),t=u.value||"ddadmin";if(e[t]){const a=e[t];l.value=a.token,i.value=a.xsrf,s.value=a.userId,n.value=a.userName,v("token",a.token),v("_xsrf",a.xsrf),v("id",a.userId),v("user",a.userName)}if(e.ddadmin){const t=e.ddadmin;c.value=t.token,f.value=t.xsrf,g.value=t.userId,m.value=t.userName,v("ddadmin_token",t.token),v("ddadmin_xsrf",t.xsrf),v("ddadmin_id",t.userId),v("ddadmin_user",t.userName)}}catch(e){}}return{primaryToken:l,primaryUser:n,primaryUserId:s,primaryXsrf:i,primaryDatabase:u,primaryApiBase:d,ddadminToken:c,ddadminUser:m,ddadminUserId:g,ddadminXsrf:f,myToken:_,myUser:y,myUserId:p,myXsrf:I,isLoading:w,error:k,unifiedSession:t,isAuthenticated:x,isDdadminAuthenticated:b,isMyAuthenticated:A,initFromLocalStorage:async function(){if(l.value=localStorage.getItem("token"),n.value=localStorage.getItem("user"),s.value=localStorage.getItem("id"),i.value=localStorage.getItem("_xsrf"),u.value=localStorage.getItem("db")||"a2025",d.value=localStorage.getItem("apiBase")||window.location.hostname,c.value=localStorage.getItem("ddadmin_token"),m.value=localStorage.getItem("ddadmin_user"),g.value=localStorage.getItem("ddadmin_id"),f.value=localStorage.getItem("ddadmin_xsrf"),_.value=localStorage.getItem("my_token"),y.value=localStorage.getItem("my_user"),p.value=localStorage.getItem("my_id"),I.value=localStorage.getItem("my_xsrf"),r.isAuthenticated())try{const e=await r.getSession();e?(t.value=e,await T()):t.value=null}catch(e){t.value=null}},login:async function(t,a,o=window.location.hostname,r="my"){w.value=!0,k.value=null;try{u.value=r,d.value=o,v("db",r),v("apiBase",o);const c=await async function(t,a,o,r){const l=new URLSearchParams;let n;l.append("login",t),l.append("pwd",a),n="localhost"===o?`http://localhost/${r}/`:`https://${o}/${r}`;const s=e.create({baseURL:n,timeout:3e4,headers:{"Content-Type":"application/x-www-form-urlencoded"}});let i=(await s.post("/auth",l,{params:{JSON_KV:!0}})).data;if(Array.isArray(i)&&i.length>0&&(i=i[0]),!i.token)throw new Error(i.error||i.warning||"Authentication failed");return{token:i.token,_xsrf:i._xsrf,id:i.id,user:t}}(t,a,o,r);l.value=c.token,n.value=c.user,s.value=c.id,i.value=c._xsrf;const m={token:c.token,user:c.user,id:c.id,_xsrf:c._xsrf};for(const[e,t]of Object.entries(m)){if(!v(e,t))throw new Error(`Failed to save ${e} to localStorage - storage quota may be exceeded`);if(h(e)!==t)throw new Error(`Failed to save ${e} to localStorage`)}const g=localStorage.getItem("token");if(!g||g!==c.token)throw new Error("Token verification failed - localStorage may be disabled or full");const f=Date.now();if(!v("session_timestamp",f.toString()))throw new Error("Failed to save session timestamp - storage quota may be exceeded");const S={database:r,token:c.token,xsrfToken:c._xsrf,userId:c.id,userName:c.user,authDatabase:r,timestamp:f};if(!v("integram_session",JSON.stringify(S)))throw new Error("Failed to save session data - storage quota may be exceeded");if(await new Promise(e=>setTimeout(e,100)),!localStorage.getItem("token"))throw new Error("Token verification failed after commit delay - localStorage may be disabled");return{success:!0,user:c.user}}catch(c){throw k.value=c.message||"Login failed",c}finally{w.value=!1}},logout:async function(){if(r.isAuthenticated())try{await r.logout()}catch(e){}t.value=null,l.value=null,n.value=null,s.value=null,i.value=null,S("token"),S("user"),S("id"),S("_xsrf"),c.value=null,m.value=null,g.value=null,f.value=null,S("ddadmin_token"),S("ddadmin_user"),S("ddadmin_id"),S("ddadmin_xsrf"),_.value=null,y.value=null,p.value=null,I.value=null,S("my_token"),S("my_user"),S("my_id"),S("my_xsrf"),S("accessToken"),S("refreshToken"),S("integram_session"),S("unified_auth_session_id"),S("session_timestamp")},clearAllAuthData:async function(){t.value=null,l.value=null,n.value=null,s.value=null,i.value=null,c.value=null,m.value=null,g.value=null,f.value=null,_.value=null,y.value=null,p.value=null,I.value=null,S("token"),S("user"),S("id"),S("_xsrf"),S("ddadmin_token"),S("ddadmin_user"),S("ddadmin_id"),S("ddadmin_xsrf"),S("my_token"),S("my_user"),S("my_id"),S("my_xsrf"),S("accessToken"),S("refreshToken"),S("session_timestamp"),S("integram_session"),S("unified_auth_session_id")},getDdadminAuth:function(){return{token:c.value,user:m.value,id:g.value,xsrf:f.value,isAuthenticated:b.value}},getMyAuth:function(){return{token:_.value,user:y.value,id:p.value,xsrf:I.value,isAuthenticated:A.value}},getPrimaryAuth:function(){return{token:l.value,user:n.value,id:s.value,xsrf:i.value,database:u.value,apiBase:d.value,isAuthenticated:x.value}},getTokenForDatabase:async function(e){if(r.isAuthenticated())try{const t=await r.getTokenForDatabase(e);if(t)return t}catch(t){}if("ddadmin"===e){const e=c.value||localStorage.getItem("ddadmin_token");if(e)return{token:e,xsrf:f.value||localStorage.getItem("ddadmin_xsrf"),userId:g.value||localStorage.getItem("ddadmin_id"),userName:m.value||localStorage.getItem("ddadmin_user"),database:"ddadmin"}}else{const t=u.value||localStorage.getItem("db");if(e===t){const e=l.value||localStorage.getItem("token");if(e)return{token:e,xsrf:i.value||localStorage.getItem("_xsrf"),userId:s.value||localStorage.getItem("id"),userName:n.value||localStorage.getItem("user"),database:t}}}return null},getAllTokens:async function(){if(r.isAuthenticated())try{return await r.getAllTokens()}catch(d){}const e={},t=u.value||localStorage.getItem("db"),a=l.value||localStorage.getItem("token");a&&(e[t]={token:a,xsrf:i.value||localStorage.getItem("_xsrf"),userId:s.value||localStorage.getItem("id"),userName:n.value||localStorage.getItem("user"),database:t});const o=c.value||localStorage.getItem("ddadmin_token");return o&&(e.ddadmin={token:o,xsrf:f.value||localStorage.getItem("ddadmin_xsrf"),userId:g.value||localStorage.getItem("ddadmin_id"),userName:m.value||localStorage.getItem("ddadmin_user"),database:"ddadmin"}),e},getAvailableDatabases:async function(){if(r.isAuthenticated())try{return await r.getAvailableDatabases()}catch(t){}const e=[];return(l.value||localStorage.getItem("token"))&&e.push(u.value||localStorage.getItem("db")),(c.value||localStorage.getItem("ddadmin_token"))&&e.push("ddadmin"),e},syncUnifiedTokensToLocalStorage:T}});export{s as r,_ as u};
