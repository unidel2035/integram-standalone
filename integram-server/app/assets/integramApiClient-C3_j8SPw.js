import{a as p}from"./index-B9ygI19o.js";import{u as g}from"./unifiedAuthService-xCuNj-Bd.js";function y(d){if(d==null||d==="")return d;if(d instanceof Date||d&&typeof d.getFullYear=="function"&&typeof d.getMonth=="function"){if(isNaN(d.getTime()))return console.warn("[formatRequisiteValue] Invalid Date object received:",d),d;const n=d.getFullYear(),i=String(d.getMonth()+1).padStart(2,"0"),c=String(d.getDate()).padStart(2,"0"),u=String(d.getHours()).padStart(2,"0"),f=String(d.getMinutes()).padStart(2,"0"),l=String(d.getSeconds()).padStart(2,"0"),h=`${n}-${i}-${c} ${u}:${f}:${l}`;return console.log("[formatRequisiteValue] Date object formatted:",{original:d,formatted:h}),h}const e=String(d),s=/^(\d{4})[-\/.](\d{2})[-\/.](\d{2})(?:[T\s](\d{2}):(\d{2})(?::(\d{2}))?)?$/,a=e.match(s);if(a){const[,n,i,c,u,f,l]=a;return`${n}-${i}-${c} ${u!==void 0?u:"00"}:${f!==void 0?f:"00"}:${l!==void 0?l:"00"}`}const o=/^(\d{2})\.(\d{2})\.(\d{4})(?:\s+(\d{2}):(\d{2})(?::(\d{2}))?)?$/,r=e.match(o);if(r){const[,n,i,c,u,f,l]=r;return`${c}-${i}-${n} ${u!==void 0?u:"00"}:${f!==void 0?f:"00"}:${l!==void 0?l:"00"}`}return d}class W{constructor(){let e=localStorage.getItem("integram_server")||void 0||"https://app.integram.io";e=e.replace(/\/$/,"");const s=e.match(/^(https?:\/\/[^/]+)\/([a-zA-Z0-9_]+)$/);s&&(e=s[1],console.warn(`Cleaned up integram_server from localStorage. Removed database path: ${s[2]}`),localStorage.setItem("integram_server",e)),this.baseURL=e,this.databases={},this.currentDatabase=null,this.database=null,this.token=null,this.xsrfToken=null,this.userId=null,this.userRole=null,this.userName=null,this.authDatabase=null,this.loadSession()}setServer(t){let e=t.replace(/\/$/,"");const s=e.match(/^(https?:\/\/[^/]+)\/([a-zA-Z0-9_]+)$/);s&&(e=s[1],console.warn(`Removed database path from server URL. Using: ${e}`)),this.baseURL=e,localStorage.setItem("integram_server",this.baseURL)}getServer(){return this.baseURL}setCredentials(t,e,s=null,a=null){this.database=t,this.token=e,this.xsrfToken=s||e,this.authDatabase=a||t}saveSession(){if(Object.keys(this.databases).length>0){const t={version:2,server:this.baseURL,currentDatabase:this.currentDatabase,databases:this.databases};localStorage.setItem("integram_session",JSON.stringify(t));return}if(this.token&&this.xsrfToken&&this.database){const t={database:this.database,token:this.token,xsrfToken:this.xsrfToken,userId:this.userId,userName:this.userName,userRole:this.userRole,authServer:this.baseURL,authDatabase:this.authDatabase};localStorage.setItem("integram_session",JSON.stringify(t))}else localStorage.removeItem("integram_session")}loadSession(){try{if(g.isAuthenticated()){this.loadSessionFromUnifiedAuth();return}const t=localStorage.getItem("integram_session");if(t){const e=JSON.parse(t);if(e.version===2&&e.databases){if(this.baseURL=e.server,this.databases=e.databases,this.currentDatabase=e.currentDatabase,this.currentDatabase&&this.databases[this.currentDatabase]){const s=this.databases[this.currentDatabase];this.database=this.currentDatabase,this.token=s.token,this.xsrfToken=s.xsrfToken,this.userId=s.userId,this.userName=s.userName,this.userRole=s.userRole,this.authDatabase=this.currentDatabase,this.currentDatabase==="my"&&this.userId&&(!s.ownedDatabases||s.ownedDatabases.length===0)&&this.getOwnedDatabases(this.userId).then(a=>{this.databases.my.ownedDatabases=a,this.saveSession()}).catch(a=>{console.warn("[integramApiClient] Failed to load owned databases on restore:",a)})}localStorage.setItem("integram_server",this.baseURL);return}this.database=e.database,this.token=e.token,this.xsrfToken=e.xsrfToken,this.userId=e.userId,this.userName=e.userName,this.userRole=e.userRole,this.authDatabase=e.authDatabase||e.database,this.database&&this.token&&(this.databases[this.database]={token:this.token,xsrfToken:this.xsrfToken,userId:this.userId,userName:this.userName,userRole:this.userRole,ownedDatabases:[]},this.currentDatabase=this.database,this.database==="my"&&this.userId?this.getOwnedDatabases(this.userId).then(s=>{this.databases.my.ownedDatabases=s,this.saveSession()}).catch(s=>{console.warn("[integramApiClient] Failed to load owned databases on migration:",s)}):this.saveSession()),e.authServer&&(this.baseURL=e.authServer,localStorage.setItem("integram_server",e.authServer));return}this.loadSessionFromMyToken()}catch(t){console.error("Failed to load session from localStorage:",t),localStorage.removeItem("integram_session")}}loadSessionFromMyToken(){try{const t=localStorage.getItem("my_token"),e=localStorage.getItem("my_xsrf"),s=localStorage.getItem("my_user"),a=localStorage.getItem("my_id"),o=localStorage.getItem("db");if(t&&e)return this.database="my",this.token=t,this.xsrfToken=e,this.userId=a,this.userName=s,this.baseURL="https://dronedoc.ru",this.authDatabase="my",console.log("[integramApiClient] Loaded session from my_token (Issue #3778)"),!0;const r=localStorage.getItem("token"),n=localStorage.getItem("_xsrf"),i=localStorage.getItem("user"),c=localStorage.getItem("id");return r&&n&&o==="my"?(this.database="my",this.token=r,this.xsrfToken=n,this.userId=c,this.userName=i,this.baseURL="https://dronedoc.ru",this.authDatabase="my",console.log("[integramApiClient] Loaded session from legacy token (db=my) (Issue #3778)"),!0):!1}catch(t){return console.error("[integramApiClient] Failed to load session from my token:",t),!1}}async loadSessionFromUnifiedAuth(){if(!g.isAuthenticated())return console.warn("[integramApiClient] Unified auth not available"),!1;try{const t=this.database||localStorage.getItem("db")||"A2025",e=await g.getTokenForDatabase(t);if(e){this.token=e.token,this.userId=e.userId,this.userName=e.userName,this.userRole=e.userRole,this.database=e.database;const s=await g.getTokenForDatabase("my");return s&&s.xsrf?(this.xsrfToken=s.xsrf,console.log('[integramApiClient] Using XSRF token from "my" database for',t)):(this.xsrfToken=e.xsrf,console.warn('[integramApiClient] Could not get XSRF from "my", using',t,"XSRF")),this.saveSession(),!0}}catch(t){console.error("[integramApiClient] Failed to load session from unified auth:",t)}return!1}async switchToDatabase(t){if(!g.isAuthenticated())return console.warn("[integramApiClient] Cannot switch database - unified auth not available"),!1;try{const e=await g.getTokenForDatabase(t);if(e){this.database=t,this.token=e.token,this.userId=e.userId,this.userName=e.userName,this.userRole=e.userRole;const s=await g.getTokenForDatabase("my");return s&&s.xsrf?(this.xsrfToken=s.xsrf,console.log('[integramApiClient] Using XSRF token from "my" database for',t)):(this.xsrfToken=e.xsrf,console.warn('[integramApiClient] Could not get XSRF from "my", using',t,"XSRF")),this.saveSession(),!0}}catch(e){console.error("[integramApiClient] Failed to switch database:",e)}return!1}clearSession(){localStorage.removeItem("integram_session")}setDatabase(t){this.database=t}getDatabase(){return this.database}isAuthenticated(){return!!this.token&&!!this.xsrfToken}async validateSession(){if(!this.token||!this.xsrfToken)return!1;try{const t=await this.get("xsrf");return t.token&&(this.token=t.token),t._xsrf&&(this.xsrfToken=t._xsrf),t.id&&(this.userId=t.id),t.user&&(this.userName=t.user),t.role&&(this.userRole=t.role),this.saveSession(),!0}catch(t){return console.warn("[integramApiClient] Session validation failed:",t.message),!1}}tryRestoreSession(){if(this.isAuthenticated())return!0;const t=localStorage.getItem("integram_session");if(t)try{const e=JSON.parse(t);if(e.token&&e.xsrfToken)return this.database=e.database,this.token=e.token,this.xsrfToken=e.xsrfToken,this.userId=e.userId,this.userName=e.userName,this.userRole=e.userRole,this.authDatabase=e.authDatabase||e.database,e.authServer&&(this.baseURL=e.authServer),console.log("[integramApiClient] Session restored from localStorage"),!0}catch(e){console.warn("[integramApiClient] Failed to parse stored session:",e)}return!!this.loadSessionFromMyToken()}getAuthInfo(){return{token:this.token,xsrf:this.xsrfToken,userId:this.userId,userName:this.userName,userRole:this.userRole,database:this.database}}buildURL(t){if(!this.database)throw new Error("Database not set. Call setDatabase() first.");let e=this.baseURL.replace(/\/$/,"");const s=/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/.test(e);return e.includes("dronedoc.ru")||e.includes("sakhwings.ru")||s?new RegExp(`/${this.database}$`).test(e)?`${e}/${t}`:t.startsWith(`${this.database}/`)?`${e}/${t}`:`${e}/${this.database}/${t}`:`${e}/api/${this.database}/${t}`}async authenticate(t,e,s){var a,o;try{this.database=t;const r=this.buildURL("auth"),n=new URLSearchParams;n.append("login",e),n.append("pwd",s);const i=await p.post(r,n,{params:{JSON_KV:""},headers:{"Content-Type":"application/x-www-form-urlencoded"}});if(i.data.failed)throw new Error("Неверный логин или пароль");const c=i.data.token;if(!c)throw new Error("Сервер не вернул токен авторизации");if(c===s)throw console.error("[integramApiClient] CRITICAL: Server returned password as token!",{database:t,login:e,tokenReceived:c,tokenLength:c.length}),new Error("Ошибка сервера: получен некорректный токен авторизации");if(c.length<16&&console.warn("[integramApiClient] Warning: Received token is suspiciously short",{tokenLength:c.length,token:c}),this.databases[t]={token:c,xsrfToken:i.data._xsrf,userId:i.data.id,userName:e,userRole:i.data.role||"user",ownedDatabases:[]},this.currentDatabase=t,this.token=c,this.xsrfToken=i.data._xsrf,this.userId=i.data.id,this.userName=e,this.userRole=i.data.role||"user",this.database=t,this.authDatabase=t,t==="my"&&this.userId)try{const u=await this.getOwnedDatabases(this.userId);this.databases[t].ownedDatabases=u}catch(u){console.warn("[integramApiClient] Failed to load owned databases:",u.message),this.databases[t].ownedDatabases=[]}return this.saveSession(),{success:!0,database:t,token:c,xsrf:i.data._xsrf,userId:this.userId,userName:this.userName,userRole:this.userRole,ownedDatabases:this.databases[t].ownedDatabases}}catch(r){throw console.error("Integram authentication error:",r),new Error(((o=(a=r.response)==null?void 0:a.data)==null?void 0:o.message)||r.message||"Ошибка авторизации")}}async getOwnedDatabases(t){try{const e=this.database;this.database="my";const s=await this.get("object/271/",{F_U:t});this.database=e;const a=[];if(s&&s.object&&Array.isArray(s.object))for(const r of s.object)r.val&&typeof r.val=="string"&&r.val.match(/^[a-zA-Z0-9_]{2,20}$/)&&a.push(r.val);const o=[...new Set(a)].sort();return console.log("[integramApiClient] Owned databases loaded:",o),o}catch(e){return console.error("[integramApiClient] Failed to load owned databases:",e),[]}}async switchDatabase(t){var e,s;try{if(!this.databases[t])if((s=(e=this.databases.my)==null?void 0:e.ownedDatabases)!=null&&s.includes(t))console.log(`[integramApiClient] Switching to owned database: ${t}`);else throw new Error(`No session for database: ${t}. Please authenticate first.`);if(this.currentDatabase=t,this.databases[t]){const a=this.databases[t];this.database=t,this.token=a.token,this.xsrfToken=a.xsrfToken,this.userId=a.userId,this.userName=a.userName,this.userRole=a.userRole,this.authDatabase=t}else{const a=this.databases.my;this.database=t,this.token=a.token,this.xsrfToken=a.xsrfToken,this.userId=a.userId,this.userName=a.userName,this.userRole=a.userRole,this.authDatabase="my"}return this.saveSession(),!0}catch(a){throw console.error("[integramApiClient] Failed to switch database:",a),a}}getAuthHeaders(t=null){const e=t||this.currentDatabase||this.database;if(!e)throw new Error("No database specified for request");const s={};return e==="my"?this.databases.my?s["X-Authorization"]=this.databases.my.token:this.token&&(s["X-Authorization"]=this.token):this.databases.my?(console.log("[DEBUG] Using my token for",e,'database access (will use "my" header)'),s.my=this.databases.my.token):(console.warn('[integramApiClient] No "my" session found for accessing other databases'),this.token&&this.authDatabase==="my"?s.my=this.token:s["X-Authorization"]=this.token),s}async fetchSessionInfo(){try{const t=await this.get("xsrf");return this.userId=t.id,this.userName=t.user,this.userRole=t.role,this.xsrfToken=t._xsrf,this.token=t.token,t}catch(t){throw console.error("Failed to fetch session info:",t),t}}logout(){this.token=null,this.xsrfToken=null,this.userId=null,this.userName=null,this.userRole=null,this.database=null,this.clearSession()}async get(t,e={}){try{if(!this.isAuthenticated()&&t!=="xsrf")throw new Error("Not authenticated. Call authenticate() first.");const s=this.buildURL(t),a=this.getAuthHeaders(this.database),o={JSON_KV:"",...e};return(await p.get(s,{params:o,headers:a,timeout:3e4})).data}catch(s){throw console.error("Integram GET error:",s),this.handleError(s)}}async post(t,e={},s={}){try{if(!this.isAuthenticated())throw new Error("Not authenticated. Call authenticate() first.");const a=this.buildURL(t),o=new URLSearchParams;o.append("_xsrf",this.xsrfToken);for(const[c,u]of Object.entries(e))u!=null&&o.append(c,u);const n={"Content-Type":"application/x-www-form-urlencoded",...this.getAuthHeaders(this.database)};return(await p.post(a,o,{params:{JSON_KV:""},headers:n,timeout:3e4,...s})).data}catch(a){throw console.error("Integram POST error:",a),this.handleError(a)}}handleError(t){var e;if(t.code==="ECONNABORTED"||(e=t.message)!=null&&e.includes("timeout"))return console.warn("Request timeout:",t.message),new Error("Превышено время ожидания ответа от сервера.");if(t.code==="ERR_NETWORK"||t.message==="Network Error")return console.warn("Network error:",t.message),new Error("Ошибка сети. Проверьте подключение к интернету.");if(t.response){const{status:s,data:a}=t.response;if(s===401){if(console.warn("[integramApiClient] 401 error - attempting session restore"),this.tryRestoreSession()){console.log("[integramApiClient] Session restored, retry the request");const o=new Error("SESSION_RESTORED_RETRY");return o.canRetry=!0,o}return console.warn("[integramApiClient] Session could not be restored"),new Error("Сессия истекла. Обновите страницу или войдите заново.")}return s===403?new Error("Доступ запрещен."):s===404?new Error("Ресурс не найден."):s===500?new Error("Ошибка сервера: "+(a.message||a.error||"Internal server error")):new Error(a.message||a.error||`HTTP ${s}`)}return t.request?new Error("Нет ответа от сервера. Проверьте подключение к сети."):t}async createType(t,e,s=!1){const a={val:t,t:e};return s&&(a.unique=1),this.post("_d_new",a)}async saveType(t,e,s,a=!1){const o={val:e,t:s};return a&&(o.unique=1),this.post(`_d_save/${t}`,o)}async deleteType(t){return this.post(`_d_del/${t}`)}async addRequisite(t,e){return this.post(`_d_req/${t}`,{t:e})}async deleteRequisite(t,e=!0){const s=e?{forced:"1"}:{};return this.post(`_d_del_req/${t}`,s)}async saveRequisiteAlias(t,e){return this.post(`_d_alias/${t}`,{val:e})}async saveRequisiteAttributes(t,e){return this.post(`_d_attrs/${t}`,{val:e})}async toggleRequisiteNull(t){return this.post(`_d_null/${t}`)}async toggleRequisiteMulti(t){return this.post(`_d_multi/${t}`)}async createTypeReference(t){return this.post(`_d_ref/${t}`)}async saveRequisiteDefaultValue(t,e){return this.post(`_d_save/${t}/`,{val:e})}async moveRequisiteUp(t){return this.post(`_d_up/${t}`)}async addReferenceColumn(t,e,s){const a=await this.addRequisite(t,e);return a&&a.id&&await this.saveRequisiteAlias(a.id,s),a}async createObject(t,e,s={},a=null){const o={[`t${t}`]:e};o.up=a||1;for(const[r,n]of Object.entries(s))o[`t${r}`]=y(n);return this.post(`_m_new/${t}`,o)}async saveObject(t,e,s,a={}){const o={[`t${e}`]:s};for(const[r,n]of Object.entries(a)){const i=y(n);o[`t${r}`]=i??""}return this.post(`_m_save/${t}`,o)}async setObjectRequisites(t,e={}){const s={};for(const[a,o]of Object.entries(e)){const r=y(o);s[`t${a}`]=r??""}return this.post(`_m_set/${t}`,s)}async uploadRequisiteFile(t,e,s){const a=new FormData;a.append(`t${e}`,s,s.name),a.append("_xsrf",this.xsrfToken);const o=this.buildURL(`_m_save/${t}`),r={};return this.database==="my"||this.authDatabase===this.database?r["X-Authorization"]=this.token:r.my=this.token,(await p.post(o,a,{params:{JSON_KV:""},headers:r})).data}async deleteObject(t){return this.post(`_m_del/${t}`)}async moveObjectUp(t){return this.post(`_m_up/${t}`)}async moveObjectToParent(t,e){return this.post(`_m_move/${t}`,{up:e})}async getDictionary(){return this.get("dict")}async getTypeMetadata(t){const e=new Error().stack.split(`
`)[2].trim();return console.log(`[getTypeMetadata] typeId=${t}, caller: ${e}`),this.get(`metadata/${t}`)}async getObjectList(t,e={}){const s=e.LIMIT||"all",a=new Error().stack.split(`
`)[2].trim();return console.log(`[getObjectList] typeId=${t}, LIMIT=${s}, caller: ${a}`),this.get(`object/${t}`,e)}async getObjectEditData(t){return this.get(`edit_obj/${t}`)}async getTypeEditorData(){return this.get("edit_types")}async executeReport(t,e={}){return e._m_confirmed?this.post(`report/${t}`,e):this.get(`report/${t}`,e)}async deleteObjectsByFilter(t,e={}){return this.post(`object/${t}`,{_m_del_select:1,...e})}async getDirAdmin(t=""){return this.get("dir_admin",{path:t})}async uploadFile(t,e=""){const s=new FormData;s.append("file",t),s.append("path",e),s.append("_xsrf",this.xsrfToken);const a=this.buildURL("dir_admin"),o={"Content-Type":"multipart/form-data"};return this.database==="my"||this.authDatabase===this.database?o["X-Authorization"]=this.token:o.my=this.token,(await p.post(a,s,{params:{JSON_KV:""},headers:o})).data}async createBackup(){return this.post("backup")}async restoreBackup(t){return this.get("restore",{backup_file:t})}async getReferenceOptions(t,e,s=null,a=null){const o={id:e};return s&&(o.r=s),a&&(o.type="query",o.q=a),this.get(`_ref_reqs/${t}`,o)}async addMultiselectItem(t,e,s){return this.post(`_m_set/${t}`,{[`t${e}`]:s})}async removeMultiselectItem(t){return this.post(`_m_del/${t}`)}async getMultiselectItems(t,e){const s=await this.getObjectEditData(t);if(s&&s.reqs&&s.reqs[e]){const a=s.reqs[e];if(Array.isArray(a))return a.map(o=>({id:o.id,value:o.val||o.value}))}return[]}async createReport(t,e={}){const o=(await this.createObject(22,t)).id;if(o&&Object.keys(e).length>0){const r={};e.where&&(r[262]=e.where),e.having&&(r[263]=e.having),e.orderBy&&(r[264]=e.orderBy),e.limit&&(r[134]=e.limit),e.execute&&(r[228]="1"),Object.keys(r).length>0&&await this.setObjectRequisites(o,r)}return{id:o,name:t}}async addReportColumn(t,e){const a=e.nameInReport||e.alias||`Column ${e.fieldId}`,r=(await this.createObject(28,a,{},t)).id;if(r){const n={};e.fieldId!==void 0&&(n[91]=String(e.fieldId)),e.nameInReport&&(n[100]=e.nameInReport),e.formula&&(n[101]=e.formula),e.functionId&&(n[104]=String(e.functionId)),e.hide&&(n[107]="1"),e.alias&&(n[58]=e.alias),e.set&&(n[132]=e.set),e.sort&&(n[109]=String(e.sort)),e.total&&(n[72]=String(e.total)),e.format&&(n[84]=String(e.format)),Object.keys(n).length>0&&await this.setObjectRequisites(r,n)}return{id:r,...e}}async addReportFrom(t,e,s=null,a=null){let r=`Table ${e}`;try{const c=await this.getTypeMetadata(e);c&&c.type&&(r=c.type.val||c.type.name||r)}catch{}const i=(await this.createObject(44,r,{},t)).id;if(i){const c={91:String(e)};s&&(c[265]=s),a&&(c[266]=a),await this.setObjectRequisites(i,c)}return{id:i,tableId:e,alias:s,joinOn:a}}async cloneReport(t,e,s=!1){const a=await this.getReportStructure(t);if(!a||!a.report)throw new Error(`Report ${t} not found`);const o=await this.createReport(e,{where:a.report.where,having:a.report.having,orderBy:a.report.orderBy,limit:a.report.limit,execute:s});if(a.fromTables&&a.fromTables.length>0)for(const r of a.fromTables)await this.addReportFrom(o.id,r.tableId,r.alias,r.joinOn);if(a.columns&&a.columns.length>0)for(const r of a.columns)await this.addReportColumn(o.id,r);return o}async getReportStructure(t){var r,n,i,c,u,f,l,h,b,R,I,S,_,T,D,v,q,$,x,O,j,E,A,C,N,L,U,M,F,P,V,J,B,H,X,Y;const e=await this.getObjectEditData(t);if(!e||!e.obj)return null;const s={id:t,name:e.obj.val,where:((n=(r=e.reqs)==null?void 0:r["262"])==null?void 0:n.value)||null,having:((c=(i=e.reqs)==null?void 0:i["263"])==null?void 0:c.value)||null,orderBy:((f=(u=e.reqs)==null?void 0:u["264"])==null?void 0:f.value)||null,limit:((h=(l=e.reqs)==null?void 0:l["134"])==null?void 0:h.value)||null,execute:((R=(b=e.reqs)==null?void 0:b["228"])==null?void 0:R.value)==="1"},a=[],o=[];if(e["&object_reqs"]){const k=e["&object_reqs"];if(k[44]){const w=k[44];if(Array.isArray(w))for(const m of w)a.push({id:m.id,tableId:parseInt((S=(I=m.reqs)==null?void 0:I["91"])==null?void 0:S.value)||0,alias:((T=(_=m.reqs)==null?void 0:_["265"])==null?void 0:T.value)||null,joinOn:((v=(D=m.reqs)==null?void 0:D["266"])==null?void 0:v.value)||null})}if(k[28]){const w=k[28];if(Array.isArray(w))for(const m of w)o.push({id:m.id,fieldId:parseInt(($=(q=m.reqs)==null?void 0:q["91"])==null?void 0:$.value)||0,nameInReport:((O=(x=m.reqs)==null?void 0:x["100"])==null?void 0:O.value)||null,formula:((E=(j=m.reqs)==null?void 0:j["101"])==null?void 0:E.value)||null,functionId:parseInt((C=(A=m.reqs)==null?void 0:A["104"])==null?void 0:C.value)||null,hide:((L=(N=m.reqs)==null?void 0:N["107"])==null?void 0:L.value)==="1",alias:((M=(U=m.reqs)==null?void 0:U["58"])==null?void 0:M.value)||null,set:((P=(F=m.reqs)==null?void 0:F["132"])==null?void 0:P.value)||null,sort:parseInt((J=(V=m.reqs)==null?void 0:V["109"])==null?void 0:J.value)||null,total:parseInt((H=(B=m.reqs)==null?void 0:B["72"])==null?void 0:H.value)||null,format:parseInt((Y=(X=m.reqs)==null?void 0:X["84"])==null?void 0:Y.value)||null})}}return{report:s,fromTables:a,columns:o}}async register(t){try{const e=`${this.baseURL}/register.asp`,s=new URLSearchParams;return s.append("email",t.email),s.append("password",t.password),s.append("agree",t.agree?"1":"0"),{success:!0,message:"Registration successful. Please check your email to confirm.",data:(await p.post(e,s,{headers:{"Content-Type":"application/x-www-form-urlencoded"}})).data}}catch(e){throw console.error("Registration error:",e),this.handleError(e)}}async resetPassword(t){try{const e=`${this.baseURL}/reset.asp`,s=new URLSearchParams;return t.database&&s.append("db",t.database),s.append("login",t.login),{success:!0,message:"Password reset email sent. Please check your inbox.",data:(await p.post(e,s,{headers:{"Content-Type":"application/x-www-form-urlencoded"}})).data}}catch(e){throw console.error("Password reset error:",e),this.handleError(e)}}async handleGoogleOAuthCallback(t,e="my"){try{const s=`${this.baseURL}/auth.asp`,a=new URLSearchParams;a.append("code",t),e&&a.append("state",e);const o=await p.get(`${s}?${a.toString()}`);if(o.data.success||o.data.token){const r=o.data;return this.database=e,this.token=r.token,this.xsrfToken=r.xsrf||r.token,this.userId=r.userId,this.userName=r.userName||r.email,this.userRole=r.userRole,this.authDatabase=e,this.saveSession(),{success:!0,token:this.token,xsrf:this.xsrfToken,userId:this.userId,userName:this.userName,userRole:this.userRole}}else throw new Error("OAuth authentication failed")}catch(s){throw console.error("Google OAuth callback error:",s),this.handleError(s)}}async setObjectOrder(t,e){if(!Number.isInteger(e)||e<1)throw new Error("Invalid order: must be a positive integer");return this.post(`_m_ord/${t}`,{order:e})}async setObjectId(t,e){if(!Number.isInteger(e)||e<1)throw new Error("Invalid new_id: must be a positive integer");return this.post(`_m_id/${t}`,{new_id:e})}async setRequisiteOrder(t,e){if(!Number.isInteger(e)||e<1)throw new Error("Invalid order: must be a positive integer");return this.post(`_d_ord/${t}`,{order:e})}async getObjectMeta(t){return this.get(`obj_meta/${t}`)}async getReferences(t){return this.get(`_references/${t}`)}async getTerms(){return this.get("terms")}async authenticateJWT(t){try{const e=this.buildURL("jwt"),s=new URLSearchParams;s.append("jwt",t);const a=await p.post(e,s,{params:{JSON_KV:""},headers:{"Content-Type":"application/x-www-form-urlencoded"}});if(a.data.error)throw new Error(a.data.error);return a.data.token&&(this.token=a.data.token,this.xsrfToken=a.data._xsrf||a.data.xsrf,this.userId=a.data.id||a.data.userId,this.userName=a.data.user||a.data.userName,this.userRole=a.data.role,this.authDatabase=this.database,this.saveSession()),{success:!0,token:this.token,xsrf:this.xsrfToken,userId:this.userId,userName:this.userName,userRole:this.userRole}}catch(e){throw console.error("JWT authentication error:",e),this.handleError(e)}}async getOTPCode(t){try{const e=this.buildURL("getcode"),s=new URLSearchParams;return s.append("u",t),s.append("tzone",Date.now()),(await p.post(e,s,{params:{JSON_KV:""},headers:{"Content-Type":"application/x-www-form-urlencoded"}})).data}catch(e){throw console.error("OTP request error:",e),this.handleError(e)}}async checkOTPCode(t,e){try{if(!e||e.length!==4)throw new Error("OTP code must be exactly 4 characters");const s=this.buildURL("checkcode"),a=new URLSearchParams;a.append("u",t),a.append("c",e.toLowerCase());const o=await p.post(s,a,{params:{JSON_KV:""},headers:{"Content-Type":"application/x-www-form-urlencoded"}});if(o.data.error)throw new Error(o.data.error);return o.data.token&&(this.token=o.data.token,this.xsrfToken=o.data._xsrf,this.userName=t,this.authDatabase=this.database,this.saveSession()),{success:!0,token:o.data.token,xsrf:o.data._xsrf}}catch(s){throw console.error("OTP verification error:",s),this.handleError(s)}}async confirmRegistration(t,e,s){try{const a=this.buildURL("confirm");return{success:!0,data:(await p.get(a,{params:{JSON_KV:"",u:t,o:e,p:s}})).data}}catch(a){throw console.error("Registration confirmation error:",a),this.handleError(a)}}async createDatabase(t,e="ru",s=""){try{if(!/^[a-z][a-z0-9]{2,14}$/i.test(t))throw new Error("Недопустимое имя базы (3-15 латинских букв и цифр, начиная с буквы)");const o=this.database;this.database="my";try{return await this.post("_new_db",{db:t.toLowerCase(),template:e.toLowerCase(),descr:s})}finally{this.database=o}}catch(a){throw console.error("Database creation error:",a),this.handleError(a)}}async connect(t){return this.post("_connect",t)}async exit(){try{await this.post("exit")}catch(t){console.warn("Exit error (ignored):",t)}finally{this.logout()}}async getAllTypesMetadata(){return this.get("metadata")}async getAllObjects(t,e=100,s=50){let a=[],o={},r=1,n=!0,i=null;const c=new Set;for(;n&&r<=s;){const u=await this.get(`object/${t}`,{LIMIT:e,pg:r});r===1&&(i=u.type);const f=u.object||[];if(f.length===0)n=!1;else{for(const l of f){const h=l.id||l.ID;h&&!c.has(h)&&(c.add(h),a.push(l))}if(u.reqs)for(const[l,h]of Object.entries(u.reqs))c.has(l)&&!o[l]&&(o[l]=h);f.length<e&&(n=!1)}r++}return{type:i,totalCount:a.length,pagesLoaded:r-1,object:a,reqs:o}}async getObjectCount(t){const e=await this.get(`object/${t}`,{_count:""});return{typeId:t,count:parseInt(e.count,10)||0}}async createTableWithColumns(t,e=[],s=3,a=!1){const o=await this.createType(t,s,a),r=o.obj||o.id;if(!r)throw new Error(`Failed to create table: ${JSON.stringify(o)}`);const n=[];for(const i of e){const u=(await this.addRequisite(r,i.requisiteTypeId)).id;u&&(await this.saveRequisiteAlias(u,i.alias),i.allowNull===!1&&await this.toggleRequisiteNull(u),i.multiSelect===!0&&await this.toggleRequisiteMulti(u),n.push({requisiteId:u,alias:i.alias,requisiteTypeId:i.requisiteTypeId}))}return{typeId:r,tableName:t,columns:n}}async deleteTableCascade(t,e=!1){if(!e)throw new Error("Confirmation required: set confirm=true to delete");const s=await this.getObjectList(t,{LIMIT:1e3});for(const a of s.object||[])await this.deleteObject(a.id||a.ID);return this.deleteType(t)}async getTableStructure(t){const[e,s]=await Promise.all([this.getTypeMetadata(t),this.getObjectCount(t)]);return{type:e.type||e,columns:e.reqs||[],objectCount:s.count}}async cloneTableStructure(t,e,s=3){const o=((await this.getTypeMetadata(t)).reqs||[]).map(r=>({requisiteTypeId:r.requisite_type_id||r.t,alias:r.alias||r.val}));return this.createTableWithColumns(e,o,s)}async renameTable(t,e){var o;const a=((o=(await this.getTypeMetadata(t)).type)==null?void 0:o.t)||3;return this.saveType(t,e,a)}async addColumnsToTable(t,e=[]){const s=[];for(const a of e){const r=(await this.addRequisite(t,a.requisiteTypeId)).id;r&&(await this.saveRequisiteAlias(r,a.alias),a.allowNull===!1&&await this.toggleRequisiteNull(r),a.multiSelect===!0&&await this.toggleRequisiteMulti(r),s.push({requisiteId:r,alias:a.alias}))}return{typeId:t,columns:s}}async createLookupTable(t,e=[],s=!0){const a=await this.createType(t,3,s),o=a.obj||a.id,r=[];for(const n of e){const i=await this.createObject(o,n);i.id&&r.push({id:i.id,value:n})}return{typeId:o,tableName:t,objects:r}}async createLookupWithReference(t,e,s,a=[],o=!1){const r=await this.createLookupTable(e,a),i=(await this.addRequisite(t,r.typeId)).id;return i&&(await this.saveRequisiteAlias(i,s||e),o&&await this.toggleRequisiteMulti(i)),{lookupTypeId:r.typeId,lookupObjects:r.objects,referenceColumn:{requisiteId:i,alias:s||e}}}async createObjectsBatch(t,e=[],s=null){const a=[];for(const o of e){const r={};for(const[i,c]of Object.entries(o.requisites||{}))r[i]=y(c);const n=await this.createObject(t,o.value,r,s);n.id&&a.push({id:n.id,value:o.value})}return{typeId:t,created:a}}async createParentWithChildren(t,e,s={},a,o=[]){const r={};for(const[u,f]of Object.entries(s))r[u]=y(f);const i=(await this.createObject(t,e,r)).id;if(!i)throw new Error("Failed to create parent object");const c=[];for(const u of o){const f={};for(const[h,b]of Object.entries(u.requisites||{}))f[h]=y(b);const l=await this.createObject(a,u.value,f,i);l.id&&c.push({id:l.id,value:u.value})}return{parent:{id:i,value:e},children:c}}async renameRequisite(t,e,s){return this.post(`_d_save/${t}`,{val:e,t:s})}async getSchema(t=null,e=!1){var i;const s=await this.getDictionary(),a=s.type||s.types||[],o=[1,6,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,42,44],r={2:"LONG",3:"SHORT",4:"DATETIME",7:"BOOL",8:"CHARS",9:"DATE",10:"FILE",13:"NUMBER"},n=[];for(const c of a){const u=c.id||c.ID;if(!e&&o.includes(u)||t&&!((i=c.val)!=null&&i.toLowerCase().includes(t.toLowerCase())))continue;const l=((await this.getTypeMetadata(u)).reqs||[]).map(h=>{const b={id:h.id,name:h.alias||h.val,type:r[h.requisite_type_id]||"REF"};return r[h.requisite_type_id]||(b.ref=h.requisite_type_id),b});n.push({id:u,name:c.val,fields:l})}return n}}const G=new W;export{G as i};
