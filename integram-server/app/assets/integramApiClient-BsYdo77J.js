import{a as t}from"./index-CcrxTH1M.js";import{u as e}from"./unifiedAuthService-6fZILgG8.js";function s(t){if(null==t||""===t)return t;if(t instanceof Date||t&&"function"==typeof t.getFullYear&&"function"==typeof t.getMonth)return isNaN(t.getTime())?t:`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}:${String(t.getSeconds()).padStart(2,"0")}`;const e=String(t),s=e.match(/^(\d{4})[-\/.](\d{2})[-\/.](\d{2})(?:[T\s](\d{2}):(\d{2})(?::(\d{2}))?)?$/);if(s){const[,t,e,a,r,i,n]=s;return`${t}-${e}-${a} ${void 0!==r?r:"00"}:${void 0!==i?i:"00"}:${void 0!==n?n:"00"}`}const a=e.match(/^(\d{2})\.(\d{2})\.(\d{4})(?:\s+(\d{2}):(\d{2})(?::(\d{2}))?)?$/);if(a){const[,t,e,s,r,i,n]=a;return`${s}-${e}-${t} ${void 0!==r?r:"00"}:${void 0!==i?i:"00"}:${void 0!==n?n:"00"}`}return t}const a=new class{constructor(){let t=localStorage.getItem("integram_server")||"https://app.integram.io";t=t.replace(/\/$/,"");const e=t.match(/^(https?:\/\/[^/]+)\/([a-zA-Z0-9_]+)$/);e&&(t=e[1],localStorage.setItem("integram_server",t)),this.baseURL=t,this.databases={},this.currentDatabase=null,this.database=null,this.token=null,this.xsrfToken=null,this.userId=null,this.userRole=null,this.userName=null,this.authDatabase=null,this.loadSession()}setServer(t){let e=t.replace(/\/$/,"");const s=e.match(/^(https?:\/\/[^/]+)\/([a-zA-Z0-9_]+)$/);s&&(e=s[1]),this.baseURL=e,localStorage.setItem("integram_server",this.baseURL)}getServer(){return this.baseURL}setCredentials(t,e,s=null,a=null){this.database=t,this.token=e,this.xsrfToken=s||e,this.authDatabase=a||t}saveSession(){if(Object.keys(this.databases).length>0){const t={version:2,server:this.baseURL,currentDatabase:this.currentDatabase,databases:this.databases};return void localStorage.setItem("integram_session",JSON.stringify(t))}if(this.token&&this.xsrfToken&&this.database){const t={database:this.database,token:this.token,xsrfToken:this.xsrfToken,userId:this.userId,userName:this.userName,userRole:this.userRole,authServer:this.baseURL,authDatabase:this.authDatabase};localStorage.setItem("integram_session",JSON.stringify(t))}else localStorage.removeItem("integram_session")}loadSession(){try{if(e.isAuthenticated())return void this.loadSessionFromUnifiedAuth();const t=localStorage.getItem("integram_session");if(t){const e=JSON.parse(t);if(2===e.version&&e.databases){if(this.baseURL=e.server,this.databases=e.databases,this.currentDatabase=e.currentDatabase,this.currentDatabase&&this.databases[this.currentDatabase]){const t=this.databases[this.currentDatabase];this.database=this.currentDatabase,this.token=t.token,this.xsrfToken=t.xsrfToken,this.userId=t.userId,this.userName=t.userName,this.userRole=t.userRole,this.authDatabase=this.currentDatabase,"my"!==this.currentDatabase||!this.userId||t.ownedDatabases&&0!==t.ownedDatabases.length||this.getOwnedDatabases(this.userId).then(t=>{this.databases.my.ownedDatabases=t,this.saveSession()}).catch(t=>{})}return void localStorage.setItem("integram_server",this.baseURL)}return this.database=e.database,this.token=e.token,this.xsrfToken=e.xsrfToken,this.userId=e.userId,this.userName=e.userName,this.userRole=e.userRole,this.authDatabase=e.authDatabase||e.database,this.database&&this.token&&(this.databases[this.database]={token:this.token,xsrfToken:this.xsrfToken,userId:this.userId,userName:this.userName,userRole:this.userRole,ownedDatabases:[]},this.currentDatabase=this.database,"my"===this.database&&this.userId?this.getOwnedDatabases(this.userId).then(t=>{this.databases.my.ownedDatabases=t,this.saveSession()}).catch(t=>{}):this.saveSession()),void(e.authServer&&(this.baseURL=e.authServer,localStorage.setItem("integram_server",e.authServer)))}this.loadSessionFromMyToken()}catch(t){localStorage.removeItem("integram_session")}}loadSessionFromMyToken(){try{const t=localStorage.getItem("my_token"),e=localStorage.getItem("my_xsrf"),s=localStorage.getItem("my_user"),a=localStorage.getItem("my_id"),r=localStorage.getItem("db");if(t&&e)return this.database="my",this.token=t,this.xsrfToken=e,this.userId=a,this.userName=s,this.baseURL="https://dronedoc.ru",this.authDatabase="my",!0;const i=localStorage.getItem("token"),n=localStorage.getItem("_xsrf"),o=localStorage.getItem("user"),u=localStorage.getItem("id");return!(!i||!n||"my"!==r||(this.database="my",this.token=i,this.xsrfToken=n,this.userId=u,this.userName=o,this.baseURL="https://dronedoc.ru",this.authDatabase="my",0))}catch(t){return!1}}async loadSessionFromUnifiedAuth(){if(!e.isAuthenticated())return!1;try{const t=this.database||localStorage.getItem("db")||"A2025",s=await e.getTokenForDatabase(t);if(s){this.token=s.token,this.userId=s.userId,this.userName=s.userName,this.userRole=s.userRole,this.database=s.database;const t=await e.getTokenForDatabase("my");return t&&t.xsrf?this.xsrfToken=t.xsrf:this.xsrfToken=s.xsrf,this.saveSession(),!0}}catch(t){}return!1}async switchToDatabase(t){if(!e.isAuthenticated())return!1;try{const s=await e.getTokenForDatabase(t);if(s){this.database=t,this.token=s.token,this.userId=s.userId,this.userName=s.userName,this.userRole=s.userRole;const a=await e.getTokenForDatabase("my");return a&&a.xsrf?this.xsrfToken=a.xsrf:this.xsrfToken=s.xsrf,this.saveSession(),!0}}catch(s){}return!1}clearSession(){localStorage.removeItem("integram_session")}setDatabase(t){this.database=t}getDatabase(){return this.database}isAuthenticated(){return!!this.token&&!!this.xsrfToken}async validateSession(){if(!this.token||!this.xsrfToken)return!1;try{const t=await this.get("xsrf");return t.token&&(this.token=t.token),t._xsrf&&(this.xsrfToken=t._xsrf),t.id&&(this.userId=t.id),t.user&&(this.userName=t.user),t.role&&(this.userRole=t.role),this.saveSession(),!0}catch(t){return!1}}tryRestoreSession(){if(this.isAuthenticated())return!0;const t=localStorage.getItem("integram_session");if(t)try{const e=JSON.parse(t);if(e.token&&e.xsrfToken)return this.database=e.database,this.token=e.token,this.xsrfToken=e.xsrfToken,this.userId=e.userId,this.userName=e.userName,this.userRole=e.userRole,this.authDatabase=e.authDatabase||e.database,e.authServer&&(this.baseURL=e.authServer),!0}catch(e){}return!!this.loadSessionFromMyToken()}getAuthInfo(){return{token:this.token,xsrf:this.xsrfToken,userId:this.userId,userName:this.userName,userRole:this.userRole,database:this.database}}buildURL(t){if(!this.database)throw new Error("Database not set. Call setDatabase() first.");let e=this.baseURL.replace(/\/$/,"");const s=/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/.test(e);return e.includes("dronedoc.ru")||e.includes("sakhwings.ru")||s?new RegExp(`/${this.database}$`).test(e)||t.startsWith(`${this.database}/`)?`${e}/${t}`:`${e}/${this.database}/${t}`:`${e}/api/${this.database}/${t}`}async authenticate(e,s,a){var r,i;try{this.database=e;const r=this.buildURL("auth"),i=new URLSearchParams;i.append("login",s),i.append("pwd",a);const o=await t.post(r,i,{params:{JSON_KV:""},headers:{"Content-Type":"application/x-www-form-urlencoded"}});if(o.data.failed)throw new Error("Неверный логин или пароль");const u=o.data.token;if(!u)throw new Error("Сервер не вернул токен авторизации");if(u===a)throw new Error("Ошибка сервера: получен некорректный токен авторизации");if(u.length,this.databases[e]={token:u,xsrfToken:o.data._xsrf,userId:o.data.id,userName:s,userRole:o.data.role||"user",ownedDatabases:[]},this.currentDatabase=e,this.token=u,this.xsrfToken=o.data._xsrf,this.userId=o.data.id,this.userName=s,this.userRole=o.data.role||"user",this.database=e,this.authDatabase=e,"my"===e&&this.userId)try{const t=await this.getOwnedDatabases(this.userId);this.databases[e].ownedDatabases=t}catch(n){this.databases[e].ownedDatabases=[]}return this.saveSession(),{success:!0,database:e,token:u,xsrf:o.data._xsrf,userId:this.userId,userName:this.userName,userRole:this.userRole,ownedDatabases:this.databases[e].ownedDatabases}}catch(n){throw new Error((null==(i=null==(r=n.response)?void 0:r.data)?void 0:i.message)||n.message||"Ошибка авторизации")}}async getOwnedDatabases(t){try{const e=this.database;this.database="my";const s=await this.get("object/271/",{F_U:t});this.database=e;const a=[];if(s&&s.object&&Array.isArray(s.object))for(const t of s.object)t.val&&"string"==typeof t.val&&t.val.match(/^[a-zA-Z0-9_]{2,20}$/)&&a.push(t.val);return[...new Set(a)].sort()}catch(e){return[]}}async switchDatabase(t){var e,s;try{if(!this.databases[t]&&!(null==(s=null==(e=this.databases.my)?void 0:e.ownedDatabases)?void 0:s.includes(t)))throw new Error(`No session for database: ${t}. Please authenticate first.`);if(this.currentDatabase=t,this.databases[t]){const e=this.databases[t];this.database=t,this.token=e.token,this.xsrfToken=e.xsrfToken,this.userId=e.userId,this.userName=e.userName,this.userRole=e.userRole,this.authDatabase=t}else{const e=this.databases.my;this.database=t,this.token=e.token,this.xsrfToken=e.xsrfToken,this.userId=e.userId,this.userName=e.userName,this.userRole=e.userRole,this.authDatabase="my"}return this.saveSession(),!0}catch(a){throw a}}getAuthHeaders(t=null){const e=t||this.currentDatabase||this.database;if(!e)throw new Error("No database specified for request");const s={};return"my"===e?this.databases.my?s["X-Authorization"]=this.databases.my.token:this.token&&(s["X-Authorization"]=this.token):this.databases.my?s.my=this.databases.my.token:this.token&&"my"===this.authDatabase?s.my=this.token:s["X-Authorization"]=this.token,s}async fetchSessionInfo(){try{const t=await this.get("xsrf");return this.userId=t.id,this.userName=t.user,this.userRole=t.role,this.xsrfToken=t._xsrf,this.token=t.token,t}catch(t){throw t}}logout(){this.token=null,this.xsrfToken=null,this.userId=null,this.userName=null,this.userRole=null,this.database=null,this.clearSession()}async get(e,s={}){try{if(!this.isAuthenticated()&&"xsrf"!==e)throw new Error("Not authenticated. Call authenticate() first.");const a=this.buildURL(e),r=this.getAuthHeaders(this.database),i={JSON_KV:"",...s};return(await t.get(a,{params:i,headers:r,timeout:3e4})).data}catch(a){throw this.handleError(a)}}async post(e,s={},a={}){try{if(!this.isAuthenticated())throw new Error("Not authenticated. Call authenticate() first.");const r=this.buildURL(e),i=new URLSearchParams;i.append("_xsrf",this.xsrfToken);for(const[t,e]of Object.entries(s))null!=e&&i.append(t,e);const n={"Content-Type":"application/x-www-form-urlencoded",...this.getAuthHeaders(this.database)};return(await t.post(r,i,{params:{JSON_KV:""},headers:n,timeout:3e4,...a})).data}catch(r){throw this.handleError(r)}}handleError(t){var e;if("ECONNABORTED"===t.code||(null==(e=t.message)?void 0:e.includes("timeout")))return new Error("Превышено время ожидания ответа от сервера.");if("ERR_NETWORK"===t.code||"Network Error"===t.message)return new Error("Ошибка сети. Проверьте подключение к интернету.");if(t.response){const{status:e,data:s}=t.response;if(401===e){if(this.tryRestoreSession()){const t=new Error("SESSION_RESTORED_RETRY");return t.canRetry=!0,t}return new Error("Сессия истекла. Обновите страницу или войдите заново.")}return 403===e?new Error("Доступ запрещен."):404===e?new Error("Ресурс не найден."):500===e?new Error("Ошибка сервера: "+(s.message||s.error||"Internal server error")):new Error(s.message||s.error||`HTTP ${e}`)}return t.request?new Error("Нет ответа от сервера. Проверьте подключение к сети."):t}async createType(t,e,s=!1){const a={val:t,t:e};return s&&(a.unique=1),this.post("_d_new",a)}async saveType(t,e,s,a=!1){const r={val:e,t:s};return a&&(r.unique=1),this.post(`_d_save/${t}`,r)}async deleteType(t){return this.post(`_d_del/${t}`)}async addRequisite(t,e){return this.post(`_d_req/${t}`,{t:e})}async deleteRequisite(t,e=!0){const s=e?{forced:"1"}:{};return this.post(`_d_del_req/${t}`,s)}async saveRequisiteAlias(t,e){return this.post(`_d_alias/${t}`,{val:e})}async saveRequisiteAttributes(t,e){return this.post(`_d_attrs/${t}`,{val:e})}async toggleRequisiteNull(t){return this.post(`_d_null/${t}`)}async toggleRequisiteMulti(t){return this.post(`_d_multi/${t}`)}async createTypeReference(t){return this.post(`_d_ref/${t}`)}async saveRequisiteDefaultValue(t,e){return this.post(`_d_save/${t}/`,{val:e})}async moveRequisiteUp(t){return this.post(`_d_up/${t}`)}async addReferenceColumn(t,e,s){const a=await this.addRequisite(t,e);return a&&a.id&&await this.saveRequisiteAlias(a.id,s),a}async createObject(t,e,a={},r=null){const i={[`t${t}`]:e};i.up=r||1;for(const[n,o]of Object.entries(a))i[`t${n}`]=s(o);return this.post(`_m_new/${t}`,i)}async saveObject(t,e,a,r={}){const i={[`t${e}`]:a};for(const[n,o]of Object.entries(r)){const t=s(o);i[`t${n}`]=null!=t?t:""}return this.post(`_m_save/${t}`,i)}async setObjectRequisites(t,e={}){const a={};for(const[r,i]of Object.entries(e)){const t=s(i);a[`t${r}`]=null!=t?t:""}return this.post(`_m_set/${t}`,a)}async uploadRequisiteFile(e,s,a){const r=new FormData;r.append(`t${s}`,a,a.name),r.append("_xsrf",this.xsrfToken);const i=this.buildURL(`_m_save/${e}`),n={};return"my"===this.database||this.authDatabase===this.database?n["X-Authorization"]=this.token:n.my=this.token,(await t.post(i,r,{params:{JSON_KV:""},headers:n})).data}async deleteObject(t){return this.post(`_m_del/${t}`)}async moveObjectUp(t){return this.post(`_m_up/${t}`)}async moveObjectToParent(t,e){return this.post(`_m_move/${t}`,{up:e})}async getDictionary(){return this.get("dict")}async getTypeMetadata(t){return(new Error).stack.split("\n")[2].trim(),this.get(`metadata/${t}`)}async getObjectList(t,e={}){return e.LIMIT,(new Error).stack.split("\n")[2].trim(),this.get(`object/${t}`,e)}async getObjectEditData(t){return this.get(`edit_obj/${t}`)}async getTypeEditorData(){return this.get("edit_types")}async executeReport(t,e={}){return e._m_confirmed?this.post(`report/${t}`,e):this.get(`report/${t}`,e)}async deleteObjectsByFilter(t,e={}){return this.post(`object/${t}`,{_m_del_select:1,...e})}async getDirAdmin(t=""){return this.get("dir_admin",{path:t})}async uploadFile(e,s=""){const a=new FormData;a.append("file",e),a.append("path",s),a.append("_xsrf",this.xsrfToken);const r=this.buildURL("dir_admin"),i={"Content-Type":"multipart/form-data"};return"my"===this.database||this.authDatabase===this.database?i["X-Authorization"]=this.token:i.my=this.token,(await t.post(r,a,{params:{JSON_KV:""},headers:i})).data}async createBackup(){return this.post("backup")}async restoreBackup(t){return this.get("restore",{backup_file:t})}async getReferenceOptions(t,e,s=null,a=null){const r={id:e};return s&&(r.r=s),a&&(r.type="query",r.q=a),this.get(`_ref_reqs/${t}`,r)}async addMultiselectItem(t,e,s){return this.post(`_m_set/${t}`,{[`t${e}`]:s})}async removeMultiselectItem(t){return this.post(`_m_del/${t}`)}async getMultiselectItems(t,e){const s=await this.getObjectEditData(t);if(s&&s.reqs&&s.reqs[e]){const t=s.reqs[e];if(Array.isArray(t))return t.map(t=>({id:t.id,value:t.val||t.value}))}return[]}async createReport(t,e={}){const s=(await this.createObject(22,t)).id;if(s&&Object.keys(e).length>0){const t={};e.where&&(t[262]=e.where),e.having&&(t[263]=e.having),e.orderBy&&(t[264]=e.orderBy),e.limit&&(t[134]=e.limit),e.execute&&(t[228]="1"),Object.keys(t).length>0&&await this.setObjectRequisites(s,t)}return{id:s,name:t}}async addReportColumn(t,e){const s=e.nameInReport||e.alias||`Column ${e.fieldId}`,a=(await this.createObject(28,s,{},t)).id;if(a){const t={};void 0!==e.fieldId&&(t[91]=String(e.fieldId)),e.nameInReport&&(t[100]=e.nameInReport),e.formula&&(t[101]=e.formula),e.functionId&&(t[104]=String(e.functionId)),e.hide&&(t[107]="1"),e.alias&&(t[58]=e.alias),e.set&&(t[132]=e.set),e.sort&&(t[109]=String(e.sort)),e.total&&(t[72]=String(e.total)),e.format&&(t[84]=String(e.format)),Object.keys(t).length>0&&await this.setObjectRequisites(a,t)}return{id:a,...e}}async addReportFrom(t,e,s=null,a=null){let r=`Table ${e}`;try{const t=await this.getTypeMetadata(e);t&&t.type&&(r=t.type.val||t.type.name||r)}catch(n){}const i=(await this.createObject(44,r,{},t)).id;if(i){const t={91:String(e)};s&&(t[265]=s),a&&(t[266]=a),await this.setObjectRequisites(i,t)}return{id:i,tableId:e,alias:s,joinOn:a}}async cloneReport(t,e,s=!1){const a=await this.getReportStructure(t);if(!a||!a.report)throw new Error(`Report ${t} not found`);const r=await this.createReport(e,{where:a.report.where,having:a.report.having,orderBy:a.report.orderBy,limit:a.report.limit,execute:s});if(a.fromTables&&a.fromTables.length>0)for(const i of a.fromTables)await this.addReportFrom(r.id,i.tableId,i.alias,i.joinOn);if(a.columns&&a.columns.length>0)for(const i of a.columns)await this.addReportColumn(r.id,i);return r}async getReportStructure(t){var e,s,a,r,i,n,o,u,h,d,l,c,b,m,p,f,y,w,g,v,k,R,I,_,T,S,$,x,q,D,O,N,j,E,L,A;const U=await this.getObjectEditData(t);if(!U||!U.obj)return null;const C={id:t,name:U.obj.val,where:(null==(s=null==(e=U.reqs)?void 0:e[262])?void 0:s.value)||null,having:(null==(r=null==(a=U.reqs)?void 0:a[263])?void 0:r.value)||null,orderBy:(null==(n=null==(i=U.reqs)?void 0:i[264])?void 0:n.value)||null,limit:(null==(u=null==(o=U.reqs)?void 0:o[134])?void 0:u.value)||null,execute:"1"===(null==(d=null==(h=U.reqs)?void 0:h[228])?void 0:d.value)},M=[],F=[];if(U["&object_reqs"]){const t=U["&object_reqs"];if(t[44]){const e=t[44];if(Array.isArray(e))for(const t of e)M.push({id:t.id,tableId:parseInt(null==(c=null==(l=t.reqs)?void 0:l[91])?void 0:c.value)||0,alias:(null==(m=null==(b=t.reqs)?void 0:b[265])?void 0:m.value)||null,joinOn:(null==(f=null==(p=t.reqs)?void 0:p[266])?void 0:f.value)||null})}if(t[28]){const e=t[28];if(Array.isArray(e))for(const t of e)F.push({id:t.id,fieldId:parseInt(null==(w=null==(y=t.reqs)?void 0:y[91])?void 0:w.value)||0,nameInReport:(null==(v=null==(g=t.reqs)?void 0:g[100])?void 0:v.value)||null,formula:(null==(R=null==(k=t.reqs)?void 0:k[101])?void 0:R.value)||null,functionId:parseInt(null==(_=null==(I=t.reqs)?void 0:I[104])?void 0:_.value)||null,hide:"1"===(null==(S=null==(T=t.reqs)?void 0:T[107])?void 0:S.value),alias:(null==(x=null==($=t.reqs)?void 0:$[58])?void 0:x.value)||null,set:(null==(D=null==(q=t.reqs)?void 0:q[132])?void 0:D.value)||null,sort:parseInt(null==(N=null==(O=t.reqs)?void 0:O[109])?void 0:N.value)||null,total:parseInt(null==(E=null==(j=t.reqs)?void 0:j[72])?void 0:E.value)||null,format:parseInt(null==(A=null==(L=t.reqs)?void 0:L[84])?void 0:A.value)||null})}}return{report:C,fromTables:M,columns:F}}async register(e){try{const s=`${this.baseURL}/register.asp`,a=new URLSearchParams;return a.append("email",e.email),a.append("password",e.password),a.append("agree",e.agree?"1":"0"),{success:!0,message:"Registration successful. Please check your email to confirm.",data:(await t.post(s,a,{headers:{"Content-Type":"application/x-www-form-urlencoded"}})).data}}catch(s){throw this.handleError(s)}}async resetPassword(e){try{const s=`${this.baseURL}/reset.asp`,a=new URLSearchParams;return e.database&&a.append("db",e.database),a.append("login",e.login),{success:!0,message:"Password reset email sent. Please check your inbox.",data:(await t.post(s,a,{headers:{"Content-Type":"application/x-www-form-urlencoded"}})).data}}catch(s){throw this.handleError(s)}}async handleGoogleOAuthCallback(e,s="my"){try{const a=`${this.baseURL}/auth.asp`,r=new URLSearchParams;r.append("code",e),s&&r.append("state",s);const i=await t.get(`${a}?${r.toString()}`);if(i.data.success||i.data.token){const t=i.data;return this.database=s,this.token=t.token,this.xsrfToken=t.xsrf||t.token,this.userId=t.userId,this.userName=t.userName||t.email,this.userRole=t.userRole,this.authDatabase=s,this.saveSession(),{success:!0,token:this.token,xsrf:this.xsrfToken,userId:this.userId,userName:this.userName,userRole:this.userRole}}throw new Error("OAuth authentication failed")}catch(a){throw this.handleError(a)}}async setObjectOrder(t,e){if(!Number.isInteger(e)||e<1)throw new Error("Invalid order: must be a positive integer");return this.post(`_m_ord/${t}`,{order:e})}async setObjectId(t,e){if(!Number.isInteger(e)||e<1)throw new Error("Invalid new_id: must be a positive integer");return this.post(`_m_id/${t}`,{new_id:e})}async setRequisiteOrder(t,e){if(!Number.isInteger(e)||e<1)throw new Error("Invalid order: must be a positive integer");return this.post(`_d_ord/${t}`,{order:e})}async getObjectMeta(t){return this.get(`obj_meta/${t}`)}async getReferences(t){return this.get(`_references/${t}`)}async getTerms(){return this.get("terms")}async authenticateJWT(e){try{const s=this.buildURL("jwt"),a=new URLSearchParams;a.append("jwt",e);const r=await t.post(s,a,{params:{JSON_KV:""},headers:{"Content-Type":"application/x-www-form-urlencoded"}});if(r.data.error)throw new Error(r.data.error);return r.data.token&&(this.token=r.data.token,this.xsrfToken=r.data._xsrf||r.data.xsrf,this.userId=r.data.id||r.data.userId,this.userName=r.data.user||r.data.userName,this.userRole=r.data.role,this.authDatabase=this.database,this.saveSession()),{success:!0,token:this.token,xsrf:this.xsrfToken,userId:this.userId,userName:this.userName,userRole:this.userRole}}catch(s){throw this.handleError(s)}}async getOTPCode(e){try{const s=this.buildURL("getcode"),a=new URLSearchParams;return a.append("u",e),a.append("tzone",Date.now()),(await t.post(s,a,{params:{JSON_KV:""},headers:{"Content-Type":"application/x-www-form-urlencoded"}})).data}catch(s){throw this.handleError(s)}}async checkOTPCode(e,s){try{if(!s||4!==s.length)throw new Error("OTP code must be exactly 4 characters");const a=this.buildURL("checkcode"),r=new URLSearchParams;r.append("u",e),r.append("c",s.toLowerCase());const i=await t.post(a,r,{params:{JSON_KV:""},headers:{"Content-Type":"application/x-www-form-urlencoded"}});if(i.data.error)throw new Error(i.data.error);return i.data.token&&(this.token=i.data.token,this.xsrfToken=i.data._xsrf,this.userName=e,this.authDatabase=this.database,this.saveSession()),{success:!0,token:i.data.token,xsrf:i.data._xsrf}}catch(a){throw this.handleError(a)}}async confirmRegistration(e,s,a){try{const r=this.buildURL("confirm");return{success:!0,data:(await t.get(r,{params:{JSON_KV:"",u:e,o:s,p:a}})).data}}catch(r){throw this.handleError(r)}}async createDatabase(t,e="ru",s=""){try{if(!/^[a-z][a-z0-9]{2,14}$/i.test(t))throw new Error("Недопустимое имя базы (3-15 латинских букв и цифр, начиная с буквы)");const a=this.database;this.database="my";try{return await this.post("_new_db",{db:t.toLowerCase(),template:e.toLowerCase(),descr:s})}finally{this.database=a}}catch(a){throw this.handleError(a)}}async connect(t){return this.post("_connect",t)}async exit(){try{await this.post("exit")}catch(t){}finally{this.logout()}}async getAllTypesMetadata(){return this.get("metadata")}async getAllObjects(t,e=100,s=50){let a=[],r={},i=1,n=!0,o=null;const u=new Set;for(;n&&i<=s;){const s=await this.get(`object/${t}`,{LIMIT:e,pg:i});1===i&&(o=s.type);const h=s.object||[];if(0===h.length)n=!1;else{for(const t of h){const e=t.id||t.ID;e&&!u.has(e)&&(u.add(e),a.push(t))}if(s.reqs)for(const[t,e]of Object.entries(s.reqs))u.has(t)&&!r[t]&&(r[t]=e);h.length<e&&(n=!1)}i++}return{type:o,totalCount:a.length,pagesLoaded:i-1,object:a,reqs:r}}async getObjectCount(t){const e=await this.get(`object/${t}`,{_count:""});return{typeId:t,count:parseInt(e.count,10)||0}}async createTableWithColumns(t,e=[],s=3,a=!1){const r=await this.createType(t,s,a),i=r.obj||r.id;if(!i)throw new Error(`Failed to create table: ${JSON.stringify(r)}`);const n=[];for(const o of e){const t=(await this.addRequisite(i,o.requisiteTypeId)).id;t&&(await this.saveRequisiteAlias(t,o.alias),!1===o.allowNull&&await this.toggleRequisiteNull(t),!0===o.multiSelect&&await this.toggleRequisiteMulti(t),n.push({requisiteId:t,alias:o.alias,requisiteTypeId:o.requisiteTypeId}))}return{typeId:i,tableName:t,columns:n}}async deleteTableCascade(t,e=!1){if(!e)throw new Error("Confirmation required: set confirm=true to delete");const s=await this.getObjectList(t,{LIMIT:1e3});for(const a of s.object||[])await this.deleteObject(a.id||a.ID);return this.deleteType(t)}async getTableStructure(t){const[e,s]=await Promise.all([this.getTypeMetadata(t),this.getObjectCount(t)]);return{type:e.type||e,columns:e.reqs||[],objectCount:s.count}}async cloneTableStructure(t,e,s=3){const a=((await this.getTypeMetadata(t)).reqs||[]).map(t=>({requisiteTypeId:t.requisite_type_id||t.t,alias:t.alias||t.val}));return this.createTableWithColumns(e,a,s)}async renameTable(t,e){var s;const a=(null==(s=(await this.getTypeMetadata(t)).type)?void 0:s.t)||3;return this.saveType(t,e,a)}async addColumnsToTable(t,e=[]){const s=[];for(const a of e){const e=(await this.addRequisite(t,a.requisiteTypeId)).id;e&&(await this.saveRequisiteAlias(e,a.alias),!1===a.allowNull&&await this.toggleRequisiteNull(e),!0===a.multiSelect&&await this.toggleRequisiteMulti(e),s.push({requisiteId:e,alias:a.alias}))}return{typeId:t,columns:s}}async createLookupTable(t,e=[],s=!0){const a=await this.createType(t,3,s),r=a.obj||a.id,i=[];for(const n of e){const t=await this.createObject(r,n);t.id&&i.push({id:t.id,value:n})}return{typeId:r,tableName:t,objects:i}}async createLookupWithReference(t,e,s,a=[],r=!1){const i=await this.createLookupTable(e,a),n=(await this.addRequisite(t,i.typeId)).id;return n&&(await this.saveRequisiteAlias(n,s||e),r&&await this.toggleRequisiteMulti(n)),{lookupTypeId:i.typeId,lookupObjects:i.objects,referenceColumn:{requisiteId:n,alias:s||e}}}async createObjectsBatch(t,e=[],a=null){const r=[];for(const i of e){const e={};for(const[t,a]of Object.entries(i.requisites||{}))e[t]=s(a);const n=await this.createObject(t,i.value,e,a);n.id&&r.push({id:n.id,value:i.value})}return{typeId:t,created:r}}async createParentWithChildren(t,e,a={},r,i=[]){const n={};for(const[h,d]of Object.entries(a))n[h]=s(d);const o=(await this.createObject(t,e,n)).id;if(!o)throw new Error("Failed to create parent object");const u=[];for(const h of i){const t={};for(const[a,r]of Object.entries(h.requisites||{}))t[a]=s(r);const e=await this.createObject(r,h.value,t,o);e.id&&u.push({id:e.id,value:h.value})}return{parent:{id:o,value:e},children:u}}async renameRequisite(t,e,s){return this.post(`_d_save/${t}`,{val:e,t:s})}async getSchema(t=null,e=!1){var s;const a=await this.getDictionary(),r=a.type||a.types||[],i=[1,6,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,42,44],n={2:"LONG",3:"SHORT",4:"DATETIME",7:"BOOL",8:"CHARS",9:"DATE",10:"FILE",13:"NUMBER"},o=[];for(const u of r){const a=u.id||u.ID;if(!e&&i.includes(a))continue;if(t&&!(null==(s=u.val)?void 0:s.toLowerCase().includes(t.toLowerCase())))continue;const r=((await this.getTypeMetadata(a)).reqs||[]).map(t=>{const e={id:t.id,name:t.alias||t.val,type:n[t.requisite_type_id]||"REF"};return n[t.requisite_type_id]||(e.ref=t.requisite_type_id),e});o.push({id:a,name:u.val,fields:r})}return o}};export{a as i};
