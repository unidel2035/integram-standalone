import{D as e,aq as l,r as a,N as t,J as i,K as o,L as u,P as n,U as s,c as d,A as r,w as c,y as v,u as p,o as m,b as y,f,t as b,a as g,F as h,d as w,g as k,h as x,V,C as _,j as I,G as j}from"./index-CaUq7SZf.js";import{u as q}from"./useIntegramSession-Cxdp2JJh.js";import{u as T}from"./useGrants-vN-kUvJ5.js";import{i as C}from"./integramApiClient-BsYdo77J.js";import{I as E}from"./IntegramBreadcrumb-DtRSJ3Ex.js";import{_ as U}from"./_plugin-vue_export-helper-BCo6x5W8.js";import"./index-CcrxTH1M.js";import"./unifiedAuthService-6fZILgG8.js";const $={class:"integram-object-view-container"},N={class:"flex align-items-center justify-content-between"},D={class:"flex gap-2 align-items-center ml-auto"},O={key:0,class:"extra-controls-panel mt-2 p-2 surface-50 border-round flex gap-2 flex-wrap"},A={key:0,class:"text-center py-5"},B={key:1,class:"text-center py-5"},S={key:0,class:"filter-panel mb-3 p-3 border-round surface-50"},L={class:"grid"},M={class:"col-12 md:col-3"},R={class:"text-sm mb-2 block"},K={class:"text-color-secondary text-sm"},z=["onClick"],F=["onClick"],G={class:"flex align-items-center gap-2"},X={key:1},H={class:"flex gap-1 justify-content-end action-buttons"},P={key:1,class:"mt-3 text-center py-3"},W={key:2,class:"mt-3 text-center text-color-secondary text-sm py-2"},J={key:3,class:"mt-3 flex align-items-center justify-content-between flex-wrap gap-3"},Q={class:"text-color-secondary text-sm"},Y={key:0},Z={class:"flex gap-2 align-items-center"},ee={class:"text-sm"},le={class:"mt-3 text-color-secondary text-sm"},ae={key:0},te={key:1},ie={class:"flex flex-column gap-3"},oe={class:"field"},ue={key:0,class:"field"},ne={class:"p-inputgroup"},se={key:0,class:"text-green-500"},de={key:1,class:"text-orange-500"},re=["for"],ce={class:"flex align-items-center gap-2"},ve={class:"p-3"},pe={class:"mt-2"},me={key:0,class:"mb-3 p-2 surface-100 border-round"},ye={class:"text-sm text-color-secondary"},fe={key:0},be={key:1,class:"mb-3 p-2 surface-100 border-round"},ge={key:0,class:"text-center py-4"},he={key:1,class:"text-center py-4"},we={key:2},ke={class:"text-color-secondary"},xe={class:"flex flex-column gap-3 p-2"},Ve={class:"field"},_e={class:"field"},Ie={class:"field flex align-items-center gap-2"},je={key:0,class:"field flex align-items-center gap-2 ml-4"},qe=U({__name:"IntegramObjectView",setup(U){const qe=t(),Te=u(),Ce=e(),Ee=l(),{isAuthenticated:Ue}=q(),{grantOptions:$e,loading:Ne,formatGrantValue:De,getGrantSeverity:Oe,getGrantIcon:Ae,getGrantWarning:Be}=T(),Se=a(qe.params.typeId),Le=i(()=>qe.params.database||C.getDatabase()||""),Me=a(!1),Re=a(null),Ke=a(!1),ze=a(!1),Fe=a(!1),Ge=a(!1),Xe=a(!1),He=a(!1),Pe=a(!1),We=a(""),Je=a(!1),Qe=a(null),Ye=a(!1),Ze=a(!1),el=a([]),ll=a(!1),al=a(null),tl=a(!1),il=a(!1),ol=a({name:"",baseTypeId:3,isDictionary:!1,isMultiSelect:!1}),ul=[{id:3,name:"Текст (SHORT)"},{id:2,name:"Длинный текст (LONG)"},{id:13,name:"Число (NUMBER)"},{id:4,name:"Дата и время (DATETIME)"},{id:9,name:"Дата (DATE)"},{id:7,name:"Да/Нет (BOOL)"}],nl=a(null),sl=a(null),dl=a(null),rl=a(null),cl=a([]),vl=a([]),pl=a({}),ml=a({}),yl=a(!1),fl=a("normal"),bl=[{label:"Обычный",value:"normal"},{label:"Компактный",value:"compact"},{label:"Фикс. высота",value:"fixed"},{label:"Фикс. ширина",value:"ultra"}],gl=a(25),hl=a(1),wl=a(1),kl=a(0),xl=a(!1),Vl=a(!1),_l=a(!0),Il=a(null),jl=a({val:""}),ql=a({value:"",up:"",requisites:{}}),Tl=i(()=>{var e;return[{label:"Таблицы",to:`/integram/${Le.value}/table`,icon:"pi pi-table"},{label:(null==(e=rl.value)?void 0:e.val)||"Объекты",icon:"pi pi-bars"}]}),Cl=i(()=>Object.values(jl.value).some(e=>e&&e.length>0)),El=i(()=>ol.value.name.trim().length>0&&ol.value.baseTypeId),Ul=i(()=>Cl.value?vl.value.filter(e=>{if(jl.value.val&&!e.val.toLowerCase().includes(jl.value.val.toLowerCase()))return!1;for(const l in jl.value)if(l.startsWith("req_")&&jl.value[l]){const a=l.replace("req_",""),t=Nl(e.id,a);if(!t||!t.toLowerCase().includes(jl.value[l].toLowerCase()))return!1}return!0}):vl.value);async function $l(e=1,l=!1){if(Ue.value)try{l||(Me.value=!0),Re.value=null;const a={pg:e,LIMIT:gl.value,...qe.query};a.pg===e&&(delete a.pg,a.pg=e);const t=await C.getObjectList(Se.value,a);if(dl.value=t,rl.value=t.type,l&&xl.value){const e=t.object||[];if(0===e.length)_l.value=!1;else{vl.value=[...vl.value,...e];const l=t.reqs||{};pl.value={...pl.value,...l},e.length<gl.value&&(_l.value=!1)}}else vl.value=t.object||[],pl.value=t.reqs||{},_l.value=(t.object||[]).length>=gl.value;void 0!==t.current_page&&(hl.value=t.current_page),void 0!==t.total_objects?kl.value=t.total_objects:(t.object||[]).length>=gl.value?kl.value=2*(t.object||[]).length:kl.value=(t.object||[]).length,void 0!==t.total_pages?wl.value=t.total_pages:gl.value>0&&kl.value>0?wl.value=Math.ceil(kl.value/gl.value):(t.object||[]).length>=gl.value?wl.value=e+1:wl.value=e,t.req_type&&t.req_order&&(cl.value=t.req_order.map(e=>{var l,a,i,o,u;return{id:e,val:t.req_type[e]||`Req ${e}`,base:(null==(l=t.req_base)?void 0:l[e])||"TEXT",baseId:null==(a=t.req_base_id)?void 0:a[e],refType:(null==(i=t.ref_type)?void 0:i[e])||null,isMulti:(null==(u=null==(o=t.req_attrs)?void 0:o[e])?void 0:u.includes(":MULTI:"))||!1}}))}catch(a){Re.value=a.message,Ce.add({severity:"error",summary:"Ошибка",detail:"Не удалось загрузить объекты: "+a.message,life:5e3})}finally{Me.value=!1}else Te.replace("/integram/login")}function Nl(e,l){var a;return(null==(a=pl.value[e])?void 0:a[l])||""}function Dl(){jl.value={val:""}}function Ol(){He.value=!He.value,He.value||Gl()}function Al(){Xe.value=!Xe.value}function Bl(){}function Sl(){xl.value=!xl.value,xl.value?(hl.value=1,_l.value=!0,$l(1,!1),window.addEventListener("scroll",Ll)):(window.removeEventListener("scroll",Ll),$l(hl.value,!1))}function Ll(){if(!xl.value||Vl.value||!_l.value)return;const e=window.scrollY||document.documentElement.scrollTop,l=window.innerHeight;document.documentElement.scrollHeight-e-l<200&&async function(){if(Vl.value||!_l.value)return;Vl.value=!0;const e=hl.value+1;try{await $l(e,!0),hl.value=e}catch(l){}finally{Vl.value=!1}}()}function Ml(){Fe.value=!0}function Rl(e){}function Kl(e){e<1||e===hl.value||(hl.value=e,Te.push({path:qe.path,query:{...qe.query,pg:e}}),$l(e))}function zl(){hl.value=1,Te.push({path:qe.path,query:{...qe.query,pg:1,limit:gl.value}}),$l(1)}async function Fl(e,l,a,t,i=null){var o;if(He.value&&"id"!==l)if(nl.value={rowId:e.id,field:l,baseType:t,req:i},null==i?void 0:i.refType){await async function(e){if(e&&!ml.value[e])try{yl.value=!0;const l=await C.getObjectList(e,{LIMIT:500});ml.value[e]=(l.object||[]).map(e=>({id:e.id,val:e.val,label:e.val,value:e.id}))}catch(l){ml.value[e]=[]}finally{yl.value=!1}}(i.refType);const l=e.id,a=i.id,t=null==(o=pl.value[l])?void 0:o[a];sl.value=t||""}else sl.value="BOOLEAN"===t?"X"===a:"DATE"===t||"DATETIME"===t?a?new Date(a):null:"NUMBER"===t||"SIGNED"===t?a?parseFloat(a):null:a||""}function Gl(){nl.value=null,sl.value=null}async function Xl(e,l=null){if(nl.value)try{ze.value=!0;let a=sl.value;if("BOOLEAN"===nl.value.baseType?a=sl.value?"X":"":"DATE"===nl.value.baseType?a=sl.value?new Date(sl.value).toISOString().split("T")[0]:"":"DATETIME"===nl.value.baseType&&(a=sl.value?new Date(sl.value).toISOString():""),"val"===nl.value.field){const l=pl.value[e.id]||{};await C.saveObject(e.id,Se.value,a,l);const t=vl.value.findIndex(l=>l.id===e.id);-1!==t&&(vl.value[t].val=a)}else if(l){const t={};t[l]=a,await C.setObjectRequisites(e.id,t),pl.value[e.id]||(pl.value[e.id]={}),pl.value[e.id][l]=a}Ce.add({severity:"success",summary:"Успешно",detail:"Ячейка обновлена",life:2e3}),Gl()}catch(a){Ce.add({severity:"error",summary:"Ошибка",detail:"Не удалось обновить: "+a.message,life:5e3})}finally{ze.value=!1}}function Hl(){var e;if(!Ul.value||0===Ul.value.length)return void Ce.add({severity:"warn",summary:"Нет данных",detail:"Нет данных для экспорта",life:3e3});const l=["ID","Значение"];cl.value.forEach(e=>{l.push(e.val||`Реквизит ${e.id}`)});const a=Ul.value.map(e=>{const l=[e.id,e.val];return cl.value.forEach(a=>{var t;const i=(null==(t=e.reqs)?void 0:t[a.id])||"";l.push("string"==typeof i?i.replace(/"/g,'""'):i)}),l}),t=[l.map(e=>`"${e}"`).join(","),...a.map(e=>e.map(e=>`"${e}"`).join(","))].join("\n"),i=new Blob(["\ufeff"+t],{type:"text/csv;charset=utf-8;"}),o=document.createElement("a");o.href=URL.createObjectURL(i),o.download=`${(null==(e=rl.value)?void 0:e.val)||"export"}_${(new Date).toISOString().slice(0,10)}.csv`,o.click(),Ce.add({severity:"success",summary:"Экспорт завершён",detail:`Экспортировано ${Ul.value.length} записей`,life:3e3})}function Pl(){var e,l;if(!Ul.value||0===Ul.value.length)return void Ce.add({severity:"warn",summary:"Нет данных",detail:"Нет данных для экспорта",life:3e3});const a=[];a.push(`0:${(null==(e=rl.value)?void 0:e.val)||"Значение"}:3:`),cl.value.forEach(e=>{const l=e.val||`Req${e.id}`,t=e.baseId||"3",i=e.refType||"";a.push(`${e.id}:${l}:${t}:${i}`)});let t="";t+=a.join(";")+"\r\n",t+="DATA\r\n",Ul.value.forEach(e=>{const l=[];l.push(`${Se.value}::${Wl(e.val)}`),cl.value.forEach(a=>{const t=Nl(e.id,a.id);l.push(Wl(t))}),t+=l.join(";")+"\r\n"});const i=new Blob([t],{type:"application/octet-stream"}),o=document.createElement("a");o.href=URL.createObjectURL(i),o.download=`${(null==(l=rl.value)?void 0:l.val)||"export"}_${(new Date).toISOString().slice(0,10)}.bki`,o.click(),Ce.add({severity:"success",summary:"Экспорт BKI завершён",detail:`Экспортировано ${Ul.value.length} записей`,life:3e3})}function Wl(e){if(null==e)return"";let l=String(e);return l=l.replace(/[\r\n]+/g," "),l=l.replace(/;/g,","),l}function Jl(){Qe.value&&Qe.value.click()}async function Ql(e){var l;const a=null==(l=e.target.files)?void 0:l[0];if(a){e.target.value="";try{Ye.value=!0;const e=await function(e){return new Promise((l,a)=>{const t=new FileReader;t.onload=e=>l(e.target.result),t.onerror=()=>a(new Error("Не удалось прочитать файл")),t.readAsText(e)})}(a);await async function(e){const l=e.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(e=>e.trim());if(l.length<2)throw new Error("BKI файл пуст или имеет неверный формат");const a=l.findIndex(e=>"DATA"===e.trim().toUpperCase());if(-1===a)throw new Error("Не найден маркер DATA в BKI файле");const t=l.slice(0,a),i=function(e){const l=e.split(";"),a=[];for(const t of l){const e=t.split(":");e.length>=2&&a.push({id:e[0],alias:e[1],baseId:e[2]||"3",refType:e[3]||""})}return a}(t[t.length-1]),o=l.slice(a+1);if(0===o.length)throw new Error("Нет данных для импорта");const u=function(e){const l={};for(let a=1;a<e.length;a++){const t=e[a],i=cl.value.find(e=>e.val.toLowerCase()===t.alias.toLowerCase());i&&(l[a]=i.id)}return l}(i);let n=0,s=0;for(const r of o)if(r.trim())try{await Yl(r,u),n++}catch(d){s++}await $l(hl.value),s>0?Ce.add({severity:"warn",summary:"Импорт завершён с ошибками",detail:`Импортировано: ${n}, ошибок: ${s}`,life:5e3}):Ce.add({severity:"success",summary:"Импорт BKI завершён",detail:`Импортировано ${n} записей`,life:3e3})}(e)}catch(t){Ce.add({severity:"error",summary:"Ошибка импорта",detail:t.message||"Не удалось импортировать BKI файл",life:5e3})}finally{Ye.value=!1}}}async function Yl(e,l){const a=e.split(";");if(0===a.length)return;const t=a[0].split("::"),i=t.length>1?t[1]:t[0];if(!i||!i.trim())throw new Error("Пустое значение");const o={};for(let n=1;n<a.length;n++){const e=l[n];e&&a[n]&&(o[e]=a[n])}const u=qe.query.F_U||null;await C.createObject(Se.value,i,o,u)}async function Zl(){if("УДАЛИТЬ"!==We.value)return;const e=Ul.value;if(0!==e.length){Je.value=!0;try{let a=0,t=0;for(const i of e)try{await C.deleteObject(i.id),a++}catch(l){t++}Pe.value=!1,We.value="",t>0?Ce.add({severity:"warn",summary:"Удаление завершено с ошибками",detail:`Удалено: ${a}, ошибок: ${t}`,life:5e3}):Ce.add({severity:"success",summary:"Удаление завершено",detail:`Удалено ${a} объектов`,life:3e3}),await $l(1)}catch(a){Ce.add({severity:"error",summary:"Ошибка удаления",detail:a.message||"Произошла ошибка при удалении",life:5e3})}finally{Je.value=!1}}else Ce.add({severity:"warn",summary:"Нет объектов",detail:"Нет объектов для удаления",life:3e3})}async function ea(){var e;try{Ke.value=!0;const l=qe.query.F_U||null;if("0"!==(null==(e=rl.value)?void 0:e.up)&&!l)return void Ce.add({severity:"error",summary:"Ошибка",detail:"Для создания записи в подчинённой таблице откройте её из родительской записи",life:5e3});const a={};Object.keys(ql.value.requisites).length>0&&Object.keys(ql.value.requisites).forEach(e=>{const l=ql.value.requisites[e];if(null!=l&&""!==l){const t=cl.value.find(l=>l.id===e);t&&("BOOLEAN"===t.base?a[e]=l?"X":"":"DATE"===t.base||"DATETIME"===t.base?l instanceof Date&&(a[e]="DATE"===t.base?l.toISOString().split("T")[0]:l.toISOString()):a[e]=l)}});const t=await C.createObject(Se.value,ql.value.value,a,l);Ce.add({severity:"success",summary:"Успешно",detail:"Объект создан!",life:3e3}),Fe.value=!1,ql.value={value:"",up:"",requisites:{}},await $l(),t.id&&Te.push(`/integram/${Le.value}/edit_obj/${t.id}`)}catch(l){Ce.add({severity:"error",summary:"Ошибка",detail:"Не удалось создать объект: "+l.message,life:5e3})}finally{Ke.value=!1}}function la(){ol.value={name:"",baseTypeId:3,isDictionary:!1,isMultiSelect:!1}}function aa(){}async function ta(){if(El.value){il.value=!0;try{const e=ol.value.name.trim();let l=null;if(ol.value.isDictionary){const a=await C.createType(e,3,!0),t=a.obj||a.id;if(!t)throw new Error("Не удалось создать справочник");await C.createTypeReference(t),l=(await C.addRequisite(Se.value,t)).id,ol.value.isMultiSelect&&l&&await C.toggleRequisiteMulti(l),Ce.add({severity:"success",summary:"Колонка добавлена",detail:`Создан справочник "${e}" и добавлен как колонка`,life:3e3})}else l=(await C.addRequisite(Se.value,ol.value.baseTypeId)).id,l&&await C.saveRequisiteAlias(l,e),Ce.add({severity:"success",summary:"Колонка добавлена",detail:`Колонка "${e}" успешно добавлена`,life:3e3});tl.value=!1,la(),await $l()}catch(e){Ce.add({severity:"error",summary:"Ошибка",detail:"Не удалось добавить колонку: "+(e.message||"Неизвестная ошибка"),life:5e3})}finally{il.value=!1}}}return o(async()=>{if(!Ue.value)return void Te.replace("/integram/login");const e=parseInt(qe.query.pg)||1,l=parseInt(qe.query.LIMIT||qe.query.limit)||25;hl.value=e,gl.value=l,await $l(e)}),n(()=>{window.removeEventListener("scroll",Ll)}),s(()=>qe.params.typeId,async e=>{e&&e!==Se.value&&(Se.value=e,await $l())}),(e,l)=>{var a,t;const i=v("Button"),o=v("Dropdown"),u=v("ProgressSpinner"),n=v("Message"),s=v("InputText"),q=v("Column"),T=v("router-link"),U=v("InputNumber"),Ue=v("Checkbox"),Se=v("Calendar"),ze=v("Textarea"),Ye=v("Badge"),pl=v("DataTable"),Ll=v("Card"),Wl=v("Divider"),Yl=v("Dialog"),ia=p("tooltip");return m(),d("div",$,[r(E,{items:Tl.value},null,8,["items"]),r(Ll,null,{title:c(()=>{var e;return[g("div",N,[g("span",null,b((null==(e=rl.value)?void 0:e.val)||"Загрузка..."),1),g("div",D,[I(r(i,{icon:"pi pi-plus",label:"Добавить",size:"small",onClick:Ml,disabled:Me.value},null,8,["disabled"]),[[ia,"Добавить запись в таблицу",void 0,{bottom:!0}]]),I(r(i,{icon:"pi pi-filter",size:"small",outlined:"",onClick:l[0]||(l[0]=e=>Ge.value=!Ge.value)},null,512),[[ia,"Показать/скрыть фильтры",void 0,{bottom:!0}]]),Cl.value?I((m(),x(i,{key:0,icon:"pi pi-filter-slash",size:"small",outlined:"",onClick:Dl},null,512)),[[ia,"Очистить фильтры",void 0,{bottom:!0}]]):y("",!0),I(r(i,{icon:"pi pi-refresh",size:"small",outlined:"",onClick:$l,loading:Me.value},null,8,["loading"]),[[ia,"Обновить",void 0,{bottom:!0}]]),I(r(i,{icon:"pi pi-pencil",size:"small",outlined:"",onClick:Ol,class:k({"button-on":He.value})},null,8,["class"]),[[ia,"Редактировать ячейки",void 0,{bottom:!0}]]),r(o,{modelValue:fl.value,"onUpdate:modelValue":l[1]||(l[1]=e=>fl.value=e),options:bl,optionLabel:"label",optionValue:"value",placeholder:"Режим",size:"small",onChange:Bl},null,8,["modelValue"]),I(r(i,{icon:xl.value?"pi pi-arrows-v":"pi pi-list",size:"small",outlined:!xl.value,onClick:Sl,class:k({"button-on":xl.value})},null,8,["icon","outlined","class"]),[[ia,xl.value?"Infinite Scroll (вкл)":"Обычная пагинация",void 0,{bottom:!0}]]),I(r(i,{icon:"pi pi-ellipsis-h",size:"small",text:"",onClick:Al},null,512),[[ia,"Ещё",void 0,{bottom:!0}]])])]),Xe.value?(m(),d("div",O,[I(r(i,{label:"Скачать CSV",icon:"pi pi-file-export",size:"small",outlined:"",onClick:Hl},null,512),[[ia,"Скачать данные в формате CSV",void 0,{bottom:!0}]]),I(r(i,{label:"Экспорт BKI",icon:"pi pi-download",size:"small",outlined:"",onClick:Pl},null,512),[[ia,"Экспортировать в BKI формат",void 0,{bottom:!0}]]),I(r(i,{label:"Импорт BKI",icon:"pi pi-upload",size:"small",outlined:"",onClick:Jl},null,512),[[ia,"Импортировать из BKI файла",void 0,{bottom:!0}]]),g("input",{ref_key:"bkiFileInput",ref:Qe,type:"file",accept:".bki",style:{display:"none"},onChange:Ql},null,544),I(r(i,{label:"Удалить по фильтру",icon:"pi pi-trash",size:"small",outlined:"",severity:"danger",onClick:l[2]||(l[2]=e=>Pe.value=!0),disabled:0===Ul.value.length},null,8,["disabled"]),[[ia,"Удалить все записи, соответствующие текущему фильтру",void 0,{bottom:!0}]]),I(r(i,{label:"Добавить колонку",icon:"pi pi-plus-circle",size:"small",outlined:"",onClick:l[3]||(l[3]=e=>tl.value=!0)},null,512),[[ia,"Добавить новую колонку в таблицу",void 0,{bottom:!0}]])])):y("",!0)]}),content:c(()=>[Me.value&&!dl.value?(m(),d("div",A,[r(u)])):Re.value?(m(),d("div",B,[r(n,{severity:"error",closable:!1},{default:c(()=>[f(b(Re.value),1)]),_:1})])):dl.value?(m(),d("div",{key:2,ref_key:"tableWrapperRef",ref:Il,class:"table-wrapper"},[Ge.value&&cl.value.length>0?(m(),d("div",S,[g("div",L,[g("div",M,[l[32]||(l[32]=g("label",{class:"text-sm mb-2 block"},"Значение",-1)),r(s,{modelValue:jl.value.val,"onUpdate:modelValue":l[4]||(l[4]=e=>jl.value.val=e),placeholder:"Фильтр по значению",class:"w-full",size:"small"},null,8,["modelValue"])]),(m(!0),d(h,null,w(cl.value,e=>(m(),d("div",{key:e.id,class:"col-12 md:col-3"},[g("label",R,b(e.val),1),r(s,{modelValue:jl.value[`req_${e.id}`],"onUpdate:modelValue":l=>jl.value[`req_${e.id}`]=l,placeholder:`Filter by ${e.val}`,class:"w-full",size:"small"},null,8,["modelValue","onUpdate:modelValue","placeholder"])]))),128))])])):y("",!0),r(pl,{value:Ul.value,paginator:!1,sortMode:"multiple",removableSort:"",stripedRows:"",class:k(["integram-table",`mode-${fl.value}`]),tableStyle:"min-width: 50rem",onRowClick:Rl},{empty:c(()=>[...l[33]||(l[33]=[g("div",{class:"text-center py-4"},[g("i",{class:"pi pi-inbox text-4xl text-color-secondary mb-2"}),g("p",{class:"text-color-secondary"},"Объекты не найдены")],-1)])]),default:c(()=>{var e;return[r(q,{field:"ord",header:"N",style:{width:"60px","text-align":"center"},headerStyle:"text-align: center",sortable:""},{body:c(e=>[g("span",K,b(e.index+1),1)]),_:1}),r(q,{field:"val",header:(null==(e=rl.value)?void 0:e.val)||"Value",sortable:"",style:{"min-width":"200px"}},{body:c(e=>{var a,t,i,o;return[g("div",{class:k({"editable-cell":He.value,editing:(null==(a=nl.value)?void 0:a.rowId)===e.data.id&&"val"===(null==(t=nl.value)?void 0:t.field)}),onClick:l=>Fl(e.data,"val",e.data.val,"TEXT")},[(null==(i=nl.value)?void 0:i.rowId)===e.data.id&&"val"===(null==(o=nl.value)?void 0:o.field)?(m(),x(s,{key:0,modelValue:sl.value,"onUpdate:modelValue":l[5]||(l[5]=e=>sl.value=e),class:"inline-edit w-full",onBlur:l=>Xl(e.data),onKeydown:[V(l=>Xl(e.data),["enter"]),V(Gl,["esc"])],autofocus:""},null,8,["modelValue","onBlur","onKeydown"])):(m(),x(T,{key:1,to:`/integram/${Le.value}/edit_obj/${e.data.id}`,class:"value-link"},{default:c(()=>[f(b(e.data.val),1)]),_:2},1032,["to"]))],10,z)]}),_:1},8,["header"]),(m(!0),d(h,null,w(cl.value,e=>(m(),x(q,{key:e.id,field:`req_${e.id}`,header:e.val,sortable:""},{body:c(a=>{var t,i,u,n;return[g("div",{class:k({"editable-cell":He.value,editing:(null==(t=nl.value)?void 0:t.rowId)===a.data.id&&(null==(i=nl.value)?void 0:i.field)===`req_${e.id}`,"cell-dir":e.refType}),onClick:l=>Fl(a.data,`req_${e.id}`,Nl(a.data.id,e.id),e.base||"TEXT",e)},[(null==(u=nl.value)?void 0:u.rowId)===a.data.id&&(null==(n=nl.value)?void 0:n.field)===`req_${e.id}`?(m(),d(h,{key:0},["GRANT"===e.base||5===e.baseId?(m(),x(o,{key:0,modelValue:sl.value,"onUpdate:modelValue":l[6]||(l[6]=e=>sl.value=e),options:_($e),optionLabel:"label",optionValue:"value",placeholder:"Select grant...",class:"inline-edit w-full",loading:_(Ne),onChange:l=>Xl(a.data,e.id),onKeydown:V(Gl,["esc"]),filter:"",showClear:"",autofocus:""},{option:c(e=>[g("div",G,[g("i",{class:k(e.option.icon)},null,2),g("span",null,b(e.option.label),1)])]),_:2},1032,["modelValue","options","loading","onChange"])):e.refType?(m(),x(o,{key:1,modelValue:sl.value,"onUpdate:modelValue":l[7]||(l[7]=e=>sl.value=e),options:ml.value[e.refType]||[],optionLabel:"val",optionValue:"id",placeholder:"Select...",class:"inline-edit w-full",loading:yl.value,onChange:l=>Xl(a.data,e.id),onKeydown:V(Gl,["esc"]),filter:"",showClear:"",autofocus:""},null,8,["modelValue","options","loading","onChange"])):"NUMBER"===e.base||"SIGNED"===e.base?(m(),x(U,{key:2,modelValue:sl.value,"onUpdate:modelValue":l[8]||(l[8]=e=>sl.value=e),class:"inline-edit w-full",onBlur:l=>Xl(a.data,e.id),onKeydown:[V(l=>Xl(a.data,e.id),["enter"]),V(Gl,["esc"])],autofocus:""},null,8,["modelValue","onBlur","onKeydown"])):"BOOLEAN"===e.base?(m(),x(Ue,{key:3,modelValue:sl.value,"onUpdate:modelValue":l[9]||(l[9]=e=>sl.value=e),binary:"",onChange:l=>Xl(a.data,e.id)},null,8,["modelValue","onChange"])):"DATE"===e.base?(m(),x(Se,{key:4,modelValue:sl.value,"onUpdate:modelValue":l[10]||(l[10]=e=>sl.value=e),dateFormat:"yy-mm-dd",class:"inline-edit w-full",onBlur:l=>Xl(a.data,e.id),onKeydown:[V(l=>Xl(a.data,e.id),["enter"]),V(Gl,["esc"])],autofocus:""},null,8,["modelValue","onBlur","onKeydown"])):"DATETIME"===e.base?(m(),x(Se,{key:5,modelValue:sl.value,"onUpdate:modelValue":l[11]||(l[11]=e=>sl.value=e),showTime:"",dateFormat:"yy-mm-dd",class:"inline-edit w-full",onBlur:l=>Xl(a.data,e.id),onKeydown:[V(l=>Xl(a.data,e.id),["enter"]),V(Gl,["esc"])],autofocus:""},null,8,["modelValue","onBlur","onKeydown"])):"MEMO"===e.base?(m(),x(ze,{key:6,modelValue:sl.value,"onUpdate:modelValue":l[12]||(l[12]=e=>sl.value=e),class:"inline-edit w-full",rows:"3",onBlur:l=>Xl(a.data,e.id),onKeydown:V(Gl,["esc"]),autofocus:""},null,8,["modelValue","onBlur"])):(m(),x(s,{key:7,modelValue:sl.value,"onUpdate:modelValue":l[13]||(l[13]=e=>sl.value=e),class:"inline-edit w-full",onBlur:l=>Xl(a.data,e.id),onKeydown:[V(l=>Xl(a.data,e.id),["enter"]),V(Gl,["esc"])],autofocus:""},null,8,["modelValue","onBlur","onKeydown"]))],64)):(m(),d(h,{key:1},["GRANT"===e.base||5===e.baseId?I((m(),x(Ye,{key:0,value:_(De)(Nl(a.data.id,e.id)),severity:_(Oe)(Nl(a.data.id,e.id))},{default:c(()=>[g("i",{class:k([_(Ae)(Nl(a.data.id,e.id)),"mr-1"])},null,2),f(" "+b(_(De)(Nl(a.data.id,e.id))),1)]),_:2},1032,["value","severity"])),[[ia,_(Be)(Nl(a.data.id,e.id)),void 0,{top:!0}]]):"BOOLEAN"===e.base?(m(),d("span",X,b("X"===Nl(a.data.id,e.id)?"✓":""),1)):(m(),d("span",{key:2,class:k({dir:e.refType})},b(Nl(a.data.id,e.id)),3))],64))],10,F)]}),_:2},1032,["field","header"]))),128)),r(q,{header:"",style:{width:"160px"}},{body:c(e=>[g("div",H,[I(r(i,{icon:"pi pi-arrow-up",text:"",rounded:"",size:"small",severity:"secondary",onClick:j(l=>async function(e){try{await C.moveObjectUp(e),Ce.add({severity:"success",summary:"Объект перемещён",detail:"Объект успешно перемещён вверх",life:2e3}),await $l(hl.value)}catch(l){Ce.add({severity:"error",summary:"Ошибка перемещения",detail:l.message||"Не удалось переместить объект",life:5e3})}}(e.data.id),["stop"])},null,8,["onClick"]),[[ia,"Переместить вверх",void 0,{bottom:!0}]]),I(r(i,{icon:"pi pi-link",text:"",rounded:"",size:"small",severity:"secondary",onClick:j(l=>async function(e){var l,a;al.value=e,Ze.value=!0,ll.value=!0,el.value=[];try{const l=await C.getReferences(e.id);if(l&&l.references)el.value=l.references.map(e=>({typeId:e.type_id||e.typeId,typeName:e.type_name||e.typeName||`Тип ${e.type_id}`,objectId:e.object_id||e.objectId,objectName:e.object_name||e.objectName||`Объект ${e.object_id}`,fieldName:e.field_name||e.fieldName||e.requisite_alias||""}));else if(Array.isArray(l))el.value=l.map(e=>({typeId:e.type_id||e.typeId||e.t,typeName:e.type_name||e.typeName||e.type||`Тип ${e.type_id||e.t}`,objectId:e.object_id||e.objectId||e.id,objectName:e.object_name||e.objectName||e.val||`Объект ${e.object_id||e.id}`,fieldName:e.field_name||e.fieldName||e.requisite_alias||""}));else if(l&&"object"==typeof l){const e=l.refs||l.data||[];Array.isArray(e)&&(el.value=e.map(e=>({typeId:e.type_id||e.typeId||e.t,typeName:e.type_name||e.typeName||`Тип ${e.type_id}`,objectId:e.object_id||e.objectId||e.id,objectName:e.object_name||e.objectName||e.val,fieldName:e.field_name||e.fieldName||""})))}}catch(t){el.value=[],((null==(l=t.message)?void 0:l.includes("404"))||(null==(a=t.message)?void 0:a.includes("не найден")))&&Ce.add({severity:"info",summary:"Функция недоступна",detail:"API не поддерживает получение ссылок на объект",life:3e3})}finally{ll.value=!1}}(e.data),["stop"])},null,8,["onClick"]),[[ia,"Показать ссылки",void 0,{bottom:!0}]]),I(r(i,{icon:"pi pi-pencil",text:"",rounded:"",size:"small",onClick:j(l=>{return a=e.data.id,void Te.push(`/integram/${Le.value}/edit_obj/${a}`);var a},["stop"])},null,8,["onClick"]),[[ia,"Редактировать",void 0,{bottom:!0}]]),I(r(i,{icon:"pi pi-trash",text:"",rounded:"",size:"small",severity:"danger",onClick:j(l=>{return a=e.data,void Ee.require({message:`Вы уверены, что хотите удалить "${a.val}" (ID: ${a.id})?`,header:"Подтверждение удаления",icon:"pi pi-exclamation-triangle",acceptClass:"p-button-danger",accept:()=>{!async function(e){try{await C.deleteObject(e),Ce.add({severity:"success",summary:"Успешно",detail:"Объект удалён!",life:3e3}),await $l()}catch(l){Ce.add({severity:"error",summary:"Ошибка",detail:"Не удалось удалить объект: "+l.message,life:5e3})}}(a.id)}});var a},["stop"])},null,8,["onClick"]),[[ia,"Удалить",void 0,{bottom:!0}]])])]),_:1})]}),_:1},8,["value","class"]),xl.value&&Vl.value?(m(),d("div",P,[r(u,{style:{width:"30px",height:"30px"}}),l[34]||(l[34]=g("span",{class:"ml-2 text-color-secondary"},"Загрузка...",-1))])):y("",!0),xl.value&&!_l.value&&vl.value.length>0?(m(),d("div",W,[l[35]||(l[35]=g("i",{class:"pi pi-check-circle mr-2"},null,-1)),f("Все данные загружены ("+b(vl.value.length)+" записей) ",1)])):y("",!0),!xl.value&&(wl.value>1||vl.value.length>=gl.value)?(m(),d("div",J,[g("div",Q,[f(" Страница "+b(hl.value)+" из "+b(wl.value)+" ",1),kl.value?(m(),d("span",Y," ("+b(kl.value)+" объектов) ",1)):y("",!0)]),g("div",Z,[I(r(i,{icon:"pi pi-angle-left",size:"small",outlined:"",disabled:1===hl.value,onClick:l[14]||(l[14]=e=>Kl(hl.value-1))},null,8,["disabled"]),[[ia,"Предыдущая",void 0,{bottom:!0}]]),g("span",ee,b(hl.value),1),I(r(i,{icon:"pi pi-angle-right",size:"small",outlined:"",disabled:hl.value>=wl.value||vl.value.length<gl.value,onClick:l[15]||(l[15]=e=>Kl(hl.value+1))},null,8,["disabled"]),[[ia,"Следующая",void 0,{bottom:!0}]]),r(o,{modelValue:gl.value,"onUpdate:modelValue":l[16]||(l[16]=e=>gl.value=e),options:[10,20,25,50,100],onChange:zl,size:"small",class:"w-auto"},null,8,["modelValue"])])])):y("",!0),g("div",le,[f(" Показано "+b(Ul.value.length)+" объектов ",1),xl.value?(m(),d("span",ae," (infinite scroll)")):y("",!0),Cl.value?(m(),d("span",te," (фильтры применены) ")):y("",!0)])],512)):y("",!0)]),_:1}),r(Yl,{visible:Fe.value,"onUpdate:visible":l[19]||(l[19]=e=>Fe.value=e),modal:"",header:"Создать: "+((null==(a=rl.value)?void 0:a.val)||"Объект"),style:{width:"50rem"},breakpoints:{"960px":"75vw","640px":"95vw"}},{footer:c(()=>{var e;return[r(i,{label:"Отмена",text:"",onClick:l[18]||(l[18]=e=>Fe.value=!1)}),r(i,{label:"Создать",loading:Ke.value,onClick:ea,disabled:!ql.value.value||"0"!==(null==(e=rl.value)?void 0:e.up)&&!_(qe).query.F_U},null,8,["loading","disabled"])]}),default:c(()=>{var e;return[g("div",ie,[g("div",oe,[l[36]||(l[36]=g("label",{for:"objectValue"},"Значение *",-1)),r(s,{id:"objectValue",modelValue:ql.value.value,"onUpdate:modelValue":l[17]||(l[17]=e=>ql.value.value=e),placeholder:"Введите значение",class:"w-full"},null,8,["modelValue"])]),"0"!==(null==(e=rl.value)?void 0:e.up)?(m(),d("div",ue,[l[40]||(l[40]=g("label",null,"Родитель",-1)),g("div",ne,[l[37]||(l[37]=g("span",{class:"p-inputgroup-addon"},[g("i",{class:"pi pi-link"})],-1)),r(s,{value:_(qe).query.F_U||"Не указан",disabled:"",class:"w-full"},null,8,["value"])]),_(qe).query.F_U?(m(),d("small",se,[...l[38]||(l[38]=[g("i",{class:"pi pi-check"},null,-1),f(" Родитель определён автоматически из контекста ",-1)])])):(m(),d("small",de,[...l[39]||(l[39]=[g("i",{class:"pi pi-exclamation-triangle"},null,-1),f(" Откройте таблицу из родительской записи для создания подчинённых объектов ",-1)])]))])):y("",!0),cl.value.length>0?(m(),x(Wl,{key:1})):y("",!0),(m(!0),d(h,null,w(cl.value,e=>(m(),d("div",{key:e.id,class:"field"},[g("label",{for:"req_"+e.id},b(e.val),9,re),"GRANT"===e.base||5===e.baseId?(m(),x(o,{key:0,id:"req_"+e.id,modelValue:ql.value.requisites[e.id],"onUpdate:modelValue":l=>ql.value.requisites[e.id]=l,options:_($e),optionLabel:"label",optionValue:"value",placeholder:"Выберите "+e.val,class:"w-full",loading:_(Ne),filter:"",showClear:""},{option:c(e=>[g("div",ce,[g("i",{class:k(e.option.icon)},null,2),g("span",null,b(e.option.label),1)])]),_:1},8,["id","modelValue","onUpdate:modelValue","options","placeholder","loading"])):"NUMBER"===e.base||"SIGNED"===e.base?(m(),x(U,{key:1,id:"req_"+e.id,modelValue:ql.value.requisites[e.id],"onUpdate:modelValue":l=>ql.value.requisites[e.id]=l,placeholder:"Введите "+e.val,class:"w-full"},null,8,["id","modelValue","onUpdate:modelValue","placeholder"])):"BOOLEAN"===e.base?(m(),x(Ue,{key:2,id:"req_"+e.id,modelValue:ql.value.requisites[e.id],"onUpdate:modelValue":l=>ql.value.requisites[e.id]=l,binary:""},null,8,["id","modelValue","onUpdate:modelValue"])):"DATE"===e.base?(m(),x(Se,{key:3,id:"req_"+e.id,modelValue:ql.value.requisites[e.id],"onUpdate:modelValue":l=>ql.value.requisites[e.id]=l,dateFormat:"yy-mm-dd",class:"w-full"},null,8,["id","modelValue","onUpdate:modelValue"])):"DATETIME"===e.base?(m(),x(Se,{key:4,id:"req_"+e.id,modelValue:ql.value.requisites[e.id],"onUpdate:modelValue":l=>ql.value.requisites[e.id]=l,showTime:"",dateFormat:"yy-mm-dd",class:"w-full"},null,8,["id","modelValue","onUpdate:modelValue"])):"MEMO"===e.base?(m(),x(ze,{key:5,id:"req_"+e.id,modelValue:ql.value.requisites[e.id],"onUpdate:modelValue":l=>ql.value.requisites[e.id]=l,placeholder:"Введите "+e.val,class:"w-full",rows:"3"},null,8,["id","modelValue","onUpdate:modelValue","placeholder"])):(m(),x(s,{key:6,id:"req_"+e.id,modelValue:ql.value.requisites[e.id],"onUpdate:modelValue":l=>ql.value.requisites[e.id]=l,placeholder:"Введите "+e.val,class:"w-full"},null,8,["id","modelValue","onUpdate:modelValue","placeholder"]))]))),128))])]}),_:1},8,["visible","header"]),r(Yl,{visible:Pe.value,"onUpdate:visible":l[22]||(l[22]=e=>Pe.value=e),header:"Удаление по фильтру",style:{width:"450px"},modal:!0,onHide:l[23]||(l[23]=e=>We.value="")},{footer:c(()=>[r(i,{label:"Отмена",icon:"pi pi-times",onClick:l[21]||(l[21]=e=>Pe.value=!1),text:""}),r(i,{label:"Удалить",icon:"pi pi-trash",severity:"danger",onClick:Zl,disabled:"УДАЛИТЬ"!==We.value,loading:Je.value},null,8,["disabled","loading"])]),default:c(()=>[g("div",ve,[r(n,{severity:"warn",closable:!1,class:"mb-3"},{default:c(()=>[l[42]||(l[42]=g("p",{class:"font-bold mb-2"},"⚠️ Внимание!",-1)),l[43]||(l[43]=g("p",null,"Будут удалены все записи, соответствующие текущему фильтру.",-1)),g("p",pe,[l[41]||(l[41]=f("Количество записей для удаления: ",-1)),g("strong",null,b(Ul.value.length),1)])]),_:1}),Cl.value?(m(),d("div",me,[l[44]||(l[44]=g("p",{class:"text-sm font-medium mb-1"},"Активные фильтры:",-1)),g("p",ye,[jl.value.val?(m(),d("span",fe,'Значение: "'+b(jl.value.val)+'"',1)):y("",!0),e.key.startsWith("req_")&&e.value?(m(!0),d(h,{key:1},w(jl.value,(e,l)=>(m(),d("span",{key:l}," , "+b(function(e){const l=e.replace("req_",""),a=cl.value.find(e=>e.id===l);return(null==a?void 0:a.val)||l}(l))+': "'+b(e)+'" ',1))),128)):y("",!0)])])):(m(),d("div",be,[...l[45]||(l[45]=[g("p",{class:"text-sm text-orange-500 font-bold"},"⚠️ Фильтры не активны - будут удалены ВСЕ записи!",-1)])])),l[46]||(l[46]=g("p",{class:"mb-2"},[f("Для подтверждения введите "),g("strong",null,"УДАЛИТЬ"),f(":")],-1)),r(s,{modelValue:We.value,"onUpdate:modelValue":l[20]||(l[20]=e=>We.value=e),placeholder:"Введите УДАЛИТЬ",class:"w-full"},null,8,["modelValue"])])]),_:1},8,["visible"]),r(Yl,{visible:Ze.value,"onUpdate:visible":l[25]||(l[25]=e=>Ze.value=e),header:"Ссылки на: "+((null==(t=al.value)?void 0:t.val)||""),style:{width:"600px"},modal:!0},{footer:c(()=>[r(i,{label:"Закрыть",icon:"pi pi-times",onClick:l[24]||(l[24]=e=>Ze.value=!1),text:""})]),default:c(()=>[ll.value?(m(),d("div",ge,[r(u,{style:{width:"50px",height:"50px"}}),l[47]||(l[47]=g("p",{class:"mt-2 text-color-secondary"},"Загрузка ссылок...",-1))])):0===el.value.length?(m(),d("div",he,[...l[48]||(l[48]=[g("i",{class:"pi pi-check-circle text-4xl text-green-500 mb-3"},null,-1),g("p",{class:"text-color-secondary"},"На этот объект нет ссылок",-1),g("p",{class:"text-sm text-color-secondary"},"Объект можно безопасно удалить",-1)])])):(m(),d("div",we,[r(n,{severity:"info",closable:!1,class:"mb-3"},{default:c(()=>[f(" Найдено "+b(el.value.length)+" ссылок на этот объект ",1)]),_:1}),r(pl,{value:el.value,paginator:el.value.length>10,rows:10,class:"p-datatable-sm"},{default:c(()=>[r(q,{field:"typeName",header:"Таблица",style:{width:"40%"}},{body:c(e=>[r(T,{to:`/integram/${Le.value}/object/${e.data.typeId}`,class:"text-primary"},{default:c(()=>[f(b(e.data.typeName),1)]),_:2},1032,["to"])]),_:1}),r(q,{field:"objectName",header:"Объект",style:{width:"40%"}},{body:c(e=>[r(T,{to:`/integram/${Le.value}/edit_obj/${e.data.objectId}`,class:"text-primary"},{default:c(()=>[f(b(e.data.objectName),1)]),_:2},1032,["to"])]),_:1}),r(q,{field:"fieldName",header:"Поле",style:{width:"20%"}},{body:c(e=>[g("span",ke,b(e.data.fieldName),1)]),_:1})]),_:1},8,["value","paginator"])]))]),_:1},8,["visible","header"]),r(Yl,{visible:tl.value,"onUpdate:visible":l[31]||(l[31]=e=>tl.value=e),header:"Добавить колонку",style:{width:"450px"},modal:!0,onHide:la},{footer:c(()=>[r(i,{label:"Отмена",icon:"pi pi-times",onClick:l[30]||(l[30]=e=>tl.value=!1),text:""}),r(i,{label:"Добавить",icon:"pi pi-plus",onClick:ta,disabled:!El.value,loading:il.value},null,8,["disabled","loading"])]),default:c(()=>[g("div",xe,[g("div",Ve,[l[49]||(l[49]=g("label",{class:"font-semibold mb-2 block"},"Название колонки",-1)),r(s,{modelValue:ol.value.name,"onUpdate:modelValue":l[26]||(l[26]=e=>ol.value.name=e),placeholder:"Введите название",class:"w-full",onKeyup:aa},null,8,["modelValue"])]),g("div",_e,[l[50]||(l[50]=g("label",{class:"font-semibold mb-2 block"},"Тип данных",-1)),r(o,{modelValue:ol.value.baseTypeId,"onUpdate:modelValue":l[27]||(l[27]=e=>ol.value.baseTypeId=e),options:ul,optionLabel:"name",optionValue:"id",placeholder:"Выберите тип",class:"w-full",onChange:aa},null,8,["modelValue"])]),g("div",Ie,[r(Ue,{modelValue:ol.value.isDictionary,"onUpdate:modelValue":l[28]||(l[28]=e=>ol.value.isDictionary=e),binary:!0,inputId:"isDictionary"},null,8,["modelValue"]),l[51]||(l[51]=g("label",{for:"isDictionary",class:"cursor-pointer"}," Справочник (создать отдельную таблицу для значений) ",-1))]),ol.value.isDictionary?(m(),d("div",je,[r(Ue,{modelValue:ol.value.isMultiSelect,"onUpdate:modelValue":l[29]||(l[29]=e=>ol.value.isMultiSelect=e),binary:!0,inputId:"isMultiSelect"},null,8,["modelValue"]),l[52]||(l[52]=g("label",{for:"isMultiSelect",class:"cursor-pointer"}," Мульти-выбор (можно выбрать несколько значений) ",-1))])):y("",!0)])]),_:1},8,["visible"])])}}},[["__scopeId","data-v-dd306f52"]]);export{qe as default};
