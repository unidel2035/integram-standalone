import{r as e,J as t,K as a,as as n,c as s,o as l,A as o,h as r,m as i,C as u,H as c,b as d,n as p,a as v,F as m,d as f,G as h,g as y,t as g,aV as x,U as w,w as k,aY as b,f as M}from"./index-UE8Rfyf2.js";import{u as _}from"./useTimer-odPaXYPz.js";import{_ as I}from"./_plugin-vue_export-helper-BCo6x5W8.js";import{i as $}from"./integramApiClient-BsYdo77J.js";const P=["photo","изображение","фото","картинка","аватара","picture","avatar","img","image","пиеср","аватар"],D=["имя","name","login","username","фио","полное_имя","полное имя","полное_название","полное название","displayname"],V=new Map;function U(t){const a="my";V.has(a)||V.set(a,{users:e([]),loading:e(!1),loadPromise:null});const n=V.get(a),s=n.users,l=n.loading;function o(e){if(!e)return[];const t=/@(\w+)_(\d+)/g,a=[];let n;for(;null!==(n=t.exec(e));)a.push({full:n[0],database:n[1],userId:n[2],startIndex:n.index,endIndex:n.index+n[0].length});return a}function r(e){return s.value.find(t=>t.id===e)}return{users:s,loading:l,loadUsers:async function(){return n.loadPromise?n.loadPromise:s.value.length>0?void 0:(n.loadPromise=(async()=>{l.value=!0;let e=null;try{e=$.currentDatabase,$.setDatabase("my");const t=await $.getTypeMetadata(18),a=(null==t?void 0:t.reqs)||[];a.forEach((e,t)=>{e.alias||e.val});const n=a.find(e=>{const t=(e.alias||e.val||"").toLowerCase();return P.some(e=>t.includes(e))});let l=a.find(e=>{const t=(e.alias||e.val||"").toLowerCase();return D.some(e=>t.includes(e))});!l&&a.length>1&&(l=a[1]),!n&&a.length>2&&(n=a[2]);const o=await $.getAllObjects(18,100,50);let r=0;s.value=o.object.map(e=>{var t;const a=e.id||e.ID,s=null==(t=o.reqs)?void 0:t[a],i=r<3;let u=a,c=null;if(s){if(l){const e=s[l.id];e&&(u=e)}if(n){const e=s[n.id];if(e){let t=null;if("string"==typeof e&&e.includes("href")){const a=e.match(/href=['"]([^'"]+)['"]/);a&&(t=a[1])}else"string"==typeof e&&(t=e);t&&(c=t.startsWith("http://")||t.startsWith("https://")?t:t.startsWith("/")?`https://dronedoc.ru${t}`:`https://dronedoc.ru/${t}`)}}}return i&&r++,{id:a,name:u,photo:c,mention:`@my_${a}`}})}catch(t){s.value=[]}finally{l.value=!1,e&&$.setDatabase(e),n.loadPromise=null}})(),n.loadPromise)},filterUsers:function(e){if(!e)return s.value;const t=e.toLowerCase();return s.value.filter(e=>e.name.toLowerCase().includes(t)||e.id.toString().includes(t))},parseMentions:o,getUserById:r,renderMentions:function(e){if(!e)return[{type:"text",content:""}];const t=o(e);if(0===t.length)return[{type:"text",content:e}];const a=[];let n=0;return t.forEach(t=>{t.startIndex>n&&a.push({type:"text",content:e.substring(n,t.startIndex)});const s=r(t.userId);a.push({type:"mention",content:t.full,user:s||{id:t.userId,name:t.userId,photo:null}}),n=t.endIndex}),n<e.length&&a.push({type:"text",content:e.substring(n)}),a},insertMention:function(e,t,a){const n=e.substring(0,t),s=e.substring(t),l=n.endsWith("@")?n.slice(0,-1):n;return{text:l+a.mention+" "+s,cursorPosition:l.length+a.mention.length+1}}}}const E={key:0,class:"mention-item-empty"},L=["onMousedown","onMouseenter"],C=["src","alt"],S={key:1,class:"mention-avatar-default"},j={class:"mention-name"},A={class:"mention-id text-400 text-xs ml-auto"},T=I({__name:"MentionAutocomplete",props:{modelValue:{type:String,default:""},database:{type:String,required:!0}},emits:["update:modelValue"],setup(w,{expose:k,emit:b}){const M=w,I=b,{setTimeout:$}=_(),P=e(null),D=e(null),V=e(!1),T=e(0),q=e(""),R=e(0),{users:W,loadUsers:z,filterUsers:B,insertMention:H}=U(M.database),J=t(()=>B(q.value)),K=t(()=>{var e;const t=(null==(e=D.value)?void 0:e.$el)||D.value;if(!t)return{position:"fixed",top:"0",left:"0",zIndex:1e4,display:"none"};const a=t.getBoundingClientRect();return{position:"fixed",top:a.bottom+4+"px",left:a.left+"px",width:Math.max(a.width,280)+"px",zIndex:1e4}});function F(e){var t;I("update:modelValue",e);const a=(null==(t=D.value)?void 0:t.$el)||D.value;R.value=a.selectionStart;const n=e.substring(0,R.value).match(/@(\w*)$/);n?(q.value=n[1]||"",V.value=!0,T.value=0,z()):V.value=!1}function G(e){if(V.value)switch(e.key){case"ArrowDown":e.preventDefault(),T.value=Math.min(T.value+1,J.value.length-1);break;case"ArrowUp":e.preventDefault(),T.value=Math.max(T.value-1,0);break;case"Enter":case"Tab":J.value.length>0&&(e.preventDefault(),O(J.value[T.value]));break;case"Escape":e.preventDefault(),V.value=!1}}function O(e){var t;const a=H(M.modelValue,R.value,e);I("update:modelValue",a.text),V.value=!1;const n=(null==(t=D.value)?void 0:t.$el)||D.value;$(()=>{n.focus(),n.setSelectionRange(a.cursorPosition,a.cursorPosition)},0)}function Y(){$(()=>{V.value=!1},200)}function N(e){P.value&&!P.value.contains(e.target)&&(V.value=!1)}return a(()=>{document.addEventListener("click",N)}),n(()=>{document.removeEventListener("click",N)}),k({focus:()=>{var e;const t=(null==(e=D.value)?void 0:e.$el)||D.value;null==t||t.focus()}}),(e,t)=>(l(),s("div",{class:"mention-autocomplete",ref_key:"containerRef",ref:P},[o(u(c),i({ref_key:"inputRef",ref:D,modelValue:w.modelValue,"onUpdate:modelValue":F,onKeydown:G,onBlur:Y},e.$attrs,{class:"w-full"}),null,16,["modelValue"]),(l(),r(x,{to:"body"},[V.value?(l(),s("div",{key:0,class:"mention-dropdown",style:p(K.value)},[0===J.value.length?(l(),s("div",E,[...t[0]||(t[0]=[v("i",{class:"pi pi-user text-400 mr-2"},null,-1),v("span",{class:"text-500"},"Пользователи не найдены",-1)])])):(l(!0),s(m,{key:1},f(J.value,(e,a)=>(l(),s("div",{key:e.id,class:y(["mention-item",{"mention-item-active":a===T.value}]),onMousedown:h(t=>O(e),["prevent"]),onMouseenter:e=>T.value=a},[e.photo?(l(),s("img",{key:0,src:e.photo,alt:e.name,class:"mention-avatar"},null,8,C)):(l(),s("div",S,[...t[1]||(t[1]=[v("i",{class:"pi pi-user"},null,-1)])])),v("span",j,g(e.name),1),v("span",A,"ID: "+g(e.id),1)],42,L))),128))],4)):d("",!0)]))],512))}},[["__scopeId","data-v-aeaae1b1"]]),q={class:"mention-display"},R={key:0,class:"user-preview-card"},W={class:"user-preview-header"},z=["src","alt"],B={key:1,class:"user-preview-avatar-default"},H={class:"user-preview-info"},J={class:"user-preview-name"},K={class:"user-preview-id"},F=["innerHTML"],G=["onMouseenter"],O=["src","alt","onError"],Y={key:1,class:"mention-tag-avatar-default"},N={class:"mention-tag-name"},Q={key:2,class:"mention-text-raw"},X={style:{"font-size":"0.7em",opacity:"0.5"}},Z=I({__name:"MentionDisplay",props:{text:{type:String,default:""},database:{type:String,required:!0}},setup(n){const r=n,i=e(null),c=e(null),{users:p,loadUsers:h,renderMentions:y}=U(r.database),x=()=>{i.value&&i.value.hide(),c.value=null},_=e=>{if(!e)return e;let t=e;return t=t.replace(/(\+\d{1,3}[-.\s]?\(?\d{1,4}\)?(?:[-.\s]?\d{1,4}){2,4})/g,e=>`<a href="tel:${e.replace(/[-.\s()]/g,"")}" class="cell-chip cell-phone" title="Позвонить: ${e}" onclick="event.stopPropagation()"><i class="pi pi-phone"></i><span>${e}</span></a>`),t=t.replace(/([\w.-]+@[\w.-]+\.\w{2,})/gi,e=>`<a href="mailto:${e}" class="cell-chip cell-email" title="Написать: ${e}" onclick="event.stopPropagation()"><i class="pi pi-envelope"></i><span>${e}</span></a>`),t},I=t(()=>y(r.text));return a(async()=>{r.text&&r.text.includes("@")&&await h()}),w(()=>r.text,async e=>{e&&e.includes("@")&&0===p.value.length&&await h()}),(e,t)=>(l(),s("span",q,[o(u(b),{ref_key:"userPreviewPopover",ref:i,class:"user-preview-popover"},{default:k(()=>[c.value?(l(),s("div",R,[v("div",W,[c.value.photo?(l(),s("img",{key:0,src:c.value.photo,alt:c.value.name,class:"user-preview-avatar"},null,8,z)):(l(),s("div",B,[...t[0]||(t[0]=[v("i",{class:"pi pi-user"},null,-1)])])),v("div",H,[v("div",J,g(c.value.name),1),v("div",K,"ID: "+g(c.value.id),1)])])])):d("",!0)]),_:1},512),(l(!0),s(m,null,f(I.value,(e,a)=>(l(),s(m,{key:a},["text"===e.type?(l(),s("span",{key:0,innerHTML:_(e.content)},null,8,F)):"mention"===e.type&&e.user?(l(),s("span",{key:1,class:"mention-tag",onMouseenter:t=>{return a=t,n=e.user,c.value=n,void(i.value&&i.value.show(a));var a,n},onMouseleave:x},[e.user.photo?(l(),s("img",{key:0,src:e.user.photo,alt:e.user.name,class:"mention-tag-avatar",onError:e=>{}},null,40,O)):(l(),s("span",Y,[...t[1]||(t[1]=[v("i",{class:"pi pi-user"},null,-1)])])),v("span",N,g(e.user.name),1)],40,G)):(l(),s("span",Q,[M(g(e.content)+" ",1),v("span",X,"(user data not loaded, type="+g(e.type)+", user="+g(e.user?"exists":"null")+")",1)]))],64))),128))]))}},[["__scopeId","data-v-a8bf57c6"]]);export{Z as M,T as a,U as u};
