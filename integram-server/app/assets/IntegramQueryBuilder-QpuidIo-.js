import{_ as Se,y as h,u as Fe,c as p,A as s,a as u,w as q,L as ae,D as te,d as f,I as J,J as ne,o as m,b as U,h as H,F as A,r as S,j as K,t as W,f as De}from"./index-D6FYndJO.js";import{I as Be}from"./IntegramBreadcrumb-DEnfToFO.js";import{i as R}from"./integramService-BbyM5pB3.js";import{l as L}from"./logger-CLWPjr6Q.js";import"./integramApiClient-C3_j8SPw.js";import"./index-B9ygI19o.js";import"./unifiedAuthService-xCuNj-Bd.js";const ze={__name:"IntegramQueryBuilder",setup(se,{expose:t}){t();const $=ae(),e=te(),_=f(null),F=f([]),E=f([]),d=f([]),N=f([]),b=f([]),g=f([]),w=f([]),D=f([]),I=f([]),k=f(100),B=f([]),z=f([]),G=f(!1),j=f(null),T=f(null),l=f(!1),c=f(""),n=f(""),P=f(!1),ie=Object.freeze(["INNER JOIN","LEFT JOIN","RIGHT JOIN","FULL JOIN"]),re=Object.freeze(["=","!=",">","<",">=","<=","LIKE","IN","NOT IN","IS NULL","IS NOT NULL"]),ue=Object.freeze([{value:"COUNT",label:"COUNT - Количество"},{value:"COUNT_ALL",label:"COUNT(*) - Всего записей"},{value:"SUM",label:"SUM - Сумма"},{value:"AVG",label:"AVG - Среднее"},{value:"MAX",label:"MAX - Максимум"},{value:"MIN",label:"MIN - Минимум"},{value:"GROUP_CONCAT",label:"GROUP_CONCAT - Объединить"}]),de=Object.freeze([{value:"",label:"По умолчанию"},{value:"number",label:"Число"},{value:"decimal2",label:"Десятичное (2 знака)"},{value:"decimal4",label:"Десятичное (4 знака)"},{value:"currency",label:"Валюта (₽)"},{value:"percent",label:"Процент (%)"},{value:"date",label:"Дата"},{value:"datetime",label:"Дата и время"},{value:"time",label:"Время"},{value:"bool",label:"Да/Нет"}]),X=Object.freeze({value:"*",label:"* (все колонки)"}),Z=Object.freeze([Object.freeze({label:"Конструктор запросов",icon:"pi pi-sliders-h"})]),me=J(()=>Z),ee=J(()=>_.value&&(F.value.length>0||d.value.length>0)),ce=J(()=>[X,...z.value]),pe=J(()=>d.value.map((o,y)=>{let i="";return o.func==="COUNT_ALL"?i="COUNT(*)":i=`${o.func}(${o.column||"*"})`,o.alias&&(i+=` AS ${o.alias}`),{value:y,label:i}})),Y=J(()=>{if(!_.value)return"-- Выберите таблицу для начала";let o="SELECT ";const y=[];if(F.value.length>0&&y.push(...F.value),E.value.forEach(i=>{i.expression&&y.push(i.alias?`${i.expression} AS ${i.alias}`:i.expression)}),d.value.forEach(i=>{if(i.func){let r="";i.func==="COUNT_ALL"?r="COUNT(*)":i.func==="GROUP_CONCAT"?r=`GROUP_CONCAT(${i.column||"*"})`:r=`${i.func}(${i.column||"*"})`,i.alias&&(r+=` AS ${i.alias}`),y.push(r)}}),y.length===0?o+="*":o+=y.join(", "),o+=`
FROM ${_.value}`,N.value.forEach(i=>{i.table&&i.onLeft&&i.onRight&&(o+=`
${i.type||"INNER JOIN"} ${i.table} ON ${i.onLeft} = ${i.onRight}`)}),b.value.length>0){o+=`
WHERE `;const i=b.value.map((r,M)=>{let C="";return M>0&&r.logic&&(C+=`${r.logic} `),r.operator==="IS NULL"||r.operator==="IS NOT NULL"?C+=`${r.field} ${r.operator}`:r.operator==="IN"||r.operator==="NOT IN"?C+=`${r.field} ${r.operator} (${r.value})`:r.operator==="LIKE"?C+=`${r.field} LIKE '%${r.value}%'`:C+=`${r.field} ${r.operator} '${r.value}'`,C}).join(" ");o+=i}if(g.value.length>0&&(o+=`
GROUP BY ${g.value.join(", ")}`),w.value.length>0&&d.value.length>0){o+=`
HAVING `;const i=w.value.map((r,M)=>{let C="";M>0&&r.logic&&(C+=`${r.logic} `);const x=r.aggregate,a=d.value[x];if(a){let v="";a.func==="COUNT_ALL"?v="COUNT(*)":v=`${a.func}(${a.column||"*"})`,r.valueTo&&r.valueFrom?C+=`${v} BETWEEN ${r.valueFrom} AND ${r.valueTo}`:r.valueFrom&&(C+=`${v} ${r.operator||">"} ${r.valueFrom}`)}return C}).filter(r=>r).join(" ");i?o+=i:o=o.replace(`
HAVING `,"")}if(I.value.length>0){const i=I.value.map(r=>`${r.column} ${r.direction||"ASC"}`).join(", ");o+=`
ORDER BY ${i}`}return k.value&&(o+=`
LIMIT ${k.value}`),o});async function le(){try{const o=await R.getDictionary();o&&o.types&&(B.value=Object.entries(o.types).map(([y,i])=>({value:i.val,label:`${i.val} (ID: ${y})`})))}catch(o){L.error("Failed to load tables:",o),T.value="Не удалось загрузить список таблиц"}}async function ve(){if(_.value)try{const o=B.value.find(r=>r.value===_.value);if(!o)return;const y=parseInt(o.label.match(/ID: (\d+)/)[1]),i=await R.getMetadata(y);i&&i.reqs&&(z.value=i.reqs.map(r=>({value:r.name||r.val,label:r.name||r.val})))}catch(o){L.error("Failed to load columns:",o),e.add({severity:"warn",summary:"Предупреждение",detail:"Не удалось загрузить колонки таблицы",life:3e3})}}function fe(){E.value.push({expression:"",alias:""})}function be(o){E.value.splice(o,1)}function ge(){d.value.push({func:"COUNT",column:"*",alias:"",format:""})}function ye(o){d.value.splice(o,1)}function Ve(){N.value.push({type:"INNER JOIN",table:null,onLeft:"",onRight:""})}function Ce(o){N.value.splice(o,1)}function he(){b.value.push({logic:"AND",field:"",operator:"=",value:""})}function xe(o){b.value.splice(o,1)}function Ue(){I.value.push({column:"",direction:"ASC"})}function _e(o){I.value.splice(o,1)}function Ne(){if(d.value.length===0){e.add({severity:"warn",summary:"Предупреждение",detail:"Сначала добавьте хотя бы одну агрегатную функцию",life:3e3});return}w.value.push({logic:"AND",aggregate:0,operator:">",valueFrom:"",valueTo:""})}function we(o){w.value.splice(o,1)}function Ie(){D.value.push({column:"",expression:""})}function Te(o){D.value.splice(o,1)}async function Oe(){if(!ee.value){e.add({severity:"warn",summary:"Предупреждение",detail:"Заполните обязательные поля",life:3e3});return}G.value=!0,T.value=null,j.value=null;try{const o=await R.post("sql",{query:Y.value,JSON:!0});if(o&&o.data){const y=o.columns||Object.keys(o.data[0]||{});j.value={columns:y.map(i=>({field:i,header:i})),rows:o.data,total:o.total||o.data.length},e.add({severity:"success",summary:"Успех",detail:`Запрос выполнен. Получено ${j.value.rows.length} записей`,life:3e3})}}catch(o){L.error("Query execution failed:",o),T.value="Ошибка выполнения запроса: "+o.message,e.add({severity:"error",summary:"Ошибка",detail:T.value,life:5e3})}finally{G.value=!1}}function Le(){navigator.clipboard.writeText(Y.value).then(()=>{e.add({severity:"success",summary:"Скопировано",detail:"SQL запрос скопирован в буфер обмена",life:2e3})})}function Re(){_.value=null,F.value=[],E.value=[],d.value=[],N.value=[],b.value=[],g.value=[],w.value=[],D.value=[],I.value=[],k.value=100,j.value=null,T.value=null,z.value=[]}function Ee(){l.value=!0}async function ke(){var o,y;if(!c.value.trim()){e.add({severity:"warn",summary:"Предупреждение",detail:"Введите название отчета",life:3e3});return}P.value=!0;try{let i="";b.value.length>0&&(i=b.value.map((a,v)=>{let V="";return v>0&&a.logic&&(V+=`${a.logic} `),a.operator==="IS NULL"||a.operator==="IS NOT NULL"?V+=`${a.field} ${a.operator}`:a.operator==="IN"||a.operator==="NOT IN"?V+=`${a.field} ${a.operator} (${a.value})`:a.operator==="LIKE"?V+=`${a.field} LIKE '%${a.value}%'`:V+=`${a.field} ${a.operator} '${a.value}'`,V}).join(" "));let r="";I.value.length>0&&(r=I.value.map(a=>`${a.column} ${a.direction||"ASC"}`).join(", "));let M="";w.value.length>0&&d.value.length>0&&(M=w.value.map((a,v)=>{let V="";v>0&&a.logic&&(V+=`${a.logic} `);const O=d.value[a.aggregate];if(O){let Q=O.func==="COUNT_ALL"?"COUNT(*)":`${O.func}(${O.column||"*"})`;a.valueTo&&a.valueFrom?V+=`${Q} BETWEEN ${a.valueFrom} AND ${a.valueTo}`:a.valueFrom&&(V+=`${Q} ${a.operator||">"} ${a.valueFrom}`)}return V}).filter(a=>a).join(" "));const C=await R.createReport(c.value,{where:i||void 0,having:M||void 0,orderBy:r||void 0,limit:k.value?String(k.value):void 0});if(!C||!C.id)throw new Error("Failed to create report");const x=C.id;if(L.info(`Created report ${x}: ${c.value}`),_.value){const a=B.value.find(v=>v.value===_.value);if(a){const v=parseInt((o=a.label.match(/ID: (\d+)/))==null?void 0:o[1]);v&&(await R.addReportFrom(x,v,"t1"),L.info(`Added FROM table ${v} to report ${x}`))}}for(let a=0;a<N.value.length;a++){const v=N.value[a];if(v.table){const V=B.value.find(O=>O.value===v.table);if(V){const O=parseInt((y=V.label.match(/ID: (\d+)/))==null?void 0:y[1]);if(O){const Q=`t${a+2}`,Ae=v.onLeft&&v.onRight?`${v.onLeft} = ${v.onRight}`:null;await R.addReportFrom(x,O,Q,Ae),L.info(`Added JOIN table ${O} to report ${x}`)}}}}for(const a of F.value)z.value.find(V=>V.value===a)&&(await R.addReportColumn(x,{fieldId:0,nameInReport:a,formula:a}),L.info(`Added column ${a} to report ${x}`));for(const a of E.value)a.expression&&(await R.addReportColumn(x,{fieldId:0,nameInReport:a.alias||a.expression,formula:a.expression,set:a.expression}),L.info(`Added expression ${a.expression} to report ${x}`));e.add({severity:"success",summary:"Успех",detail:"Отчет успешно сохранен",life:3e3}),l.value=!1,c.value="",n.value="",$.push(`/integram/smartq?reportId=${x}`)}catch(i){L.error("Failed to save report:",i),e.add({severity:"error",summary:"Ошибка",detail:"Не удалось сохранить отчет: "+i.message,life:5e3})}finally{P.value=!1}}ne(()=>{le()});const oe={router:$,toast:e,selectedTable:_,selectedColumns:F,customExpressions:E,aggregateFunctions:d,joins:N,conditions:b,groupByColumns:g,havingConditions:w,setExpressions:D,orderByColumns:I,limit:k,availableTables:B,availableColumns:z,executing:G,queryResults:j,error:T,showSaveDialog:l,reportName:c,reportDescription:n,saving:P,joinTypes:ie,operators:re,aggregateFunctionTypes:ue,columnFormatTypes:de,ALL_COLUMNS_OPTION:X,QUERY_BUILDER_BREADCRUMB:Z,breadcrumbItems:me,isQueryValid:ee,availableColumnsForAggregate:ce,havingAggregateOptions:pe,generatedSql:Y,loadTables:le,onTableChange:ve,addCustomExpression:fe,removeCustomExpression:be,addAggregateFunction:ge,removeAggregateFunction:ye,addJoin:Ve,removeJoin:Ce,addCondition:he,removeCondition:xe,addOrderBy:Ue,removeOrderBy:_e,addHavingCondition:Ne,removeHavingCondition:we,addSetExpression:Ie,removeSetExpression:Te,executeQuery:Oe,copySqlToClipboard:Le,clearQuery:Re,saveAsReport:Ee,confirmSaveReport:ke,ref:f,computed:J,onMounted:ne,get useRouter(){return ae},get useToast(){return te},IntegramBreadcrumb:Be,get integramService(){return R},get logger(){return L}};return Object.defineProperty(oe,"__isScriptSetup",{enumerable:!1,value:!0}),oe}},je={class:"integram-query-builder-container"},Me={class:"mb-3"},qe={class:"flex align-items-center justify-content-between"},Je={class:"flex gap-2 align-items-center ml-auto"},Ge={class:"query-builder-form"},Qe={class:"form-section mb-4"},He={class:"flex gap-2 mb-2"},$e={key:0,class:"custom-expressions"},Pe={key:1,class:"aggregate-functions mt-3"},Ye={class:"flex gap-2 mt-2"},Ke={class:"form-section mb-4"},We={class:"form-section mb-4"},Xe={class:"flex justify-content-between align-items-center mb-2"},Ze={key:0},el={class:"flex gap-2 mb-2"},ll={class:"flex gap-2"},ol={class:"form-section mb-4"},al={class:"flex justify-content-between align-items-center mb-2"},tl={key:0},nl={class:"form-section mb-4"},sl={class:"form-section mb-4"},il={class:"flex justify-content-between align-items-center mb-2"},rl={key:0},ul={key:1,class:"text-color-secondary"},dl={class:"form-section mb-4"},ml={class:"flex justify-content-between align-items-center mb-2"},cl={key:0,class:"set-expressions"},pl={class:"form-section mb-4"},vl={class:"flex justify-content-between align-items-center mb-2"},fl={key:0},bl={class:"form-section mb-4"},gl={class:"sql-preview-section mt-4"},yl={class:"flex justify-content-between align-items-center mb-3"},Vl={class:"sql-preview-box"},Cl={key:0,class:"query-results-section mt-4"},hl={class:"mt-2 text-sm text-muted"},xl={class:"flex flex-column gap-3"};function Ul(se,t,$,e,_,F){const E=h("Toast"),d=h("Button"),N=h("MultiSelect"),b=h("InputText"),g=h("Dropdown"),w=h("InputNumber"),D=h("Divider"),I=h("Column"),k=h("DataTable"),B=h("Message"),z=h("Card"),G=h("Textarea"),j=h("Dialog"),T=Fe("tooltip");return m(),p("div",je,[s(E),u("div",Me,[s(e.IntegramBreadcrumb,{items:e.breadcrumbItems},null,8,["items"])]),s(z,null,{title:q(()=>[u("div",qe,[t[9]||(t[9]=u("span",null,"Конструктор запросов",-1)),u("div",Je,[s(d,{label:"Выполнить",icon:"pi pi-play",onClick:e.executeQuery,loading:e.executing,disabled:!e.isQueryValid,size:"small"},null,8,["loading","disabled"]),K(s(d,{icon:"pi pi-save",onClick:e.saveAsReport,disabled:!e.isQueryValid,outlined:"",rounded:"",size:"small"},null,8,["disabled"]),[[T,"Сохранить как отчет",void 0,{bottom:!0}]]),K(s(d,{icon:"pi pi-times",onClick:e.clearQuery,outlined:"",rounded:"",size:"small",severity:"secondary"},null,512),[[T,"Очистить",void 0,{bottom:!0}]])])])]),content:q(()=>[u("div",Ge,[u("div",Qe,[t[11]||(t[11]=u("label",{class:"form-label font-semibold"}," SELECT (Выбрать колонки) ",-1)),u("div",He,[s(N,{modelValue:e.selectedColumns,"onUpdate:modelValue":t[0]||(t[0]=l=>e.selectedColumns=l),options:e.availableColumns,optionLabel:"label",optionValue:"value",placeholder:"Выберите колонки",filter:!0,class:"flex-1",display:"chip"},null,8,["modelValue","options"]),s(d,{label:"Добавить выражение",icon:"pi pi-plus",onClick:e.addCustomExpression,outlined:"",size:"small"})]),e.customExpressions.length>0?(m(),p("div",$e,[(m(!0),p(A,null,S(e.customExpressions,(l,c)=>(m(),p("div",{key:c,class:"flex gap-2 mb-2"},[s(b,{modelValue:l.expression,"onUpdate:modelValue":n=>l.expression=n,placeholder:"Выражение (например: COUNT(*), SUM(column))",class:"flex-1"},null,8,["modelValue","onUpdate:modelValue"]),s(b,{modelValue:l.alias,"onUpdate:modelValue":n=>l.alias=n,placeholder:"Алиас",style:{width:"150px"}},null,8,["modelValue","onUpdate:modelValue"]),s(d,{icon:"pi pi-trash",onClick:n=>e.removeCustomExpression(c),text:"",rounded:"",severity:"danger",size:"small"},null,8,["onClick"])]))),128))])):U("",!0),e.aggregateFunctions.length>0?(m(),p("div",Pe,[t[10]||(t[10]=u("label",{class:"form-label text-sm text-color-secondary mb-2"},"Агрегатные функции",-1)),(m(!0),p(A,null,S(e.aggregateFunctions,(l,c)=>(m(),p("div",{key:"agg-"+c,class:"flex gap-2 mb-2 p-2 surface-ground border-round flex-wrap"},[s(g,{modelValue:l.func,"onUpdate:modelValue":n=>l.func=n,options:e.aggregateFunctionTypes,optionLabel:"label",optionValue:"value",placeholder:"Функция",class:"w-auto",style:{"min-width":"130px"}},null,8,["modelValue","onUpdate:modelValue","options"]),s(g,{modelValue:l.column,"onUpdate:modelValue":n=>l.column=n,options:e.availableColumnsForAggregate,optionLabel:"label",optionValue:"value",placeholder:"Колонка",filter:!0,class:"flex-1",style:{"min-width":"120px"},disabled:l.func==="COUNT_ALL"},null,8,["modelValue","onUpdate:modelValue","options","disabled"]),s(b,{modelValue:l.alias,"onUpdate:modelValue":n=>l.alias=n,placeholder:"Алиас",style:{width:"120px"}},null,8,["modelValue","onUpdate:modelValue"]),s(g,{modelValue:l.format,"onUpdate:modelValue":n=>l.format=n,options:e.columnFormatTypes,optionLabel:"label",optionValue:"value",placeholder:"Формат",class:"w-auto",style:{"min-width":"130px"}},null,8,["modelValue","onUpdate:modelValue","options"]),s(d,{icon:"pi pi-trash",onClick:n=>e.removeAggregateFunction(c),text:"",rounded:"",severity:"danger",size:"small"},null,8,["onClick"])]))),128))])):U("",!0),u("div",Ye,[s(d,{label:"Добавить функцию",icon:"pi pi-calculator",onClick:e.addAggregateFunction,outlined:"",size:"small",severity:"info"})])]),u("div",Ke,[t[12]||(t[12]=u("label",{class:"form-label font-semibold"},"FROM (Таблица)",-1)),s(g,{modelValue:e.selectedTable,"onUpdate:modelValue":t[1]||(t[1]=l=>e.selectedTable=l),options:e.availableTables,optionLabel:"label",optionValue:"value",placeholder:"Выберите таблицу",filter:!0,class:"w-full",onChange:e.onTableChange},null,8,["modelValue","options"])]),u("div",We,[u("div",Xe,[t[13]||(t[13]=u("label",{class:"form-label font-semibold"},"JOIN (Связи)",-1)),s(d,{label:"Добавить JOIN",icon:"pi pi-plus",onClick:e.addJoin,outlined:"",size:"small"})]),e.joins.length>0?(m(),p("div",Ze,[(m(!0),p(A,null,S(e.joins,(l,c)=>(m(),p("div",{key:c,class:"join-row mb-3 p-3 border-1 surface-border border-round"},[u("div",el,[s(g,{modelValue:l.type,"onUpdate:modelValue":n=>l.type=n,options:e.joinTypes,placeholder:"Тип JOIN",class:"w-full"},null,8,["modelValue","onUpdate:modelValue","options"]),s(g,{modelValue:l.table,"onUpdate:modelValue":n=>l.table=n,options:e.availableTables,optionLabel:"label",optionValue:"value",placeholder:"Таблица",filter:!0,class:"w-full"},null,8,["modelValue","onUpdate:modelValue","options"]),s(d,{icon:"pi pi-trash",onClick:n=>e.removeJoin(c),text:"",rounded:"",severity:"danger",size:"small"},null,8,["onClick"])]),u("div",ll,[s(b,{modelValue:l.onLeft,"onUpdate:modelValue":n=>l.onLeft=n,placeholder:"Левое поле",class:"flex-1"},null,8,["modelValue","onUpdate:modelValue"]),t[14]||(t[14]=u("span",{class:"flex align-items-center"},"=",-1)),s(b,{modelValue:l.onRight,"onUpdate:modelValue":n=>l.onRight=n,placeholder:"Правое поле",class:"flex-1"},null,8,["modelValue","onUpdate:modelValue"])])]))),128))])):U("",!0)]),u("div",ol,[u("div",al,[t[15]||(t[15]=u("label",{class:"form-label font-semibold"},"WHERE (Условия)",-1)),s(d,{label:"Добавить условие",icon:"pi pi-plus",onClick:e.addCondition,outlined:"",size:"small"})]),e.conditions.length>0?(m(),p("div",tl,[(m(!0),p(A,null,S(e.conditions,(l,c)=>(m(),p("div",{key:c,class:"condition-row mb-2 flex gap-2"},[c>0?(m(),H(g,{key:0,modelValue:l.logic,"onUpdate:modelValue":n=>l.logic=n,options:["AND","OR"],placeholder:"Логика",class:"w-auto",style:{width:"100px"}},null,8,["modelValue","onUpdate:modelValue"])):U("",!0),s(b,{modelValue:l.field,"onUpdate:modelValue":n=>l.field=n,placeholder:"Поле",class:"flex-1"},null,8,["modelValue","onUpdate:modelValue"]),s(g,{modelValue:l.operator,"onUpdate:modelValue":n=>l.operator=n,options:e.operators,placeholder:"Оператор",class:"w-auto",style:{width:"120px"}},null,8,["modelValue","onUpdate:modelValue","options"]),s(b,{modelValue:l.value,"onUpdate:modelValue":n=>l.value=n,placeholder:"Значение",class:"flex-1"},null,8,["modelValue","onUpdate:modelValue"]),s(d,{icon:"pi pi-trash",onClick:n=>e.removeCondition(c),text:"",rounded:"",severity:"danger",size:"small"},null,8,["onClick"])]))),128))])):U("",!0)]),u("div",nl,[t[16]||(t[16]=u("label",{class:"form-label font-semibold"},"GROUP BY (Группировка)",-1)),s(N,{modelValue:e.groupByColumns,"onUpdate:modelValue":t[2]||(t[2]=l=>e.groupByColumns=l),options:e.selectedColumns,placeholder:"Выберите колонки для группировки",class:"w-full",display:"chip"},null,8,["modelValue","options"])]),u("div",sl,[u("div",il,[t[17]||(t[17]=u("label",{class:"form-label font-semibold"},"HAVING (Условия группировки)",-1)),K(s(d,{label:"Добавить условие",icon:"pi pi-plus",onClick:e.addHavingCondition,outlined:"",size:"small",disabled:e.aggregateFunctions.length===0},null,8,["disabled"]),[[T,e.aggregateFunctions.length===0?"Сначала добавьте агрегатную функцию":"",void 0,{bottom:!0}]])]),e.havingConditions.length>0?(m(),p("div",rl,[(m(!0),p(A,null,S(e.havingConditions,(l,c)=>(m(),p("div",{key:"having-"+c,class:"having-row mb-2 flex gap-2 p-2 surface-ground border-round"},[c>0?(m(),H(g,{key:0,modelValue:l.logic,"onUpdate:modelValue":n=>l.logic=n,options:["AND","OR"],placeholder:"Логика",class:"w-auto",style:{width:"100px"}},null,8,["modelValue","onUpdate:modelValue"])):U("",!0),s(g,{modelValue:l.aggregate,"onUpdate:modelValue":n=>l.aggregate=n,options:e.havingAggregateOptions,optionLabel:"label",optionValue:"value",placeholder:"Агрегатная функция",class:"flex-1"},null,8,["modelValue","onUpdate:modelValue","options"]),s(g,{modelValue:l.operator,"onUpdate:modelValue":n=>l.operator=n,options:e.operators,placeholder:"Оператор",class:"w-auto",style:{width:"120px"}},null,8,["modelValue","onUpdate:modelValue","options"]),s(b,{modelValue:l.valueFrom,"onUpdate:modelValue":n=>l.valueFrom=n,placeholder:"От",class:"w-auto",style:{width:"100px"}},null,8,["modelValue","onUpdate:modelValue"]),s(b,{modelValue:l.valueTo,"onUpdate:modelValue":n=>l.valueTo=n,placeholder:"До (опционально)",class:"w-auto",style:{width:"120px"}},null,8,["modelValue","onUpdate:modelValue"]),s(d,{icon:"pi pi-trash",onClick:n=>e.removeHavingCondition(c),text:"",rounded:"",severity:"danger",size:"small"},null,8,["onClick"])]))),128))])):U("",!0),e.aggregateFunctions.length===0?(m(),p("small",ul," HAVING используется после GROUP BY для фильтрации агрегированных результатов ")):U("",!0)]),u("div",dl,[u("div",ml,[t[18]||(t[18]=u("label",{class:"form-label font-semibold"},"SET (Вычисляемые присваивания)",-1)),s(d,{label:"Добавить SET",icon:"pi pi-plus",onClick:e.addSetExpression,outlined:"",size:"small"})]),e.setExpressions.length>0?(m(),p("div",cl,[(m(!0),p(A,null,S(e.setExpressions,(l,c)=>(m(),p("div",{key:"set-"+c,class:"flex gap-2 mb-2 p-2 surface-ground border-round"},[s(g,{modelValue:l.column,"onUpdate:modelValue":n=>l.column=n,options:e.availableColumns,optionLabel:"label",optionValue:"value",placeholder:"Колонка",filter:!0,class:"w-auto",style:{"min-width":"150px"}},null,8,["modelValue","onUpdate:modelValue","options"]),t[19]||(t[19]=u("span",{class:"flex align-items-center"},"=",-1)),s(b,{modelValue:l.expression,"onUpdate:modelValue":n=>l.expression=n,placeholder:"Выражение (например: RAND(), колонка*2, IF(...))",class:"flex-1"},null,8,["modelValue","onUpdate:modelValue"]),s(d,{icon:"pi pi-trash",onClick:n=>e.removeSetExpression(c),text:"",rounded:"",severity:"danger",size:"small"},null,8,["onClick"])]))),128)),t[20]||(t[20]=u("small",{class:"text-color-secondary"}," SET используется для вычисления новых значений. Примеры: RAND(), POWER(val,2), IF(val>0,'Да','Нет') ",-1))])):U("",!0)]),u("div",pl,[u("div",vl,[t[21]||(t[21]=u("label",{class:"form-label font-semibold"},"ORDER BY (Сортировка)",-1)),s(d,{label:"Добавить сортировку",icon:"pi pi-plus",onClick:e.addOrderBy,outlined:"",size:"small"})]),e.orderByColumns.length>0?(m(),p("div",fl,[(m(!0),p(A,null,S(e.orderByColumns,(l,c)=>(m(),p("div",{key:c,class:"flex gap-2 mb-2"},[s(g,{modelValue:l.column,"onUpdate:modelValue":n=>l.column=n,options:e.selectedColumns,placeholder:"Колонка",class:"flex-1"},null,8,["modelValue","onUpdate:modelValue","options"]),s(g,{modelValue:l.direction,"onUpdate:modelValue":n=>l.direction=n,options:["ASC","DESC"],placeholder:"Направление",class:"w-auto",style:{width:"120px"}},null,8,["modelValue","onUpdate:modelValue"]),s(d,{icon:"pi pi-trash",onClick:n=>e.removeOrderBy(c),text:"",rounded:"",severity:"danger",size:"small"},null,8,["onClick"])]))),128))])):U("",!0)]),u("div",bl,[t[22]||(t[22]=u("label",{class:"form-label font-semibold"},"LIMIT (Лимит записей)",-1)),s(w,{modelValue:e.limit,"onUpdate:modelValue":t[3]||(t[3]=l=>e.limit=l),placeholder:"Количество записей",min:1,max:1e4,showButtons:""},null,8,["modelValue"])])]),u("div",gl,[s(D),u("div",yl,[t[23]||(t[23]=u("h4",{class:"m-0"},"Сгенерированный SQL",-1)),s(d,{label:"Копировать",icon:"pi pi-copy",onClick:e.copySqlToClipboard,outlined:"",size:"small"})]),u("div",Vl,[u("pre",null,W(e.generatedSql),1)])]),e.queryResults?(m(),p("div",Cl,[s(D),t[24]||(t[24]=u("h4",null,"Результаты запроса",-1)),s(k,{value:e.queryResults.rows,paginator:!0,rows:20,stripedRows:"",showGridlines:"",responsiveLayout:"scroll"},{default:q(()=>[(m(!0),p(A,null,S(e.queryResults.columns,l=>(m(),H(I,{key:l.field,field:l.field,header:l.header},null,8,["field","header"]))),128))]),_:1},8,["value"]),u("div",hl," Всего записей: "+W(e.queryResults.total||e.queryResults.rows.length),1)])):U("",!0),e.error?(m(),H(B,{key:1,severity:"error",onClose:t[4]||(t[4]=l=>e.error=null),closable:"",class:"mt-4"},{default:q(()=>[De(W(e.error),1)]),_:1})):U("",!0)]),_:1}),s(j,{visible:e.showSaveDialog,"onUpdate:visible":t[8]||(t[8]=l=>e.showSaveDialog=l),header:"Сохранить как отчет",modal:!0,style:{width:"500px"}},{footer:q(()=>[s(d,{label:"Отмена",icon:"pi pi-times",onClick:t[7]||(t[7]=l=>e.showSaveDialog=!1),text:""}),s(d,{label:"Сохранить",icon:"pi pi-check",onClick:e.confirmSaveReport,loading:e.saving},null,8,["loading"])]),default:q(()=>[u("div",xl,[u("div",null,[t[25]||(t[25]=u("label",{for:"reportName",class:"form-label"},"Название отчета",-1)),s(b,{id:"reportName",modelValue:e.reportName,"onUpdate:modelValue":t[5]||(t[5]=l=>e.reportName=l),placeholder:"Введите название отчета",class:"w-full"},null,8,["modelValue"])]),u("div",null,[t[26]||(t[26]=u("label",{for:"reportDescription",class:"form-label"},"Описание (опционально)",-1)),s(G,{id:"reportDescription",modelValue:e.reportDescription,"onUpdate:modelValue":t[6]||(t[6]=l=>e.reportDescription=l),placeholder:"Описание отчета",autoResize:!0,rows:"3",class:"w-full"},null,8,["modelValue"])])])]),_:1},8,["visible"])])}const Rl=Se(ze,[["render",Ul],["__scopeId","data-v-43a842f9"],["__file","/home/hive/integram-standalone/src/components/integram/IntegramQueryBuilder.vue"]]);export{Rl as default};
