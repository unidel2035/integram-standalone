import{D as e,r as a,J as l,K as t,L as s,N as i,P as n,c as o,A as u,w as c,y as r,u as d,o as v,f as p,t as m,b,F as y,d as f,a as g,j as h,g as I,h as w,v as j}from"./index-m6PXRYQN.js";import{u as x}from"./useIntegramSession-Bx_TCvff.js";import{i as k}from"./integramApiClient-BsYdo77J.js";import{I as S}from"./IntegramBreadcrumb-Br9bSfo2.js";import{_}from"./_plugin-vue_export-helper-BCo6x5W8.js";import"./index-CcrxTH1M.js";import"./unifiedAuthService-6fZILgG8.js";const V={class:"integram-dictionary-container integram-touch-friendly"},C={class:"flex align-items-center justify-content-between"},O={class:"flex align-items-center gap-2"},N={class:"flex align-items-center gap-2 ml-auto"},q={key:0,class:"text-center py-5"},T={key:1,class:"text-center py-5"},J={key:2},D=["onClick"],L={class:"flex align-items-center gap-1"},U={class:"m-0 category-title"},$={class:"tables-grid integram-dictionary-grid"},E={class:"flex align-items-center justify-content-center text-center"},B={class:"table-name truncate-with-tooltip"},P={class:"tables-list"},A={class:"table-list-name"},M={key:0,class:"text-center py-5"},R={class:"flex flex-column gap-3"},F={class:"field"},z={class:"field"},H={class:"field-checkbox"},K=_({__name:"IntegramDictionary",setup(_){const K=s(),Q=i(),G=e(),{isAuthenticated:W}=x(),X=a(!1),Y=a(null),Z=a(""),ee=a(!1),ae=a(!1),le=a(null),te=a("grid"),se=[{value:"grid",icon:"pi pi-th-large",label:"Сетка"},{value:"list",icon:"pi pi-list",label:"Список"}],ie=a(null),ne=a(null),oe=[{name:"Избранное",open:!0,tables:[],tableIds:["18","42"]},{name:"Основные",open:!0,tables:[],tableIds:[]},{name:"Служебные",open:!1,tables:[],tableIds:["22","269"]},{name:"Скрытые",open:!1,tables:[],tableIds:["47","65","137","29","63"]}],ue=a(JSON.parse(JSON.stringify(oe))),ce=a({name:"",baseTypeId:"",unique:!1}),re=[{label:"Короткий текст (до 127 символов)",value:"3"},{label:"Текст неограниченной длины",value:"8"},{label:"Дата",value:"9"},{label:"Целое число",value:"13"},{label:"Десятичное число",value:"14"},{label:"Логический (Да/Нет)",value:"11"},{label:"Многострочный текст",value:"12"},{label:"Дата и время",value:"4"}],de=l(()=>k.getDatabase()||""),ve=l(()=>!0),pe=l(()=>{if(!Z.value)return ue.value;const e=Z.value.toLowerCase();return ue.value.map(a=>({...a,tables:a.tables.filter(a=>a.name.toLowerCase().includes(e)||a.id.toString().includes(e))})).filter(e=>e.tables.length>0)}),me=l(()=>[{label:"Таблицы",icon:"pi pi-table"}]);async function be(){try{X.value=!0,Y.value=null,await async function(){var e,a;try{const t=localStorage.getItem("dictionarySettingsId");if(t)try{const l=await k.getObjectEditData(t);if(l&&l.obj){ne.value=t;const s=null==(a=null==(e=l.reqs)?void 0:e.t269)?void 0:a.value;if(s){const e=JSON.parse(s);return void(ue.value=Object.entries(e).map(([e,a])=>({name:e,open:a.open??!0,tables:[],tableIds:a.tabs||[]})))}}}catch(l){}ue.value=JSON.parse(JSON.stringify(oe))}catch(l){ue.value=JSON.parse(JSON.stringify(oe))}}();const e=await k.getDictionary();ie.value=e;const a=Object.keys(e);ue.value.forEach(a=>{a.tableIds.length>0&&(a.tables=a.tableIds.filter(a=>e[a]).map(a=>({id:a,name:e[a]})))});const l=ue.value.find(e=>e.name.includes("Основные")||e.name.includes("Main"));if(l){const t=new Set(ue.value.flatMap(e=>e.tableIds));l.tables=a.filter(e=>!t.has(e)).map(a=>({id:a,name:e[a]}))}}catch(e){Y.value=e.message,G.add({severity:"error",summary:"Ошибка",detail:"Не удалось загрузить справочник: "+e.message,life:5e3})}finally{X.value=!1}}async function ye(){try{ae.value=!0;const e=await k.createType(ce.value.name,ce.value.baseTypeId,ce.value.unique);G.add({severity:"success",summary:"Успешно",detail:"Таблица создана!",life:3e3}),ee.value=!1,ce.value={name:"",baseTypeId:"",unique:!1},await be(),e.obj&&K.push(`/integram/${de.value}/object/${e.obj}`)}catch(e){G.add({severity:"error",summary:"Ошибка",detail:"Не удалось создать таблицу: "+e.message,life:5e3})}finally{ae.value=!1}}function fe(e){if("Home"===e.key&&le.value){e.preventDefault();const a=le.value.$el.querySelector("input");a&&a.focus()}}return t(async()=>{W.value?(await be(),window.addEventListener("keydown",fe)):K.push("/integram/login?redirect="+encodeURIComponent(Q.fullPath))}),n(()=>{window.removeEventListener("keydown",fe)}),(e,a)=>{const l=r("Button"),t=r("InputIcon"),s=r("InputText"),i=r("IconField"),n=r("SelectButton"),x=r("ProgressSpinner"),_=r("Message"),K=r("Badge"),Q=r("Card"),W=r("router-link"),ie=r("Select"),oe=r("Checkbox"),be=r("Dialog"),fe=d("tooltip");return v(),o("div",V,[u(S,{items:me.value},null,8,["items"]),u(Q,null,{title:c(()=>[g("div",C,[g("div",O,[a[8]||(a[8]=g("span",null,"Объекты",-1)),ve.value?h((v(),w(l,{key:0,icon:"pi pi-plus",rounded:"",outlined:"",size:"small",onClick:a[0]||(a[0]=e=>ee.value=!0),class:"create-table-btn"},null,512)),[[fe,"Добавить таблицу",void 0,{bottom:!0}]]):b("",!0)]),g("div",N,[u(i,{iconPosition:"left"},{default:c(()=>[u(t,{class:"pi pi-search"}),u(s,{ref_key:"searchInputRef",ref:le,modelValue:Z.value,"onUpdate:modelValue":a[1]||(a[1]=e=>Z.value=e),placeholder:"Быстрый поиск..."},null,8,["modelValue"])]),_:1}),u(n,{modelValue:te.value,"onUpdate:modelValue":a[2]||(a[2]=e=>te.value=e),options:se,optionLabel:"icon",optionValue:"value",allowEmpty:!1,class:"view-toggle"},{option:c(({option:e})=>[h(g("i",{class:I(e.icon)},null,2),[[fe,e.label,void 0,{top:!0}]])]),_:1},8,["modelValue"])])])]),content:c(()=>[X.value?(v(),o("div",q,[u(x)])):Y.value?(v(),o("div",T,[u(_,{severity:"error",closable:!1},{default:c(()=>[p(m(Y.value),1)]),_:1})])):(v(),o("div",J,[(v(!0),o(y,null,f(pe.value,e=>(v(),o("div",{key:e.name,class:"mb-4"},[g("div",{class:"category-header flex align-items-center justify-content-between mb-2 cursor-pointer",onClick:a=>async function(e){const a=ue.value.find(a=>a.name===e);a&&(a.open=!a.open,await async function(){try{const e={};ue.value.forEach(a=>{e[a.name]={open:a.open,tabs:a.tableIds}});const a=JSON.stringify(e);if(ne.value)await k.setObjectRequisites(ne.value,{t269:a});else{const e=await k.createObject("269","{_global_.user}",{t269:a},"1");e.obj&&(ne.value=e.obj,localStorage.setItem("dictionarySettingsId",e.obj))}G.add({severity:"success",summary:"Сохранено",detail:"Конфигурация категорий сохранена",life:2e3})}catch(e){G.add({severity:"warn",summary:"Предупреждение",detail:"Не удалось сохранить конфигурацию на сервер",life:3e3})}}())}(e.name)},[g("div",L,[g("h3",U,m(e.name),1),u(K,{value:e.tables.length,class:"category-badge"},null,8,["value"])]),g("i",{class:I([e.open?"pi pi-chevron-down":"pi pi-chevron-right","category-chevron"])},null,2)],8,D),h(g("div",$,[(v(!0),o(y,null,f(e.tables,e=>(v(),w(W,{key:e.id,to:`/integram/${de.value}/object/${e.id}`,class:"table-card-link"},{default:c(()=>[u(Q,{class:"table-card cursor-pointer"},{content:c(()=>[g("div",E,[h((v(),o("span",B,[p(m(e.name),1)])),[[fe,e.name,void 0,{top:!0}]])])]),_:2},1024)]),_:2},1032,["to"]))),128))],512),[[j,e.open&&"grid"===te.value]]),h(g("div",P,[(v(!0),o(y,null,f(e.tables,e=>(v(),w(W,{key:e.id,to:`/integram/${de.value}/object/${e.id}`,class:"table-list-item"},{default:c(()=>[a[9]||(a[9]=g("i",{class:"pi pi-table table-list-icon"},null,-1)),g("span",A,m(e.name),1),a[10]||(a[10]=g("i",{class:"pi pi-chevron-right table-list-arrow"},null,-1))]),_:2},1032,["to"]))),128))],512),[[j,e.open&&"list"===te.value]])]))),128)),0!==pe.value.length||X.value?b("",!0):(v(),o("div",M,[...a[11]||(a[11]=[g("i",{class:"pi pi-inbox text-5xl text-color-secondary mb-3"},null,-1),g("p",{class:"text-color-secondary"},"Таблицы не найдены",-1)])]))]))]),_:1}),u(be,{visible:ee.value,"onUpdate:visible":a[7]||(a[7]=e=>ee.value=e),modal:"",header:"Добавить таблицу",style:{width:"50rem"}},{footer:c(()=>[u(l,{label:"Отмена",text:"",onClick:a[6]||(a[6]=e=>ee.value=!1)}),u(l,{label:"Добавить",loading:ae.value,onClick:ye,disabled:!ce.value.name||!ce.value.baseTypeId},null,8,["loading","disabled"])]),default:c(()=>[g("div",R,[g("div",F,[a[12]||(a[12]=g("label",{for:"typeName"},"Название таблицы",-1)),u(s,{id:"typeName",modelValue:ce.value.name,"onUpdate:modelValue":a[3]||(a[3]=e=>ce.value.name=e),placeholder:"Введите название",class:"w-full"},null,8,["modelValue"])]),g("div",z,[a[13]||(a[13]=g("label",{for:"baseType"},"Базовый тип (первая колонка)",-1)),u(ie,{id:"baseType",modelValue:ce.value.baseTypeId,"onUpdate:modelValue":a[4]||(a[4]=e=>ce.value.baseTypeId=e),options:re,optionLabel:"label",optionValue:"value",placeholder:"Выберите базовый тип",class:"w-full"},null,8,["modelValue"])]),g("div",H,[u(oe,{id:"uniqueCheck",modelValue:ce.value.unique,"onUpdate:modelValue":a[5]||(a[5]=e=>ce.value.unique=e),binary:!0},null,8,["modelValue"]),a[14]||(a[14]=g("label",{for:"uniqueCheck"},"Сделать первую колонку уникальной",-1))])])]),_:1},8,["visible"])])}}},[["__scopeId","data-v-87561f3a"]]);export{K as default};
