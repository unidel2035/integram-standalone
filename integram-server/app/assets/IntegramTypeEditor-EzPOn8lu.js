import{r as e,J as a,K as l,P as i,y as t,u as s,c as n,o,a as r,e as d,F as u,d as c,g as p,A as v,h as y,b as m,j as f,w as b,t as g,G as h,f as T,aS as k,U as x,D as R,E,C as w,V as q,N as C,L as I}from"./index-m6PXRYQN.js";import{u as A}from"./useIntegramSession-Bx_TCvff.js";import{i as L}from"./integramApiClient-BsYdo77J.js";import{_}from"./_plugin-vue_export-helper-BCo6x5W8.js";import{I as O}from"./IntegramBreadcrumb-Br9bSfo2.js";import"./index-CcrxTH1M.js";import"./unifiedAuthService-6fZILgG8.js";const S=["d","stroke-dasharray"],U=["d","marker-end"],D=["cx","cy"],V={class:"legacy-toolbar"},N={class:"stats"},M={class:"types-container"},$=["data-type-id"],B=["onClick"],H={class:"type-icon"},P={class:"type-name"},j={class:"type-badges"},G={key:0,class:"badge unique",title:"Уникальный"},W={key:1,class:"badge ref",title:"Справочник"},z={key:0,class:"type-count"},F={key:0,class:"type-requisites"},Y=["onMouseenter"],K={class:"req-name"},X=["onClick","title"],Q={key:1,class:"type-preview"},J=["onMouseenter"],Z={class:"chip-type"},ee={key:0,class:"chip-ref"},ae={key:0,class:"more"},le=_({__name:"IntegramSchemaLegacy",props:{typesData:{type:Array,default:()=>[]}},emits:["open-table","edit-type"],setup(x,{emit:R}){const E=x,w=R,q=e(null),C=e(null),I=e({}),A=e({}),L=e(""),_=e(new Set),O=e(null),le=e([]),ie=e(!1);a(()=>{const e=new Map;return E.typesData.forEach(a=>{e.set(String(a.id),a)}),e});const te=a(()=>{let e=E.typesData||[];if(L.value){const a=L.value.toLowerCase();e=e.filter(e=>{var l,i;return(null==(l=e.name)?void 0:l.toLowerCase().includes(a))||(null==(i=e.requisites)?void 0:i.some(e=>{var l;return null==(l=e.name)?void 0:l.toLowerCase().includes(a)}))})}return e.sort((e,a)=>{var l,i;const t=(null==(l=e.requisites)?void 0:l.some(e=>e.isReference))?1:0,s=(null==(i=a.requisites)?void 0:i.some(e=>e.isReference))?1:0;return t!==s?s-t:(e.name||"").localeCompare(a.name||"")})}),se=a(()=>E.typesData.reduce((e,a)=>{var l;return e+((null==(l=a.requisites)?void 0:l.filter(e=>e.isReference).length)||0)},0));function ne(){}function oe(){L.value=""}function re(e){return e.isReferenceTable?"pi pi-book":e.isService?"pi pi-cog":"pi pi-table"}function de(e){return{short:"type-string",chars:"type-string",number:"type-number",signed:"type-number",date:"type-date",datetime:"type-date",boolean:"type-bool",memo:"type-text",reference:"type-ref"}[null==e?void 0:e.toLowerCase()]||"type-other"}function ue(e){return{short:"str",chars:"txt",number:"int",signed:"dec",date:"dt",datetime:"dt",boolean:"bool",memo:"memo",reference:"ref"}[null==e?void 0:e.toLowerCase()]||(null==e?void 0:e.slice(0,3))||"?"}function ce(e,a,l,i){const t=l>e,s=Math.abs(l-e),n=Math.abs(i-a),o=Math.max(50,Math.min(s/3,150));let r,d="right";if(t)r=`M ${e} ${a} C ${e+o} ${a}, ${l-o} ${i}, ${l} ${i}`;else{d="left";const t=Math.max(40,n/4);r=Math.abs(n)<50?`M ${e} ${a} C ${e+o} ${a-t}, ${l-o} ${i+t}, ${l} ${i}`:`M ${e} ${a} C ${e+o} ${a}, ${l-o} ${i}, ${l} ${i}`}return{path:r,direction:d}}function pe(e,a){if(!a.refTypeId)return;const l=a.refTypeId;O.value=l;const i=A.value[a.id]||I.value[e],t=I.value[l];if(!i||!t||!q.value)return;const s=q.value.getBoundingClientRect(),n=i.getBoundingClientRect(),o=t.getBoundingClientRect(),r=q.value.scrollTop||0,d=q.value.scrollLeft||0,u=n.right-s.left+d+5,c=n.top+n.height/2-s.top+r;let p,v;o.left+o.width/2>n.right?(p=o.left-s.left+d-5,v=o.top+o.height/2-s.top+r):(p=o.right-s.left+d+5,v=o.top+o.height/2-s.top+r);const{path:y,direction:m}=ce(u,c,p,v);le.value=[{id:`${e}-${a.id}-${l}`,x1:u,y1:c,x2:p,y2:v,path:y,direction:m,animated:!0}]}function ve(){ie.value||(O.value=null,le.value=[])}function ye(){ie.value=!ie.value,ie.value?me():(le.value=[],O.value=null)}async function me(){var e;await k();const a=[],l=null==(e=q.value)?void 0:e.getBoundingClientRect();if(!l)return;const i=q.value.scrollTop||0,t=q.value.scrollLeft||0;E.typesData.forEach(e=>{var s;const n=I.value[e.id];if(!n)return;const o=n.getBoundingClientRect();null==(s=e.requisites)||s.forEach(s=>{if(!s.isReference||!s.refTypeId)return;const n=I.value[s.refTypeId];if(!n)return;const r=n.getBoundingClientRect(),d=o.right-l.left+t+5,u=o.top+o.height/2-l.top+i;let c,p;r.left+r.width/2>o.right?(c=r.left-l.left+t-5,p=r.top+r.height/2-l.top+i):(c=r.right-l.left+t+5,p=r.top+r.height/2-l.top+i);const{path:v,direction:y}=ce(d,u,c,p);a.push({id:`${e.id}-${s.id}-${s.refTypeId}`,x1:d,y1:u,x2:c,y2:p,path:v,direction:y,animated:!1})})}),le.value=a}function fe(){E.typesData.forEach(e=>{var a;(null==(a=e.requisites)?void 0:a.length)>0&&_.value.add(e.id)}),_.value=new Set(_.value),ie.value&&me()}function be(){_.value.clear(),_.value=new Set(_.value),ie.value&&me()}function ge(){ie.value&&me()}return l(()=>{E.typesData.slice(0,3).forEach(e=>{var a;(null==(a=e.requisites)?void 0:a.length)>0&&_.value.add(e.id)}),q.value&&q.value.addEventListener("scroll",ge,{passive:!0});const e=new ResizeObserver(()=>{ge()});q.value&&e.observe(q.value)}),i(()=>{q.value&&q.value.removeEventListener("scroll",ge)}),(e,a)=>{const l=t("InputIcon"),i=t("InputText"),k=t("IconField"),x=t("Button"),R=t("Tag"),E=s("tooltip");return o(),n("div",{class:"integram-schema-legacy",ref_key:"containerRef",ref:q},[(o(),n("svg",{class:"connection-lines",ref_key:"svgRef",ref:C},[a[2]||(a[2]=d('<defs data-v-e1ea81d6><marker id="arrowhead-right" markerWidth="12" markerHeight="8" refX="10" refY="4" orient="auto" markerUnits="userSpaceOnUse" data-v-e1ea81d6><polygon points="0 0, 12 4, 0 8" fill="#ff9800" data-v-e1ea81d6></polygon></marker><marker id="arrowhead-left" markerWidth="12" markerHeight="8" refX="2" refY="4" orient="auto" markerUnits="userSpaceOnUse" data-v-e1ea81d6><polygon points="12 0, 0 4, 12 8" fill="#ff9800" data-v-e1ea81d6></polygon></marker><filter id="connection-glow" x="-50%" y="-50%" width="200%" height="200%" data-v-e1ea81d6><feGaussianBlur stdDeviation="2" result="blur" data-v-e1ea81d6></feGaussianBlur><feMerge data-v-e1ea81d6><feMergeNode in="blur" data-v-e1ea81d6></feMergeNode><feMergeNode in="SourceGraphic" data-v-e1ea81d6></feMergeNode></feMerge></filter></defs>',1)),(o(!0),n(u,null,c(le.value,e=>(o(),n("g",{key:e.id,class:"connection-group"},[r("path",{d:e.path,fill:"none",stroke:"rgba(255, 152, 0, 0.3)","stroke-width":"6","stroke-dasharray":e.animated?"8,4":"none"},null,8,S),r("path",{d:e.path,fill:"none",stroke:"#ff9800","stroke-width":"2","marker-end":"left"===e.direction?"url(#arrowhead-left)":"url(#arrowhead-right)",class:p(["connection-path",{animated:e.animated}])},null,10,U),r("circle",{cx:e.x1,cy:e.y1,r:"4",fill:"#ff9800"},null,8,D)]))),128))],512)),r("div",V,[v(k,{iconPosition:"left"},{default:b(()=>[v(l,{class:"pi pi-search"}),v(i,{modelValue:L.value,"onUpdate:modelValue":a[0]||(a[0]=e=>L.value=e),placeholder:"Поиск таблиц...",class:"search-input",onInput:ne},null,8,["modelValue"])]),_:1}),L.value?(o(),y(x,{key:0,icon:"pi pi-times",text:"",rounded:"",size:"small",onClick:oe})):m("",!0),a[3]||(a[3]=r("div",{class:"toolbar-divider"},null,-1)),f(v(x,{icon:ie.value?"pi pi-eye-slash":"pi pi-share-alt",label:ie.value?"Скрыть связи":"Все связи",severity:ie.value?"warning":"secondary",size:"small",outlined:"",onClick:ye},null,8,["icon","label","severity"]),[[E,"Показать/скрыть все связи между таблицами",void 0,{bottom:!0}]]),f(v(x,{icon:"pi pi-expand",label:"Развернуть",severity:"secondary",size:"small",outlined:"",onClick:fe},null,512),[[E,"Развернуть все таблицы",void 0,{bottom:!0}]]),f(v(x,{icon:"pi pi-minus",label:"Свернуть",severity:"secondary",size:"small",outlined:"",onClick:be},null,512),[[E,"Свернуть все таблицы",void 0,{bottom:!0}]]),r("div",N,[v(R,{value:`${te.value.length} таблиц`,severity:"info"},null,8,["value"]),v(R,{value:`${se.value} связей`,severity:"warning"},null,8,["value"])])]),r("div",M,[(o(!0),n(u,null,c(te.value,e=>{var l;return o(),n("div",{key:e.id,ref_for:!0,ref:a=>function(e,a){a&&(I.value[e]=a)}(e.id,a),class:p(["type-card",{highlighted:O.value===e.id,"is-reference-table":e.isReferenceTable}]),"data-type-id":e.id},[r("div",{class:"type-header",onClick:a=>{return l=e.id,_.value.has(l)?_.value.delete(l):_.value.add(l),void(_.value=new Set(_.value));var l}},[r("div",H,[r("i",{class:p(re(e))},null,2)]),r("div",P,g(e.name),1),r("div",j,[e.unique?(o(),n("span",G,"U")):m("",!0),e.isReferenceTable?(o(),n("span",W,"R")):m("",!0)]),(null==(l=e.requisites)?void 0:l.length)?(o(),n("div",z,g(e.requisites.length),1)):m("",!0),r("div",{class:"type-actions",onClick:a[1]||(a[1]=h(()=>{},["stop"]))},[f(v(x,{icon:"pi pi-database",text:"",rounded:"",size:"small",severity:"secondary",onClick:a=>w("open-table",e.id)},null,8,["onClick"]),[[E,"Просмотр данных",void 0,{bottom:!0}]]),f(v(x,{icon:"pi pi-cog",text:"",rounded:"",size:"small",severity:"secondary",onClick:a=>w("edit-type",e.id)},null,8,["onClick"]),[[E,"Редактировать структуру",void 0,{bottom:!0}]])]),r("i",{class:p(_.value.has(e.id)?"pi pi-chevron-up":"pi pi-chevron-down")},null,2)],8,B),_.value.has(e.id)?(o(),n("div",F,[(o(!0),n(u,null,c(e.requisites,a=>(o(),n("div",{key:a.id,class:p(["requisite-row",{"is-ref":a.isReference}]),onMouseenter:l=>a.isReference&&pe(e.id,a),onMouseleave:ve,ref_for:!0,ref:e=>a.isReference&&function(e,a){a&&(A.value[e]=a)}(a.id,e)},[r("span",{class:p(["req-type-badge",de(a.type)])},g(ue(a.type)),3),r("span",K,g(a.name),1),a.isReference&&a.refTypeName?(o(),n("a",{key:0,class:"req-ref-link",onClick:h(e=>function(e){const a=I.value[e];a&&(a.scrollIntoView({behavior:"smooth",block:"center"}),O.value=e,_.value.has(e)||(_.value.add(e),_.value=new Set(_.value)),setTimeout(()=>{O.value=null},2e3))}(a.refTypeId),["stop"]),title:`Перейти к: ${a.refTypeName}`}," → "+g(a.refTypeName),9,X)):m("",!0)],42,Y))),128))])):(o(),n("div",Q,[(o(!0),n(u,null,c((e.requisites||[]).slice(0,5),a=>(o(),n("span",{key:a.id,class:p(["preview-chip",{"is-ref":a.isReference}]),onMouseenter:l=>a.isReference&&pe(e.id,a),onMouseleave:ve},[r("span",Z,g(ue(a.type)),1),T(" "+g(a.name)+" ",1),a.refTypeName?(o(),n("span",ee,"("+g(a.refTypeName)+")",1)):m("",!0)],42,J))),128)),(e.requisites||[]).length>5?(o(),n("span",ae," +"+g(e.requisites.length-5),1)):m("",!0)]))],10,$)}),128))])],512)}}},[["__scopeId","data-v-e1ea81d6"]]),ie={class:"integram-schema-tree"},te={class:"tree-toolbar"},se={class:"stats"},ne={class:"tree-legend"},oe={class:"legend-item"},re={class:"node-label"},de={class:"node-badges"},ue=["onClick"],ce={key:0,class:"node-actions"},pe={key:0,class:"empty-state"},ve=_({__name:"IntegramSchemaTree",props:{typesData:{type:Array,default:()=>[]}},emits:["open-table","edit-type"],setup(l,{emit:i}){const u=l,c=i,k=e(""),R=e({}),E=e(null),w=a(()=>{const e=new Map;return u.typesData.forEach(a=>{e.set(String(a.id),a)}),e}),q=a(()=>{const e=new Set;return u.typesData.forEach(a=>{var l;null==(l=a.requisites)||l.forEach(a=>{a.isReference&&a.refTypeId&&e.add(String(a.refTypeId))})}),e}),C=a(()=>u.typesData.filter(e=>{var a;const l=q.value.has(String(e.id)),i=null==(a=e.requisites)?void 0:a.some(e=>e.isReference);return!l||e.isReferenceTable||!i})),I=a(()=>{const e=[],a=new Set;function l(e,i=0){var t,s;if(a.has(e.id)||i>10)return null;a.add(e.id);const n=[];return null==(t=e.requisites)||t.forEach(e=>{const t={key:`req-${e.id}`,label:e.name||e.alias||`Поле ${e.id}`,type:"requisite",reqType:O(e.type),isReference:e.isReference,refTarget:e.refTypeName,refTargetId:e.refTypeId,icon:e.isReference?"pi pi-link":"pi pi-minus",selectable:!1};if(e.isReference&&e.refTypeId){const s=w.value.get(String(e.refTypeId));if(s&&!a.has(s.id)){const e=l(s,i+1);e&&(t.children=[e])}}n.push(t)}),{key:`type-${e.id}`,label:e.name,type:"table",typeId:e.id,unique:e.unique,isReferenceTable:e.isReferenceTable,reqCount:(null==(s=e.requisites)?void 0:s.length)||0,icon:e.isReferenceTable?"pi pi-book":"pi pi-table",children:n.length>0?n:void 0}}return C.value.forEach(a=>{const i=l(a);i&&e.push(i)}),e.sort((e,a)=>(e.label||"").localeCompare(a.label||"")),e}),A=a(()=>u.typesData.length),L=a(()=>u.typesData.reduce((e,a)=>{var l;return e+((null==(l=a.requisites)?void 0:l.filter(e=>e.isReference).length)||0)},0));function _(e){return"table"===e.type?e.isReferenceTable?"pi pi-book":"pi pi-table":"requisite"===e.type?e.isReference?"pi pi-link":"pi pi-minus":"pi pi-circle"}function O(e){var a;return{short:"STR",chars:"TXT",number:"INT",signed:"DEC",date:"DATE",datetime:"DT",boolean:"BOOL",memo:"MEMO",reference:"REF",file:"FILE",html:"HTML"}[null==e?void 0:e.toLowerCase()]||(null==(a=null==e?void 0:e.slice(0,4))?void 0:a.toUpperCase())||"?"}function S(){const e={};!function a(l){l.forEach(l=>{e[l.key]=!0,l.children&&a(l.children)})}(I.value),R.value=e}function U(){R.value={}}function D(){k.value&&S()}function V(){k.value=""}function N(e){e.type}return x(()=>u.typesData,()=>{if(u.typesData.length>0&&0===Object.keys(R.value).length){const e={};I.value.slice(0,5).forEach(a=>{e[a.key]=!0}),R.value=e}},{immediate:!0}),(e,a)=>{const l=t("InputIcon"),i=t("InputText"),u=t("IconField"),x=t("Button"),w=t("Tag"),q=t("Badge"),O=t("Tree"),M=s("tooltip");return o(),n("div",ie,[r("div",te,[v(u,{iconPosition:"left"},{default:b(()=>[v(l,{class:"pi pi-search"}),v(i,{modelValue:k.value,"onUpdate:modelValue":a[0]||(a[0]=e=>k.value=e),placeholder:"Поиск таблиц...",class:"search-input",onInput:D},null,8,["modelValue"])]),_:1}),k.value?(o(),y(x,{key:0,icon:"pi pi-times",text:"",rounded:"",size:"small",onClick:V})):m("",!0),a[3]||(a[3]=r("div",{class:"toolbar-divider"},null,-1)),v(x,{icon:"pi pi-plus",label:"Развернуть все",severity:"secondary",size:"small",outlined:"",onClick:S}),v(x,{icon:"pi pi-minus",label:"Свернуть все",severity:"secondary",size:"small",outlined:"",onClick:U}),r("div",se,[v(w,{value:`${C.value.length} корневых`,severity:"info"},null,8,["value"]),v(w,{value:`${A.value} таблиц`,severity:"secondary"},null,8,["value"]),v(w,{value:`${L.value} связей`,severity:"warning"},null,8,["value"])])]),r("div",ne,[a[5]||(a[5]=d('<span class="legend-item" data-v-813d9a73><i class="pi pi-table" style="color:var(--p-primary-color);" data-v-813d9a73></i> Таблица </span><span class="legend-item" data-v-813d9a73><i class="pi pi-book" style="color:#ff9800;" data-v-813d9a73></i> Справочник </span><span class="legend-item" data-v-813d9a73><i class="pi pi-link" style="color:#9c27b0;" data-v-813d9a73></i> Ссылка </span>',3)),r("span",oe,[v(q,{value:"U",severity:"info",size:"small"}),a[4]||(a[4]=T(" Уникальный ",-1))])]),v(O,{expandedKeys:R.value,"onUpdate:expandedKeys":a[1]||(a[1]=e=>R.value=e),value:I.value,filter:!!k.value,filterBy:"label",filterMode:"lenient",selectionMode:"single",selectionKeys:E.value,"onUpdate:selectionKeys":a[2]||(a[2]=e=>E.value=e),class:"schema-tree",onNodeSelect:N},{default:b(({node:e})=>{return[r("div",{class:p(["tree-node-content",{"is-table":"table"===e.type,"is-reference":"reference"===e.type,"is-requisite":"requisite"===e.type,"is-ref-requisite":e.isReference}])},[r("i",{class:p([_(e),"node-icon"])},null,2),r("span",re,g(e.label),1),r("div",de,[e.reqType?(o(),n("span",{key:0,class:p(["req-type-badge",(a=e.reqType,{STR:"type-string",TXT:"type-string",INT:"type-number",DEC:"type-number",DATE:"type-date",DT:"type-date",BOOL:"type-bool",MEMO:"type-text",REF:"type-ref",FILE:"type-file",HTML:"type-html"}[a]||"type-other")])},g(e.reqType),3)):m("",!0),e.unique?f((o(),y(q,{key:1,value:"U",severity:"info",size:"small"},null,512)),[[M,"Уникальный",void 0,{top:!0}]]):m("",!0),e.refTarget?(o(),n("span",{key:2,class:"ref-target",onClick:h(a=>function(e){const a=`type-${e}`;R.value={...R.value,[a]:!0},E.value={[a]:!0},setTimeout(()=>{const a=document.querySelector(`[data-pc-section="label"]:has(+ [data-type-id="${e}"])`);a&&a.scrollIntoView({behavior:"smooth",block:"center"})},100)}(e.refTargetId),["stop"])}," → "+g(e.refTarget),9,ue)):m("",!0),e.reqCount?f((o(),y(q,{key:3,value:e.reqCount,severity:"secondary",size:"small"},null,8,["value"])),[[M,"Количество полей",void 0,{top:!0}]]):m("",!0)]),"table"===e.type?(o(),n("div",ce,[f(v(x,{icon:"pi pi-database",text:"",rounded:"",size:"small",severity:"secondary",onClick:h(a=>c("open-table",e.typeId),["stop"])},null,8,["onClick"]),[[M,"Просмотр данных",void 0,{top:!0}]]),f(v(x,{icon:"pi pi-cog",text:"",rounded:"",size:"small",severity:"secondary",onClick:h(a=>c("edit-type",e.typeId),["stop"])},null,8,["onClick"]),[[M,"Редактировать",void 0,{top:!0}]])])):m("",!0)],2)];var a}),_:1},8,["expandedKeys","value","filter","selectionKeys"]),0===I.value.length?(o(),n("div",pe,[...a[6]||(a[6]=[r("i",{class:"pi pi-inbox"},null,-1),r("p",null,"Нет данных для отображения",-1)])])):m("",!0)])}}},[["__scopeId","data-v-813d9a73"]]),ye={class:"integram-type-editor integram-touch-friendly"},me={class:"flex align-items-center justify-content-between"},fe={class:"flex gap-2 align-items-center ml-auto"},be={key:0,class:"legacy-view-container"},ge={key:1,class:"tree-view-container"},he={key:2},Te={class:"integram-badge-legend mb-3"},ke={class:"legend-item"},xe={class:"legend-item"},Re={class:"legend-item"},Ee={class:"legend-item"},we={class:"grid"},qe={class:"col-12 md:col-4"},Ce={class:"field"},Ie={class:"col-12 md:col-3"},Ae={class:"field"},Le={class:"text-sm text-color-secondary"},_e={class:"col-12 md:col-2 flex align-items-end pb-3"},Oe={class:"flex align-items-center gap-2"},Se={class:"col-12 md:col-3 flex align-items-end"},Ue={key:0},De={class:"flex gap-2 align-items-center flex-wrap"},Ve={class:"integram-actions"},Ne={key:0,class:"flex justify-content-center p-5"},Me={key:1,class:"types-list"},$e=["data-type-id"],Be={class:"flex justify-content-between align-items-center"},He={class:"flex align-items-center gap-2 flex-wrap"},Pe={class:"font-bold"},je=["title"],Ge={class:"chip-type"},We={key:0,class:"ref-name"},ze={key:3,class:"text-color-secondary text-sm"},Fe={class:"flex gap-2 align-items-center"},Ye={key:0},Ke={class:"grid mb-3"},Xe={class:"col-12 md:col-4"},Qe={class:"col-12 md:col-4"},Je={class:"col-12 md:col-4"},Ze={class:"integram-actions mb-3"},ea={class:"flex justify-content-between align-items-center w-full"},aa={key:0},la={key:0,class:"text-sm ml-1"},ia={class:"flex gap-1"},ta={class:"integram-actions"},sa={key:1,class:"text-center p-4 text-color-secondary"},na={key:0,class:"text-center p-5 text-color-secondary"},oa={class:"flex flex-column gap-3"},ra={class:"field"},da={class:"field"},ua={key:0,class:"field-checkbox"},ca={key:1,class:"field-checkbox"},pa={class:"field"},va={class:"field"},ya={for:"reqDefault"},ma={key:0,class:"flex flex-column gap-2"},fa={class:"p-3 surface-ground border-round"},ba={class:"m-0 pl-4 text-sm"},ga={key:1,class:"flex gap-2"},ha={key:2,class:"text-color-secondary"},Ta={class:"integram-actions justify-content-end w-full"},ka={class:"flex align-items-center gap-3"},xa={class:"integram-actions justify-content-end w-full"},Ra={class:"flex flex-column gap-3"},Ea={class:"p-3 surface-ground border-round"},wa={class:"text-lg"},qa={class:"field"},Ca={class:"field-checkbox"},Ia={class:"integram-actions justify-content-end w-full"},Aa={class:"flex flex-column gap-3"},La={class:"p-3 surface-ground border-round"},_a={class:"text-lg"},Oa={class:"text-color-secondary"},Sa={class:"field"},Ua={class:"field-checkbox"},Da={class:"integram-actions justify-content-end w-full"},Va=_({__name:"IntegramTypeEditor",props:{session:{type:Object,required:!0}},emits:["view-table","refresh"],setup(i,{emit:d}){const h=i,k=d,x=R(),C=e("legacy"),I=[{value:"legacy",label:"Связи",icon:"pi pi-share-alt"},{value:"tree",label:"Дерево",icon:"pi pi-sitemap"},{value:"list",label:"Список",icon:"pi pi-list"}],A=[{value:"SHORT",label:"SHORT",description:"Короткая строка (до 127 символов)",example:"Интеграл"},{value:"CHARS",label:"CHARS",description:"Строка без ограничения длины",example:""},{value:"DATE",label:"DATE",description:"Дата",example:"30.10.2019"},{value:"NUMBER",label:"NUMBER",description:"Целое число",example:"100500"},{value:"SIGNED",label:"SIGNED",description:"Число с десятичной частью",example:"12.50"},{value:"BOOLEAN",label:"BOOLEAN",description:"Логическое значение (Да/Нет)",example:"true"},{value:"MEMO",label:"MEMO",description:"Многострочный текст",example:""},{value:"DATETIME",label:"DATETIME",description:"Дата и время",example:"05.11.2019 13:35:40"},{value:"FILE",label:"FILE",description:"Файл",example:"document.pdf"},{value:"HTML",label:"HTML",description:"HTML-текст",example:"<span>777</span>"},{value:"BUTTON",label:"BUTTON",description:"Действие (кнопка) над записью",example:""},{value:"PWD",label:"PWD",description:"Пароль (маскируется)",example:"******"},{value:"GRANT",label:"GRANT",description:"Объект системы (выбор из таблиц)",example:"",hidden:!0},{value:"CALCULATABLE",label:"CALCULATABLE",description:"Вычисляемое поле (read-only, автозаполнение)",example:"[TODAY], [USER]"},{value:"REPORT_COLUMN",label:"REPORT_COLUMN",description:"Колонка запроса",example:"",hidden:!0},{value:"PATH",label:"PATH",description:"Путь к файлу",example:"/path/to/file"},{value:"0",label:"------------",description:"Разделитель закладок",example:""}],_=A.filter(e=>!e.hidden),O=_,S={HTML:2,SHORT:3,DATETIME:4,GRANT:5,PWD:6,BUTTON:7,CHARS:8,DATE:9,FILE:10,BOOLEAN:11,MEMO:12,NUMBER:13,SIGNED:14,CALCULATABLE:15,REPORT_COLUMN:16,PATH:17,0:0},U=E({name:"",baseType:"SHORT",unique:!1}),D=e([]),V=e([]),N=e(""),M=e(!1),$=e(!1),B=e(!1),H=E({list:!1,create:!1,delete:!1,createSubordinate:!1,editType:!1}),P=E({visible:!1,mode:"add",typeId:null,data:{id:null,name:"",type:"SHORT",nullable:!0,multi:!1,alias:"",defaultValue:""}}),j={DATE:[{label:"[TODAY] — сегодня",value:"[TODAY]"},{label:"[YESTERDAY] — вчера",value:"[YESTERDAY]"},{label:"[TOMORROW] — завтра",value:"[TOMORROW]"},{label:"[MONTH_AGO] — месяц назад",value:"[MONTH_AGO]"},{label:"[WEEK_AGO] — неделя назад",value:"[WEEK_AGO]"},{label:"[MONTH_PLUS] — месяц вперёд",value:"[MONTH_PLUS]"}],DATETIME:[{label:"[NOW] — текущие дата и время",value:"[NOW]"}],REFERENCE:[{label:"[USER_ID] — ID текущего пользователя",value:"[USER_ID]"}],CALCULATABLE:[{label:"--- Дата/время ---",value:"",disabled:!0},{label:"[TODAY] — сегодня",value:"[TODAY]"},{label:"[NOW] — дата и время",value:"[NOW]"},{label:"[YESTERDAY] — вчера",value:"[YESTERDAY]"},{label:"[TOMORROW] — завтра",value:"[TOMORROW]"},{label:"[MONTH_AGO] — месяц назад",value:"[MONTH_AGO]"},{label:"[WEEK_AGO] — неделя назад",value:"[WEEK_AGO]"},{label:"[MONTH_PLUS] — месяц вперёд",value:"[MONTH_PLUS]"},{label:"--- Пользователь ---",value:"",disabled:!0},{label:"[USER] — логин пользователя",value:"[USER]"},{label:"[USER_ID] — ID пользователя",value:"[USER_ID]"},{label:"[ROLE] — название роли",value:"[ROLE]"},{label:"[ROLE_ID] — ID роли",value:"[ROLE_ID]"},{label:"--- Система ---",value:"",disabled:!0},{label:"[REMOTE_ADDR] — IP адрес",value:"[REMOTE_ADDR]"},{label:"[HTTP_USER_AGENT] — браузер",value:"[HTTP_USER_AGENT]"},{label:"[HTTP_REFERER] — откуда пришёл",value:"[HTTP_REFERER]"},{label:"[HTTP_HOST] — хост сервера",value:"[HTTP_HOST]"},{label:"[REQUEST_URI] — URL запроса",value:"[REQUEST_URI]"},{label:"[TSHIFT] — часовой пояс",value:"[TSHIFT]"}]};function G(e){return j[e]||[]}const W=E({visible:!1,type:null,item:null,itemName:""}),z=E({visible:!1,parentType:null,name:"",unique:!1}),F=E({visible:!1,type:null,name:"",baseType:"SHORT",unique:!1,originalName:""}),Y=a(()=>U.name&&U.baseType),K=a(()=>{let e=Array.isArray(D.value)?D.value:[];if(N.value){const a=N.value.toLowerCase();e=e.filter(e=>e.name&&e.name.toLowerCase().includes(a))}return M.value||(e=e.filter(e=>!e.isService)),$.value||(e=e.filter(e=>!e.isSimple)),e}),X={0:"tab",1:"short",2:"html",3:"short",4:"datetime",5:"grant",6:"pwd",7:"button",8:"chars",9:"date",10:"file",11:"boolean",12:"memo",13:"number",14:"signed",15:"calculatable",16:"path",17:"report_column",18:"user",19:"connect",20:"time"},Q=new Set(Object.keys(X));function J(e){return X[String(e)]||"reference"}function Z(e){const a=String(e);return Q.has(a)||parseInt(a)<=20}async function ee(){var e,a;H.list=!0;try{h.session.database&&L.setDatabase(h.session.database);const e=await L.getTypeEditorData();if(e&&e.edit_types){const a=e.edit_types;Object.keys(a).slice(0,10).forEach(e=>{const l=a[e];Array.isArray(l)});const l=(a[7]||a.req_t||[]).map((e,a)=>({idx:a,val:parseInt(e)||0})).filter(e=>e.val>20).slice(0,5);l.length>0&&l.forEach(({idx:e,val:l})=>{(a[0]||[])[e],(a[4]||[])[e]});const i=a[0]||a.id||[],t=a[1]||a.t||[],s=a[2]||a.ref_val||[],n=a[3]||a.uniq||[],o=a[4]||a.val||[],r=a[5]||a.ord||[],d=a[6]||a.req_id||[],u=a[7]||a.req_t||[],c=(a[8]||a.attrs,a[9]||a.reft||[]),p=new Map,v=[];for(let e=0;e<i.length;e++){const a=String(i[e]),l=t[e],y=s[e],m=n[e],f=o[e]||"",b=r[e],g=d[e],h=(c[e],void 0!==b&&""!==b&&null!==b);if(h||p.has(a)){if(h&&p.has(a)){const i=p.get(a),t=u[e],s=t&&!Z(t),n=s?String(t):null;i.requisites.push({id:g?String(g):`${a}-req-${e}`,name:f,type:s?"reference":J(l),baseTypeId:l,refTypeId:n,isReference:s,order:b})}else if(!p.has(a)){v.push(a);const e=y&&""!==y&&"0"!==y&&0!==y;p.set(a,{id:a,name:f,baseType:l,refVal:y,unique:1===m||"1"===m||!0===m,requisites:[],isService:0===l||"0"===l,isSimple:!y||""===y||"0"===y||0===y,isReferenceTable:e})}}else{v.push(a);const e=y&&""!==y&&"0"!==y&&0!==y;p.set(a,{id:a,name:f,baseType:l,refVal:y,unique:1===m||"1"===m||!0===m,requisites:[],isService:0===l||"0"===l,isSimple:!y||""===y||"0"===y||0===y,isReferenceTable:e})}}p.forEach(e=>{e.requisites.forEach(e=>{e.refTypeId&&p.has(e.refTypeId)&&(e.refTypeName=p.get(e.refTypeId).name)})});const y=v.map(e=>p.get(e));if(D.value=y,y.reduce((e,a)=>e+a.requisites.length,0),y.reduce((e,a)=>e+a.requisites.filter(e=>e.isReference).length,0)>0){let e=0;for(const a of y){for(const l of a.requisites)l.isReference&&e<5&&e++;if(e>=5)break}}else{const e=[];for(const a of y){for(const l of a.requisites.slice(0,2))e.push(`${a.name}.${l.name}: baseTypeId=${l.baseTypeId}, refTypeId=${l.refTypeId}`);if(e.length>=5)break}}}else e&&e.types?D.value=Array.isArray(e.types)?e.types:[]:D.value=[]}catch(l){D.value=[],x.add({severity:"error",summary:"Ошибка",detail:(null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.details)||l.message||"Не удалось загрузить типы",life:5e3})}finally{H.list=!1}}async function ae(){var e,a;H.create=!0;try{h.session.database&&L.setDatabase(h.session.database);const e=_.find(e=>e.value===U.baseType),a=e?e.value:U.baseType;await L.createType(U.name,a,U.unique)&&(x.add({severity:"success",summary:"Успешно",detail:`Тип "${U.name}" создан`,life:3e3}),U.name="",U.baseType="SHORT",U.unique=!1,ee())}catch(l){x.add({severity:"error",summary:"Ошибка",detail:(null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.details)||l.message||"Не удалось создать тип",life:5e3})}finally{H.create=!1}}function ie(){}function te(){N.value=""}function se(){M.value=!M.value}function ne(){$.value=!$.value}function oe(e){const a=A.find(a=>a.value===e);return a?a.label:e}async function re(){var e,a,l;if(F.name&&F.type){H.editType=!0;try{h.session.database&&L.setDatabase(h.session.database),F.baseType;const a=(null==(e=(await L.getTypeMetadata(F.type.id)).type)?void 0:e.t)||F.type.baseTypeId||3;await L.saveType(F.type.id,F.name,a,F.unique),x.add({severity:"success",summary:"Тип обновлён",detail:`Тип "${F.name}" успешно сохранён`,life:3e3}),F.visible=!1,await ee(),k("refresh")}catch(i){x.add({severity:"error",summary:"Ошибка сохранения",detail:(null==(l=null==(a=i.response)?void 0:a.data)?void 0:l.details)||i.message||"Не удалось сохранить тип",life:5e3})}finally{H.editType=!1}}else x.add({severity:"warn",summary:"Ошибка",detail:"Название типа не может быть пустым",life:3e3})}async function de(){var e,a;if(z.name&&z.parentType){H.createSubordinate=!0;try{h.session.database&&L.setDatabase(h.session.database);const e=z.parentType.id;await L.createType(z.name,e,z.unique)&&(x.add({severity:"success",summary:"Успешно",detail:`Подчинённый тип "${z.name}" создан для "${z.parentType.name}"`,life:3e3}),z.visible=!1,z.name="",z.parentType=null,ee())}catch(l){x.add({severity:"error",summary:"Ошибка",detail:(null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.details)||l.message||"Не удалось создать подчинённый тип",life:5e3})}finally{H.createSubordinate=!1}}}function ue(e){k("view-table",e)}function ce(e){D.value.find(a=>a.id===e)&&(C.value="list",V.value.includes(e)||V.value.push(e),setTimeout(()=>{const a=document.querySelector(`[data-type-id="${e}"]`);a&&a.scrollIntoView({behavior:"smooth",block:"center"})},100))}async function pe(){W.visible=!1,"type"===W.type?await async function(e){var a,l;H.delete=!0;try{h.session.database&&L.setDatabase(h.session.database),await L.deleteType(e.id)&&(x.add({severity:"success",summary:"Успешно",detail:`Тип "${e.name}" удален`,life:3e3}),ee())}catch(i){x.add({severity:"error",summary:"Ошибка",detail:(null==(l=null==(a=i.response)?void 0:a.data)?void 0:l.details)||i.message||"Не удалось удалить тип",life:5e3})}finally{H.delete=!1}}(W.item):"requisite"===W.type&&await async function(e,a){var l,i;try{h.session.database&&L.setDatabase(h.session.database),await L.deleteRequisite(a.id)&&(x.add({severity:"success",summary:"Успешно",detail:`Реквизит "${a.name}" удален`,life:3e3}),ee())}catch(t){x.add({severity:"error",summary:"Ошибка",detail:(null==(i=null==(l=t.response)?void 0:l.data)?void 0:i.details)||t.message||"Не удалось удалить реквизит",life:5e3})}}(W.item.type,W.item.requisite)}async function Va(){var e,a,l;P.visible=!1;try{if(h.session.database&&L.setDatabase(h.session.database),"add"===P.mode){const e=(l=P.data.type,S[l]||l),a=await L.addRequisite(P.typeId,e);a&&a.id&&P.data.name&&await L.saveRequisiteAlias(a.id,P.data.name),a&&a.id&&!P.data.nullable&&await L.toggleRequisiteNull(a.id),a&&a.id&&P.data.multi&&await L.toggleRequisiteMulti(a.id),a&&a.id&&P.data.defaultValue&&await L.saveRequisiteDefaultValue(a.id,P.data.defaultValue)}else P.data.name&&await L.saveRequisiteAlias(P.data.id,P.data.name),void 0!==P.data.defaultValue&&await L.saveRequisiteDefaultValue(P.data.id,P.data.defaultValue||"");x.add({severity:"success",summary:"Успешно",detail:"add"===P.mode?"Реквизит добавлен":"Реквизит обновлен",life:3e3}),ee()}catch(i){x.add({severity:"error",summary:"Ошибка",detail:(null==(a=null==(e=i.response)?void 0:e.data)?void 0:a.details)||i.message||"Не удалось сохранить реквизит",life:5e3})}}function Na(){D.value.some(e=>e.name.toLowerCase()===U.name.toLowerCase().trim()&&e.baseType===U.baseType)&&x.add({severity:"warn",summary:"Дубликат",detail:"Тип с таким именем уже существует",life:2e3})}return l(()=>{h.session&&h.session.sessionId&&(h.session.database&&L.setDatabase(h.session.database),ee())}),(e,a)=>{const l=t("SelectButton"),i=t("Tag"),d=t("Badge"),h=t("InputText"),R=t("Select"),E=t("Checkbox"),S=t("Button"),j=t("Column"),X=t("DataTable"),Q=t("Panel"),J=t("InputIcon"),Z=t("IconField"),Ma=t("ProgressSpinner"),$a=t("Divider"),Ba=t("Card"),Ha=t("Dialog"),Pa=t("Message"),ja=s("tooltip");return o(),n("div",ye,[v(Ba,{class:"mb-3"},{title:b(()=>[r("div",me,[a[25]||(a[25]=r("span",null,"Структура",-1)),r("div",fe,[v(l,{modelValue:C.value,"onUpdate:modelValue":a[0]||(a[0]=e=>C.value=e),options:I,optionLabel:"icon",optionValue:"value",allowEmpty:!1,class:"view-toggle"},{option:b(({option:e})=>[f(r("i",{class:p(e.icon)},null,2),[[ja,e.label,void 0,{top:!0}]])]),_:1},8,["modelValue"])])])]),content:b(()=>["legacy"===C.value?(o(),n("div",be,[v(le,{"types-data":D.value,onOpenTable:ue,onEditType:ce},null,8,["types-data"])])):"tree"===C.value?(o(),n("div",ge,[v(ve,{"types-data":D.value,onOpenTable:ue,onEditType:ce},null,8,["types-data"])])):"list"===C.value?(o(),n("div",he,[r("div",Te,[r("div",ke,[v(i,{severity:"info",value:"Уникальный"}),a[26]||(a[26]=r("span",{class:"legend-label"},"— первый столбец уникален",-1))]),r("div",xe,[v(d,{value:"Служебный",severity:"secondary"}),a[27]||(a[27]=r("span",{class:"legend-label"},"— системный тип",-1))]),r("div",Re,[v(d,{value:"Простой"}),a[28]||(a[28]=r("span",{class:"legend-label"},"— базовый тип данных",-1))]),r("div",Ee,[v(d,{value:"5",severity:"secondary"}),a[29]||(a[29]=r("span",{class:"legend-label"},"— количество реквизитов",-1))])]),v(Q,{header:"Добавить тип",class:"mb-2"},{default:b(()=>[r("div",we,[r("div",qe,[r("div",Ce,[a[30]||(a[30]=r("label",{for:"newTypeName"},"Название типа *",-1)),v(h,{id:"newTypeName",modelValue:U.name,"onUpdate:modelValue":a[1]||(a[1]=e=>U.name=e),placeholder:"Новый тип",class:"w-full",onKeyup:Na},null,8,["modelValue"])])]),r("div",Ie,[r("div",Ae,[a[31]||(a[31]=r("label",{for:"baseType"},"Базовый тип *",-1)),v(R,{id:"baseType",modelValue:U.baseType,"onUpdate:modelValue":a[2]||(a[2]=e=>U.baseType=e),options:w(_),optionLabel:"label",optionValue:"value",placeholder:"Выберите базовый тип",class:"w-full"},{option:b(({option:e})=>[r("div",null,[r("strong",null,g(e.label),1),r("div",Le,g(e.description),1)])]),_:1},8,["modelValue","options"])])]),r("div",_e,[r("div",Oe,[v(E,{id:"newTypeUnique",modelValue:U.unique,"onUpdate:modelValue":a[3]||(a[3]=e=>U.unique=e),binary:!0},null,8,["modelValue"]),a[32]||(a[32]=r("label",{for:"newTypeUnique"},"Уникальный",-1))])]),r("div",Se,[v(S,{icon:"pi pi-plus",label:"Добавить",onClick:ae,loading:H.create,disabled:!Y.value,class:"w-full","aria-label":"Добавить новый тип"},null,8,["loading","disabled"])])]),v(Q,{header:"Описание базовых типов",toggleable:!0,collapsed:!0,class:"mt-3"},{default:b(()=>[v(X,{value:A,stripedRows:""},{default:b(()=>[v(j,{field:"label",header:"Тип",style:{width:"150px"}},{body:b(({data:e})=>[r("span",{class:p({"text-color-secondary":e.hidden})},g(e.label),3),e.hidden?(o(),y(i,{key:0,value:"системный",severity:"secondary",class:"ml-2",style:{"font-size":"0.7rem"}})):m("",!0)]),_:1}),v(j,{field:"description",header:"Описание"}),v(j,{field:"example",header:"Пример",style:{width:"200px"}},{body:b(({data:e})=>[e.example?(o(),n("code",Ue,g(e.example),1)):m("",!0)]),_:1})]),_:1})]),_:1})]),_:1}),v(Q,{header:"Поиск типов",toggleable:!0,collapsed:B.value,class:"mb-2"},{default:b(()=>[r("div",De,[v(Z,{iconPosition:"left",class:"flex-1"},{default:b(()=>[v(J,{class:"pi pi-search"}),v(h,{modelValue:N.value,"onUpdate:modelValue":a[4]||(a[4]=e=>N.value=e),placeholder:"Поиск по названию типа...",class:"w-full",onInput:ie,"aria-label":"Поиск типов"},null,8,["modelValue"])]),_:1}),v(S,{icon:"pi pi-times",label:"Очистить",onClick:te,severity:"secondary",outlined:"","aria-label":"Очистить поиск"}),r("div",Ve,[v(S,{label:M.value?"Скрыть служебные":"Показать служебные",onClick:se,outlined:"","aria-label":"Переключить отображение служебных типов"},null,8,["label"]),v(S,{label:$.value?"Скрыть простые":"Показать простые",onClick:ne,outlined:"","aria-label":"Переключить отображение простых типов"},null,8,["label"])])])]),_:1},8,["collapsed"]),v(Q,{header:"Типы данных",class:"mb-3"},{default:b(()=>[H.list?(o(),n("div",Ne,[v(Ma)])):(o(),n("div",Me,[(o(!0),n(u,null,c(K.value,e=>(o(),n("div",{key:e.id,class:"type-card mb-3","data-type-id":e.id},[v(Ba,null,{title:b(()=>{var a;return[r("div",Be,[r("div",He,[e.unique?(o(),y(i,{key:0,severity:"info",value:"Уникальный"})):m("",!0),r("span",Pe,g(e.name),1),e.isService?(o(),y(d,{key:1,value:"Служебный",severity:"secondary"})):m("",!0),e.isSimple?(o(),y(d,{key:2,value:"Простой"})):m("",!0),(o(!0),n(u,null,c((e.requisites||[]).slice(0,5),e=>(o(),n("span",{key:e.id,class:p(["requisite-chip",{"ref-chip":e.isReference}]),title:e.refTypeName?`Ссылка на: ${e.refTypeName}`:e.type},[r("span",Ge,g(e.type),1),T(g(e.name)+" ",1),e.refTypeName?(o(),n("span",We,"("+g(e.refTypeName)+")",1)):m("",!0)],10,je))),128)),(e.requisites||[]).length>5?(o(),n("span",ze," +"+g(e.requisites.length-5)+" ещё ",1)):m("",!0)]),r("div",Fe,[(null==(a=e.requisites)?void 0:a.length)?(o(),y(d,{key:0,value:e.requisites.length,severity:"secondary"},null,8,["value"])):m("",!0),v(S,{icon:V.value.includes(e.id)?"pi pi-chevron-up":"pi pi-chevron-down",onClick:a=>function(e){const a=V.value.indexOf(e);a>-1?V.value.splice(a,1):V.value.push(e)}(e.id),text:"",rounded:""},null,8,["icon","onClick"])])])]}),content:b(()=>[V.value.includes(e.id)?(o(),n("div",Ye,[r("div",Ke,[r("div",Xe,[a[33]||(a[33]=r("span",{class:"font-semibold"},"ID:",-1)),a[34]||(a[34]=T()),r("code",null,g(e.id),1)]),r("div",Qe,[a[35]||(a[35]=r("span",{class:"font-semibold"},"Базовый тип:",-1)),T(" "+g(oe(e.baseType)),1)]),r("div",Je,[a[36]||(a[36]=r("span",{class:"font-semibold"},"Реквизитов:",-1)),T(" "+g((e.requisites||[]).length),1)])]),v($a),r("div",Ze,[v(S,{icon:"pi pi-pencil",label:"Редактировать тип",onClick:a=>function(e){F.type=e,F.name=e.name,F.baseType=e.baseType||e.base||"SHORT",F.unique=e.unique||!1,F.originalName=e.name,F.visible=!0}(e),outlined:"","aria-label":"Редактировать тип"},null,8,["onClick"]),v(S,{icon:"pi pi-eye",label:"Просмотр таблицы",onClick:a=>{return l=e.id,void k("view-table",l);var l},outlined:"","aria-label":"Открыть таблицу"},null,8,["onClick"]),f(v(S,{icon:"pi pi-sitemap",label:"Создать подчинённый",onClick:a=>{return l=e,z.parentType=l,z.name="",z.unique=!1,void(z.visible=!0);var l},outlined:"",severity:"secondary","aria-label":"Создать подчинённый тип"},null,8,["onClick"]),[[ja,"Создать подчинённый тип (таблица со ссылкой на родителя)",void 0,{top:!0}]]),f(v(S,{icon:"pi pi-link",label:"Создать ссылку",onClick:a=>async function(e){var a,l;try{await L.createTypeReference(e.id),x.add({severity:"success",summary:"Ссылка создана",detail:`Тип "${e.name}" теперь можно использовать как справочник в других таблицах`,life:3e3}),await ee()}catch(i){x.add({severity:"error",summary:"Ошибка",detail:(null==(l=null==(a=i.response)?void 0:a.data)?void 0:l.details)||i.message||"Не удалось создать ссылку на тип",life:5e3})}}(e),outlined:"",severity:"secondary","aria-label":"Создать ссылку на этот тип"},null,8,["onClick"]),[[ja,"Использовать этот тип как справочник (добавить колонку-ссылку в другой таблице)",void 0,{top:!0}]]),e.hasReferences?m("",!0):(o(),y(S,{key:0,icon:"pi pi-trash",label:"Удалить тип",onClick:a=>function(e){W.type="type",W.item=e,W.itemName=e.name,W.visible=!0}(e),severity:"danger",outlined:"","aria-label":"Удалить тип"},null,8,["onClick"]))]),v(Q,{header:"Реквизиты (колонки)",class:"requisites-panel"},{header:b(()=>[r("div",ea,[a[37]||(a[37]=r("span",null,"Реквизиты (колонки)",-1)),v(S,{icon:"pi pi-plus",label:"Добавить реквизит",onClick:a=>function(e){P.mode="add",P.typeId=e.id,P.data={id:null,name:"",type:"SHORT",nullable:!0,multi:!1,alias:"",defaultValue:""},P.visible=!0}(e),"aria-label":"Добавить новый реквизит"},null,8,["onClick"])])]),default:b(()=>[e.requisites&&e.requisites.length>0?(o(),n("div",aa,[v(X,{value:e.requisites,stripedRows:""},{default:b(()=>[v(j,{field:"order",header:"#",style:{width:"50px"}},{body:b(({index:e})=>[T(g(e+1),1)]),_:1}),v(j,{field:"name",header:"Название"}),v(j,{field:"type",header:"Тип"},{body:b(({data:e})=>[r("span",{class:p({"text-orange-600":e.isReference})},[T(g(e.type)+" ",1),e.refTypeName?(o(),n("span",la," → "+g(e.refTypeName),1)):m("",!0)],2)]),_:2},1024),v(j,{field:"attributes",header:"Атрибуты"},{body:b(({data:e})=>[r("div",ia,[!1===e.nullable?(o(),y(i,{key:0,severity:"warning",value:"NOT NULL"})):m("",!0),e.multi?(o(),y(i,{key:1,severity:"info",value:"MULTI"})):m("",!0),e.alias?(o(),y(i,{key:2,value:"ALIAS"})):m("",!0)])]),_:1}),v(j,{header:"Действия",style:{width:"180px"}},{body:b(({data:a})=>[r("div",ta,[f(v(S,{icon:"pi pi-arrow-up",onClick:e=>async function(e,a){var l,i;try{await L.moveRequisiteUp(a.id),x.add({severity:"success",summary:"Реквизит перемещён",detail:`"${a.alias||a.name}" перемещён выше`,life:2e3}),await ee()}catch(t){x.add({severity:"error",summary:"Ошибка",detail:(null==(i=null==(l=t.response)?void 0:l.data)?void 0:i.details)||t.message||"Не удалось переместить реквизит",life:5e3})}}(0,a),text:"",rounded:"","aria-label":"Переместить реквизит выше"},null,8,["onClick"]),[[ja,"Переместить выше",void 0,{top:!0}]]),f(v(S,{icon:"pi pi-arrow-down",onClick:l=>async function(e,a){var l,i;try{const l=e.requisites||[],i=l.findIndex(e=>e.id===a.id);if(-1===i||i>=l.length-1)return void x.add({severity:"warn",summary:"Невозможно переместить",detail:"Реквизит уже находится в самом низу",life:2e3});const t=i+2;await L.setRequisiteOrder(a.id,t),x.add({severity:"success",summary:"Реквизит перемещён",detail:`"${a.alias||a.name}" перемещён ниже`,life:2e3}),await ee()}catch(t){x.add({severity:"error",summary:"Ошибка",detail:(null==(i=null==(l=t.response)?void 0:l.data)?void 0:i.details)||t.message||"Не удалось переместить реквизит",life:5e3})}}(e,a),text:"",rounded:"","aria-label":"Переместить реквизит ниже"},null,8,["onClick"]),[[ja,"Переместить ниже",void 0,{top:!0}]]),f(v(S,{icon:"pi pi-pencil",onClick:l=>function(e,a){P.mode="edit",P.typeId=e.id,P.data={...a},P.visible=!0}(e,a),text:"",rounded:"","aria-label":"Редактировать реквизит"},null,8,["onClick"]),[[ja,"Редактировать",void 0,{top:!0}]]),f(v(S,{icon:"pi pi-trash",onClick:l=>function(e,a){W.type="requisite",W.item={type:e,requisite:a},W.itemName=a.name,W.visible=!0}(e,a),severity:"danger",text:"",rounded:"","aria-label":"Удалить реквизит",class:"ml-auto"},null,8,["onClick"]),[[ja,"Удалить",void 0,{top:!0}]])])]),_:2},1024)]),_:2},1032,["value"])])):(o(),n("div",sa," Реквизитов пока нет. Добавьте первый реквизит. "))]),_:2},1024)])):m("",!0)]),_:2},1024)],8,$e))),128)),0===K.value.length?(o(),n("div",na," Типы не найдены ")):m("",!0)]))]),_:1})])):m("",!0)]),_:1}),v(Ha,{visible:P.visible,"onUpdate:visible":a[14]||(a[14]=e=>P.visible=e),header:"add"===P.mode?"Добавить реквизит":"Редактировать реквизит",modal:!0,style:{width:"600px"}},{footer:b(()=>[r("div",Ta,[v(S,{label:"Отмена",icon:"pi pi-times",onClick:a[13]||(a[13]=e=>P.visible=!1),text:"","aria-label":"Отменить"}),v(S,{label:"add"===P.mode?"Добавить":"Сохранить",icon:"pi pi-check",onClick:Va,disabled:!P.data.name||!P.data.type||"CALCULATABLE"===P.data.type&&!P.data.defaultValue,"aria-label":"Сохранить реквизит"},null,8,["label","disabled"])])]),default:b(()=>[r("div",oa,[r("div",ra,[a[38]||(a[38]=r("label",{for:"reqName"},"Название реквизита *",-1)),v(h,{id:"reqName",modelValue:P.data.name,"onUpdate:modelValue":a[5]||(a[5]=e=>P.data.name=e),placeholder:"Название",class:"w-full"},null,8,["modelValue"])]),r("div",da,[a[39]||(a[39]=r("label",{for:"reqType"},"Тип данных *",-1)),v(R,{id:"reqType",modelValue:P.data.type,"onUpdate:modelValue":a[6]||(a[6]=e=>P.data.type=e),options:w(O),optionLabel:"label",optionValue:"value",placeholder:"Выберите тип",class:"w-full"},null,8,["modelValue","options"])]),"CALCULATABLE"!==P.data.type?(o(),n("div",ua,[v(E,{id:"reqNullable",modelValue:P.data.nullable,"onUpdate:modelValue":a[7]||(a[7]=e=>P.data.nullable=e),binary:!0},null,8,["modelValue"]),a[40]||(a[40]=r("label",{for:"reqNullable",class:"ml-2"},"Разрешить NULL (может быть пустым)",-1))])):m("",!0),"CALCULATABLE"!==P.data.type?(o(),n("div",ca,[v(E,{id:"reqMulti",modelValue:P.data.multi,"onUpdate:modelValue":a[8]||(a[8]=e=>P.data.multi=e),binary:!0},null,8,["modelValue"]),a[41]||(a[41]=r("label",{for:"reqMulti",class:"ml-2"},"MULTI (множественное значение)",-1))])):m("",!0),r("div",pa,[a[42]||(a[42]=r("label",{for:"reqAlias"},"ALIAS (псевдоним)",-1)),v(h,{id:"reqAlias",modelValue:P.data.alias,"onUpdate:modelValue":a[9]||(a[9]=e=>P.data.alias=e),placeholder:"Псевдоним (опционально)",class:"w-full"},null,8,["modelValue"])]),r("div",va,[r("label",ya,g("CALCULATABLE"===P.data.type?"Формула (обязательно) *":"Значение по умолчанию"),1),"CALCULATABLE"===P.data.type?(o(),n("div",ma,[v(R,{modelValue:P.data.defaultValue,"onUpdate:modelValue":a[10]||(a[10]=e=>P.data.defaultValue=e),options:G("CALCULATABLE").filter(e=>!e.disabled),optionLabel:"label",optionValue:"value",placeholder:"Выберите формулу",class:p(["w-full",{"p-invalid":!P.data.defaultValue}])},null,8,["modelValue","options","class"]),r("div",fa,[a[45]||(a[45]=r("div",{class:"flex align-items-center gap-2 mb-2"},[r("i",{class:"pi pi-info-circle text-primary"}),r("span",{class:"font-semibold"},"CALCULATABLE:")],-1)),r("ul",ba,[a[43]||(a[43]=r("li",null,[T("Значение вычисляется "),r("strong",null,"один раз"),T(" при создании записи")],-1)),a[44]||(a[44]=r("li",null,[T("Поле "),r("strong",null,"нельзя редактировать"),T(" (read-only)")],-1)),r("li",null,'Пример: [TODAY] → "'+g((new Date).toLocaleDateString("ru-RU"))+'"',1)])])])):(o(),n("div",ga,[v(h,{id:"reqDefault",modelValue:P.data.defaultValue,"onUpdate:modelValue":a[11]||(a[11]=e=>P.data.defaultValue=e),placeholder:"Значение или макрос",class:"flex-grow-1"},null,8,["modelValue"]),G(P.data.type).length>0?(o(),y(R,{key:0,options:G(P.data.type),optionLabel:"label",optionValue:"value",placeholder:"Макросы",onChange:a[12]||(a[12]=e=>P.data.defaultValue=e.value),class:"w-12rem"},null,8,["options"])):m("",!0)])),"CALCULATABLE"!==P.data.type&&G(P.data.type).length>0?(o(),n("small",ha," Выберите макрос из списка или введите значение вручную ")):m("",!0)])])]),_:1},8,["visible","header"]),v(Ha,{visible:W.visible,"onUpdate:visible":a[16]||(a[16]=e=>W.visible=e),header:"Подтверждение удаления",modal:!0,style:{width:"450px"}},{footer:b(()=>[r("div",xa,[v(S,{label:"Отмена",icon:"pi pi-times",onClick:a[15]||(a[15]=e=>W.visible=!1),text:"","aria-label":"Отменить удаление"}),v(S,{label:"Удалить",icon:"pi pi-trash",severity:"danger",onClick:pe,"aria-label":"Подтвердить удаление"})])]),default:b(()=>[r("div",ka,[a[48]||(a[48]=r("i",{class:"pi pi-exclamation-triangle text-4xl text-warning"},null,-1)),r("span",null,[a[46]||(a[46]=T(" Вы уверены, что хотите удалить ",-1)),r("strong",null,g(W.itemName),1),a[47]||(a[47]=T("? ",-1))])])]),_:1},8,["visible"]),v(Ha,{visible:z.visible,"onUpdate:visible":a[20]||(a[20]=e=>z.visible=e),header:"Создать подчинённый тип",modal:!0,style:{width:"500px"}},{footer:b(()=>[r("div",Ia,[v(S,{label:"Отмена",icon:"pi pi-times",onClick:a[19]||(a[19]=e=>z.visible=!1),text:"","aria-label":"Отменить"}),v(S,{label:"Создать",icon:"pi pi-plus",onClick:de,disabled:!z.name,loading:H.createSubordinate,"aria-label":"Создать подчинённый тип"},null,8,["disabled","loading"])])]),default:b(()=>{var e;return[r("div",Ra,[r("div",Ea,[a[49]||(a[49]=r("div",{class:"flex align-items-center gap-2 mb-2"},[r("i",{class:"pi pi-info-circle text-primary"}),r("span",{class:"font-semibold"},"Родительский тип:")],-1)),r("div",wa,g(null==(e=z.parentType)?void 0:e.name),1),a[50]||(a[50]=r("small",{class:"text-color-secondary"}," Подчинённый тип будет связан с записями родительского типа ",-1))]),r("div",qa,[a[51]||(a[51]=r("label",{for:"subordinateTypeName"},"Название подчинённого типа *",-1)),v(h,{id:"subordinateTypeName",modelValue:z.name,"onUpdate:modelValue":a[17]||(a[17]=e=>z.name=e),placeholder:"Например: Детали заказа",class:"w-full",onKeyup:q(de,["enter"])},null,8,["modelValue"])]),r("div",Ca,[v(E,{id:"subordinateTypeUnique",modelValue:z.unique,"onUpdate:modelValue":a[18]||(a[18]=e=>z.unique=e),binary:!0},null,8,["modelValue"]),a[52]||(a[52]=r("label",{for:"subordinateTypeUnique",class:"ml-2"},"Уникальный (первый столбец)",-1))])])]}),_:1},8,["visible"]),v(Ha,{visible:F.visible,"onUpdate:visible":a[24]||(a[24]=e=>F.visible=e),header:"Редактировать тип",modal:!0,style:{width:"500px"}},{footer:b(()=>[r("div",Da,[v(S,{label:"Отмена",icon:"pi pi-times",onClick:a[23]||(a[23]=e=>F.visible=!1),text:"","aria-label":"Отменить"}),v(S,{label:"Сохранить",icon:"pi pi-check",onClick:re,disabled:!F.name,loading:H.editType,"aria-label":"Сохранить изменения"},null,8,["disabled","loading"])])]),default:b(()=>{var e;return[r("div",Aa,[r("div",La,[a[53]||(a[53]=r("div",{class:"flex align-items-center gap-2 mb-2"},[r("i",{class:"pi pi-pencil text-primary"}),r("span",{class:"font-semibold"},"Редактирование типа:")],-1)),r("div",_a,g(F.originalName),1),r("small",Oa," ID: "+g(null==(e=F.type)?void 0:e.id),1)]),r("div",Sa,[a[54]||(a[54]=r("label",{for:"editTypeName"},"Название типа *",-1)),v(h,{id:"editTypeName",modelValue:F.name,"onUpdate:modelValue":a[21]||(a[21]=e=>F.name=e),placeholder:"Название типа",class:"w-full",onKeyup:q(re,["enter"])},null,8,["modelValue"])]),r("div",Ua,[v(E,{id:"editTypeUnique",modelValue:F.unique,"onUpdate:modelValue":a[22]||(a[22]=e=>F.unique=e),binary:!0},null,8,["modelValue"]),a[55]||(a[55]=r("label",{for:"editTypeUnique",class:"ml-2"},"Уникальный (первый столбец)",-1))]),v(Pa,{severity:"info",closable:!1,class:"mt-2"},{default:b(()=>[...a[56]||(a[56]=[r("small",null," Базовый тип нельзя изменить после создания. Для изменения базового типа создайте новый тип и перенесите данные. ",-1)])]),_:1})])]}),_:1},8,["visible"])])}}},[["__scopeId","data-v-7d5b357f"]]),Na={class:"integram-type-editor-page"},Ma={class:"text-center py-5"},$a={class:"text-center py-5"},Ba=_({__name:"IntegramTypeEditor",setup(i){const s=C(),d=I(),u=R(),{isAuthenticated:c,database:p}=A(),m=e(!1),f=e(""),h=e(null),k=a(()=>p.value||"integram"),x=a(()=>s.query.typeId),E=a(()=>[{label:"Структура",icon:"pi pi-sitemap"}]);function q(e){d.push(`/integram/${k.value}/object/${e}`)}async function _(){const e=d.currentRoute.value.fullPath;await d.replace("/integram-reload-placeholder"),await d.replace(e)}return l(async()=>{try{if(!c.value)return f.value="Не авторизован. Требуется вход в систему.",void setTimeout(()=>{d.replace("/integram/login")},2e3);const e=L.getAuthInfo();if(!e||!e.token)return f.value="Сессия истекла. Требуется повторный вход.",void setTimeout(()=>{d.replace("/integram/login")},2e3);h.value={sessionId:e.token,database:e.database||k.value,user:e.user},m.value=!0,x.value&&u.add({severity:"info",summary:"Редактирование типа",detail:`Тип ID: ${x.value}. Найдите его в списке ниже.`,life:5e3})}catch(e){f.value=e.message||"Ошибка инициализации сессии"}}),(e,a)=>{const l=t("ProgressSpinner"),i=t("Card"),s=t("Message"),u=t("Button");return o(),n("div",Na,[v(O,{items:E.value},null,8,["items"]),m.value?f.value?(o(),y(i,{key:1},{content:b(()=>[r("div",$a,[v(s,{severity:"error",closable:!1},{default:b(()=>[T(g(f.value),1)]),_:1}),v(u,{label:"Вернуться к списку таблиц",icon:"pi pi-arrow-left",class:"mt-3",onClick:a[0]||(a[0]=e=>w(d).push(`/integram/${k.value}/dict`))})])]),_:1})):(o(),y(Va,{key:2,session:h.value,onViewTable:q,onRefresh:_},null,8,["session"])):(o(),y(i,{key:0},{content:b(()=>[r("div",Ma,[v(l),a[1]||(a[1]=r("p",{class:"mt-3"},"Инициализация сессии...",-1))])]),_:1}))])}}},[["__scopeId","data-v-1e47129c"]]);export{Ba as default};
