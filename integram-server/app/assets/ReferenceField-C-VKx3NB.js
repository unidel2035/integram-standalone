import{_ as z,y as C,c as v,b as M,j as J,A,F as j,r as q,n as W,w as R,f as Z,t as O,a as D,aW as G,P as H,D as k,d as m,U as _,J as B,o as y}from"./index-B4X-KBPT.js";import{i as u}from"./integramApiClient-C3_j8SPw.js";const Q={__name:"ReferenceField",props:{modelValue:{type:[String,Number,Array],default:null},reqId:{type:[String,Number],required:!0},refTypeId:{type:[String,Number],required:!0},database:{type:String,required:!0},objectId:{type:[String,Number],required:!0},multi:{type:Boolean,default:!1},allowCreate:{type:Boolean,default:!1},restrict:{type:[String,Number],default:null},currentDisplayName:{type:String,default:null},initialMultiselectItems:{type:Array,default:()=>[]}},emits:["update:modelValue"],setup(N,{expose:n,emit:c}){n();const e=N,g=c,f=k(),I=m(null),d=m([]),i=m([]),b=m(!1),r=m(!1),w=m(!1),V=m(null),S=m(!1),F=m("");async function x(l=""){try{b.value=!0,u.setDatabase(e.database);const t=await u.getReferenceOptions(e.reqId,e.objectId,e.restrict,l);if(t&&t.failed)throw new Error(t.failed);if(t&&typeof t=="object"){const a=Object.entries(t).map(([o,s])=>({id:parseInt(o),text:s.toString()}));if(e.multi&&i.value.length>0){const o=i.value.map(p=>p.id),s=a.length;d.value=a.filter(p=>!o.includes(p.id));const h=d.value.length}else d.value=a}else console.warn("[ReferenceField] loadOptions: Unexpected reference options format:",t),d.value=[]}catch(t){console.error("[ReferenceField] loadOptions: Failed:",t),f.add({severity:"error",summary:"Ошибка загрузки",detail:"Не удалось загрузить варианты",life:3e3})}finally{b.value=!1}}async function T(l){await x(l.value)}async function E(l){const t=l.target?l.target.value:l.value;if(e.multi){const a=parseInt(t),o=d.value.find(s=>s.id===a);if(o&&!i.value.find(s=>s.id===o.id))try{w.value=!0,u.setDatabase(e.database);const s=await u.addMultiselectItem(e.objectId,e.reqId,o.id);if(s&&s.failed)throw new Error(s.failed);const h=s.id;if(!h)throw new Error("API did not return multiselect item ID");i.value.push({id:o.id,text:o.text,msId:h}),d.value=d.value.filter(p=>p.id!==o.id),g("update:modelValue",i.value.map(p=>p.id)),f.add({severity:"success",summary:"Добавлено",detail:`${o.text} добавлен`,life:2e3})}catch(s){console.error("Failed to add multiselect item:",s),f.add({severity:"error",summary:"Ошибка добавления",detail:s.message||"Не удалось добавить элемент",life:5e3})}finally{w.value=!1}I.value=null}else g("update:modelValue",t)}async function U(l){const t=i.value.find(a=>a.id===l);if(t){const a=t.msId;if(!a){console.error("No multiselect item ID found for deletion:",t),f.add({severity:"error",summary:"Ошибка удаления",detail:"Не найден ID элемента для удаления",life:5e3});return}try{V.value=l,u.setDatabase(e.database);const o=await u.removeMultiselectItem(a);if(o&&o.failed)throw new Error(o.failed);i.value=i.value.filter(s=>s.id!==l),d.value.push({id:t.id,text:t.text}),d.value.sort((s,h)=>s.text.localeCompare(h.text)),g("update:modelValue",i.value.map(s=>s.id)),f.add({severity:"success",summary:"Удалено",detail:`${t.text} удален`,life:2e3})}catch(o){console.error("Failed to remove multiselect item:",o),f.add({severity:"error",summary:"Ошибка удаления",detail:o.message||"Не удалось удалить элемент",life:5e3})}finally{V.value=null}}}function P(l){const t=["#78AAD2","#78AAFF","#78D2AA","#78D2FF","#78FFAA","#78FFD2","#AA78D2","#AA78FF","#AAD278","#AAD2FF","#AAFF78","#AAFFD2","#D278AA","#D278FF","#D2AA78","#D2AAFF","#D2FF78","#D2FFAA","#FF78AA","#FF78D2","#FFAA78","#FFAAD2","#FFD278","#FFD2AA"],a=parseInt(l)||0,o=Math.abs(a)%t.length;return t[o]}async function K(){var l;if(!F.value){f.add({severity:"warn",summary:"Введите значение",life:3e3});return}try{r.value=!0,u.setDatabase(e.database);const t=await u.createObject(e.refTypeId,F.value,{},null);if(t&&!t.failed){const a=t.id||((l=t.obj)==null?void 0:l.id);f.add({severity:"success",summary:"Значение создано",life:3e3}),d.value.unshift({id:a,text:F.value}),e.multi?(i.value.push({id:a,text:F.value}),g("update:modelValue",i.value.map(o=>o.id))):(I.value=a,g("update:modelValue",a)),S.value=!1,F.value=""}else throw new Error(t.failed||"Failed to create object")}catch(t){f.add({severity:"error",summary:"Ошибка создания",detail:t.message,life:5e3})}finally{r.value=!1}}_(()=>e.initialMultiselectItems,l=>{e.multi&&l&&l.length>0&&i.value.length===0&&(i.value=[...l])},{immediate:!0,deep:!0}),_(()=>e.modelValue,async l=>{if(e.multi){if(!e.initialMultiselectItems||e.initialMultiselectItems.length===0)if(Array.isArray(l)&&l.length>0&&i.value.length===0)try{u.setDatabase(e.database);const t=await u.getReferenceOptions(e.reqId,e.objectId,e.restrict,null);if(t&&!t.failed&&typeof t=="object")i.value=l.filter(a=>t[a]).map(a=>({id:parseInt(a),text:t[a].toString(),msId:null}));else throw new Error(t.failed||"Failed to load options")}catch(t){console.error("[ReferenceField] watch(modelValue): Failed to load selected item names:",t),i.value=l.map(a=>({id:a,text:`#${a}`,msId:null}))}else(!l||Array.isArray(l)&&l.length===0)&&(i.value=[])}else I.value=l},{immediate:!0}),_(()=>e.restrict,()=>{x()}),B(async()=>{if(e.multi&&e.initialMultiselectItems&&e.initialMultiselectItems.length>0&&i.value.length===0&&(i.value=[...e.initialMultiselectItems]),await x(),e.modelValue&&!e.multi){const l=parseInt(e.modelValue);if(!d.value.some(a=>a.id===l))if(e.currentDisplayName)d.value.unshift({id:l,text:e.currentDisplayName});else try{u.setDatabase(e.database);const a=await u.getReferenceOptions(e.reqId,e.objectId,e.restrict,"");a&&a[l]&&d.value.unshift({id:l,text:a[l].toString()})}catch(a){console.error("[ReferenceField] onMounted: Failed to load current value display name:",a)}}});const L={props:e,emit:g,toast:f,localValue:I,options:d,selectedItems:i,loading:b,creating:r,adding:w,removing:V,showCreateDialog:S,newRefValue:F,loadOptions:x,onFilter:T,onChange:E,removeItem:U,getColor:P,createNewReference:K,ref:m,watch:_,onMounted:B,get useToast(){return k},get integramApiClient(){return u}};return Object.defineProperty(L,"__isScriptSetup",{enumerable:!1,value:!0}),L}},X={class:"reference-field comp-control"},Y=["id"],$=["id","data-ref","data-ord","data-color"],ee=["onClick"],te={width:"12",height:"12",viewBox:"0 0 12 12",class:"flex-none ml-1",style:{"shape-rendering":"geometricprecision"}},le=["id","name","multi","i-orig","i-restrict","granted","disabled"],ae=["value","r","selected"],re={class:"field"};function ie(N,n,c,e,g,f){const I=C("font"),d=C("InputText"),i=C("Button"),b=C("Dialog");return y(),v("div",X,[c.multi?(y(),v("div",{key:0,id:`mst${c.reqId}`,class:"multiselect-badges mb-2"},[(y(!0),v(j,null,q(e.selectedItems,r=>(y(),v("span",{key:r.msId||r.id,id:r.msId,"data-ref":r.id,"data-ord":r.ord||0,"data-color":e.getColor(r.id),class:"badge badge-pill text-dark p-2 ml-0 mt-0 mb-2 mr-1",style:W({backgroundColor:e.getColor(r.id),opacity:e.removing===r.id?.5:1})},[A(I,null,{default:R(()=>[Z(O(r.text),1)]),_:2},1024),e.removing!==r.id?(y(),v("a",{key:0,onClick:w=>e.removeItem(r.id),class:"ml-1",style:{cursor:"pointer"}},[(y(),v("svg",te,[...n[4]||(n[4]=[D("path",{"fill-rule":"evenodd",fill:"currentColor",d:"M7.41421356,6 L9.88226406,3.5319495 C10.0816659,3.33254771 10.0828664,3.01179862 9.88577489,2.81470708 L9.18529292,2.11422511 C8.97977275,1.90870494 8.66708101,1.91870543 8.4680505,2.11773594 L6,4.58578644 L3.5319495,2.11773594 C3.33254771,1.91833414 3.01179862,1.91713357 2.81470708,2.11422511 L2.11422511,2.81470708 C1.90870494,3.02022725 1.91870543,3.33291899 2.11773594,3.5319495 L4.58578644,6 L2.11773594,8.4680505 C1.91833414,8.66745229 1.91713357,8.98820138 2.11422511,9.18529292 L2.81470708,9.88577489 C3.02022725,10.0912951 3.33291899,10.0812946 3.5319495,9.88226406 L6,7.41421356 L8.4680505,9.88226406 C8.66745229,10.0816659 8.98820138,10.0828664 9.18529292,9.88577489 L9.88577489,9.18529292 C10.0912951,8.97977275 10.0812946,8.66708101 9.88226406,8.4680505 L7.41421356,6 L7.41421356,6 Z"},null,-1)])]))],8,ee)):M("",!0)],12,$))),128))],8,Y)):M("",!0),J(D("select",{id:`t${c.reqId}`,name:`t${c.reqId}`,"onUpdate:modelValue":n[0]||(n[0]=r=>e.localValue=r),multi:c.multi?"1":"0","i-orig":c.refTypeId,"i-restrict":c.restrict,granted:c.allowCreate?c.reqId:void 0,class:"form-control select2-replacement",disabled:e.adding||e.removing!==null,onChange:e.onChange},[n[5]||(n[5]=D("option",{value:""},null,-1)),(y(!0),v(j,null,q(e.options,r=>(y(),v("option",{key:r.id,value:r.id,r:r.r||"",selected:!c.multi&&e.localValue==r.id},O(r.text),9,ae))),128))],40,le),[[G,e.localValue]]),A(b,{visible:e.showCreateDialog,"onUpdate:visible":n[3]||(n[3]=r=>e.showCreateDialog=r),header:"Создать новое значение",style:{width:"400px"},modal:""},{footer:R(()=>[A(i,{label:"Отмена",onClick:n[2]||(n[2]=r=>e.showCreateDialog=!1),text:""}),A(i,{label:"Создать",onClick:e.createNewReference,loading:e.creating,autofocus:""},null,8,["loading"])]),default:R(()=>[D("div",re,[n[6]||(n[6]=D("label",{for:"newRefValue"},"Значение",-1)),A(d,{id:"newRefValue",modelValue:e.newRefValue,"onUpdate:modelValue":n[1]||(n[1]=r=>e.newRefValue=r),class:"w-full",autofocus:"",onKeyup:H(e.createNewReference,["enter"])},null,8,["modelValue"])])]),_:1},8,["visible"])])}const ne=z(Q,[["render",ie],["__scopeId","data-v-1ef4aec5"],["__file","/home/hive/integram-standalone/src/components/integram/fields/ReferenceField.vue"]]);export{ne as R};
