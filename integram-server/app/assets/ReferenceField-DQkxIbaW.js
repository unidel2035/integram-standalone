import{D as e,r as t,U as a,K as l,y as i,c as r,o as s,b as d,j as u,A as n,F as o,d as c,n as m,w as f,f as v,t as p,a as y,aX as g,V as b}from"./index-m6PXRYQN.js";import{i as A}from"./integramApiClient-BsYdo77J.js";import{_ as I}from"./_plugin-vue_export-helper-BCo6x5W8.js";const h={class:"reference-field comp-control"},F=["id"],D=["id","data-ref","data-ord","data-color"],w=["onClick"],x={width:"12",height:"12",viewBox:"0 0 12 12",class:"flex-none ml-1",style:{"shape-rendering":"geometricprecision"}},C=["id","name","multi","i-orig","i-restrict","granted","disabled"],V=["value","r","selected"],j={class:"field"},q=I({__name:"ReferenceField",props:{modelValue:{type:[String,Number,Array],default:null},reqId:{type:[String,Number],required:!0},refTypeId:{type:[String,Number],required:!0},database:{type:String,required:!0},objectId:{type:[String,Number],required:!0},multi:{type:Boolean,default:!1},allowCreate:{type:Boolean,default:!1},restrict:{type:[String,Number],default:null},currentDisplayName:{type:String,default:null},initialMultiselectItems:{type:Array,default:()=>[]}},emits:["update:modelValue"],setup(I,{emit:q}){const L=I,M=q,k=e(),S=t(null),_=t([]),N=t([]),R=t(!1),E=t(!1),$=t(!1),O=t(null),B=t(!1),T=t("");async function U(e=""){try{R.value=!0,A.setDatabase(L.database);const t=await A.getReferenceOptions(L.reqId,L.objectId,L.restrict,e);if(t&&t.failed)throw new Error(t.failed);if(t&&"object"==typeof t){const e=Object.entries(t).map(([e,t])=>({id:parseInt(e),text:t.toString()}));if(L.multi&&N.value.length>0){const t=N.value.map(e=>e.id);e.length,_.value=e.filter(e=>!t.includes(e.id)),_.value.length}else _.value=e}else _.value=[]}catch(t){k.add({severity:"error",summary:"Ошибка загрузки",detail:"Не удалось загрузить варианты",life:3e3})}finally{R.value=!1}}async function K(e){const t=e.target?e.target.value:e.value;if(L.multi){const e=parseInt(t),l=_.value.find(t=>t.id===e);if(l&&!N.value.find(e=>e.id===l.id))try{$.value=!0,A.setDatabase(L.database);const e=await A.addMultiselectItem(L.objectId,L.reqId,l.id);if(e&&e.failed)throw new Error(e.failed);const t=e.id;if(!t)throw new Error("API did not return multiselect item ID");N.value.push({id:l.id,text:l.text,msId:t}),_.value=_.value.filter(e=>e.id!==l.id),M("update:modelValue",N.value.map(e=>e.id)),k.add({severity:"success",summary:"Добавлено",detail:`${l.text} добавлен`,life:2e3})}catch(a){k.add({severity:"error",summary:"Ошибка добавления",detail:a.message||"Не удалось добавить элемент",life:5e3})}finally{$.value=!1}S.value=null}else M("update:modelValue",t)}function P(e){const t=["#78AAD2","#78AAFF","#78D2AA","#78D2FF","#78FFAA","#78FFD2","#AA78D2","#AA78FF","#AAD278","#AAD2FF","#AAFF78","#AAFFD2","#D278AA","#D278FF","#D2AA78","#D2AAFF","#D2FF78","#D2FFAA","#FF78AA","#FF78D2","#FFAA78","#FFAAD2","#FFD278","#FFD2AA"],a=parseInt(e)||0;return t[Math.abs(a)%t.length]}async function X(){var e;if(T.value)try{E.value=!0,A.setDatabase(L.database);const t=await A.createObject(L.refTypeId,T.value,{},null);if(!t||t.failed)throw new Error(t.failed||"Failed to create object");{const a=t.id||(null==(e=t.obj)?void 0:e.id);k.add({severity:"success",summary:"Значение создано",life:3e3}),_.value.unshift({id:a,text:T.value}),L.multi?(N.value.push({id:a,text:T.value}),M("update:modelValue",N.value.map(e=>e.id))):(S.value=a,M("update:modelValue",a)),B.value=!1,T.value=""}}catch(t){k.add({severity:"error",summary:"Ошибка создания",detail:t.message,life:5e3})}finally{E.value=!1}else k.add({severity:"warn",summary:"Введите значение",life:3e3})}return a(()=>L.initialMultiselectItems,e=>{L.multi&&e&&e.length>0&&0===N.value.length&&(N.value=[...e])},{immediate:!0,deep:!0}),a(()=>L.modelValue,async e=>{if(L.multi){if(!L.initialMultiselectItems||0===L.initialMultiselectItems.length)if(Array.isArray(e)&&e.length>0&&0===N.value.length)try{A.setDatabase(L.database);const t=await A.getReferenceOptions(L.reqId,L.objectId,L.restrict,null);if(!t||t.failed||"object"!=typeof t)throw new Error(t.failed||"Failed to load options");N.value=e.filter(e=>t[e]).map(e=>({id:parseInt(e),text:t[e].toString(),msId:null}))}catch(t){N.value=e.map(e=>({id:e,text:`#${e}`,msId:null}))}else(!e||Array.isArray(e)&&0===e.length)&&(N.value=[])}else S.value=e},{immediate:!0}),a(()=>L.restrict,()=>{U()}),l(async()=>{if(L.multi&&L.initialMultiselectItems&&L.initialMultiselectItems.length>0&&0===N.value.length&&(N.value=[...L.initialMultiselectItems]),await U(),L.modelValue&&!L.multi){const t=parseInt(L.modelValue);if(!_.value.some(e=>e.id===t))if(L.currentDisplayName)_.value.unshift({id:t,text:L.currentDisplayName});else try{A.setDatabase(L.database);const e=await A.getReferenceOptions(L.reqId,L.objectId,L.restrict,"");e&&e[t]&&_.value.unshift({id:t,text:e[t].toString()})}catch(e){}}}),(e,t)=>{const a=i("font"),l=i("InputText"),q=i("Button"),R=i("Dialog");return s(),r("div",h,[I.multi?(s(),r("div",{key:0,id:`mst${I.reqId}`,class:"multiselect-badges mb-2"},[(s(!0),r(o,null,c(N.value,e=>(s(),r("span",{key:e.msId||e.id,id:e.msId,"data-ref":e.id,"data-ord":e.ord||0,"data-color":P(e.id),class:"badge badge-pill text-dark p-2 ml-0 mt-0 mb-2 mr-1",style:m({backgroundColor:P(e.id),opacity:O.value===e.id?.5:1})},[n(a,null,{default:f(()=>[v(p(e.text),1)]),_:2},1024),O.value!==e.id?(s(),r("a",{key:0,onClick:t=>async function(e){const t=N.value.find(t=>t.id===e);if(t){const l=t.msId;if(!l)return void k.add({severity:"error",summary:"Ошибка удаления",detail:"Не найден ID элемента для удаления",life:5e3});try{O.value=e,A.setDatabase(L.database);const a=await A.removeMultiselectItem(l);if(a&&a.failed)throw new Error(a.failed);N.value=N.value.filter(t=>t.id!==e),_.value.push({id:t.id,text:t.text}),_.value.sort((e,t)=>e.text.localeCompare(t.text)),M("update:modelValue",N.value.map(e=>e.id)),k.add({severity:"success",summary:"Удалено",detail:`${t.text} удален`,life:2e3})}catch(a){k.add({severity:"error",summary:"Ошибка удаления",detail:a.message||"Не удалось удалить элемент",life:5e3})}finally{O.value=null}}}(e.id),class:"ml-1",style:{cursor:"pointer"}},[(s(),r("svg",x,[...t[4]||(t[4]=[y("path",{"fill-rule":"evenodd",fill:"currentColor",d:"M7.41421356,6 L9.88226406,3.5319495 C10.0816659,3.33254771 10.0828664,3.01179862 9.88577489,2.81470708 L9.18529292,2.11422511 C8.97977275,1.90870494 8.66708101,1.91870543 8.4680505,2.11773594 L6,4.58578644 L3.5319495,2.11773594 C3.33254771,1.91833414 3.01179862,1.91713357 2.81470708,2.11422511 L2.11422511,2.81470708 C1.90870494,3.02022725 1.91870543,3.33291899 2.11773594,3.5319495 L4.58578644,6 L2.11773594,8.4680505 C1.91833414,8.66745229 1.91713357,8.98820138 2.11422511,9.18529292 L2.81470708,9.88577489 C3.02022725,10.0912951 3.33291899,10.0812946 3.5319495,9.88226406 L6,7.41421356 L8.4680505,9.88226406 C8.66745229,10.0816659 8.98820138,10.0828664 9.18529292,9.88577489 L9.88577489,9.18529292 C10.0912951,8.97977275 10.0812946,8.66708101 9.88226406,8.4680505 L7.41421356,6 L7.41421356,6 Z"},null,-1)])]))],8,w)):d("",!0)],12,D))),128))],8,F)):d("",!0),u(y("select",{id:`t${I.reqId}`,name:`t${I.reqId}`,"onUpdate:modelValue":t[0]||(t[0]=e=>S.value=e),multi:I.multi?"1":"0","i-orig":I.refTypeId,"i-restrict":I.restrict,granted:I.allowCreate?I.reqId:void 0,class:"form-control select2-replacement",disabled:$.value||null!==O.value,onChange:K},[t[5]||(t[5]=y("option",{value:""},null,-1)),(s(!0),r(o,null,c(_.value,e=>(s(),r("option",{key:e.id,value:e.id,r:e.r||"",selected:!I.multi&&S.value==e.id},p(e.text),9,V))),128))],40,C),[[g,S.value]]),n(R,{visible:B.value,"onUpdate:visible":t[3]||(t[3]=e=>B.value=e),header:"Создать новое значение",style:{width:"400px"},modal:""},{footer:f(()=>[n(q,{label:"Отмена",onClick:t[2]||(t[2]=e=>B.value=!1),text:""}),n(q,{label:"Создать",onClick:X,loading:E.value,autofocus:""},null,8,["loading"])]),default:f(()=>[y("div",j,[t[6]||(t[6]=y("label",{for:"newRefValue"},"Значение",-1)),n(l,{id:"newRefValue",modelValue:T.value,"onUpdate:modelValue":t[1]||(t[1]=e=>T.value=e),class:"w-full",autofocus:"",onKeyup:b(X,["enter"])},null,8,["modelValue"])])]),_:1},8,["visible"])])}}},[["__scopeId","data-v-3c10a74d"]]);export{q as R};
