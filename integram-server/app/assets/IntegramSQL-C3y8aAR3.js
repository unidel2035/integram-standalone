import{D as e,r as l,J as a,K as t,N as s,c as i,a as r,A as n,w as u,y as o,o as c,h as d,b as v,F as m,d as p,t as y,f}from"./index-DSwq2M__.js";import{I as b}from"./IntegramBreadcrumb-YrezANl5.js";import{i as g}from"./integramService-BCsancml.js";import{l as h}from"./logger-DLAyPY85.js";import{_ as S}from"./_plugin-vue_export-helper-BCo6x5W8.js";import"./integramApiClient-BsYdo77J.js";import"./index-CcrxTH1M.js";import"./unifiedAuthService-6fZILgG8.js";const x={class:"integram-sql-container integram-touch-friendly"},C={class:"mb-3"},L={class:"integram-actions mb-2"},O={class:"flex align-items-center gap-2"},E={class:"grid"},_={class:"text-sm overflow-x-auto"},k={class:"mb-2"},q={key:0,class:"ml-3 text-500"},w={class:"integram-actions mt-3"},j={class:"text-sm"},R={key:0,class:"text-center text-500 py-3"},I={key:1,class:"flex flex-column gap-2"},T=["onClick"],Q={class:"flex justify-content-between align-items-start"},U={class:"text-sm flex-1 m-0"},M={class:"text-500"},N=S({__name:"IntegramSQL",props:{session:{type:Object,required:!1}},setup(S){const N=s(),F=e(),V=l(null),B=l(""),A=l(""),P=l(!1),D=l([]),J=l([]),Y=l(null),G=l(null),W=l(!1),$=l([]),H=a(()=>{const e=[{label:"SQL",icon:"pi pi-code",to:"/integram/sql"}];return V.value&&B.value&&e.push({label:B.value,icon:"pi pi-chart-bar",to:void 0}),e});t(async()=>{N.params.reportId&&(V.value=parseInt(N.params.reportId),await async function(){if(V.value)try{P.value=!0;const e=await g.getObject(V.value);B.value=e.val||`Report #${V.value}`;const l=await g.getEditObject(V.value);if(l.reqs)for(const[a,t]of Object.entries(l.reqs))if(t.value&&"string"==typeof t.value&&(t.value.trim().toUpperCase().startsWith("SELECT")||t.value.trim().toUpperCase().includes("FROM"))){A.value=t.value,h.info(`Loaded SQL query from requisite ${a}:`,A.value);break}A.value||(h.warn("No SQL query found in report requisites"),F.add({severity:"warn",summary:"Предупреждение",detail:"SQL запрос не найден в отчете",life:5e3}))}catch(e){h.error("Failed to load report SQL:",e),Y.value=`Не удалось загрузить SQL запрос: ${e.message}`,F.add({severity:"error",summary:"Ошибка",detail:Y.value,life:5e3})}finally{P.value=!1}}())});const K=l({explainQuery:!1}),X=[{title:"Выбрать все записи",query:"SELECT * FROM your_table LIMIT 100"},{title:"Подсчёт записей",query:"SELECT COUNT(*) as total FROM your_table"},{title:"Группировка",query:"SELECT type, COUNT(*) as count\nFROM your_table\nGROUP BY type\nORDER BY count DESC"},{title:"Объединение таблиц",query:"SELECT a.*, b.name\nFROM table_a a\nLEFT JOIN table_b b ON a.parent_id = b.id\nLIMIT 100"},{title:"Фильтрация по дате",query:"SELECT *\nFROM your_table\nWHERE created_at >= '2025-01-01'\nORDER BY created_at DESC\nLIMIT 100"},{title:"Агрегация",query:"SELECT\n  type,\n  COUNT(*) as count,\n  AVG(value) as avg_value,\n  SUM(value) as total\nFROM your_table\nGROUP BY type"}];async function z(){if(A.value.trim()){P.value=!0,Y.value=null,D.value=[],J.value=[];try{throw await new Promise(e=>setTimeout(e,1e3)),new Error("SQL query execution not yet connected to backend API. Please implement the API call.")}catch(e){Y.value=e.message,$.value.unshift({query:A.value,timestamp:(new Date).toLocaleString(),rows:0,error:!0}),F.add({severity:"error",summary:"Ошибка выполнения запроса",detail:e.message,life:5e3})}finally{P.value=!1}}}function Z(){A.value="",D.value=[],J.value=[],Y.value=null,G.value=null}function ee(){0!==D.value.length&&(ae([J.value.map(e=>e.header).join(","),...D.value.map(e=>J.value.map(l=>JSON.stringify(e[l.field]||"")).join(","))].join("\n"),"query-results.csv","text/csv"),F.add({severity:"success",summary:"Экспорт выполнен",detail:"CSV файл загружен",life:3e3}))}function le(){0!==D.value.length&&(ae(JSON.stringify(D.value,null,2),"query-results.json","application/json"),F.add({severity:"success",summary:"Экспорт выполнен",detail:"JSON файл загружен",life:3e3}))}function ae(e,l,a){const t=new Blob([e],{type:a}),s=URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.download=l,i.click(),URL.revokeObjectURL(s)}return(e,l)=>{const a=o("Textarea"),t=o("Button"),s=o("Checkbox"),g=o("Panel"),h=o("Card"),S=o("Badge"),N=o("Column"),F=o("DataTable"),V=o("Message");return c(),i("div",x,[r("div",C,[n(b,{items:H.value},null,8,["items"])]),n(h,null,{title:u(()=>[...l[3]||(l[3]=[r("div",{class:"flex align-items-center justify-content-between"},[r("span",null,"SQL запросы")],-1)])]),content:u(()=>[n(g,{header:"Редактор SQL запросов",class:"mb-3"},{default:u(()=>[n(a,{modelValue:A.value,"onUpdate:modelValue":l[0]||(l[0]=e=>A.value=e),rows:10,class:"w-full mb-3",placeholder:"SELECT * FROM ...",style:{fontFamily:"monospace"}},null,8,["modelValue"]),r("div",L,[n(t,{label:"Выполнить",icon:"pi pi-play",onClick:z,loading:P.value,disabled:!A.value.trim(),"aria-label":"Выполнить SQL запрос"},null,8,["loading","disabled"]),n(t,{label:"Очистить",icon:"pi pi-times",onClick:Z,outlined:"","aria-label":"Очистить запрос"}),n(t,{label:"Примеры",icon:"pi pi-book",onClick:l[1]||(l[1]=e=>W.value=!W.value),outlined:"","aria-label":"Показать примеры запросов"})]),r("div",O,[n(s,{modelValue:K.value.explainQuery,"onUpdate:modelValue":l[2]||(l[2]=e=>K.value.explainQuery=e),inputId:"explain",binary:!0},null,8,["modelValue"]),l[4]||(l[4]=r("label",{for:"explain"},"EXPLAIN (показать план выполнения)",-1))])]),_:1}),W.value?(c(),d(g,{key:0,header:"Примеры запросов",class:"mb-3"},{default:u(()=>[r("div",E,[(c(),i(m,null,p(X,(e,l)=>r("div",{key:l,class:"col-12 md:col-6"},[n(h,{class:"h-full"},{title:u(()=>[r("small",null,y(e.title),1)]),content:u(()=>[r("pre",_,y(e.query),1),n(t,{label:"Использовать",onClick:l=>{return a=e.query,A.value=a,void(W.value=!1);var a},text:"","aria-label":"Использовать пример запроса"},null,8,["onClick"])]),_:2},1024)])),64))])]),_:1})):v("",!0),D.value.length>0?(c(),d(g,{key:1,header:"Результаты запроса",class:"mb-3"},{default:u(()=>[r("div",k,[n(S,{value:D.value.length,severity:"info"},null,8,["value"]),l[6]||(l[6]=r("span",{class:"ml-2"},"записей найдено",-1)),G.value?(c(),i("span",q,[l[5]||(l[5]=r("i",{class:"pi pi-clock"},null,-1)),f(" "+y(G.value)+"ms ",1)])):v("",!0)]),n(F,{value:D.value,rows:20,paginator:"",scrollable:!0,scrollHeight:"400px",class:"text-sm"},{default:u(()=>[(c(!0),i(m,null,p(J.value,e=>(c(),d(N,{key:e.field,field:e.field,header:e.header,style:{minWidth:"150px"}},null,8,["field","header"]))),128))]),_:1},8,["value"]),r("div",w,[n(t,{label:"Экспорт CSV",icon:"pi pi-download",onClick:ee,outlined:"","aria-label":"Экспортировать в CSV"}),n(t,{label:"Экспорт JSON",icon:"pi pi-file",onClick:le,outlined:"","aria-label":"Экспортировать в JSON"})])]),_:1})):v("",!0),Y.value?(c(),d(g,{key:2,header:"Ошибка",class:"mb-3"},{default:u(()=>[n(V,{severity:"error",closable:!1},{default:u(()=>[r("pre",j,y(Y.value),1)]),_:1})]),_:1})):v("",!0),n(g,{header:"История запросов",toggleable:!0,collapsed:!0},{default:u(()=>[0===$.value.length?(c(),i("div",R," Нет выполненных запросов ")):(c(),i("div",I,[(c(!0),i(m,null,p($.value,(e,l)=>(c(),i("div",{key:l,class:"p-3 border-1 surface-border border-round hover:surface-hover cursor-pointer",onClick:l=>function(e){A.value=e.query}(e)},[r("div",Q,[r("pre",U,y(e.query),1),n(S,{value:e.rows,severity:e.error?"danger":"success",class:"ml-2"},null,8,["value","severity"])]),r("small",M,y(e.timestamp),1)],8,T))),128))]))]),_:1})]),_:1})])}}},[["__scopeId","data-v-c2121e86"]]);export{N as default};
