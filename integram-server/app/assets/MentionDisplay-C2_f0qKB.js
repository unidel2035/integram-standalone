import{d as x,_ as z,c as g,A as W,h as G,m as J,b as H,n as Q,a as w,F as q,r as K,C as X,g as Y,t as P,aU as Z,I as N,J as V,at as F,U as B,H as ee,o as f,w as te,f as se,aX as ne}from"./index-B4X-KBPT.js";import{u as j}from"./useTimer-rFA0hy1q.js";import{i as A}from"./integramApiClient-C3_j8SPw.js";const oe=["photo","изображение","фото","картинка","аватара","picture","avatar","img","image","пиеср","аватар"],ae=["имя","name","login","username","фио","полное_имя","полное имя","полное_название","полное название","displayname"],R=new Map;function O(C){R.has("my")||R.set("my",{users:x([]),loading:x(!1),loadPromise:null});const p=R.get("my"),e=p.users,U=p.loading;async function y(){if(p.loadPromise)return p.loadPromise;if(!(e.value.length>0))return p.loadPromise=(async()=>{var d;U.value=!0;let o=null;try{o=A.currentDatabase,A.setDatabase("my");const n=await A.getTypeMetadata(18);console.log("[useUserMentions] Table 18 full metadata:",n);const t=(n==null?void 0:n.reqs)||[];console.log("[useUserMentions] Total requisites:",t.length),console.log("[useUserMentions] First 5 requisites:",t.slice(0,5).map(a=>({id:a.id,alias:a.alias,val:a.val,requisite_type_id:a.requisite_type_id}))),console.log("[useUserMentions] All column names (alias || val):"),t.forEach((a,M)=>{const b=a.alias||a.val;console.log(`  [${M}] id=${a.id}, name="${b}"`)});const l=t.find(a=>{const M=(a.alias||a.val||"").toLowerCase();return oe.some(b=>M.includes(b))});let r=t.find(a=>{const M=(a.alias||a.val||"").toLowerCase();return ae.some(b=>M.includes(b))});!r&&t.length>1&&(r=t[1],console.log("[useUserMentions] No name column matched pattern, using requisite[1] as fallback")),!l&&t.length>2&&(l=t[2],console.log("[useUserMentions] No photo column matched pattern, using requisite[2] as fallback")),console.log("[useUserMentions] Found columns:",{nameColumn:r?{id:r.id,alias:r.alias,val:r.val}:"NOT FOUND",photoColumn:l?{id:l.id,alias:l.alias,val:l.val}:"NOT FOUND"}),console.log("[useUserMentions] Loading users from table 18 (my database)...");const c=await A.getAllObjects(18,100,50);console.log("[useUserMentions] Got response:",{objectCount:((d=c.object)==null?void 0:d.length)||0,totalCount:c.totalCount||0,pagesLoaded:c.pagesLoaded||0,hasReqs:!!c.reqs,responseKeys:Object.keys(c)});let T=0;e.value=c.object.map(a=>{var i;const M=a.id||a.ID,b=(i=c.reqs)==null?void 0:i[M],L=T<3;let S=M,I=null;if(b){if(r){const u=b[r.id];u&&(S=u,L&&console.log(`[useUserMentions] User ${M}: name from column ${r.id} = "${u}"`))}if(l){const u=b[l.id];if(u){let v=null;if(typeof u=="string"&&u.includes("href")){const k=u.match(/href=['"]([^'"]+)['"]/);k&&(v=k[1])}else typeof u=="string"&&(v=u);v&&(v.startsWith("http://")||v.startsWith("https://")?I=v:v.startsWith("/")?I=`https://dronedoc.ru${v}`:I=`https://dronedoc.ru/${v}`,L&&console.log(`[useUserMentions] User ${M}: photo URL = "${I}"`))}}}return L&&T++,{id:M,name:S,photo:I,mention:`@my_${M}`}}),console.log("[useUserMentions] Successfully loaded",e.value.length,'users from "my" database (total from response:',c.totalCount,")"),console.log("[useUserMentions] Sample users with photos:",e.value.slice(0,5).map(a=>({id:a.id,name:a.name,photo:a.photo?`[photo present, length=${a.photo.length}]`:"[no photo]",mention:a.mention})))}catch(n){console.error('[useUserMentions] Failed to load users from "my" database:',n),e.value=[]}finally{U.value=!1,o&&A.setDatabase(o),p.loadPromise=null}})(),p.loadPromise}function s(o){if(!o)return e.value;const d=o.toLowerCase();return e.value.filter(n=>n.name.toLowerCase().includes(d)||n.id.toString().includes(d))}function m(o){if(!o)return[];const d=/@(\w+)_(\d+)/g,n=[];let t;for(;(t=d.exec(o))!==null;)n.push({full:t[0],database:t[1],userId:t[2],startIndex:t.index,endIndex:t.index+t[0].length});return n}function h(o){return e.value.find(d=>d.id===o)}function D(o){if(!o)return[{type:"text",content:""}];const d=m(o);if(d.length===0)return[{type:"text",content:o}];const n=[];let t=0;return d.forEach(l=>{l.startIndex>t&&n.push({type:"text",content:o.substring(t,l.startIndex)});const r=h(l.userId);n.push({type:"mention",content:l.full,user:r||{id:l.userId,name:l.userId,photo:null}}),t=l.endIndex}),t<o.length&&n.push({type:"text",content:o.substring(t)}),n}function $(o,d,n){const t=o.substring(0,d),l=o.substring(d),r=t.endsWith("@")?t.slice(0,-1):t;return{text:r+n.mention+" "+l,cursorPosition:r.length+n.mention.length+1}}return{users:e,loading:U,loadUsers:y,filterUsers:s,parseMentions:m,getUserById:h,renderMentions:D,insertMention:$}}const le={__name:"MentionAutocomplete",props:{modelValue:{type:String,default:""},database:{type:String,required:!0}},emits:["update:modelValue"],setup(C,{expose:_,emit:p}){const e=C,U=p,{setTimeout:y}=j(),s=x(null),m=x(null),h=x(!1),D=x(0),$=x(""),o=x(0),{users:d,loading:n,loadUsers:t,filterUsers:l,insertMention:r}=O(e.database),c=N(()=>l($.value)),T=N(()=>{var v;const i=((v=m.value)==null?void 0:v.$el)||m.value;if(!i)return{position:"fixed",top:"0",left:"0",zIndex:1e4,display:"none"};const u=i.getBoundingClientRect();return{position:"fixed",top:u.bottom+4+"px",left:u.left+"px",width:Math.max(u.width,280)+"px",zIndex:1e4}});function a(i){var E;U("update:modelValue",i);const u=((E=m.value)==null?void 0:E.$el)||m.value;o.value=u.selectionStart;const v=i.substring(0,o.value),k=v.match(/@(\w*)$/);console.log("[MentionAutocomplete] handleInput:",{value:i,cursorPosition:o.value,textBeforeCursor:v,atMatch:k?k[0]:null,database:e.database,filteredUsersCount:c.value.length,usersCount:d.value.length}),k?($.value=k[1]||"",h.value=!0,D.value=0,console.log("[MentionAutocomplete] @ detected, loading users for database:",e.database),t()):h.value=!1}function M(i){if(h.value)switch(i.key){case"ArrowDown":i.preventDefault(),D.value=Math.min(D.value+1,c.value.length-1);break;case"ArrowUp":i.preventDefault(),D.value=Math.max(D.value-1,0);break;case"Enter":case"Tab":c.value.length>0&&(i.preventDefault(),b(c.value[D.value]));break;case"Escape":i.preventDefault(),h.value=!1;break}}function b(i){var k;const u=r(e.modelValue,o.value,i);U("update:modelValue",u.text),h.value=!1;const v=((k=m.value)==null?void 0:k.$el)||m.value;y(()=>{v.focus(),v.setSelectionRange(u.cursorPosition,u.cursorPosition)},0)}function L(){y(()=>{h.value=!1},200)}function S(i){s.value&&!s.value.contains(i.target)&&(h.value=!1)}V(()=>{document.addEventListener("click",S)}),F(()=>{document.removeEventListener("click",S)}),_({focus:()=>{var u;const i=((u=m.value)==null?void 0:u.$el)||m.value;i==null||i.focus()}});const I={props:e,emit:U,setTimerTimeout:y,containerRef:s,inputRef:m,showDropdown:h,selectedIndex:D,mentionQuery:$,cursorPosition:o,users:d,loading:n,loadUsers:t,filterUsers:l,insertMention:r,filteredUsers:c,dropdownStyle:T,handleInput:a,handleKeydown:M,selectUser:b,handleBlur:L,handleClickOutside:S,ref:x,computed:N,watch:B,onMounted:V,onBeforeUnmount:F,get InputText(){return ee},get useUserMentions(){return O},get useTimer(){return j}};return Object.defineProperty(I,"__isScriptSetup",{enumerable:!1,value:!0}),I}},re={class:"mention-autocomplete",ref:"containerRef"},ie={key:0,class:"mention-item-empty"},ue=["onMousedown","onMouseenter"],ce=["src","alt"],de={key:1,class:"mention-avatar-default"},pe={class:"mention-name"},me={class:"mention-id text-400 text-xs ml-auto"};function fe(C,_,p,e,U,y){return f(),g("div",re,[W(e.InputText,J({ref:"inputRef",modelValue:p.modelValue,"onUpdate:modelValue":e.handleInput,onKeydown:e.handleKeydown,onBlur:e.handleBlur},C.$attrs,{class:"w-full"}),null,16,["modelValue"]),(f(),G(Z,{to:"body"},[e.showDropdown?(f(),g("div",{key:0,class:"mention-dropdown",style:Q(e.dropdownStyle)},[e.filteredUsers.length===0?(f(),g("div",ie,[..._[0]||(_[0]=[w("i",{class:"pi pi-user text-400 mr-2"},null,-1),w("span",{class:"text-500"},"Пользователи не найдены",-1)])])):(f(!0),g(q,{key:1},K(e.filteredUsers,(s,m)=>(f(),g("div",{key:s.id,class:Y(["mention-item",{"mention-item-active":m===e.selectedIndex}]),onMousedown:X(h=>e.selectUser(s),["prevent"]),onMouseenter:h=>e.selectedIndex=m},[s.photo?(f(),g("img",{key:0,src:s.photo,alt:s.name,class:"mention-avatar"},null,8,ce)):(f(),g("div",de,[..._[1]||(_[1]=[w("i",{class:"pi pi-user"},null,-1)])])),w("span",pe,P(s.name),1),w("span",me,"ID: "+P(s.id),1)],42,ue))),128))],4)):H("",!0)]))],512)}const Ne=z(le,[["render",fe],["__scopeId","data-v-c1875027"],["__file","/home/hive/integram-standalone/src/components/integram/MentionAutocomplete.vue"]]),he={__name:"MentionDisplay",props:{text:{type:String,default:""},database:{type:String,required:!0}},setup(C,{expose:_}){_();const p=C,e=x(null),U=x(null),{users:y,loadUsers:s,renderMentions:m}=O(p.database),h=(n,t)=>{U.value=t,e.value&&e.value.show(n)},D=()=>{e.value&&e.value.hide(),U.value=null},$=n=>{if(!n)return n;const t=/(\+\d{1,3}[-.\s]?\(?\d{1,4}\)?(?:[-.\s]?\d{1,4}){2,4})/g,l=/([\w.-]+@[\w.-]+\.\w{2,})/gi;let r=n;return r=r.replace(t,c=>`<a href="tel:${c.replace(/[-.\s()]/g,"")}" class="cell-chip cell-phone" title="Позвонить: ${c}" onclick="event.stopPropagation()"><i class="pi pi-phone"></i><span>${c}</span></a>`),r=r.replace(l,c=>`<a href="mailto:${c}" class="cell-chip cell-email" title="Написать: ${c}" onclick="event.stopPropagation()"><i class="pi pi-envelope"></i><span>${c}</span></a>`),r},o=N(()=>m(p.text));V(async()=>{console.log("[MentionDisplay] Mounted. Text:",p.text,"Users loaded:",y.value.length),p.text&&p.text.includes("@")&&(console.log("[MentionDisplay] Mentions detected, loading users..."),await s(),console.log("[MentionDisplay] After loadUsers, users count:",y.value.length),console.log("[MentionDisplay] Segments:",o.value))}),B(()=>p.text,async n=>{console.log("[MentionDisplay] Text changed to:",n,"Users loaded:",y.value.length),n&&n.includes("@")&&y.value.length===0&&(console.log("[MentionDisplay] New mentions detected, loading users..."),await s(),console.log("[MentionDisplay] After loadUsers, users count:",y.value.length),console.log("[MentionDisplay] Segments after update:",o.value))});const d={props:p,userPreviewPopover:e,hoveredUser:U,users:y,loadUsers:s,renderMentions:m,showUserPreview:h,hideUserPreview:D,parseContactInfo:$,segments:o,computed:N,watch:B,onMounted:V,ref:x,get Popover(){return ne},get useUserMentions(){return O}};return Object.defineProperty(d,"__isScriptSetup",{enumerable:!1,value:!0}),d}},ve={class:"mention-display"},ge={key:0,class:"user-preview-card"},_e={class:"user-preview-header"},ye=["src","alt"],Me={key:1,class:"user-preview-avatar-default"},Ue={class:"user-preview-info"},we={class:"user-preview-name"},be={class:"user-preview-id"},xe=["innerHTML"],De=["onMouseenter"],ke=["src","alt","onError"],Ie={key:1,class:"mention-tag-avatar-default"},Pe={class:"mention-tag-name"},Ce={key:2,class:"mention-text-raw"},$e={style:{"font-size":"0.7em",opacity:"0.5"}};function Se(C,_,p,e,U,y){return f(),g("span",ve,[W(e.Popover,{ref:"userPreviewPopover",class:"user-preview-popover"},{default:te(()=>[e.hoveredUser?(f(),g("div",ge,[w("div",_e,[e.hoveredUser.photo?(f(),g("img",{key:0,src:e.hoveredUser.photo,alt:e.hoveredUser.name,class:"user-preview-avatar"},null,8,ye)):(f(),g("div",Me,[..._[0]||(_[0]=[w("i",{class:"pi pi-user"},null,-1)])])),w("div",Ue,[w("div",we,P(e.hoveredUser.name),1),w("div",be,"ID: "+P(e.hoveredUser.id),1)])])])):H("",!0)]),_:1},512),(f(!0),g(q,null,K(e.segments,(s,m)=>(f(),g(q,{key:m},[s.type==="text"?(f(),g("span",{key:0,innerHTML:e.parseContactInfo(s.content)},null,8,xe)):s.type==="mention"&&s.user?(f(),g("span",{key:1,class:"mention-tag",onMouseenter:h=>e.showUserPreview(h,s.user),onMouseleave:e.hideUserPreview},[s.user.photo?(f(),g("img",{key:0,src:s.user.photo,alt:s.user.name,class:"mention-tag-avatar",onError:h=>console.log("[MentionDisplay] Photo load error for",s.user.name,s.user.photo)},null,40,ke)):(f(),g("span",Ie,[..._[1]||(_[1]=[w("i",{class:"pi pi-user"},null,-1)])])),w("span",Pe,P(s.user.name),1)],40,De)):(f(),g("span",Ce,[se(P(s.content)+" ",1),w("span",$e,"(user data not loaded, type="+P(s.type)+", user="+P(s.user?"exists":"null")+")",1)]))],64))),128))])}const Ve=z(he,[["render",Se],["__scopeId","data-v-13aeb6b5"],["__file","/home/hive/integram-standalone/src/components/integram/MentionDisplay.vue"]]);export{Ve as M,Ne as a,O as u};
