import{I as e}from"./IntegramBreadcrumb-DtRSJ3Ex.js";import{D as a,J as l,r as i,E as s,K as t,c as n,A as o,w as d,y as r,u as c,o as u,a as p,h as m,b as v,f,t as y,j as b}from"./index-CaUq7SZf.js";import{a as g}from"./index-CcrxTH1M.js";import{_ as h}from"./_plugin-vue_export-helper-BCo6x5W8.js";import"./integramApiClient-BsYdo77J.js";import"./unifiedAuthService-6fZILgG8.js";const w={class:"integram-dir-admin-page integram-touch-friendly"},x={class:"flex flex-column gap-3"},k={class:"field"},_={class:"flex gap-2 align-items-center"},C={class:"grid"},$={class:"col-12 md:col-6"},j={class:"col-12 md:col-6"},I={class:"flex flex-column gap-3"},U={class:"flex gap-2"},S={class:"flex flex-column gap-3"},z={class:"flex gap-2"},B={key:0,class:"mt-3"},M={class:"flex justify-content-between align-items-center mb-3 flex-wrap gap-2"},D={class:"font-semibold"},L={class:"integram-actions"},T={key:0,class:"pi pi-folder text-primary text-xl"},A={key:1,class:"pi pi-file text-secondary text-xl"},E=["onClick"],J={key:1},K={class:"integram-actions"},R={class:"flex align-items-center gap-3"},V={key:0},q={key:1},F={class:"integram-actions justify-content-end w-full"},G={class:"flex flex-column gap-3"},W={class:"flex align-items-center gap-3"},O={class:"m-0 mt-1"},P={class:"integram-actions justify-content-end w-full"},Q=h({__name:"IntegramDirAdmin",props:{session:{type:Object,required:!0}},setup(h){const Q=h,H=a(),N=l(()=>[{label:"Файлы",icon:"pi pi-folder",to:void 0}]),X="/api",Y=i("templates"),Z=i(""),ee=i([]),ae=i([]),le=i([]),ie=i(""),se=i(!1),te=s({list:!1,backup:!1,upload:!1,delete:!1,restore:!1}),ne=s({visible:!1,file:null}),oe=s({visible:!1,items:[]}),de=l(()=>[...ee.value.map(e=>({...e,type:"folder"})),...ae.value.map(e=>({...e,type:"file"}))]),re=l(()=>ae.value.filter(e=>e.name&&e.name.endsWith(".dmp.zip")));async function ce(){var e,a;te.list=!0;try{const e=await g.get(`${X}/integram-test/dir_admin/${Q.session.sessionId}`,{params:{folder:Y.value,path:Z.value}});e.data.success&&(ee.value=e.data.data.folders||[],ae.value=e.data.data.files||[])}catch(l){H.add({severity:"error",summary:"Ошибка",detail:(null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.details)||l.message,life:5e3})}finally{te.list=!1}}function ue(e){Y.value=e,Z.value="",ce()}function pe(){const e=Z.value.split("/");e.pop(),Z.value=e.join("/"),ce()}async function me(e){var a,l;te.upload=!0;try{const a=new FormData;e.files.forEach(e=>{a.append("files[]",e)}),a.append("folder",Y.value),a.append("path",Z.value),(await g.post(`${X}/integram-test/dir_admin/${Q.session.sessionId}/upload`,a,{headers:{"Content-Type":"multipart/form-data"}})).data.success&&(H.add({severity:"success",summary:"Успешно",detail:`Загружено файлов: ${e.files.length}`,life:3e3}),ce(),se.value=!1)}catch(i){H.add({severity:"error",summary:"Ошибка загрузки",detail:(null==(l=null==(a=i.response)?void 0:a.data)?void 0:l.details)||i.message,life:5e3})}finally{te.upload=!1}}async function ve(){var e,a;try{(await g.post(`${X}/integram-test/dir_admin/${Q.session.sessionId}/mkdir`,{folder:Y.value,path:Z.value,name:ie.value})).data.success&&(H.add({severity:"success",summary:"Успешно",detail:`Папка "${ie.value}" создана`,life:3e3}),ie.value="",ce())}catch(l){H.add({severity:"error",summary:"Ошибка",detail:(null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.details)||l.message,life:5e3})}}async function fe(){var e,a;te.backup=!0;try{const e=await g.post(`${X}/integram-test/backup/${Q.session.sessionId}`);e.data.success&&(H.add({severity:"success",summary:"Успешно",detail:"Резервная копия создана",life:3e3}),e.data.data.downloadUrl&&window.open(e.data.data.downloadUrl,"_blank"),ce())}catch(l){H.add({severity:"error",summary:"Ошибка",detail:(null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.details)||l.message,life:5e3})}finally{te.backup=!1}}async function ye(){var e,a,l;if(ne.file){ne.visible=!1,te.restore=!0;try{const a=await g.get(`/integram-test/${Q.session.database}/restore/`,{params:{backup_file:ne.file.name},withCredentials:!0});if(!a.data||!1===a.data.success)throw new Error((null==(e=a.data)?void 0:e.error)||"Ошибка восстановления");H.add({severity:"success",summary:"Успешно",detail:`База данных восстановлена из ${ne.file.name}`,life:5e3}),setTimeout(()=>{window.location.reload()},2e3)}catch(i){H.add({severity:"error",summary:"Ошибка восстановления",detail:(null==(l=null==(a=i.response)?void 0:a.data)?void 0:l.error)||i.message,life:5e3})}finally{te.restore=!1,ne.file=null}}}function be(){le.value=de.value}function ge(){oe.items=le.value,oe.visible=!0}async function he(){var e,a;oe.visible=!1,te.delete=!0;try{(await g.post(`${X}/integram-test/dir_admin/${Q.session.sessionId}/delete`,{folder:Y.value,path:Z.value,items:oe.items.map(e=>e.name)})).data.success&&(H.add({severity:"success",summary:"Успешно",detail:`Удалено элементов: ${oe.items.length}`,life:3e3}),le.value=[],ce())}catch(l){H.add({severity:"error",summary:"Ошибка",detail:(null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.details)||l.message,life:5e3})}finally{te.delete=!1}}function we(e){if(0===e)return"0 Bytes";const a=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,a)*100)/100+" "+["Bytes","KB","MB","GB"][a]}return t(()=>{Q.session.sessionId&&ce()}),(a,l)=>{const i=r("Message"),s=r("Chip"),t=r("Button"),g=r("Panel"),h=r("FileUpload"),Q=r("InputText"),X=r("Divider"),xe=r("Column"),ke=r("DataTable"),_e=r("Dialog"),Ce=c("tooltip");return u(),n("div",w,[o(e,{items:N.value},null,8,["items"]),o(i,{severity:"info",closable:!1,class:"mb-2"},{default:d(()=>[...l[8]||(l[8]=[p("p",{class:"m-0"}," Администрирование файлов и директорий. Управление шаблонами, резервное копирование базы данных, загрузка пользовательских файлов (CSS, JS, шрифты). ",-1)])]),_:1}),o(g,{header:"Навигация по директориям",class:"mb-3"},{default:d(()=>[p("div",x,[p("div",k,[l[9]||(l[9]=p("label",null,"Текущая директория",-1)),p("div",_,[o(s,{label:Y.value,icon:"pi pi-folder"},null,8,["label"]),"templates"!==Y.value?(u(),m(t,{key:0,icon:"pi pi-arrow-left",label:"Назад",onClick:pe,outlined:"","aria-label":"Вернуться в предыдущую папку"})):v("",!0)])]),p("div",C,[p("div",$,[o(t,{icon:"pi pi-folder",label:"Шаблоны",onClick:l[0]||(l[0]=e=>ue("templates")),severity:"templates"===Y.value?"primary":"secondary",outlined:"",class:"w-full"},null,8,["severity"])]),p("div",j,[o(t,{icon:"pi pi-download",label:"Загрузки",onClick:l[1]||(l[1]=e=>ue("download")),severity:"download"===Y.value?"primary":"secondary",outlined:"",class:"w-full"},null,8,["severity"])])]),l[10]||(l[10]=p("div",{class:"surface-card p-3 border-round"},[p("div",{class:"flex justify-content-between align-items-center"},[p("span",{class:"font-semibold"},"Путь для пользовательских файлов:"),p("code",{class:"surface-border border-1 px-2 py-1 border-round"}," download/{session.database}/ ")]),p("small",{class:"text-color-secondary mt-2 block"}," Загружайте CSS, JS, шрифты и другие файлы в директорию download для использования в шаблонах ")],-1))])]),_:1}),o(g,{header:"Загрузка файлов",toggleable:!0,collapsed:!se.value,class:"mb-3"},{default:d(()=>[p("div",I,[o(h,{name:"files[]",multiple:!0,customUpload:!0,onUploader:me,auto:!1,chooseLabel:"Выбрать файлы",uploadLabel:"Загрузить",cancelLabel:"Отмена"},{empty:d(()=>[...l[11]||(l[11]=[p("p",null,'Перетащите файлы сюда или нажмите "Выбрать файлы"',-1)])]),_:1})])]),_:1},8,["collapsed"]),o(g,{header:"Создать папку",toggleable:!0,collapsed:!0,class:"mb-3"},{default:d(()=>[p("div",U,[o(Q,{modelValue:ie.value,"onUpdate:modelValue":l[2]||(l[2]=e=>ie.value=e),placeholder:"Имя новой папки",class:"flex-1","aria-label":"Имя новой папки"},null,8,["modelValue"]),o(t,{icon:"pi pi-plus",label:"Создать",onClick:ve,disabled:!ie.value,"aria-label":"Создать папку"},null,8,["disabled"])])]),_:1}),o(g,{header:"Резервное копирование",toggleable:!0,collapsed:!0,class:"mb-3"},{default:d(()=>[p("div",S,[l[14]||(l[14]=p("p",null,[f(" Создайте резервную копию базы данных в компактный архив. Архив будет сохранен в папке "),p("code",null,"templates/backups/"),f(". ")],-1)),p("div",z,[o(t,{icon:"pi pi-download",label:"Создать резервную копию",onClick:fe,loading:te.backup,severity:"success","aria-label":"Создать резервную копию базы данных"},null,8,["loading"])]),re.value.length>0?(u(),n("div",B,[o(X),l[13]||(l[13]=p("h4",{class:"mt-0 mb-2"},"Восстановление из резервной копии",-1)),o(i,{severity:"warn",closable:!1,class:"mb-2"},{default:d(()=>[...l[12]||(l[12]=[p("small",null,"Внимание! Восстановление заменит все текущие данные базы.",-1)])]),_:1}),o(ke,{value:re.value,stripedRows:"",size:"small"},{default:d(()=>[o(xe,{field:"name",header:"Файл бэкапа"}),o(xe,{field:"size",header:"Размер"},{body:d(({data:e})=>[f(y(we(e.size)),1)]),_:1}),o(xe,{header:"Действие",style:{width:"150px"}},{body:d(({data:e})=>[o(t,{icon:"pi pi-replay",label:"Восстановить",size:"small",severity:"warning",onClick:a=>{return l=e,ne.file=l,void(ne.visible=!0);var l},loading:te.restore},null,8,["onClick","loading"])]),_:1})]),_:1},8,["value"])])):v("",!0)])]),_:1}),o(g,{header:"Файлы и папки",class:"mb-3"},{default:d(()=>[p("div",M,[p("span",D,y(ae.value.length+ee.value.length)+" элементов ",1),p("div",L,[o(t,{icon:"pi pi-check-square",label:"Выбрать все",onClick:be,text:"","aria-label":"Выбрать все элементы"}),o(t,{icon:"pi pi-trash",label:"Удалить выбранные",onClick:ge,disabled:0===le.value.length,severity:"danger",outlined:"","aria-label":"Удалить выбранные элементы"},null,8,["disabled"])])]),o(ke,{value:de.value,selection:le.value,"onUpdate:selection":l[3]||(l[3]=e=>le.value=e),dataKey:"name",loading:te.list,stripedRows:"",showGridlines:""},{default:d(()=>[o(xe,{selectionMode:"multiple",headerStyle:"width: 3rem"}),o(xe,{field:"type",header:"Тип",style:{width:"60px"}},{body:d(({data:e})=>["folder"===e.type?(u(),n("i",T)):(u(),n("i",A))]),_:1}),o(xe,{field:"name",header:"Имя"},{body:d(({data:e})=>["folder"===e.type?(u(),n("a",{key:0,onClick:a=>{return l=e.name,Z.value=Z.value?`${Z.value}/${l}`:l,void ce();var l},class:"cursor-pointer text-primary font-semibold"},y(e.name),9,E)):(u(),n("span",J,y(e.name),1))]),_:1}),o(xe,{field:"size",header:"Размер",style:{width:"120px"}},{body:d(({data:e})=>[f(y("file"===e.type?we(e.size):"—"),1)]),_:1}),o(xe,{field:"modified",header:"Изменен",style:{width:"180px"}},{body:d(({data:e})=>[f(y(e.modified?new Date(e.modified).toLocaleString("ru-RU"):"—"),1)]),_:1}),o(xe,{header:"Действия",style:{width:"220px"}},{body:d(({data:e})=>{return[p("div",K,["file"===e.type?b((u(),m(t,{key:0,icon:"pi pi-eye",onClick:a=>function(e){const a=`/${Y.value}/${Z.value}/${e.name}`.replace(/\/+/g,"/");window.open(a,"_blank")}(e),text:"",rounded:"","aria-label":"Просмотреть файл"},null,8,["onClick"])),[[Ce,"Просмотр",void 0,{top:!0}]]):v("",!0),"file"===e.type&&(a=e.name,[".html",".css",".js",".json",".xml",".txt",".md"].some(e=>a.toLowerCase().endsWith(e)))?b((u(),m(t,{key:1,icon:"pi pi-pencil",onClick:a=>function(e){const a=`/ace/editor.html?src=/${Y.value}/${Z.value}/${e.name}`;window.open(a,"_blank")}(e),text:"",rounded:"","aria-label":"Редактировать файл"},null,8,["onClick"])),[[Ce,"Редактировать",void 0,{top:!0}]]):v("",!0),"file"===e.type?b((u(),m(t,{key:2,icon:"pi pi-download",onClick:a=>function(e){const a=`/${Y.value}/${Z.value}/${e.name}`.replace(/\/+/g,"/"),l=document.createElement("a");l.href=a,l.download=e.name,l.click()}(e),text:"",rounded:"","aria-label":"Скачать файл"},null,8,["onClick"])),[[Ce,"Скачать",void 0,{top:!0}]]):v("",!0),"file"===e.type?b((u(),m(t,{key:3,icon:"pi pi-copy",onClick:a=>function(e){const a=`download/{_global_.z}/${Z.value}/${e.name}`.replace(/\/+/g,"/");navigator.clipboard.writeText(a).then(()=>{H.add({severity:"success",summary:"Скопировано",detail:"Путь скопирован в буфер обмена",life:2e3})})}(e),text:"",rounded:"","aria-label":"Копировать путь"},null,8,["onClick"])),[[Ce,"Копировать путь",void 0,{top:!0}]]):v("",!0),b(o(t,{icon:"pi pi-trash",onClick:a=>{return l=e,oe.items=[l],void(oe.visible=!0);var l},severity:"danger",text:"",rounded:"",class:"ml-auto","aria-label":"Удалить"},null,8,["onClick"]),[[Ce,"Удалить",void 0,{top:!0}]])])];var a}),_:1})]),_:1},8,["value","selection","loading"])]),_:1}),o(_e,{visible:oe.visible,"onUpdate:visible":l[5]||(l[5]=e=>oe.visible=e),header:"Подтверждение удаления",modal:!0,style:{width:"450px"}},{footer:d(()=>[p("div",F,[o(t,{label:"Отмена",icon:"pi pi-times",onClick:l[4]||(l[4]=e=>oe.visible=!1),text:"","aria-label":"Отменить удаление"}),o(t,{label:"Удалить",icon:"pi pi-trash",severity:"danger",onClick:he,"aria-label":"Подтвердить удаление"})])]),default:d(()=>[p("div",R,[l[19]||(l[19]=p("i",{class:"pi pi-exclamation-triangle text-4xl text-warning"},null,-1)),1===oe.items.length?(u(),n("span",V,[l[15]||(l[15]=f(" Вы уверены, что хотите удалить ",-1)),p("strong",null,y(oe.items[0].name),1),l[16]||(l[16]=f("? ",-1))])):(u(),n("span",q,[l[17]||(l[17]=f(" Вы уверены, что хотите удалить ",-1)),p("strong",null,y(oe.items.length),1),l[18]||(l[18]=f(" элементов? ",-1))]))])]),_:1},8,["visible"]),o(_e,{visible:ne.visible,"onUpdate:visible":l[7]||(l[7]=e=>ne.visible=e),header:"Подтверждение восстановления",modal:!0,style:{width:"500px"}},{footer:d(()=>[p("div",P,[o(t,{label:"Отмена",icon:"pi pi-times",onClick:l[6]||(l[6]=e=>ne.visible=!1),text:"","aria-label":"Отменить восстановление"}),o(t,{label:"Восстановить",icon:"pi pi-replay",severity:"warning",onClick:ye,loading:te.restore,"aria-label":"Подтвердить восстановление"},null,8,["loading"])])]),default:d(()=>{var e;return[p("div",G,[p("div",W,[l[22]||(l[22]=p("i",{class:"pi pi-exclamation-triangle text-4xl",style:{color:"var(--orange-500)"}},null,-1)),p("div",null,[l[20]||(l[20]=p("p",{class:"m-0 font-bold"},"Внимание! Это действие необратимо.",-1)),l[21]||(l[21]=p("p",{class:"m-0 mt-2"}," Все текущие данные базы будут заменены данными из резервной копии: ",-1)),p("p",O,[p("strong",null,y(null==(e=ne.file)?void 0:e.name),1)])])]),o(i,{severity:"warn",closable:!1},{default:d(()=>[...l[23]||(l[23]=[p("small",null,"Рекомендуется создать резервную копию текущего состояния перед восстановлением.",-1)])]),_:1})])]}),_:1},8,["visible"])])}}},[["__scopeId","data-v-8967d8eb"]]);export{Q as default};
