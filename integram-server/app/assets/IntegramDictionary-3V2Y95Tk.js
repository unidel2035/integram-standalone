import{_ as pe,y as u,u as fe,c as f,A as i,w as g,L as G,K as H,D as W,d as p,I as k,J as X,O as Y,o as m,f as Z,t as E,b as $,F as J,r as M,a as o,j as D,g as ee,h as R,v as te}from"./index-D6FYndJO.js";import{u as ae}from"./useIntegramSession-ijl0rDw4.js";import{i as _}from"./integramApiClient-C3_j8SPw.js";import{I as ge}from"./IntegramBreadcrumb-DEnfToFO.js";import"./index-B9ygI19o.js";import"./unifiedAuthService-xCuNj-Bd.js";const ve={__name:"IntegramDictionary",setup(ne,{expose:n}){n();const V=G(),t=H(),v=W(),{authenticate:U,logout:h,isAuthenticated:j,sessionId:O}=ae(),I=p(!1),C=p(null),T=p(""),F=p(!1),x=p(!1),w=p(null),N=p("grid"),B=[{value:"grid",icon:"pi pi-th-large",label:"Сетка"},{value:"list",icon:"pi pi-list",label:"Список"}],S=p(null),y=p(null),b=[{name:"Избранное",open:!0,tables:[],tableIds:["18","42"]},{name:"Основные",open:!0,tables:[],tableIds:[]},{name:"Служебные",open:!1,tables:[],tableIds:["22","269"]},{name:"Скрытые",open:!1,tables:[],tableIds:["47","65","137","29","63"]}],e=p(JSON.parse(JSON.stringify(b))),r=p({name:"",baseTypeId:"",unique:!1}),oe=[{label:"Короткий текст (до 127 символов)",value:"3"},{label:"Текст неограниченной длины",value:"8"},{label:"Дата",value:"9"},{label:"Целое число",value:"13"},{label:"Десятичное число",value:"14"},{label:"Логический (Да/Нет)",value:"11"},{label:"Многострочный текст",value:"12"},{label:"Дата и время",value:"4"}],A=k(()=>_.getDatabase()||""),le=k(()=>!0),se=k(()=>{if(!T.value)return e.value;const a=T.value.toLowerCase();return e.value.map(s=>({...s,tables:s.tables.filter(l=>l.name.toLowerCase().includes(a)||l.id.toString().includes(a))})).filter(s=>s.tables.length>0)}),ie=k(()=>[{label:"Таблицы",icon:"pi pi-table"}]);async function re(){try{await h(),S.value=null,e.value.forEach(a=>{a.tables=[]}),v.add({severity:"info",summary:"Выход",detail:"Сессия завершена",life:3e3})}catch(a){console.error("Logout error:",a)}}async function P(){var a,s;try{const l=localStorage.getItem("dictionarySettingsId");if(l)try{const c=await _.getObjectEditData(l);if(c&&c.obj){y.value=l;const d=(s=(a=c.reqs)==null?void 0:a.t269)==null?void 0:s.value;if(d){const ue=JSON.parse(d);e.value=Object.entries(ue).map(([me,K])=>({name:me,open:K.open??!0,tables:[],tableIds:K.tabs||[]}));return}}}catch(c){console.warn("Failed to load settings from server, using defaults:",c)}e.value=JSON.parse(JSON.stringify(b))}catch(l){console.error("Error loading category configuration:",l),e.value=JSON.parse(JSON.stringify(b))}}async function Q(){try{const a={};e.value.forEach(l=>{a[l.name]={open:l.open,tabs:l.tableIds}});const s=JSON.stringify(a);if(y.value)await _.setObjectRequisites(y.value,{t269:s});else{const l=await _.createObject("269","{_global_.user}",{t269:s},"1");l.obj&&(y.value=l.obj,localStorage.setItem("dictionarySettingsId",l.obj))}v.add({severity:"success",summary:"Сохранено",detail:"Конфигурация категорий сохранена",life:2e3})}catch(a){console.error("Failed to save category configuration:",a),v.add({severity:"warn",summary:"Предупреждение",detail:"Не удалось сохранить конфигурацию на сервер",life:3e3})}}async function q(){try{I.value=!0,C.value=null,await P();const a=await _.getDictionary();S.value=a;const s=Object.keys(a);e.value.forEach(c=>{c.tableIds.length>0&&(c.tables=c.tableIds.filter(d=>a[d]).map(d=>({id:d,name:a[d]})))});const l=e.value.find(c=>c.name.includes("Основные")||c.name.includes("Main"));if(l){const c=new Set(e.value.flatMap(d=>d.tableIds));l.tables=s.filter(d=>!c.has(d)).map(d=>({id:d,name:a[d]}))}}catch(a){C.value=a.message,v.add({severity:"error",summary:"Ошибка",detail:"Не удалось загрузить справочник: "+a.message,life:5e3})}finally{I.value=!1}}async function ce(a){const s=e.value.find(l=>l.name===a);s&&(s.open=!s.open,await Q())}async function de(){try{x.value=!0;const a=await _.createType(r.value.name,r.value.baseTypeId,r.value.unique);v.add({severity:"success",summary:"Успешно",detail:"Таблица создана!",life:3e3}),F.value=!1,r.value={name:"",baseTypeId:"",unique:!1},await q(),a.obj&&V.push(`/integram/${A.value}/object/${a.obj}`)}catch(a){v.add({severity:"error",summary:"Ошибка",detail:"Не удалось создать таблицу: "+a.message,life:5e3})}finally{x.value=!1}}function L(a){if(a.key==="Home"&&w.value){a.preventDefault();const s=w.value.$el.querySelector("input");s&&s.focus()}}X(async()=>{if(!j.value){V.push("/integram/login?redirect="+encodeURIComponent(t.fullPath));return}await q(),window.addEventListener("keydown",L)}),Y(()=>{window.removeEventListener("keydown",L)});const z={router:V,route:t,toast:v,authenticate:U,logout:h,isAuthenticated:j,sessionId:O,loading:I,error:C,searchQuery:T,showCreateTypeDialog:F,creatingType:x,searchInputRef:w,viewMode:N,viewOptions:B,dictionary:S,settingsId:y,DEFAULT_CATEGORIES:b,categories:e,createTypeForm:r,baseTypes:oe,database:A,canCreateTypes:le,filteredCategories:se,breadcrumbItems:ie,handleLogout:re,loadCategoryConfiguration:P,saveCategoryConfiguration:Q,loadDictionary:q,toggleCategory:ce,handleCreateType:de,handleKeyDown:L,ref:p,computed:k,onMounted:X,onUnmounted:Y,get useRouter(){return G},get useRoute(){return H},get useToast(){return W},get useIntegramSession(){return ae},get integramApiClient(){return _},IntegramBreadcrumb:ge};return Object.defineProperty(z,"__isScriptSetup",{enumerable:!1,value:!0}),z}},be={class:"integram-dictionary-container integram-touch-friendly"},ye={class:"flex align-items-center justify-content-between"},_e={class:"flex align-items-center gap-2"},he={class:"flex align-items-center gap-2 ml-auto"},we={key:0,class:"text-center py-5"},Ie={key:1,class:"text-center py-5"},Ce={key:2},Te=["onClick"],xe={class:"flex align-items-center gap-1"},Se={class:"m-0 category-title"},ke={class:"tables-grid integram-dictionary-grid"},De={class:"flex align-items-center justify-content-center text-center"},Ve={class:"table-name truncate-with-tooltip"},je={class:"tables-list"},Oe={class:"table-list-name"},Fe={key:0,class:"text-center py-5"},Ne={class:"flex flex-column gap-3"},Ee={class:"field"},Be={class:"field"},qe={class:"field-checkbox"};function Le(ne,n,V,t,v,U){const h=u("Button"),j=u("InputIcon"),O=u("InputText"),I=u("IconField"),C=u("SelectButton"),T=u("ProgressSpinner"),F=u("Message"),x=u("Badge"),w=u("Card"),N=u("router-link"),B=u("Select"),S=u("Checkbox"),y=u("Dialog"),b=fe("tooltip");return m(),f("div",be,[i(t.IntegramBreadcrumb,{items:t.breadcrumbItems},null,8,["items"]),i(w,null,{title:g(()=>[o("div",ye,[o("div",_e,[n[8]||(n[8]=o("span",null,"Объекты",-1)),t.canCreateTypes?D((m(),R(h,{key:0,icon:"pi pi-plus",rounded:"",outlined:"",size:"small",onClick:n[0]||(n[0]=e=>t.showCreateTypeDialog=!0),class:"create-table-btn"},null,512)),[[b,"Добавить таблицу",void 0,{bottom:!0}]]):$("",!0)]),o("div",he,[i(I,{iconPosition:"left"},{default:g(()=>[i(j,{class:"pi pi-search"}),i(O,{ref:"searchInputRef",modelValue:t.searchQuery,"onUpdate:modelValue":n[1]||(n[1]=e=>t.searchQuery=e),placeholder:"Быстрый поиск..."},null,8,["modelValue"])]),_:1}),i(C,{modelValue:t.viewMode,"onUpdate:modelValue":n[2]||(n[2]=e=>t.viewMode=e),options:t.viewOptions,optionLabel:"icon",optionValue:"value",allowEmpty:!1,class:"view-toggle"},{option:g(({option:e})=>[D(o("i",{class:ee(e.icon)},null,2),[[b,e.label,void 0,{top:!0}]])]),_:1},8,["modelValue"])])])]),content:g(()=>[t.loading?(m(),f("div",we,[i(T)])):t.error?(m(),f("div",Ie,[i(F,{severity:"error",closable:!1},{default:g(()=>[Z(E(t.error),1)]),_:1})])):(m(),f("div",Ce,[(m(!0),f(J,null,M(t.filteredCategories,e=>(m(),f("div",{key:e.name,class:"mb-4"},[o("div",{class:"category-header flex align-items-center justify-content-between mb-2 cursor-pointer",onClick:r=>t.toggleCategory(e.name)},[o("div",xe,[o("h3",Se,E(e.name),1),i(x,{value:e.tables.length,class:"category-badge"},null,8,["value"])]),o("i",{class:ee([e.open?"pi pi-chevron-down":"pi pi-chevron-right","category-chevron"])},null,2)],8,Te),D(o("div",ke,[(m(!0),f(J,null,M(e.tables,r=>(m(),R(N,{key:r.id,to:`/integram/${t.database}/object/${r.id}`,class:"table-card-link"},{default:g(()=>[i(w,{class:"table-card cursor-pointer"},{content:g(()=>[o("div",De,[D((m(),f("span",Ve,[Z(E(r.name),1)])),[[b,r.name,void 0,{top:!0}]])])]),_:2},1024)]),_:2},1032,["to"]))),128))],512),[[te,e.open&&t.viewMode==="grid"]]),D(o("div",je,[(m(!0),f(J,null,M(e.tables,r=>(m(),R(N,{key:r.id,to:`/integram/${t.database}/object/${r.id}`,class:"table-list-item"},{default:g(()=>[n[9]||(n[9]=o("i",{class:"pi pi-table table-list-icon"},null,-1)),o("span",Oe,E(r.name),1),n[10]||(n[10]=o("i",{class:"pi pi-chevron-right table-list-arrow"},null,-1))]),_:2},1032,["to"]))),128))],512),[[te,e.open&&t.viewMode==="list"]])]))),128)),t.filteredCategories.length===0&&!t.loading?(m(),f("div",Fe,[...n[11]||(n[11]=[o("i",{class:"pi pi-inbox text-5xl text-color-secondary mb-3"},null,-1),o("p",{class:"text-color-secondary"},"Таблицы не найдены",-1)])])):$("",!0)]))]),_:1}),i(y,{visible:t.showCreateTypeDialog,"onUpdate:visible":n[7]||(n[7]=e=>t.showCreateTypeDialog=e),modal:"",header:"Добавить таблицу",style:{width:"50rem"}},{footer:g(()=>[i(h,{label:"Отмена",text:"",onClick:n[6]||(n[6]=e=>t.showCreateTypeDialog=!1)}),i(h,{label:"Добавить",loading:t.creatingType,onClick:t.handleCreateType,disabled:!t.createTypeForm.name||!t.createTypeForm.baseTypeId},null,8,["loading","disabled"])]),default:g(()=>[o("div",Ne,[o("div",Ee,[n[12]||(n[12]=o("label",{for:"typeName"},"Название таблицы",-1)),i(O,{id:"typeName",modelValue:t.createTypeForm.name,"onUpdate:modelValue":n[3]||(n[3]=e=>t.createTypeForm.name=e),placeholder:"Введите название",class:"w-full"},null,8,["modelValue"])]),o("div",Be,[n[13]||(n[13]=o("label",{for:"baseType"},"Базовый тип (первая колонка)",-1)),i(B,{id:"baseType",modelValue:t.createTypeForm.baseTypeId,"onUpdate:modelValue":n[4]||(n[4]=e=>t.createTypeForm.baseTypeId=e),options:t.baseTypes,optionLabel:"label",optionValue:"value",placeholder:"Выберите базовый тип",class:"w-full"},null,8,["modelValue"])]),o("div",qe,[i(S,{id:"uniqueCheck",modelValue:t.createTypeForm.unique,"onUpdate:modelValue":n[5]||(n[5]=e=>t.createTypeForm.unique=e),binary:!0},null,8,["modelValue"]),n[14]||(n[14]=o("label",{for:"uniqueCheck"},"Сделать первую колонку уникальной",-1))])])]),_:1},8,["visible"])])}const Qe=pe(ve,[["render",Le],["__scopeId","data-v-d8221308"],["__file","/home/hive/integram-standalone/src/views/pages/Integram/IntegramDictionary.vue"]]);export{Qe as default};
