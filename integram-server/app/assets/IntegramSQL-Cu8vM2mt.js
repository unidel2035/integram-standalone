import{_ as X,y as v,c as _,a as l,A as r,w as m,K as F,D as U,d as n,I as D,J as P,o as i,h as k,b as w,F as j,r as V,t as g,f as z}from"./index-B4X-KBPT.js";import{I as Z}from"./IntegramBreadcrumb-DHI3pYG8.js";import{i as B}from"./integramService-BbyM5pB3.js";import{l as Q}from"./logger-CLWPjr6Q.js";import"./integramApiClient-C3_j8SPw.js";import"./index-B9ygI19o.js";import"./unifiedAuthService-xCuNj-Bd.js";const $={__name:"IntegramSQL",props:{session:{type:Object,required:!1}},setup(J,{expose:s}){s();const q=F(),e=U(),f=n(null),x=n(""),u=n(""),o=n(!1),y=n([]),c=n([]),p=n(null),h=n(null),E=n(!1),L=n([]),I=D(()=>{const t=[{label:"SQL",icon:"pi pi-code",to:"/integram/sql"}];return f.value&&x.value&&t.push({label:x.value,icon:"pi pi-chart-bar",to:void 0}),t});P(async()=>{q.params.reportId&&(f.value=parseInt(q.params.reportId),await a())});async function a(){if(f.value)try{o.value=!0;const t=await B.getObject(f.value);x.value=t.val||`Report #${f.value}`;const b=await B.getEditObject(f.value);if(b.reqs){for(const[C,d]of Object.entries(b.reqs))if(d.value&&typeof d.value=="string"&&(d.value.trim().toUpperCase().startsWith("SELECT")||d.value.trim().toUpperCase().includes("FROM"))){u.value=d.value,Q.info(`Loaded SQL query from requisite ${C}:`,u.value);break}}u.value||(Q.warn("No SQL query found in report requisites"),e.add({severity:"warn",summary:"Предупреждение",detail:"SQL запрос не найден в отчете",life:5e3}))}catch(t){Q.error("Failed to load report SQL:",t),p.value=`Не удалось загрузить SQL запрос: ${t.message}`,e.add({severity:"error",summary:"Ошибка",detail:p.value,life:5e3})}finally{o.value=!1}}const S=n({explainQuery:!1}),T=[{title:"Выбрать все записи",query:"SELECT * FROM your_table LIMIT 100"},{title:"Подсчёт записей",query:"SELECT COUNT(*) as total FROM your_table"},{title:"Группировка",query:`SELECT type, COUNT(*) as count
FROM your_table
GROUP BY type
ORDER BY count DESC`},{title:"Объединение таблиц",query:`SELECT a.*, b.name
FROM table_a a
LEFT JOIN table_b b ON a.parent_id = b.id
LIMIT 100`},{title:"Фильтрация по дате",query:`SELECT *
FROM your_table
WHERE created_at >= '2025-01-01'
ORDER BY created_at DESC
LIMIT 100`},{title:"Агрегация",query:`SELECT
  type,
  COUNT(*) as count,
  AVG(value) as avg_value,
  SUM(value) as total
FROM your_table
GROUP BY type`}];async function H(){if(u.value.trim()){o.value=!0,p.value=null,y.value=[],c.value=[];try{throw await new Promise(t=>setTimeout(t,1e3)),new Error("SQL query execution not yet connected to backend API. Please implement the API call.")}catch(t){p.value=t.message,L.value.unshift({query:u.value,timestamp:new Date().toLocaleString(),rows:0,error:!0}),e.add({severity:"error",summary:"Ошибка выполнения запроса",detail:t.message,life:5e3})}finally{o.value=!1}}}function A(){u.value="",y.value=[],c.value=[],p.value=null,h.value=null}function Y(t){u.value=t,E.value=!1}function G(t){u.value=t.query}function W(){if(y.value.length===0)return;const t=c.value.map(d=>d.header).join(","),b=y.value.map(d=>c.value.map(O=>JSON.stringify(d[O.field]||"")).join(",")),C=[t,...b].join(`
`);R(C,"query-results.csv","text/csv"),e.add({severity:"success",summary:"Экспорт выполнен",detail:"CSV файл загружен",life:3e3})}function K(){if(y.value.length===0)return;const t=JSON.stringify(y.value,null,2);R(t,"query-results.json","application/json"),e.add({severity:"success",summary:"Экспорт выполнен",detail:"JSON файл загружен",life:3e3})}function R(t,b,C){const d=new Blob([t],{type:C}),O=URL.createObjectURL(d),N=document.createElement("a");N.href=O,N.download=b,N.click(),URL.revokeObjectURL(O)}const M={route:q,toast:e,reportId:f,reportName:x,sqlQuery:u,loading:o,results:y,resultColumns:c,error:p,queryTime:h,showExamples:E,queryHistory:L,breadcrumbItems:I,loadReportSQL:a,settings:S,sqlExamples:T,executeQuery:H,clearQuery:A,useExample:Y,useHistoryQuery:G,exportCSV:W,exportJSON:K,downloadFile:R,ref:n,computed:D,onMounted:P,get useRoute(){return F},get useToast(){return U},IntegramBreadcrumb:Z,get integramService(){return B},get logger(){return Q}};return Object.defineProperty(M,"__isScriptSetup",{enumerable:!1,value:!0}),M}},ee={class:"integram-sql-container integram-touch-friendly"},te={class:"mb-3"},ae={class:"integram-actions mb-2"},le={class:"flex align-items-center gap-2"},re={class:"grid"},se={class:"text-sm overflow-x-auto"},oe={class:"mb-2"},ne={key:0,class:"ml-3 text-500"},ie={class:"integram-actions mt-3"},ue={class:"text-sm"},ce={key:0,class:"text-center text-500 py-3"},de={key:1,class:"flex flex-column gap-2"},me=["onClick"],ye={class:"flex justify-content-between align-items-start"},pe={class:"text-sm flex-1 m-0"},ve={class:"text-500"};function fe(J,s,q,e,f,x){const u=v("Textarea"),o=v("Button"),y=v("Checkbox"),c=v("Panel"),p=v("Card"),h=v("Badge"),E=v("Column"),L=v("DataTable"),I=v("Message");return i(),_("div",ee,[l("div",te,[r(e.IntegramBreadcrumb,{items:e.breadcrumbItems},null,8,["items"])]),r(p,null,{title:m(()=>[...s[3]||(s[3]=[l("div",{class:"flex align-items-center justify-content-between"},[l("span",null,"SQL запросы")],-1)])]),content:m(()=>[r(c,{header:"Редактор SQL запросов",class:"mb-3"},{default:m(()=>[r(u,{modelValue:e.sqlQuery,"onUpdate:modelValue":s[0]||(s[0]=a=>e.sqlQuery=a),rows:10,class:"w-full mb-3",placeholder:"SELECT * FROM ...",style:{fontFamily:"monospace"}},null,8,["modelValue"]),l("div",ae,[r(o,{label:"Выполнить",icon:"pi pi-play",onClick:e.executeQuery,loading:e.loading,disabled:!e.sqlQuery.trim(),"aria-label":"Выполнить SQL запрос"},null,8,["loading","disabled"]),r(o,{label:"Очистить",icon:"pi pi-times",onClick:e.clearQuery,outlined:"","aria-label":"Очистить запрос"}),r(o,{label:"Примеры",icon:"pi pi-book",onClick:s[1]||(s[1]=a=>e.showExamples=!e.showExamples),outlined:"","aria-label":"Показать примеры запросов"})]),l("div",le,[r(y,{modelValue:e.settings.explainQuery,"onUpdate:modelValue":s[2]||(s[2]=a=>e.settings.explainQuery=a),inputId:"explain",binary:!0},null,8,["modelValue"]),s[4]||(s[4]=l("label",{for:"explain"},"EXPLAIN (показать план выполнения)",-1))])]),_:1}),e.showExamples?(i(),k(c,{key:0,header:"Примеры запросов",class:"mb-3"},{default:m(()=>[l("div",re,[(i(),_(j,null,V(e.sqlExamples,(a,S)=>l("div",{key:S,class:"col-12 md:col-6"},[r(p,{class:"h-full"},{title:m(()=>[l("small",null,g(a.title),1)]),content:m(()=>[l("pre",se,g(a.query),1),r(o,{label:"Использовать",onClick:T=>e.useExample(a.query),text:"","aria-label":"Использовать пример запроса"},null,8,["onClick"])]),_:2},1024)])),64))])]),_:1})):w("",!0),e.results.length>0?(i(),k(c,{key:1,header:"Результаты запроса",class:"mb-3"},{default:m(()=>[l("div",oe,[r(h,{value:e.results.length,severity:"info"},null,8,["value"]),s[6]||(s[6]=l("span",{class:"ml-2"},"записей найдено",-1)),e.queryTime?(i(),_("span",ne,[s[5]||(s[5]=l("i",{class:"pi pi-clock"},null,-1)),z(" "+g(e.queryTime)+"ms ",1)])):w("",!0)]),r(L,{value:e.results,rows:20,paginator:"",scrollable:!0,scrollHeight:"400px",class:"text-sm"},{default:m(()=>[(i(!0),_(j,null,V(e.resultColumns,a=>(i(),k(E,{key:a.field,field:a.field,header:a.header,style:{minWidth:"150px"}},null,8,["field","header"]))),128))]),_:1},8,["value"]),l("div",ie,[r(o,{label:"Экспорт CSV",icon:"pi pi-download",onClick:e.exportCSV,outlined:"","aria-label":"Экспортировать в CSV"}),r(o,{label:"Экспорт JSON",icon:"pi pi-file",onClick:e.exportJSON,outlined:"","aria-label":"Экспортировать в JSON"})])]),_:1})):w("",!0),e.error?(i(),k(c,{key:2,header:"Ошибка",class:"mb-3"},{default:m(()=>[r(I,{severity:"error",closable:!1},{default:m(()=>[l("pre",ue,g(e.error),1)]),_:1})]),_:1})):w("",!0),r(c,{header:"История запросов",toggleable:!0,collapsed:!0},{default:m(()=>[e.queryHistory.length===0?(i(),_("div",ce," Нет выполненных запросов ")):(i(),_("div",de,[(i(!0),_(j,null,V(e.queryHistory,(a,S)=>(i(),_("div",{key:S,class:"p-3 border-1 surface-border border-round hover:surface-hover cursor-pointer",onClick:T=>e.useHistoryQuery(a)},[l("div",ye,[l("pre",pe,g(a.query),1),r(h,{value:a.rows,severity:a.error?"danger":"success",class:"ml-2"},null,8,["value","severity"])]),l("small",ve,g(a.timestamp),1)],8,me))),128))]))]),_:1})]),_:1})])}const qe=X($,[["render",fe],["__scopeId","data-v-d0102321"],["__file","/home/hive/integram-standalone/src/components/integram/IntegramSQL.vue"]]);export{qe as default};
