import{I as se}from"./IntegramBreadcrumb-DHI3pYG8.js";import{_ as ne,y as _,u as re,c as C,A as s,w as r,D as N,I as L,d as D,E as j,J as P,o as v,a as o,h as T,b as S,f as x,t as h,j as z}from"./index-B4X-KBPT.js";import{a as I}from"./index-B9ygI19o.js";import"./integramApiClient-C3_j8SPw.js";import"./unifiedAuthService-xCuNj-Bd.js";const de={__name:"IntegramDirAdmin",props:{session:{type:Object,required:!0}},setup(M,{expose:t}){t();const w=M,e=N(),A=L(()=>[{label:"Файлы",icon:"pi pi-folder",to:void 0}]),F="/api",f=D("templates"),u=D(""),d=D([]),g=D([]),U=D([]),B=D(""),E=D(!1),c=j({list:!1,backup:!1,upload:!1,delete:!1,restore:!1}),b=j({visible:!1,file:null}),y=j({visible:!1,items:[]}),k=L(()=>[...d.value.map(l=>({...l,type:"folder"})),...g.value.map(l=>({...l,type:"file"}))]),a=L(()=>g.value.filter(l=>l.name&&l.name.endsWith(".dmp.zip")));async function p(){var l,n;c.list=!0;try{const i=await I.get(`${F}/integram-test/dir_admin/${w.session.sessionId}`,{params:{folder:f.value,path:u.value}});i.data.success&&(d.value=i.data.data.folders||[],g.value=i.data.data.files||[])}catch(i){console.error("Error loading directory:",i),e.add({severity:"error",summary:"Ошибка",detail:((n=(l=i.response)==null?void 0:l.data)==null?void 0:n.details)||i.message,life:5e3})}finally{c.list=!1}}function V(l){f.value=l,u.value="",p()}function J(l){u.value=u.value?`${u.value}/${l}`:l,p()}function q(){const l=u.value.split("/");l.pop(),u.value=l.join("/"),p()}async function G(l){var n,i;c.upload=!0;try{const m=new FormData;l.files.forEach(ie=>{m.append("files[]",ie)}),m.append("folder",f.value),m.append("path",u.value),(await I.post(`${F}/integram-test/dir_admin/${w.session.sessionId}/upload`,m,{headers:{"Content-Type":"multipart/form-data"}})).data.success&&(e.add({severity:"success",summary:"Успешно",detail:`Загружено файлов: ${l.files.length}`,life:3e3}),p(),E.value=!1)}catch(m){console.error("Upload error:",m),e.add({severity:"error",summary:"Ошибка загрузки",detail:((i=(n=m.response)==null?void 0:n.data)==null?void 0:i.details)||m.message,life:5e3})}finally{c.upload=!1}}async function K(){var l,n;try{(await I.post(`${F}/integram-test/dir_admin/${w.session.sessionId}/mkdir`,{folder:f.value,path:u.value,name:B.value})).data.success&&(e.add({severity:"success",summary:"Успешно",detail:`Папка "${B.value}" создана`,life:3e3}),B.value="",p())}catch(i){console.error("Create folder error:",i),e.add({severity:"error",summary:"Ошибка",detail:((n=(l=i.response)==null?void 0:l.data)==null?void 0:n.details)||i.message,life:5e3})}}async function O(){var l,n;c.backup=!0;try{const i=await I.post(`${F}/integram-test/backup/${w.session.sessionId}`);i.data.success&&(e.add({severity:"success",summary:"Успешно",detail:"Резервная копия создана",life:3e3}),i.data.data.downloadUrl&&window.open(i.data.data.downloadUrl,"_blank"),p())}catch(i){console.error("Backup error:",i),e.add({severity:"error",summary:"Ошибка",detail:((n=(l=i.response)==null?void 0:l.data)==null?void 0:n.details)||i.message,life:5e3})}finally{c.backup=!1}}function W(l){b.file=l,b.visible=!0}async function H(){var l,n,i;if(b.file){b.visible=!1,c.restore=!0;try{const m=await I.get(`/integram-test/${w.session.database}/restore/`,{params:{backup_file:b.file.name},withCredentials:!0});if(m.data&&m.data.success!==!1)e.add({severity:"success",summary:"Успешно",detail:`База данных восстановлена из ${b.file.name}`,life:5e3}),setTimeout(()=>{window.location.reload()},2e3);else throw new Error(((l=m.data)==null?void 0:l.error)||"Ошибка восстановления")}catch(m){console.error("Restore error:",m),e.add({severity:"error",summary:"Ошибка восстановления",detail:((i=(n=m.response)==null?void 0:n.data)==null?void 0:i.error)||m.message,life:5e3})}finally{c.restore=!1,b.file=null}}}function Q(){U.value=k.value}function X(l){y.items=[l],y.visible=!0}function Y(){y.items=U.value,y.visible=!0}async function Z(){var l,n;y.visible=!1,c.delete=!0;try{(await I.post(`${F}/integram-test/dir_admin/${w.session.sessionId}/delete`,{folder:f.value,path:u.value,items:y.items.map(m=>m.name)})).data.success&&(e.add({severity:"success",summary:"Успешно",detail:`Удалено элементов: ${y.items.length}`,life:3e3}),U.value=[],p())}catch(i){console.error("Delete error:",i),e.add({severity:"error",summary:"Ошибка",detail:((n=(l=i.response)==null?void 0:l.data)==null?void 0:n.details)||i.message,life:5e3})}finally{c.delete=!1}}function $(l){const n=`/${f.value}/${u.value}/${l.name}`.replace(/\/+/g,"/");window.open(n,"_blank")}function ee(l){const n=`/ace/editor.html?src=/${f.value}/${u.value}/${l.name}`;window.open(n,"_blank")}function le(l){const n=`/${f.value}/${u.value}/${l.name}`.replace(/\/+/g,"/"),i=document.createElement("a");i.href=n,i.download=l.name,i.click()}function te(l){const n=`download/{_global_.z}/${u.value}/${l.name}`.replace(/\/+/g,"/");navigator.clipboard.writeText(n).then(()=>{e.add({severity:"success",summary:"Скопировано",detail:"Путь скопирован в буфер обмена",life:2e3})})}function ae(l){return[".html",".css",".js",".json",".xml",".txt",".md"].some(i=>l.toLowerCase().endsWith(i))}function oe(l){if(l===0)return"0 Bytes";const n=1024,i=["Bytes","KB","MB","GB"],m=Math.floor(Math.log(l)/Math.log(n));return Math.round(l/Math.pow(n,m)*100)/100+" "+i[m]}P(()=>{w.session.sessionId&&p()});const R={props:w,toast:e,breadcrumbItems:A,API_BASE:F,currentFolder:f,currentPath:u,folderList:d,fileList:g,selectedItems:U,newFolderName:B,showUpload:E,loading:c,restoreDialog:b,deleteDialog:y,combinedList:k,backupFiles:a,loadDirectoryContents:p,navigateTo:V,navigateToFolder:J,navigateUp:q,handleFileUpload:G,createFolder:K,createBackup:O,confirmRestore:W,executeRestore:H,selectAll:Q,confirmDelete:X,confirmDeleteSelected:Y,executeDelete:Z,viewFile:$,editFile:ee,downloadFile:le,copyPath:te,isEditable:ae,formatFileSize:oe,IntegramBreadcrumb:se,ref:D,reactive:j,computed:L,onMounted:P,get useToast(){return N},get axios(){return I}};return Object.defineProperty(R,"__isScriptSetup",{enumerable:!1,value:!0}),R}},ce={class:"integram-dir-admin-page integram-touch-friendly"},me={class:"flex flex-column gap-3"},ue={class:"field"},pe={class:"flex gap-2 align-items-center"},fe={class:"grid"},ve={class:"col-12 md:col-6"},be={class:"col-12 md:col-6"},ye={class:"flex flex-column gap-3"},ge={class:"flex gap-2"},_e={class:"flex flex-column gap-3"},we={class:"flex gap-2"},xe={key:0,class:"mt-3"},he={class:"flex justify-content-between align-items-center mb-3 flex-wrap gap-2"},ke={class:"font-semibold"},Ce={class:"integram-actions"},De={key:0,class:"pi pi-folder text-primary text-xl"},Fe={key:1,class:"pi pi-file text-secondary text-xl"},Ie=["onClick"],Ue={key:1},Be={class:"integram-actions"},Se={class:"flex align-items-center gap-3"},Te={key:0},ze={key:1},Ee={class:"integram-actions justify-content-end w-full"},Le={class:"flex flex-column gap-3"},je={class:"flex align-items-center gap-3"},Me={class:"m-0 mt-1"},Ae={class:"integram-actions justify-content-end w-full"};function Re(M,t,w,e,A,F){const f=_("Message"),u=_("Chip"),d=_("Button"),g=_("Panel"),U=_("FileUpload"),B=_("InputText"),E=_("Divider"),c=_("Column"),b=_("DataTable"),y=_("Dialog"),k=re("tooltip");return v(),C("div",ce,[s(e.IntegramBreadcrumb,{items:e.breadcrumbItems},null,8,["items"]),s(f,{severity:"info",closable:!1,class:"mb-2"},{default:r(()=>[...t[8]||(t[8]=[o("p",{class:"m-0"}," Администрирование файлов и директорий. Управление шаблонами, резервное копирование базы данных, загрузка пользовательских файлов (CSS, JS, шрифты). ",-1)])]),_:1}),s(g,{header:"Навигация по директориям",class:"mb-3"},{default:r(()=>[o("div",me,[o("div",ue,[t[9]||(t[9]=o("label",null,"Текущая директория",-1)),o("div",pe,[s(u,{label:e.currentFolder,icon:"pi pi-folder"},null,8,["label"]),e.currentFolder!=="templates"?(v(),T(d,{key:0,icon:"pi pi-arrow-left",label:"Назад",onClick:e.navigateUp,outlined:"","aria-label":"Вернуться в предыдущую папку"})):S("",!0)])]),o("div",fe,[o("div",ve,[s(d,{icon:"pi pi-folder",label:"Шаблоны",onClick:t[0]||(t[0]=a=>e.navigateTo("templates")),severity:e.currentFolder==="templates"?"primary":"secondary",outlined:"",class:"w-full"},null,8,["severity"])]),o("div",be,[s(d,{icon:"pi pi-download",label:"Загрузки",onClick:t[1]||(t[1]=a=>e.navigateTo("download")),severity:e.currentFolder==="download"?"primary":"secondary",outlined:"",class:"w-full"},null,8,["severity"])])]),t[10]||(t[10]=o("div",{class:"surface-card p-3 border-round"},[o("div",{class:"flex justify-content-between align-items-center"},[o("span",{class:"font-semibold"},"Путь для пользовательских файлов:"),o("code",{class:"surface-border border-1 px-2 py-1 border-round"}," download/{session.database}/ ")]),o("small",{class:"text-color-secondary mt-2 block"}," Загружайте CSS, JS, шрифты и другие файлы в директорию download для использования в шаблонах ")],-1))])]),_:1}),s(g,{header:"Загрузка файлов",toggleable:!0,collapsed:!e.showUpload,class:"mb-3"},{default:r(()=>[o("div",ye,[s(U,{name:"files[]",multiple:!0,customUpload:!0,onUploader:e.handleFileUpload,auto:!1,chooseLabel:"Выбрать файлы",uploadLabel:"Загрузить",cancelLabel:"Отмена"},{empty:r(()=>[...t[11]||(t[11]=[o("p",null,'Перетащите файлы сюда или нажмите "Выбрать файлы"',-1)])]),_:1})])]),_:1},8,["collapsed"]),s(g,{header:"Создать папку",toggleable:!0,collapsed:!0,class:"mb-3"},{default:r(()=>[o("div",ge,[s(B,{modelValue:e.newFolderName,"onUpdate:modelValue":t[2]||(t[2]=a=>e.newFolderName=a),placeholder:"Имя новой папки",class:"flex-1","aria-label":"Имя новой папки"},null,8,["modelValue"]),s(d,{icon:"pi pi-plus",label:"Создать",onClick:e.createFolder,disabled:!e.newFolderName,"aria-label":"Создать папку"},null,8,["disabled"])])]),_:1}),s(g,{header:"Резервное копирование",toggleable:!0,collapsed:!0,class:"mb-3"},{default:r(()=>[o("div",_e,[t[14]||(t[14]=o("p",null,[x(" Создайте резервную копию базы данных в компактный архив. Архив будет сохранен в папке "),o("code",null,"templates/backups/"),x(". ")],-1)),o("div",we,[s(d,{icon:"pi pi-download",label:"Создать резервную копию",onClick:e.createBackup,loading:e.loading.backup,severity:"success","aria-label":"Создать резервную копию базы данных"},null,8,["loading"])]),e.backupFiles.length>0?(v(),C("div",xe,[s(E),t[13]||(t[13]=o("h4",{class:"mt-0 mb-2"},"Восстановление из резервной копии",-1)),s(f,{severity:"warn",closable:!1,class:"mb-2"},{default:r(()=>[...t[12]||(t[12]=[o("small",null,"Внимание! Восстановление заменит все текущие данные базы.",-1)])]),_:1}),s(b,{value:e.backupFiles,stripedRows:"",size:"small"},{default:r(()=>[s(c,{field:"name",header:"Файл бэкапа"}),s(c,{field:"size",header:"Размер"},{body:r(({data:a})=>[x(h(e.formatFileSize(a.size)),1)]),_:1}),s(c,{header:"Действие",style:{width:"150px"}},{body:r(({data:a})=>[s(d,{icon:"pi pi-replay",label:"Восстановить",size:"small",severity:"warning",onClick:p=>e.confirmRestore(a),loading:e.loading.restore},null,8,["onClick","loading"])]),_:1})]),_:1},8,["value"])])):S("",!0)])]),_:1}),s(g,{header:"Файлы и папки",class:"mb-3"},{default:r(()=>[o("div",he,[o("span",ke,h(e.fileList.length+e.folderList.length)+" элементов ",1),o("div",Ce,[s(d,{icon:"pi pi-check-square",label:"Выбрать все",onClick:e.selectAll,text:"","aria-label":"Выбрать все элементы"}),s(d,{icon:"pi pi-trash",label:"Удалить выбранные",onClick:e.confirmDeleteSelected,disabled:e.selectedItems.length===0,severity:"danger",outlined:"","aria-label":"Удалить выбранные элементы"},null,8,["disabled"])])]),s(b,{value:e.combinedList,selection:e.selectedItems,"onUpdate:selection":t[3]||(t[3]=a=>e.selectedItems=a),dataKey:"name",loading:e.loading.list,stripedRows:"",showGridlines:""},{default:r(()=>[s(c,{selectionMode:"multiple",headerStyle:"width: 3rem"}),s(c,{field:"type",header:"Тип",style:{width:"60px"}},{body:r(({data:a})=>[a.type==="folder"?(v(),C("i",De)):(v(),C("i",Fe))]),_:1}),s(c,{field:"name",header:"Имя"},{body:r(({data:a})=>[a.type==="folder"?(v(),C("a",{key:0,onClick:p=>e.navigateToFolder(a.name),class:"cursor-pointer text-primary font-semibold"},h(a.name),9,Ie)):(v(),C("span",Ue,h(a.name),1))]),_:1}),s(c,{field:"size",header:"Размер",style:{width:"120px"}},{body:r(({data:a})=>[x(h(a.type==="file"?e.formatFileSize(a.size):"—"),1)]),_:1}),s(c,{field:"modified",header:"Изменен",style:{width:"180px"}},{body:r(({data:a})=>[x(h(a.modified?new Date(a.modified).toLocaleString("ru-RU"):"—"),1)]),_:1}),s(c,{header:"Действия",style:{width:"220px"}},{body:r(({data:a})=>[o("div",Be,[a.type==="file"?z((v(),T(d,{key:0,icon:"pi pi-eye",onClick:p=>e.viewFile(a),text:"",rounded:"","aria-label":"Просмотреть файл"},null,8,["onClick"])),[[k,"Просмотр",void 0,{top:!0}]]):S("",!0),a.type==="file"&&e.isEditable(a.name)?z((v(),T(d,{key:1,icon:"pi pi-pencil",onClick:p=>e.editFile(a),text:"",rounded:"","aria-label":"Редактировать файл"},null,8,["onClick"])),[[k,"Редактировать",void 0,{top:!0}]]):S("",!0),a.type==="file"?z((v(),T(d,{key:2,icon:"pi pi-download",onClick:p=>e.downloadFile(a),text:"",rounded:"","aria-label":"Скачать файл"},null,8,["onClick"])),[[k,"Скачать",void 0,{top:!0}]]):S("",!0),a.type==="file"?z((v(),T(d,{key:3,icon:"pi pi-copy",onClick:p=>e.copyPath(a),text:"",rounded:"","aria-label":"Копировать путь"},null,8,["onClick"])),[[k,"Копировать путь",void 0,{top:!0}]]):S("",!0),z(s(d,{icon:"pi pi-trash",onClick:p=>e.confirmDelete(a),severity:"danger",text:"",rounded:"",class:"ml-auto","aria-label":"Удалить"},null,8,["onClick"]),[[k,"Удалить",void 0,{top:!0}]])])]),_:1})]),_:1},8,["value","selection","loading"])]),_:1}),s(y,{visible:e.deleteDialog.visible,"onUpdate:visible":t[5]||(t[5]=a=>e.deleteDialog.visible=a),header:"Подтверждение удаления",modal:!0,style:{width:"450px"}},{footer:r(()=>[o("div",Ee,[s(d,{label:"Отмена",icon:"pi pi-times",onClick:t[4]||(t[4]=a=>e.deleteDialog.visible=!1),text:"","aria-label":"Отменить удаление"}),s(d,{label:"Удалить",icon:"pi pi-trash",severity:"danger",onClick:e.executeDelete,"aria-label":"Подтвердить удаление"})])]),default:r(()=>[o("div",Se,[t[19]||(t[19]=o("i",{class:"pi pi-exclamation-triangle text-4xl text-warning"},null,-1)),e.deleteDialog.items.length===1?(v(),C("span",Te,[t[15]||(t[15]=x(" Вы уверены, что хотите удалить ",-1)),o("strong",null,h(e.deleteDialog.items[0].name),1),t[16]||(t[16]=x("? ",-1))])):(v(),C("span",ze,[t[17]||(t[17]=x(" Вы уверены, что хотите удалить ",-1)),o("strong",null,h(e.deleteDialog.items.length),1),t[18]||(t[18]=x(" элементов? ",-1))]))])]),_:1},8,["visible"]),s(y,{visible:e.restoreDialog.visible,"onUpdate:visible":t[7]||(t[7]=a=>e.restoreDialog.visible=a),header:"Подтверждение восстановления",modal:!0,style:{width:"500px"}},{footer:r(()=>[o("div",Ae,[s(d,{label:"Отмена",icon:"pi pi-times",onClick:t[6]||(t[6]=a=>e.restoreDialog.visible=!1),text:"","aria-label":"Отменить восстановление"}),s(d,{label:"Восстановить",icon:"pi pi-replay",severity:"warning",onClick:e.executeRestore,loading:e.loading.restore,"aria-label":"Подтвердить восстановление"},null,8,["loading"])])]),default:r(()=>{var a;return[o("div",Le,[o("div",je,[t[22]||(t[22]=o("i",{class:"pi pi-exclamation-triangle text-4xl",style:{color:"var(--orange-500)"}},null,-1)),o("div",null,[t[20]||(t[20]=o("p",{class:"m-0 font-bold"},"Внимание! Это действие необратимо.",-1)),t[21]||(t[21]=o("p",{class:"m-0 mt-2"}," Все текущие данные базы будут заменены данными из резервной копии: ",-1)),o("p",Me,[o("strong",null,h((a=e.restoreDialog.file)==null?void 0:a.name),1)])])]),s(f,{severity:"warn",closable:!1},{default:r(()=>[...t[23]||(t[23]=[o("small",null,"Рекомендуется создать резервную копию текущего состояния перед восстановлением.",-1)])]),_:1})])]}),_:1},8,["visible"])])}const Ke=ne(de,[["render",Re],["__scopeId","data-v-4376913e"],["__file","/home/hive/integram-standalone/src/components/integram/IntegramDirAdmin.vue"]]);export{Ke as default};
