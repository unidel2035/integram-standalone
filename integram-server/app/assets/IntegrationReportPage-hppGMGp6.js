import{D as e,r as l,J as a,N as t,L as o,K as i,P as n,c as s,A as r,a as u,h as d,y as v,w as c,u as m,o as p,b as f,f as y,t as g,G as w,j as x,g as h,F as b,d as _,aQ as k}from"./index-DSwq2M__.js";import{i as j}from"./integramService-BCsancml.js";import{l as I}from"./logger-DLAyPY85.js";import{I as $}from"./IntegramBreadcrumb-YrezANl5.js";import{_ as R}from"./_plugin-vue_export-helper-BCo6x5W8.js";import"./integramApiClient-BsYdo77J.js";import"./index-CcrxTH1M.js";import"./unifiedAuthService-6fZILgG8.js";const C={class:"integram-report-page"},L={class:"mb-3"},z={class:"flex align-items-center justify-content-between"},E={class:"flex gap-2 align-items-center ml-auto"},S={key:0,class:"text-center p-5"},D={key:1,class:"text-center p-5"},T={class:"flex justify-content-between align-items-center"},M={class:"font-bold"},O={key:0,class:"text-sm text-500"},P={key:1,class:"text-sm text-500"},V={key:0},A={key:1},F={key:3,class:"mt-3 text-center py-3"},U={class:"flex align-items-center justify-content-between"},N={class:"flex align-items-center gap-2"},J={class:"flex gap-2 align-items-center ml-auto"},X={key:0,class:"text-center p-5"},B={key:1,class:"p-5"},G={class:"flex gap-1 align-items-center"},H={class:"flex justify-content-between align-items-center"},Q={class:"font-bold"},K={class:"text-sm text-500"},Y={key:3,class:"text-center p-5"},q=R({__name:"IntegrationReportPage",setup(R){const q=t(),W=o(),Z=e(),ee=l(!1),le=l(!1),ae=l([]),te=l(null),oe=l(null),ie=l(null),ne=l(!1),se=l(!1),re=l(null),ue=l(null),de=l(null),ve=l(null),ce=l(1),me=l(20),pe=l(0),fe=l(1),ye=l(!1),ge=l(!1),we=l(!0),xe=a(()=>q.params.database||"my"),he=a(()=>{var e;const l=[{label:"Отчёты",to:te.value?`/integram/${xe.value}/report`:void 0}];return te.value&&(null==(e=oe.value)?void 0:e.report_name)&&l.push({label:oe.value.report_name}),l}),be=a(()=>[{label:"Открыть",icon:"pi pi-eye",command:()=>{de.value&&Ee(de.value.id)}},{label:"Редактировать",icon:"pi pi-pencil",command:()=>{de.value&&W.push(`/integram/${xe.value}/object/${de.value.id}?edit=1`)}},{separator:!0},{label:"Копировать ID",icon:"pi pi-copy",command:()=>{de.value&&(navigator.clipboard.writeText(String(de.value.id)),Z.add({severity:"success",summary:"Скопировано",detail:`ID ${de.value.id} скопирован`,life:2e3}))}},{label:"Копировать название",icon:"pi pi-copy",command:()=>{de.value&&(navigator.clipboard.writeText(de.value.name||""),Z.add({severity:"success",summary:"Скопировано",detail:"Название скопировано",life:2e3}))}},{separator:!0},{label:"Удалить",icon:"pi pi-trash",class:"text-red-500",command:()=>{var e;de.value&&(e=de.value,confirm(`Удалить отчет "${e.name}" (ID: ${e.id})?`)&&async function(e){try{await j.deleteObject(e),Z.add({severity:"success",summary:"Удалено",detail:`Отчет #${e} удален`,life:3e3}),Ie(ce.value,me.value,!1)}catch(l){Z.add({severity:"error",summary:"Ошибка",detail:"Не удалось удалить отчет: "+l.message,life:5e3})}}(e.id))}}]),_e=a(()=>[{label:"Копировать строку",icon:"pi pi-copy",command:()=>{if(ve.value){const e=Object.values(ve.value).join("\t");navigator.clipboard.writeText(e),Z.add({severity:"success",summary:"Скопировано",detail:"Строка скопирована в буфер",life:2e3})}}},{label:"Копировать как JSON",icon:"pi pi-file",command:()=>{ve.value&&(navigator.clipboard.writeText(JSON.stringify(ve.value,null,2)),Z.add({severity:"success",summary:"Скопировано",detail:"JSON скопирован в буфер",life:2e3}))}},{separator:!0},{label:"Экспорт в Excel",icon:"pi pi-download",command:()=>{De()}}]);function ke(e){de.value=e.data,re.value.show(e.originalEvent)}function je(e){ve.value=e.data,ue.value.show(e.originalEvent)}async function Ie(e=1,l=me.value,a=!1){a||(ee.value=!0),ie.value=null;try{const t=await j.getObjects(22,{pg:e,LIMIT:l});if(t&&t.object){const o=t.object.map(e=>({id:e.id,name:e.val||`Отчет #${e.id}`,created_at:e.created_at||null,updated_at:e.updated_at||null}));a&&ye.value?0===o.length?we.value=!1:(ae.value=[...ae.value,...o],o.length<l&&(we.value=!1)):(ae.value=o,we.value=o.length>=l),void 0!==t.current_page?ce.value=t.current_page:ce.value=e,void 0!==t.total_objects?pe.value=t.total_objects:void 0!==t.count?pe.value=t.count:void 0!==t.total?pe.value=t.total:ae.value.length<l?pe.value=(e-1)*l+ae.value.length:pe.value=2*ae.value.length,void 0!==t.total_pages?fe.value=t.total_pages:l>0&&pe.value>0?fe.value=Math.ceil(pe.value/l):ae.value.length>=l?fe.value=e+1:fe.value=e,I.info(`Loaded ${ae.value.length} reports from type 22 objects (page ${e}, LIMIT ${l}, total ${pe.value})`)}else I.warn("No reports found in type 22 objects"),ae.value=[],pe.value=0,fe.value=1}catch(t){I.error("Failed to load reports:",t),Z.add({severity:"error",summary:"Ошибка",detail:"Не удалось загрузить список отчетов: "+t.message,life:5e3}),ae.value=[],pe.value=0,fe.value=1}finally{ee.value=!1}}function $e(e){const l=e.page+1;me.value=e.rows,Ie(l,e.rows,!1)}function Re(){ye.value=!ye.value,ye.value?(ce.value=1,we.value=!0,Ie(1,me.value,!1),window.addEventListener("scroll",Ce)):(window.removeEventListener("scroll",Ce),Ie(ce.value,me.value,!1))}function Ce(){if(!ye.value||ge.value||!we.value||te.value)return;const e=window.scrollY||document.documentElement.scrollTop,l=window.innerHeight;document.documentElement.scrollHeight-e-l<200&&async function(){if(ge.value||!we.value)return;ge.value=!0;const e=ce.value+1;try{await Ie(e,me.value,!0),ce.value=e}catch(l){}finally{ge.value=!1}}()}async function Le(){if(!te.value)return void Z.add({severity:"warn",summary:"Предупреждение",detail:"ID отчета не указан",life:3e3});le.value=!0,ie.value=null;const e=performance.now();try{const l=await j.executeReport(te.value,{}),a=performance.now()-e;if(!l)throw new Error("Пустой ответ от сервера");{I.info("Report response:",l);let e=[],t=[];if(Array.isArray(l))l.length>0&&(e=Object.keys(l[0]),t=l),I.info(`Direct array response detected. Rows: ${t.length}, Columns: ${e.join(", ")}`);else{if(!l.columns||!l.data)throw I.warn("Unexpected report response format:",l),new Error("Неподдерживаемый формат ответа от сервера. Ожидается массив объектов или {columns, data}");e=l.columns,t=l.data.map(l=>{const a={};return e.forEach((e,t)=>{a[e]=l[t]}),a}),I.info(`Legacy format detected. Rows: ${t.length}, Columns: ${e.join(", ")}`)}oe.value={report_name:l.report_name||`Отчет #${te.value}`,columns:e,rows:t,total_rows:t.length,execution_time_ms:l.execution_time_ms||a},I.info(`Report ${te.value} executed successfully`,oe.value),Z.add({severity:"success",summary:"Успех",detail:`Отчет выполнен. Получено строк: ${t.length}`,life:3e3})}}catch(l){I.error(`Failed to execute report ${te.value}:`,l),ie.value=l.message||"Не удалось выполнить отчет",Z.add({severity:"error",summary:"Ошибка",detail:ie.value,life:5e3})}finally{le.value=!1}}function ze(e){Ee(e.data.id)}function Ee(e){te.value=e,oe.value=null,ie.value=null,W.push({name:"Integram Report",params:{reportId:e}}),Le()}function Se(){te.value=null,oe.value=null,ie.value=null,W.push({name:"Integram Report"})}function De(){if(!oe.value||!oe.value.rows||0===oe.value.rows.length)return void Z.add({severity:"warn",summary:"Предупреждение",detail:"Нет данных для экспорта",life:3e3});const e=window.XLSX;if(e)try{const l=oe.value.rows,a=e.utils.json_to_sheet(l),t=e.utils.book_new();e.utils.book_append_sheet(t,a,"Report");const o=`report_${te.value}_${(new Date).toISOString().split("T")[0]}.xlsx`;e.writeFile(t,o),Z.add({severity:"success",summary:"Экспорт",detail:"Отчет экспортирован в Excel",life:3e3})}catch(l){I.error("Failed to export to Excel:",l),Z.add({severity:"error",summary:"Ошибка",detail:"Не удалось экспортировать отчет: "+l.message,life:5e3})}else Z.add({severity:"error",summary:"Ошибка",detail:"Библиотека XLSX не загружена",life:3e3})}function Te(e){if(!e)return"-";try{return new Date(e).toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}catch{return e}}return i(async()=>{q.params.reportId&&"undefined"!==q.params.reportId?(te.value=q.params.reportId,await Le()):await Ie()}),n(()=>{window.removeEventListener("scroll",Ce)}),(e,l)=>{const a=v("Toast"),t=v("ContextMenu"),o=v("Button"),i=v("ProgressSpinner"),n=v("Column"),j=v("DataTable"),I=v("Card"),R=v("Message"),q=v("InputText"),W=m("tooltip");return p(),s("div",C,[r(a),r(t,{ref_key:"reportListMenuRef",ref:re,model:be.value},null,8,["model"]),r(t,{ref_key:"reportDataMenuRef",ref:ue,model:_e.value},null,8,["model"]),u("div",L,[r($,{items:he.value},null,8,["items"])]),te.value?(p(),d(I,{key:1},{title:c(()=>{var e;return[u("div",U,[u("div",N,[x(r(o,{icon:"pi pi-arrow-left",onClick:Se,outlined:"",rounded:"",size:"small"},null,512),[[W,"Назад",void 0,{bottom:!0}]]),u("span",null,g((null==(e=oe.value)?void 0:e.report_name)||(te.value?`Отчет #${te.value}`:"Отчет")),1)]),u("div",J,[x(r(o,{icon:"pi pi-filter",onClick:l[1]||(l[1]=e=>ne.value=!ne.value),size:"small",rounded:"",severity:ne.value?"info":"secondary",outlined:!ne.value},null,8,["severity","outlined"]),[[W,ne.value?"Скрыть фильтры":"Показать фильтры",void 0,{bottom:!0}]]),x(r(o,{icon:"pi pi-arrows-h",onClick:l[2]||(l[2]=e=>se.value=!se.value),size:"small",rounded:"",outlined:""},null,512),[[W,se.value?"Обычный":"Компактный",void 0,{bottom:!0}]]),x(r(o,{icon:"pi pi-download",onClick:De,size:"small",rounded:"",severity:"success",outlined:"",disabled:!oe.value||!oe.value.rows||0===oe.value.rows.length},null,8,["disabled"]),[[W,"Excel",void 0,{bottom:!0}]]),x(r(o,{icon:"pi pi-refresh",onClick:Le,size:"small",rounded:"",loading:le.value,outlined:""},null,8,["loading"]),[[W,"Обновить",void 0,{bottom:!0}]])])])]}),content:c(()=>[le.value&&!oe.value?(p(),s("div",X,[r(i),l[8]||(l[8]=u("p",{class:"mt-3"},"Выполнение отчета...",-1))])):ie.value?(p(),s("div",B,[r(R,{severity:"error",closable:!1},{default:c(()=>[y(g(ie.value),1)]),_:1})])):oe.value&&oe.value.rows?(p(),d(j,{key:2,value:oe.value.rows,size:se.value?"small":"normal",showGridlines:"",stripedRows:"",loading:le.value,paginator:oe.value.rows.length>20,rows:20,rowsPerPageOptions:[20,50,100],responsiveLayout:"scroll",onRowContextmenu:je,contextMenu:""},{footer:c(()=>{var e;return[u("div",H,[u("div",Q," Всего строк: "+g(oe.value.total_rows),1),u("div",K," Время выполнения: "+g(null==(e=oe.value.execution_time_ms)?void 0:e.toFixed(2))+" мс ",1)])]}),default:c(()=>[(p(!0),s(b,null,_(oe.value.columns,(e,a)=>(p(),d(n,{key:a,field:e,header:e,sortable:!0},k({_:2},[ne.value?{name:"filter",fn:c(({filterModel:e})=>[u("div",G,[r(q,{modelValue:e.from,"onUpdate:modelValue":l=>e.from=l,placeholder:"От",size:"small",class:"p-column-filter",style:{width:"50px"}},null,8,["modelValue","onUpdate:modelValue"]),l[9]||(l[9]=u("span",null,"-",-1)),r(q,{modelValue:e.to,"onUpdate:modelValue":l=>e.to=l,placeholder:"До",size:"small",class:"p-column-filter",style:{width:"50px"}},null,8,["modelValue","onUpdate:modelValue"])])]),key:"0"}:void 0]),1032,["field","header"]))),128))]),_:1},8,["value","size","loading","paginator"])):(p(),s("div",Y,[...l[10]||(l[10]=[u("i",{class:"pi pi-inbox text-6xl text-400 mb-3"},null,-1),u("p",{class:"text-xl text-500"},"Нет данных для отображения",-1)])]))]),_:1})):(p(),d(I,{key:0},{title:c(()=>[u("div",z,[l[3]||(l[3]=u("span",null,"Отчеты",-1)),u("div",E,[x(r(o,{icon:ye.value?"pi pi-arrows-v":"pi pi-list",size:"small",outlined:!ye.value,rounded:"",onClick:Re,class:h({"button-on":ye.value})},null,8,["icon","outlined","class"]),[[W,ye.value?"Infinite Scroll (вкл)":"Обычная пагинация",void 0,{bottom:!0}]]),x(r(o,{icon:"pi pi-refresh",onClick:l[0]||(l[0]=e=>Ie(1,me.value,!1)),loading:ee.value,outlined:"",rounded:"",size:"small"},null,8,["loading"]),[[W,"Обновить",void 0,{bottom:!0}]])])])]),content:c(()=>[ee.value&&0===ae.value.length?(p(),s("div",S,[r(i),l[4]||(l[4]=u("p",{class:"mt-3"},"Загрузка списка отчетов...",-1))])):ee.value||0!==ae.value.length?(p(),d(j,{key:2,value:ae.value,paginator:!ye.value,rows:me.value,totalRecords:pe.value,lazy:!ye.value,loading:ee.value,stripedRows:"",showGridlines:"",responsiveLayout:"scroll",onRowClick:ze,onRowContextmenu:ke,onPage:$e,rowsPerPageOptions:[10,20,50,100],class:"cursor-pointer",contextMenu:""},{footer:c(()=>[u("div",T,[u("div",M," Всего отчетов: "+g(ye.value?ae.value.length:pe.value),1),ye.value?(p(),s("div",P,[we.value?(p(),s("span",V,"Прокрутите для загрузки...")):(p(),s("span",A,[...l[6]||(l[6]=[u("i",{class:"pi pi-check-circle mr-1"},null,-1),y("Все данные загружены",-1)])]))])):(p(),s("div",O," Страница "+g(ce.value)+" из "+g(fe.value),1))])]),default:c(()=>[r(n,{field:"id",header:"ID",sortable:"",style:{width:"100px"}}),r(n,{field:"name",header:"Название",sortable:""}),r(n,{field:"created_at",header:"Создан",sortable:"",style:{width:"200px"}},{body:c(({data:e})=>[y(g(Te(e.created_at)),1)]),_:1}),r(n,{field:"updated_at",header:"Обновлен",sortable:"",style:{width:"200px"}},{body:c(({data:e})=>[y(g(Te(e.updated_at)),1)]),_:1}),r(n,{header:"Действия",style:{width:"150px"}},{body:c(({data:e})=>[r(o,{label:"Открыть",icon:"pi pi-eye",size:"small",onClick:w(l=>Ee(e.id),["stop"]),outlined:""},null,8,["onClick"])]),_:1})]),_:1},8,["value","paginator","rows","totalRecords","lazy","loading"])):(p(),s("div",D,[...l[5]||(l[5]=[u("i",{class:"pi pi-file text-6xl text-400 mb-3"},null,-1),u("p",{class:"text-xl text-500"},"Отчеты не найдены",-1)])])),ye.value&&ge.value?(p(),s("div",F,[r(i,{style:{width:"30px",height:"30px"}}),l[7]||(l[7]=u("span",{class:"ml-2 text-color-secondary"},"Загрузка...",-1))])):f("",!0)]),_:1}))])}}},[["__scopeId","data-v-e935e311"]]);export{q as default};
