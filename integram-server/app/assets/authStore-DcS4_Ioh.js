import{a as X}from"./index-B9ygI19o.js";import{W as le,d,I as z}from"./index-D6FYndJO.js";import{u as S}from"./unifiedAuthService-xCuNj-Bd.js";function ie(e){e.interceptors.request.use(t=>t,t=>Promise.reject(t)),e.interceptors.response.use(t=>t,t=>Promise.reject(t))}function ue(e){return ie(e)}function ce(e){return e}let k=0;const O=new Map,_e=(e,t,o)=>(O.set(o,{show:e,hide:t}),()=>O.delete(o)),$=e=>{O.forEach(t=>{e?t.show():t.hide()})},J=(e=null)=>{const t=localStorage.getItem("apiBase"),o=e||localStorage.getItem("db")||"a2025";if(t==="localhost")return`http://localhost/${o}/`;let a=t;if(!a){const r=window.location.hostname,u=window.location.protocol;if(a=r,r.match(/^\d+\.\d+\.\d+\.\d+$/)||r==="localhost")return`${u}//${a}/${o}/`;a=r}return`https://${a}/${o}/`},R=X.create({baseURL:J(),timeout:5e6,headers:{"Content-Type":"application/json"}});function de(){const e=localStorage.getItem("token"),t=localStorage.getItem("db")||"a2025";return{token:e,db:t}}R.interceptors.request.use(e=>{e.baseURL=J(e.targetDatabase);const{token:t,db:o}=de(),a=e.baseURL||"";let r=o.toLowerCase();try{const _=new URL(a).pathname.split("/").filter(I=>I.length>0);_.length>0&&(r=_[0].toLowerCase())}catch{const v=a.match(/\/([^/]+)\/?$/);v&&(r=v[1].toLowerCase())}const u=o.toLowerCase(),f=r.toLowerCase();return u==="my"?f==="my"?t&&(e.headers["X-Authorization"]=t):t&&(e.headers.my=t):t&&(e.headers["X-Authorization"]=t),t?t.length>8&&`${t.substring(0,4)}${t.substring(t.length-4)}`:console.warn("[axios2] No token found in localStorage!",{authDb:o,url:e.url,localStorageKeys:Object.keys(localStorage)}),e.params||(e.params={}),e.url&&e.url.includes("/report")?e.params.JSON_RICH=!0:e.params.JSON_RICH||(e.params.JSON_KV=!0),e.data instanceof FormData&&(e.headers["Content-Type"]="multipart/form-data"),k++,k===1&&$(!0),e},e=>(k=Math.max(0,k-1),k===0&&$(!1),window.errorHandler&&window.errorHandler.handle(e,{source:"axios2-request"}),Promise.reject(e)));R.interceptors.response.use(async e=>{if(k=Math.max(0,k-1),k===0&&$(!1),(e.config.url||"").includes("/object/")&&e.data)try{const a={edit_types:{}},r=ce(e.data,a,{});e.data={status:200,response:r}}catch(a){console.error("Error remapping response:",a),e.data.response||(e.data={status:200,response:e.data})}return e},e=>{var t,o,a,r,u;if(k=Math.max(0,k-1),k===0&&$(!1),e.response&&e.response.status===401){const f=((t=e.config)==null?void 0:t.url)||"";f.includes("/auth")||f.includes("/user")||f.includes("/login")?(console.warn("⚠️ 401 Unauthorized on auth endpoint - clearing session"),localStorage.removeItem("token"),localStorage.removeItem("_xsrf"),localStorage.removeItem("integram_session"),window.errorHandler&&window.errorHandler.handle(new Error("Сессия истекла. Пожалуйста, войдите в систему заново."),{source:"axios2-auth-expired",url:(o=e.config)==null?void 0:o.url,method:(a=e.config)==null?void 0:a.method})):console.warn("⚠️ 401 Unauthorized on non-auth endpoint:",f,"- not clearing session")}return window.errorHandler&&window.errorHandler.handle(e,{source:"axios2-response",url:(r=e.config)==null?void 0:r.url,method:(u=e.config)==null?void 0:u.method}),Promise.reject(e)});ue(R);const F=5*1024*1024,me=.8,ge=10080*60*1e3;function y(e){return e?new Blob([e]).size:0}function M(){let e=0;try{for(let t in localStorage)localStorage.hasOwnProperty(t)&&(e+=y(localStorage[t]),e+=y(t))}catch(t){console.warn("[localStorage] Error calculating storage size:",t)}return e}function V(){let e=0;try{const t=localStorage.getItem("session_timestamp");if(t){const a=Date.now()-parseInt(t);if(a>ge){const r=localStorage.getItem("integram_session");r&&(e+=y(r),localStorage.removeItem("integram_session")),e+=y(t),localStorage.removeItem("session_timestamp"),console.log("[localStorage] Removed expired session data:",{ageInDays:Math.floor(a/(1440*60*1e3)),bytesFreed:e})}}if(!t&&localStorage.getItem("unified_auth_session_id")){const a=localStorage.getItem("unified_auth_session_id");e+=y(a),localStorage.removeItem("unified_auth_session_id"),console.log("[localStorage] Removed orphaned unified_auth_session_id")}const o=[];for(let a in localStorage)localStorage.hasOwnProperty(a)&&a.startsWith("test_")&&o.push(a);o.forEach(a=>{const r=localStorage.getItem(a);e+=y(r)+y(a),localStorage.removeItem(a)}),o.length>0&&console.log(`[localStorage] Removed ${o.length} test keys`)}catch(t){console.warn("[localStorage] Error during cleanup:",t)}return e}function h(e,t){try{const o=typeof t=="string"?t:String(t),a=M(),r=y(o)+y(e),u=a+r;if(u>F*me){const f=(u/F*100).toFixed(1);console.warn(`[localStorage] Near quota limit: ${f}% (${(u/1024).toFixed(1)} KB / ${(F/1024).toFixed(0)} KB)`);const m=V();m>0&&console.log(`[localStorage] Freed ${(m/1024).toFixed(2)} KB from cleanup`)}return localStorage.setItem(e,o),!0}catch(o){if(o.name==="QuotaExceededError"){console.error("[localStorage] QuotaExceededError: Storage quota exceeded",{key:e,valueSize:y(t),currentSize:M(),maxSize:F});const a=V();console.log(`[localStorage] Cleanup freed ${(a/1024).toFixed(2)} KB`);try{return localStorage.setItem(e,typeof t=="string"?t:String(t)),console.log("[localStorage] Successfully saved after cleanup"),!0}catch(r){console.error("[localStorage] Failed to save even after cleanup:",r);const u=Se();return console.error("[localStorage] Current storage state:",{totalSizeKB:u.totalSizeKB,percentUsed:u.percentUsed,itemCount:u.items.length,largestItems:u.items.slice(0,5)}),!1}}return console.error("[localStorage] Error setting item:",o),!1}}function fe(e){try{return localStorage.getItem(e)}catch(t){return console.error("[localStorage] Error getting item:",t),null}}function n(e){try{return localStorage.removeItem(e),!0}catch(t){return console.error("[localStorage] Error removing item:",t),!1}}function Se(){let e=0;const t={};try{for(let o in localStorage)if(localStorage.hasOwnProperty(o)){const a=localStorage[o],r=y(a)+y(o);e+=r,t[o]=r}}catch(o){console.warn("[localStorage] Error getting storage stats:",o)}return{totalSize:e,totalSizeKB:(e/1024).toFixed(2),percentUsed:(e/F*100).toFixed(1),items:Object.entries(t).sort(([,o],[,a])=>a-o).map(([o,a])=>({key:o,sizeKB:(a/1024).toFixed(2),sizeBytes:a}))}}const ke=le("auth",()=>{const e=d(null),t=d(null),o=d(null),a=d(null),r=d(null),u=d("my"),f=d(window.location.hostname),m=d(null),v=d(null),_=d(null),I=d(null),b=d(null),A=d(null),T=d(null),D=d(null),L=d(!1),C=d(null),N=z(()=>!!t.value||S.isAuthenticated()),j=z(()=>!!m.value),B=z(()=>!!b.value);async function G(){if(t.value=localStorage.getItem("token"),o.value=localStorage.getItem("user"),a.value=localStorage.getItem("id"),r.value=localStorage.getItem("_xsrf"),u.value=localStorage.getItem("db")||"a2025",f.value=localStorage.getItem("apiBase")||window.location.hostname,m.value=localStorage.getItem("ddadmin_token"),v.value=localStorage.getItem("ddadmin_user"),_.value=localStorage.getItem("ddadmin_id"),I.value=localStorage.getItem("ddadmin_xsrf"),b.value=localStorage.getItem("my_token"),A.value=localStorage.getItem("my_user"),T.value=localStorage.getItem("my_id"),D.value=localStorage.getItem("my_xsrf"),S.isAuthenticated())try{const s=await S.getSession();s?(e.value=s,await q()):(console.warn("[authStore] Unified session not found, clearing unified session only"),e.value=null)}catch(s){console.warn("[authStore] Failed to load unified session:",s),e.value=null}}async function q(){if(S.isAuthenticated())try{const s=await S.getAllTokens(),c=u.value||"ddadmin";if(s[c]){const l=s[c];t.value=l.token,r.value=l.xsrf,a.value=l.userId,o.value=l.userName,h("token",l.token),h("_xsrf",l.xsrf),h("id",l.userId),h("user",l.userName)}if(s.ddadmin){const l=s.ddadmin;m.value=l.token,I.value=l.xsrf,_.value=l.userId,v.value=l.userName,h("ddadmin_token",l.token),h("ddadmin_xsrf",l.xsrf),h("ddadmin_id",l.userId),h("ddadmin_user",l.userName)}}catch(s){console.warn("[authStore] Failed to sync unified tokens:",s)}}async function W(){e.value=null,t.value=null,o.value=null,a.value=null,r.value=null,m.value=null,v.value=null,_.value=null,I.value=null,b.value=null,A.value=null,T.value=null,D.value=null,n("token"),n("user"),n("id"),n("_xsrf"),n("ddadmin_token"),n("ddadmin_user"),n("ddadmin_id"),n("ddadmin_xsrf"),n("my_token"),n("my_user"),n("my_id"),n("my_xsrf"),n("accessToken"),n("refreshToken"),n("session_timestamp"),n("integram_session"),n("unified_auth_session_id")}async function Q(s,c,l,p){const w=new URLSearchParams;w.append("login",s),w.append("pwd",c);let i;l==="localhost"?i=`http://localhost/${p}/`:i=`https://${l}/${p}`;let g=(await X.create({baseURL:i,timeout:3e4,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).post("/auth",w,{params:{JSON_KV:!0}})).data;if(Array.isArray(g)&&g.length>0&&(g=g[0]),!g.token)throw new Error(g.error||g.warning||"Authentication failed");return{token:g.token,_xsrf:g._xsrf,id:g.id,user:s}}async function Z(s,c,l=window.location.hostname,p="my"){var w;L.value=!0,C.value=null;try{u.value=p,f.value=l,h("db",p),h("apiBase",l);const i=await Q(s,c,l,p);t.value=i.token,o.value=i.user,a.value=i.id,r.value=i._xsrf;const K={token:i.token,user:i.user,id:i.id,_xsrf:i._xsrf};console.log("[authStore] Saving authentication tokens to localStorage",{database:p,hasToken:!!i.token,tokenLength:(w=i.token)==null?void 0:w.length,userId:i.id});for(const[x,U]of Object.entries(K)){if(!h(x,U))throw console.error(`[authStore] Failed to save ${x} to localStorage (quota exceeded or storage error)`),new Error(`Failed to save ${x} to localStorage - storage quota may be exceeded`);const P=fe(x);if(P!==U)throw console.error(`[authStore] Failed to save ${x} to localStorage. Expected: ${U}, Got: ${P}`),new Error(`Failed to save ${x} to localStorage`)}const E=localStorage.getItem("token");if(!E||E!==i.token)throw console.error("[authStore] Token verification failed after save!",{expected:i.token,actual:E}),new Error("Token verification failed - localStorage may be disabled or full");console.log("[authStore] Authentication tokens saved successfully",{token:E.substring(0,10)+"...",user:localStorage.getItem("user"),id:localStorage.getItem("id")});const g=Date.now();if(!h("session_timestamp",g.toString()))throw console.error("[authStore] Failed to save session_timestamp - storage quota exceeded"),new Error("Failed to save session timestamp - storage quota may be exceeded");console.log("[authStore] Session timestamp saved:",g);const se={database:p,token:i.token,xsrfToken:i._xsrf,userId:i.id,userName:i.user,authDatabase:p,timestamp:g};if(!h("integram_session",JSON.stringify(se)))throw console.error("[authStore] Failed to save integram_session - storage quota exceeded"),new Error("Failed to save session data - storage quota may be exceeded");await new Promise(x=>setTimeout(x,100));const H=localStorage.getItem("token");if(!H)throw console.error("[authStore] CRITICAL: Token disappeared after delay!",{expected:i.token,actual:H}),new Error("Token verification failed after commit delay - localStorage may be disabled");return console.log("[authStore] Final verification passed, token persisted successfully"),{success:!0,user:i.user}}catch(i){throw C.value=i.message||"Login failed",i}finally{L.value=!1}}async function Y(){if(S.isAuthenticated())try{await S.logout()}catch(s){console.warn("[authStore] Failed to logout from unified session:",s)}e.value=null,t.value=null,o.value=null,a.value=null,r.value=null,n("token"),n("user"),n("id"),n("_xsrf"),m.value=null,v.value=null,_.value=null,I.value=null,n("ddadmin_token"),n("ddadmin_user"),n("ddadmin_id"),n("ddadmin_xsrf"),b.value=null,A.value=null,T.value=null,D.value=null,n("my_token"),n("my_user"),n("my_id"),n("my_xsrf"),n("accessToken"),n("refreshToken"),n("integram_session"),n("unified_auth_session_id"),n("session_timestamp")}async function ee(s){if(S.isAuthenticated())try{const c=await S.getTokenForDatabase(s);if(c)return c}catch(c){console.warn(`[authStore] Failed to get token for ${s} from unified auth:`,c)}if(s==="ddadmin"){const c=m.value||localStorage.getItem("ddadmin_token");if(c)return{token:c,xsrf:I.value||localStorage.getItem("ddadmin_xsrf"),userId:_.value||localStorage.getItem("ddadmin_id"),userName:v.value||localStorage.getItem("ddadmin_user"),database:"ddadmin"}}else{const c=u.value||localStorage.getItem("db");if(s===c){const l=t.value||localStorage.getItem("token");if(l)return{token:l,xsrf:r.value||localStorage.getItem("_xsrf"),userId:a.value||localStorage.getItem("id"),userName:o.value||localStorage.getItem("user"),database:c}}}return null}async function te(){if(S.isAuthenticated())try{return await S.getAllTokens()}catch(w){console.warn("[authStore] Failed to get all tokens from unified auth:",w)}const s={},c=u.value||localStorage.getItem("db"),l=t.value||localStorage.getItem("token");l&&(s[c]={token:l,xsrf:r.value||localStorage.getItem("_xsrf"),userId:a.value||localStorage.getItem("id"),userName:o.value||localStorage.getItem("user"),database:c});const p=m.value||localStorage.getItem("ddadmin_token");return p&&(s.ddadmin={token:p,xsrf:I.value||localStorage.getItem("ddadmin_xsrf"),userId:_.value||localStorage.getItem("ddadmin_id"),userName:v.value||localStorage.getItem("ddadmin_user"),database:"ddadmin"}),s}async function ae(){if(S.isAuthenticated())try{return await S.getAvailableDatabases()}catch(c){console.warn("[authStore] Failed to get available databases:",c)}const s=[];return(t.value||localStorage.getItem("token"))&&s.push(u.value||localStorage.getItem("db")),(m.value||localStorage.getItem("ddadmin_token"))&&s.push("ddadmin"),s}function oe(){return{token:m.value,user:v.value,id:_.value,xsrf:I.value,isAuthenticated:j.value}}function re(){return{token:b.value,user:A.value,id:T.value,xsrf:D.value,isAuthenticated:B.value}}function ne(){return{token:t.value,user:o.value,id:a.value,xsrf:r.value,database:u.value,apiBase:f.value,isAuthenticated:N.value}}return{primaryToken:t,primaryUser:o,primaryUserId:a,primaryXsrf:r,primaryDatabase:u,primaryApiBase:f,ddadminToken:m,ddadminUser:v,ddadminUserId:_,ddadminXsrf:I,myToken:b,myUser:A,myUserId:T,myXsrf:D,isLoading:L,error:C,unifiedSession:e,isAuthenticated:N,isDdadminAuthenticated:j,isMyAuthenticated:B,initFromLocalStorage:G,login:Z,logout:Y,clearAllAuthData:W,getDdadminAuth:oe,getMyAuth:re,getPrimaryAuth:ne,getTokenForDatabase:ee,getAllTokens:te,getAvailableDatabases:ae,syncUnifiedTokensToLocalStorage:q}});export{R as a,_e as r,ke as u};
