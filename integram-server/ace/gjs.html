<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>GrapesJS Page Builder</title>
  <link rel="icon" type="image/x-icon" href="https://grapesjs.com/favicon.ico">
</head>

<body style="margin:0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/grapesjs/0.20.1/css/grapes.min.css">
  <script>
    localStorage.removeItem('gjsProject');
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/grapesjs/0.21.1/grapes.min.js"></script>
  <script src="https://unpkg.com/grapesjs-preset-webpage@1.0.2"></script>
  <script src="https://unpkg.com/grapesjs-blocks-basic@1.0.1"></script>
  <script src="https://unpkg.com/grapesjs-plugin-forms@2.0.5"></script>
  <script src="https://unpkg.com/grapesjs-component-countdown@1.0.1"></script>
  <script src="https://unpkg.com/grapesjs-plugin-export@1.0.11"></script>
  <script src="https://unpkg.com/grapesjs-tabs@1.0.6"></script>
  <script src="https://unpkg.com/grapesjs-custom-code@1.0.1"></script>
  <script src="https://unpkg.com/grapesjs-touch@0.1.1"></script>
  <script src="https://unpkg.com/grapesjs-parser-postcss@1.0.1"></script>
  <script src="https://unpkg.com/grapesjs-tooltip@0.1.7"></script>
  <script src="https://unpkg.com/grapesjs-tui-image-editor@0.1.3"></script>
  <script src="https://unpkg.com/grapesjs-typed@1.0.5"></script>
  <script src="https://unpkg.com/grapesjs-style-bg@1.0.5"></script>
  <script src="https://unpkg.com/grapesjs-navbar@1.0.1"></script>
  <!--<script src="https://unpkg.com/grapesjs-echarts@0.0.20"></script>-->

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <style>
    .src-options-box {
      border: 1px solid lightgray;
      border-radius: 5px;
      width: max-content;
      position: absolute;
      max-width: 266px;
      padding: 10px;
      margin-bottom: 0;
      font-family: Helvetica, sans-serif;
      font-size: .75rem;
      z-index: 10;
    }
  </style>
  <script>
    var params = window.location.search.replace('?', '').split('&').reduce(function (p, e) { var a = e.split('='); p[decodeURIComponent(a[0])] = decodeURIComponent(a[1]); return p; }, {});
    var db = params['src'].split('/')[1];
    var fileName=db+params['src'].replace(/\//g,'_') + params['gf'].replace(/\./g,'_');
  </script>
  <script src="/js/js.js"></script>

  <div id="gjs"></div>

  <script type="text/javascript">
    function myCustomElements(editor) {
      // text-with-checkbox
      editor.BlockManager.add('text-with-checkbox', {
        label: 'Text with Checkbox',
        content: {
          tagName: 'label',
          classes: ['my-label-class'],
          attributes: {
            'for': 'my-checkbox',
            'display': 'flex'
          },
          components: [
            {
              tagName: 'input',
              type: 'checkbox',
              attributes: { id: 'my-checkbox', name: 'my-checkbox' }
            },
            {
              type: 'text',
              content: 'Some editable text'
            }
          ],
          traits: [
            {
              type: 'text',
              label: 'For',
              name: 'for',
              changeProp: 1
            }
          ]
        },
        attributes: { class: 'fa fa-square-o' },
      });

      // accordion
      editor.DomComponents.addType('accordion-wrap', {
        model: {
          defaults: {
            attributes: {
              title: 'Accordion Wrap',
              name: 'Accordion Wrap',
            },
            traits: [
              {
                type: 'checkbox',
                label: 'Single Toggle',
                name: 'single-toggle-accordion',
                changeProp: 1
              }
            ],
            script: function () {
              var singleToggle = !!'{[ single-toggle-accordion ]}';

              var acc = this.querySelectorAll('.accordion-header');
              acc.forEach(function (el) {
                el.addEventListener('click', function () {
                  var isActive = this.classList.contains('active');
                  if (singleToggle) {
                    acc.forEach(function (otherEl) {
                      otherEl.classList.remove('active');
                      otherEl.nextElementSibling.style.display = 'none';
                    });
                    this.classList.add('active');
                    var panel = this.nextElementSibling;
                    panel.style.display = 'block';
                  }
                  if (!singleToggle) {
                    this.classList.toggle('active');
                    var panel = this.nextElementSibling;
                    panel.style.display = (panel.style.display === 'block' ? 'none' : 'block');
                  }
                });
              });
            }
          }
        }
      });

      editor.BlockManager.add('accordion', {
        label: 'Accordion',
        content: {
          tagName: 'div',
          type: 'accordion-wrap',
          classes: ['accordion'],
          components: [
            {
              tagName: 'div',
              classes: ['accordion-section'],
              attributes: {
                title: 'accordion-section',
                name: 'accordion-section',
              },
              components: [
                {
                  name: 'Top',
                  tagName: 'div',
                  classes: ['accordion-header'],
                  content: 'Section 1',
                  attributes: { 'data-accordion': 'true' }
                },
                {
                  name: 'Open Content',
                  tagName: 'div',
                  classes: ['accordion-content'],
                  content: 'Content for section 1...',
                  style: { display: 'none' }
                }
              ]
            },
            {
              tagName: 'div',
              classes: ['accordion-section'],
              attributes: {
                title: 'accordion-section',
                name: 'accordion-section',
              },
              components: [
                {
                  name: 'Top',
                  tagName: 'div',
                  classes: ['accordion-header'],
                  content: 'Section 2',
                  attributes: { 'data-accordion': 'true' },
                },
                {
                  name: 'Open Content',
                  tagName: 'div',
                  classes: ['accordion-content'],
                  content: 'Content for section 2...',
                  style: { display: 'none' }
                }
              ]
            }
          ],
          styles: `
            .accordion .accordion-section {
              margin-bottom: 10px;
            }

            .accordion .accordion-header {
              background-color: #f7f7f7;
              color: #333;
              cursor: pointer;
              padding: 10px;
              width: 100%;
              border: none;
              text-align: left;
              outline: none;
              font-size: 15px;
              transition: background-color 0.3s ease;
            }

            .accordion .accordion-header:hover,
            .accordion .accordion-header.active {
              background-color: #e7e7e7;
            }

            .accordion .accordion-content {
              padding: 0 18px;
              display: none;
              overflow: hidden;
              background-color: white;
              transition: max-height 0.2s ease-out;
            }
          `,
        },
        attributes: { class: 'fa fa-bars' },
      });

      // click-block
      editor.DomComponents.addType('click-block', {
        model: {
          defaults: {
            tagName: 'div',
            draggable: true,
            attributes: { class: 'click-block' },
            script: function () {
              var defaultContent = this.querySelector('.content-default');
              var hiddenContent = this.querySelector('.content-hidden');
              var cancelButton = this.querySelector('.cancel-button');


              this.addEventListener('click', function (e) {
                if (e.target !== cancelButton) {
                  defaultContent.classList.add('_hide');
                  hiddenContent.classList.remove('_hide');
                }
              });

              if (cancelButton) cancelButton.addEventListener('click', function () {
                hiddenContent.classList.add('_hide');
                defaultContent.classList.remove('_hide');
              });
            },
            styles: `
              .animation {
                transition: all 0.4s ease 0s;
              }
              ._hide {
                opacity: 0;
                height: 0;
                overflow: hidden;
                visibility: hidden;
                padding: 0;
                margin: 0;
              }
            `
          }
        }
      })

      editor.BlockManager.add('click-block', {
        label: 'Clickable Block',
        attributes: { class: 'fa fa-user' },
        content: {
          type: 'click-block',
          components: [
            {
              tagName: 'div',
              name: 'open block',
              attributes: { class: 'content-default animation' },
              components: [
                {
                  type: 'text',
                  content: 'Click me!'
                },
              ]
            },
            {
              tagName: 'div',
              name: 'content hidden',
              attributes: { class: 'content-hidden animation _hide' },
              components: [
                {
                  type: 'text',
                  name: 'Hidden text',
                  content: '<p>Hidden content</p>'
                },
                {
                  type: 'button',
                  text: 'Отмена',
                  name: 'Cancel button',
                  attributes: { class: 'cancel-button' }
                }
              ]
            }
          ],
        }
      });

      // icon selector
      // editor.DomComponents.addType('icon-selector', {
      //   model: {
      //     defaults: {
      //       traits: [
      //         {
      //           type: 'select',
      //           label: 'Icon',
      //           name: 'icon',
      //           options: [
      //             { id: '', name: 'None' },
      //             { id: 'fa fa-home', name: 'Home' },
      //             { id: 'fa fa-user', name: 'User' },
      //             { id: 'fa fa-car', name: 'Car' },
      //             { id: 'fa fa-heart', name: 'Heart' },
      //             { id: 'fa fa-bicycle', name: 'Bicycle' },
      //           ],
      //           changeProp: 1
      //         },
      //         {
      //           type: 'number',
      //           label: 'Size (px)',
      //           name: 'size',
      //           changeProp: 1
      //         }
      //       ],
      //       script: function () {
      //         var iconClass = '{[ icon ]}';
      //         var iconSize = '{[ size ]}' + 'px';
      //         this.innerHTML = iconClass ? `<div class="${iconClass}" style="font-size:${iconSize};width:${iconSize};height:${iconSize}; display: block;"></div>` : '';
      //       }
      //     }
      //   }
      // });

      // editor.BlockManager.add('icon-selector', {
      //   label: 'Icon Selector',
      //   content: {
      //     tagName: 'div',
      //     type: 'icon-selector',
      //     attributes: { class: 'icon-selector' },
      //   }
      // });
      editor.BlockManager.add('div', {
        label: 'Div',
        attributes: { class: 'fa fa-square-o' },
        content: {
          tagName: 'div',
          style: {
                    height: '80px',
                    width: '33%',
                    border: '1px solid lightgray'
                }
        }
      })
    }
    var lastSavedState = null;
    var editor = grapesjs.init({
      height: window.innerHeight,
      container: '#gjs',
      fromElement: true,
      showOffsets: true,
      components: '',
      allowScripts: true,
      style: '.txt-red{color: red}',
      protectedCss: '',
      plugins: [
        'grapesjs-navbar',
        'gjs-blocks-basic',
        'grapesjs-plugin-forms',
        'grapesjs-component-countdown',
        'grapesjs-plugin-export',
        'grapesjs-tabs',
        'grapesjs-custom-code',
        'grapesjs-touch',
        'grapesjs-parser-postcss',
        'grapesjs-tooltip',
        'grapesjs-tui-image-editor',
        'grapesjs-typed',
        'grapesjs-style-bg',
        'grapesjs-preset-webpage',
        'myCustomElements',
        //'grapesjs-echarts'
      ],
      assetManager: {
        embedAsBase64: true,
        upload: true,
        uploadText: 'Drop files here or click to upload',
        uploadFile: function (e) {
          var files = e.dataTransfer ? e.dataTransfer.files : e.target.files;
          // Здесь вы можете отправить файлы на сервер и получить URL изображений
          for (var i in files) {
            var formData = new FormData();
            formData.append('userfile', files[i]);
            formData.append('_xsrf', '0ac53ef9d6149d47d37fb4');
            formData.append('add_path', '');

            $.ajax({
              url: 'https://ideav.online/gjs/dir_admin/?templates=1', // Замените на URL вашего сервера
              type: 'POST',
              data: formData,
              contentType: false,
              processData: false,
              success: function (result) {
                var url = result.url; // Получите URL изображения от вашего сервера
                editor.AssetManager.add({ src: url, name: files[i].name });
              },
              error: function (xhr, status, error) {
                console.error('Ошибка загрузки файла: ' + error);
              }
            });
          }
        }
      },
      pluginsOpts: {
        "gjs-blocks-basic": {
          /* ...options */
        }
      }
    });

    var ajaxPending = 2, sources = {}, dict = [{ id: '', name: ' ' }], reps = [{ id: '', name: ' ' }];
    newApi('GET', 'dict?JSON', 'fillInSources', '', 'dict');
    newApi('GET', 'object/22?JSON&LIMIT=1000', 'fillInSources', '', 'reps');
    function fillInSources(json, index) {
      sources[index] = json;
      if (--ajaxPending > 0)
        return;
      for (i in sources['dict']) // Get the IdeaV tables list
        dict.push({ id: i, name: sources['dict'][i] });
      for (i in sources['reps'].object) // and the reports list
        reps.push({ id: sources['reps'].object[i].id, name: sources['reps'].object[i].val });
      // Add traits
      var defaultType = editor.DomComponents.getType("default");
      var _initialize = defaultType.model.prototype.initialize;
      defaultType.model.prototype.initialize = function () {
        _initialize.apply(this, arguments);
        if (this.attributes.tagName !== '') {
          this.get("traits").add({
            type: 'select', // Type of the trait
            label: 'Table', // The label you will see in Settings
            name: 'src-object', // The name of the attribute/property to use on component
            options: dict
          });
          this.get("traits").add({
            type: 'select',
            label: 'Report',
            name: 'src-report',
            options: reps
          });
          this.get("traits").add({
            type: 'text',
            label: 'Split (,)',
            name: 'src-split'
          });
        }
      };
    }
    var ajaxIcon = '<span title="Saving" class="gjs-pn-btn gjs-save" style="margin-bottom:-5px; display:none;" onclick="saveGJS()"><img src="/i/ajax.gif"></span>'
      , saveBtn = `<span title="Save" class="gjs-pn-btn gjs-save" style="margin-bottom:-5px;" onclick="saveGJS()">
                    <svg viewBox="0 0 16 16" class="cloud-upload" fill="currentColor" height="18" width="18" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383z" id="mainIconPathAttribute" fill="#ffffff"></path> <path fill-rule="evenodd" d="M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3z" id="mainIconPathAttribute" fill="#ffffff"></path>
                    </svg>
                </span>`;
    $(ajaxIcon).insertBefore('span[title="View components"]');
    $(saveBtn).insertBefore('span[title="View components"]');
    /*
    editor.Panels.addButton('options', {
        id: 'save',
        title: 'Save',
        className: 'fa fa-cloud-upload', // button icon
        command: {
            run: () => {
             saveGJS()// sign out the user from system
           }
         },
      });
    */
    $('body').click(function () {
      $('#srcOptionsBox').remove();
    });
    $('body').keyup(function (event) {
      if (event.keyCode === 219) {
        var i, el = editor.getSelected().getEl();
        console.log(el.id)
        if ((i = $(el).closest('[src-report]').attr('src-report')) > 0)
          newApi('GET', 'report/' + i + '?JSON&LIMIT=1', 'getReportCols', '', el);
        else if ((i = $(el).closest('[src-object]').attr('src-object')) > 0)
          newApi('GET', 'metadata/' + i, 'getObjectCols', '', el);
      }
    });

    function handleColumnSelection(elementWasClicked) {
      var elId = $(elementWasClicked).data('el-id');
      var columnName = $(elementWasClicked).data('column-name');
      var parentElemnt = $(elementWasClicked).parent();
      var component = editor.getWrapper().find(`#${elId}`)[0];
      if (component) {
        var textComponent = component.findType('textnode')[0];
        if (textComponent) {
          var content = textComponent.get('content');
          var newContent = content.replace(/({ ?(?![^{]*?}))/gm, '{ ' + columnName + ' }');
          textComponent.set('content', newContent);
          editor.refresh();
          component.view.render();
          parentElemnt.remove();
        }
      }
    }

    function getReportCols(json, el) {
      var h = '';
      for (var i in json.columns) {
        h += '<a class="column-selection" data-el-id="' + el.id + '" data-column-name="' + json.columns[i].name + '"><div style="margin:6px; cursor:pointer; color:#333;">' + json.columns[i].name + '</div></a>';
      }
      if (h != '') {
        $(el).after('<div id="srcOptionsBox" style="position:absolute; border:1px solid lightgray; border-radius:5px; background-color:#fafafa; margin-top:28px;">' + h + '</div>');

        $(el).next().find('a').on('click', function () {
          handleColumnSelection(this);
        });
      }
    }


    function getObjectCols(json, el) {
      console.log('json', json);
      var h = '';
      h += '<a class="column-selection" data-el-id="' + el.id + '" data-column-name="' + json.val + '"><div style="margin:6px; cursor:pointer; color:#333;">' + json.val + '</div></a>';

      for (var i in json.reqs) {
        h += '<a class="column-selection" data-el-id="' + el.id + '" data-column-name="' + json.reqs[i].val + '"><div style="margin:6px; cursor:pointer; color:#333;">' + json.reqs[i].val + '</div></a>';
      }
      if (h != '') {
        $(el).after('<div id="srcOptionsBox" style="position:absolute; border:1px solid lightgray; border-radius:5px; background-color:#fafafa;">' + h + '</div>');

        $(el).next().find('a').on('click', function () {
          handleColumnSelection(this);
        });
      }
    }

    var request = new XMLHttpRequest(), xsrf, token, html, css = '', matches;
    document.title = params['gf'];
    request.open('GET', '/' + db + '/xsrf', true);
    request.onload = function () {
      try {
        var json = JSON.parse(this.responseText);
      }
      catch (err) {
        alert('Ошибка авторизации ' + err);
        return;
      }
      xsrf = json['_xsrf'];
      token = json['token'];
      user = json['user'];
      request.abort();
      request.open('GET', params['src'] + '?templates=1&add_path=&gf=' + params['gf'], true);
      request.onload = function () {
        matches = request.responseText.match(/<style>([\S\s]*?)<\/style>/g);
        if (matches)
          css = matches.map(function (val) {
            return val.replace(/<\/?style>/g, '');
          }).join('\n');
        html = request.responseText.replace(/<style>[\S\s]*?<\/style>/gmi, '');
        editor.setComponents(html);
        editor.setStyle(css);
        html = editor.getHtml();
        css = editor.getCss();

        var savedEditorContent = localStorage.getItem(fileName);
        if (savedEditorContent) {
          editor.load(JSON.parse(savedEditorContent));
        }

        request.abort();
      };
      request.send(null);
    };
    request.send(null);

    function hasChanges(currentState) {
      return JSON.stringify(currentState) !== JSON.stringify(lastSavedState);
    }

    function saveGJS() {
      $('.gjs-save').toggle();
      editor.store().then(editorContent => {
        if (hasChanges(editorContent)) {
          const editorStateJSON = JSON.stringify(editorContent);
          localStorage.setItem(fileName, editorStateJSON);
          lastSavedState = editorContent;

          // Дополнительная логика для отправки данных на сервер или другие действия
          var obj = new XMLHttpRequest();
          var fd = new FormData();
          var file = new File([(editor.getCss().length > 0 ? '<style>\n' + editor.getCss() + '</style>\n' : '') + editor.getHtml()], params['gf']);
          obj.open('POST', params['src'] + '?templates=1&add_path=', true);
          fd.append("_xsrf", xsrf);
          fd.append("rewrite", "1");
          fd.append("upload", "1");
          fd.append('userfile', file);
          fd.append('editorState', editorStateJSON);

          obj.send(fd);
          obj.onload = function (e) {
            if (this.responseText.indexOf('Файл ' + params['gf'] + ' загружен') == this.responseText.indexOf('File ' + params['gf'] + ' uploaded')) {
              alert('Ошибка (см. консоль)');
              console.log(this.responseText);
            }
            obj.abort();
            html = editor.getHtml();
            css = editor.getCss();
            $('.gjs-save').toggle();
          };
        } else {
          $('.gjs-save').toggle();
          console.log('Нет изменений для сохранения');
        }
      });
    }
  </script>
</body>

</html>