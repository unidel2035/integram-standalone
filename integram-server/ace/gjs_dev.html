<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>GrapesJS Page Builder</title>
    <link rel="icon" type="image/x-icon" href="https://grapesjs.com/favicon.ico">
</head>
<body style="margin:0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/grapesjs/0.20.1/css/grapes.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/grapesjs/0.21.1/grapes.min.js"></script>
<script src="https://unpkg.com/grapesjs-preset-webpage@1.0.2"></script>
<script src="https://unpkg.com/grapesjs-blocks-basic@1.0.1"></script>
<script src="https://unpkg.com/grapesjs-plugin-forms@2.0.5"></script>
<script src="https://unpkg.com/grapesjs-component-countdown@1.0.1"></script>
<script src="https://unpkg.com/grapesjs-plugin-export@1.0.11"></script>
<script src="https://unpkg.com/grapesjs-tabs@1.0.6"></script>
<script src="https://unpkg.com/grapesjs-custom-code@1.0.1"></script>
<script src="https://unpkg.com/grapesjs-touch@0.1.1"></script>
<script src="https://unpkg.com/grapesjs-parser-postcss@1.0.1"></script>
<script src="https://unpkg.com/grapesjs-tooltip@0.1.7"></script>
<script src="https://unpkg.com/grapesjs-tui-image-editor@0.1.3"></script>
<script src="https://unpkg.com/grapesjs-typed@1.0.5"></script>
<script src="https://unpkg.com/grapesjs-style-bg@1.0.5"></script>
<script src="https://unpkg.com/grapesjs-navbar@1.0.1"></script>
<!--<script src="https://unpkg.com/grapesjs-echarts@0.0.20"></script>-->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<style>
    .src-options-box {
        border: 1px solid lightgray;
        border-radius: 5px;
        width: max-content;
        position:absolute;
        max-width: 266px;
        padding: 10px;
        margin-bottom: 0;
        font-family: Helvetica,sans-serif;
        font-size: .75rem;
        z-index: 10;
    }
</style>
<script>
    var params=window.location.search.replace('?','').split('&').reduce(function(p,e){var a=e.split('=');p[decodeURIComponent(a[0])]=decodeURIComponent(a[1]);return p;},{});
    var db=params['src'].split('/')[1];
</script>
<script src="/js/js.js"></script>

<div id="gjs"></div>

<script type="text/javascript">
  function myPlugin(editor){
      editor.BlockManager.add('my-first-block', {
        label: 'Simple block',
        content: '<div class="my-block">This is a simple block</div>',
      });
  }
    var editor = grapesjs.init({
        height: window.innerHeight,
        container : '#gjs',
        fromElement: true,
        showOffsets: true,
        components: '',
        allowScripts: true,
        style: '.txt-red{color: red}',
        protectedCss: '',
        plugins: [
            'grapesjs-navbar',
            'gjs-blocks-basic',
            'grapesjs-plugin-forms',
            'grapesjs-component-countdown',
            'grapesjs-plugin-export',
            'grapesjs-tabs',
            'grapesjs-custom-code',
            'grapesjs-touch',
            'grapesjs-parser-postcss',
            'grapesjs-tooltip',
            'grapesjs-tui-image-editor',
            'grapesjs-typed',
            'grapesjs-style-bg',
            'grapesjs-preset-webpage',
            'myPlugin'
            //'grapesjs-echarts'
        ],
        assetManager: {
          embedAsBase64: false
        },
        pluginsOpts: {
          "gjs-blocks-basic": {
            /* ...options */
          }
        }
    });
    var ajaxPending=2,sources={},dict=[{id:'',name:' '}],reps=[{id:'',name:' '}];
    newApi('GET','dict?JSON','fillInSources','','dict');
    newApi('GET','object/22?JSON&LIMIT=1000','fillInSources','','reps');
    function fillInSources(json,index){
        sources[index]=json;
        if(--ajaxPending>0)
            return;
        for(i in sources['dict']) // Get the IdeaV tables list
            dict.push({id:i,name:sources['dict'][i]});
        for(i in sources['reps'].object) // and the reports list
            reps.push({id:sources['reps'].object[i].id,name:sources['reps'].object[i].val});
        // Add traits
        var defaultType = editor.DomComponents.getType("default");
        var _initialize = defaultType.model.prototype.initialize;
        defaultType.model.prototype.initialize = function() {
        	_initialize.apply(this, arguments);
        	if(this.attributes.tagName!==''){
            	this.get("traits").add({
                        type: 'select', // Type of the trait
                        label: 'Table', // The label you will see in Settings
                        name: 'src-object', // The name of the attribute/property to use on component
                        options: dict});
            	this.get("traits").add({
                        type: 'select',
                        label: 'Report',
                        name: 'src-report',
                        options: reps});
            	this.get("traits").add({
                        type: 'text',
                        label: 'Split (,)',
                        name: 'src-split'});
        	}
        };        
    }
    var ajaxIcon='<span title="Saving" class="gjs-pn-btn gjs-save" style="margin-bottom:-5px; display:none;" onclick="saveGJS()"><img src="/i/ajax.gif"></span>'
        ,saveBtn=`<span title="Save" class="gjs-pn-btn gjs-save" style="margin-bottom:-5px;" onclick="saveGJS()">
                    <svg viewBox="0 0 16 16" class="cloud-upload" fill="currentColor" height="18" width="18" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383z" id="mainIconPathAttribute" fill="#ffffff"></path> <path fill-rule="evenodd" d="M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3z" id="mainIconPathAttribute" fill="#ffffff"></path>
                    </svg>
                </span>`;
    $(ajaxIcon).insertBefore('span[title="View components"]');
    $(saveBtn).insertBefore('span[title="View components"]');
    /*
    editor.Panels.addButton('options', {
        id: 'save',
        title: 'Save',
        className: 'fa fa-cloud-upload', // button icon
        command: {
            run: () => {
             saveGJS()// sign out the user from system
           }
         },
      });
    */
    $('body').click(function(){
        $('#srcOptionsBox').remove();
    });
    $('body').keyup(function(){
        if(event.keyCode===219){
            var i,el=editor.getSelected().getEl();
            console.log(el.id)
            if((i=$(el).closest('[src-report]').attr('src-report'))>0)
                newApi('GET','report/'+i+'?JSON&LIMIT=1','getReportCols','',el);
            else if((i=$(el).closest('[src-object]').attr('src-object'))>0)
                newApi('GET','obj_meta/'+i,'getObjectCols','',el);
        }
    });
    function getReportCols(json,el){
        var i,h='';
        for(i in json.columns)
            h+='<a onclick="document.getElementById(\''+el.id+'\').innerHTML=document.getElementById(\''+el.id+'\').innerHTML.replace(/\{ ?/,\'{ '+json.columns[i].name+' }\');document.getElementById(\'srcOptionsBox\').remove()"><div style="margin:6px; cursor:pointer; color:color:#333;">'+json.columns[i].name+'</div></a>';
        if(h!='')
            $(el).after('<div id="srcOptionsBox" style="position:absolute; border:1px solid lightgray; border-radius:5px; background-color:#fafafa;">'+h+'</div>');
    }
    function getObjectCols(json,el){
        var i,h='';
        for(i in json.columns)
            h+='<a onclick="document.getElementById(\''+el.id+'\').innerHTML=document.getElementById(\''+el.id+'\').innerHTML.replace(/\{ ?/,\'{ '+json.columns[i].name+' }\');document.getElementById(\'srcOptionsBox\').remove()"><div style="margin:6px; cursor:pointer; color:color:#333;">'+json.columns[i].name+'</div></a>';
        if(h!='')
            $(el).after('<div id="srcOptionsBox" style="position:absolute; border:1px solid lightgray; border-radius:5px; background-color:#fafafa;">'+h+'</div>');
    }

    var request=new XMLHttpRequest(),xsrf,token,html,css='',matches;
    document.title=params['gf'];
    request.open('GET','/'+db+'/xsrf',true);
    request.onload=function(){
        try{
            var json=JSON.parse(this.responseText);
        }
        catch(err){
            alert('Ошибка авторизации '+err);
            return;
        }
        xsrf=json['_xsrf'];
        token=json['token'];
        user=json['user'];
        request.abort();
        request.open('GET',params['src']+'?templates=1&add_path=&gf='+params['gf'],true);
        request.onload=function(){
            matches=request.responseText.match(/<style>([\S\s]*?)<\/style>/g);
            if(matches)
                css = matches.map(function(val){
                   return val.replace(/<\/?style>/g,'');
                }).join('\n');
            html=request.responseText.replace(/<style>[\S\s]*?<\/style>/gmi,'');
            editor.setComponents(html);
            editor.setStyle(css);
            html=editor.getHtml();
            css=editor.getCss();
            request.abort();
        };
        request.send(null);
    };
    request.send(null);
    function saveGJS(){
        if(html===editor.getHtml()&&css===editor.getCss()){
            alert('В файле нет изменений для сохранения');
            return;
        }
        $('.gjs-save').toggle();
        var obj=new XMLHttpRequest();
        var fd = new FormData();
        var file = new File([(editor.getCss().length>0?'<style>\n'+editor.getCss()+'</style>\n':'')+editor.getHtml()]
                            , params['gf']);
        obj.open('POST',params['src']+'?templates=1&add_path=',true);
        fd.append("_xsrf", xsrf);
        fd.append("rewrite", "1");
        fd.append("upload", "1");
        fd.append('userfile', file);
        
        obj.send(fd);
        obj.onload=function(e) {
            if(this.responseText.indexOf('Файл '+params['gf']+' загружен')==this.responseText.indexOf('File '+params['gf']+' uploaded')){
                alert('Ошибка (см. консоль)');
                console.log(this.responseText)
            }
            obj.abort();
            html=editor.getHtml();
            css=editor.getCss();
            $('.gjs-save').toggle();
        }
    }
</script>
</body>
</html>