<style>
.table thead th{
    white-space: normal !important;
    vertical-align: top !important;
    text-align: center;
}
.table tfoot th{
    text-align: right;
}
tr.no-padding td{
    padding: 0;
}
tr.no-padding input{
    width: 100%;
    background-color: #f5f5f5;
    border: 1px solid gray;
}
td[sq-granted="1"]{
    background-color: #f5fff5;
}
tr:hover td{
    background-color: #fafafa;
}
.saving{
    background-color: #fff5f5;
}
.editing{
    padding: 0 !important;
}
.editing-text{
    border: 2px solid #333 !important;
}
.switch-pages{
    width: 30px;
}
.new-req{
    position: absolute;
}
.sq-table th,.page-count-from,.page-count-to{
    font-weight: 500;
}
.sq-table th{
    position: relative;
}
.sq-order-num,.sq-order-dir{
    color: #a1a1a1;
    font-weight: 400;
}
.calculable,.dub-grouped{
    background-color: #fafafa;
}
.dub-rec{
    background-color: #fff5f5;
}
.ms-link{
	color: #333;
}
.err-msg{
    z-index:1000;
}
.new-table-req{
    margin:-2px;
}
.NUMBER{
    left:0;
}
.NO-NUMBER{
    right:0;
}
.select2{
    padding: .25rem !important;
}
.same-object{
    background-color:lightgray;
}
td[base=SIGNED],td[base=NUMBER]{
    white-space:nowrap;
    text-align-last: right;
}
input.inline-edit,textarea.inline-edit{
    outline: none;
    border: none;
}
.sub-totals-left{
    border-left: 2px solid darkgreen !important;
}
.sub-totals-right{
    border-right: 2px solid darkgreen !important;
}
.sub-totals-top{
    border-top: 2px solid darkgreen !important;
}
.sub-totals-bottom{
    border-bottom: 2px solid darkgreen !important;
}
.sub-totals{
    background-color: #fafafa;
}
.sub-totals-tab{
    z-index:10;
}
.right-totals{
    right: 0;
}
.tr-sticky{
    position:sticky;
    top: 48px;
    z-index: 1;   
}
.resize-handle {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    background: black;
    opacity: 0;
    width: 6px;
    cursor: col-resize;
}
.resize-handle:hover,
.header--being-resized .resize-handle {
    opacity: 0.5;
}
th:hover .resize-handle {
    opacity: 0.3;
}
</style>
<link href="/css/select2.min.css" rel="stylesheet" />
<script src="/js/select2.min.js"></script>
<div class="err-msg card bg-warning position-absolute mt-5 p-3" onclick="$(this).hide()" style="display: none;"></div>
<div class="sub-totals-tab bg-light border shadow position-absolute mt-3 ml-3 mr-3 p-3" style="display: none;">
    <nobr><span>SUM: </span><span class="sub-totals-sum">0</span>, </nobr>&nbsp; 
    <nobr><span>COUNT: </span><span class="sub-totals-count">0</span>, </nobr>&nbsp; 
    <nobr><span>AVG: </span><span class="sub-totals-avg">0</span>, </nobr>&nbsp; 
    <nobr><span>MIN: </span><span class="sub-totals-min">0</span>, </nobr>&nbsp; 
    <nobr><span>MAX: </span><span class="sub-totals-max">0</span> </nobr>&nbsp; 
    <a onclick="clearSubTotals()"><svg width="36" height="36" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg" style="/* display: inline; *//* margin-top: -4px; */"><path d="M8.64284 8.64287L13.3571 13.3572M13.3571 8.64287L8.64284 13.3572" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"></path></svg></a>
    <a onclick="$('.sub-totals-tab').toggleClass('right-totals')"><svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17 19L22 14L17 9M11 9L6 14L11 19" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/></svg></a>
</div>
<a class="new-req pt-1" onclick="addRow()" style="display:none"><svg width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M18 12.8572V23.1429M12.8571 18H23.1428M8.99999 6.42859H27C28.4201 6.42859 29.5714 7.57986 29.5714 9.00002V27C29.5714 28.4202 28.4201 29.5714 27 29.5714H8.99999C7.57983 29.5714 6.42856 28.4202 6.42856 27V9.00002C6.42856 7.57986 7.57983 6.42859 8.99999 6.42859Z" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
</svg></a>
<center>
<h3>
    <span class="ajax-wait" style="display:none"><img src="/i/ajax.gif"></span>&nbsp;<span class="rep-header"></span>
    <a href="/{_global_.z}/smartq/{_global_.id}" class="ml-2 clear-filters" style="display: none;"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28" fill="none">
    <path d="M25 25L19.6833 19.6833M22.5555 12.7777C22.5555 18.1778 18.1778 22.5555 12.7777 22.5555C7.37764 22.5555 3 18.1778 3 12.7777C3 7.37764 7.37764 3 12.7777 3C18.1778 3 22.5555 7.37764 22.5555 12.7777Z" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M8 8L18 18M18 8L8 18" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/></svg></a>
    <a onclick="$('.refr').toggle();doApplyFilters()"><svg class="ml-2 refr" width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M25 5.99763V11.9976M25 11.9976H19M25 11.9976L20.36 7.63763C19.2853 6.56235 17.9556 5.77684 16.4952 5.35441C15.0348 4.93198 13.4911 4.88639 12.0083 5.22189C10.5255 5.5574 9.1518 6.26307 8.01547 7.27305C6.87913 8.28304 6.01717 9.56442 5.51 10.9976M3 21.9976V15.9976M3 15.9976H9M3 15.9976L7.64 20.3576C8.71475 21.4329 10.0444 22.2184 11.5048 22.6409C12.9652 23.0633 14.5089 23.1089 15.9917 22.7734C17.4745 22.4379 18.8482 21.7322 19.9845 20.7222C21.1209 19.7122 21.9828 18.4308 22.49 16.9976" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
    </svg><svg class="ml-2 refr" width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:none">
    <path d="M3 5.99763V11.9976M3 11.9976H9M3 11.9976L7.64 7.63763C8.71475 6.56235 10.0444 5.77684 11.5048 5.35441C12.9652 4.93198 14.5089 4.88639 15.9917 5.22189C17.4745 5.5574 18.8482 6.26307 19.9845 7.27305C21.1209 8.28304 21.9828 9.56442 22.49 10.9976M25 21.9976V15.9976M25 15.9976H19M25 15.9976L20.36 20.3576C19.2853 21.4329 17.9556 22.2184 16.4952 22.6409C15.0348 23.0633 13.4911 23.1089 12.0083 22.7734C10.5255 22.4379 9.1518 21.7322 8.01547 20.7222C6.87913 19.7122 6.01717 18.4308 5.51 16.9976" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
    </svg></a>
    <a href="/{_global_.z}/sql/{_global_.id}"><svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M14 17C15.6569 17 17 15.6569 17 14C17 12.3431 15.6569 11 14 11C12.3431 11 11 12.3431 11 14C11 15.6569 12.3431 17 14 17Z" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M21.4 17C21.2669 17.3016 21.2272 17.6362 21.286 17.9606C21.3448 18.285 21.4995 18.5843 21.73 18.82L21.79 18.88C21.976 19.0657 22.1235 19.2863 22.2241 19.5291C22.3248 19.7719 22.3766 20.0322 22.3766 20.295C22.3766 20.5578 22.3248 20.8181 22.2241 21.0609C22.1235 21.3037 21.976 21.5243 21.79 21.71C21.6043 21.896 21.3837 22.0435 21.1409 22.1441C20.8981 22.2448 20.6378 22.2966 20.375 22.2966C20.1122 22.2966 19.8519 22.2448 19.6091 22.1441C19.3663 22.0435 19.1457 21.896 18.96 21.71L18.9 21.65C18.6643 21.4195 18.365 21.2648 18.0406 21.206C17.7162 21.1472 17.3816 21.1869 17.08 21.32C16.7842 21.4468 16.532 21.6572 16.3543 21.9255C16.1766 22.1938 16.0813 22.5082 16.08 22.83V23C16.08 23.5304 15.8693 24.0391 15.4942 24.4142C15.1191 24.7893 14.6104 25 14.08 25C13.5496 25 13.0409 24.7893 12.6658 24.4142C12.2907 24.0391 12.08 23.5304 12.08 23V22.91C12.0723 22.579 11.9651 22.258 11.7725 21.9887C11.5799 21.7194 11.3107 21.5143 11 21.4C10.6984 21.2669 10.3638 21.2272 10.0394 21.286C9.71502 21.3448 9.41568 21.4995 9.18 21.73L9.12 21.79C8.93425 21.976 8.71368 22.1235 8.47088 22.2241C8.22808 22.3248 7.96783 22.3766 7.705 22.3766C7.44217 22.3766 7.18192 22.3248 6.93912 22.2241C6.69632 22.1235 6.47575 21.976 6.29 21.79C6.10405 21.6043 5.95653 21.3837 5.85588 21.1409C5.75523 20.8981 5.70343 20.6378 5.70343 20.375C5.70343 20.1122 5.75523 19.8519 5.85588 19.6091C5.95653 19.3663 6.10405 19.1457 6.29 18.96L6.35 18.9C6.58054 18.6643 6.73519 18.365 6.794 18.0406C6.85282 17.7162 6.81312 17.3816 6.68 17.08C6.55324 16.7842 6.34276 16.532 6.07447 16.3543C5.80618 16.1766 5.49179 16.0813 5.17 16.08H5C4.46957 16.08 3.96086 15.8693 3.58579 15.4942C3.21071 15.1191 3 14.6104 3 14.08C3 13.5496 3.21071 13.0409 3.58579 12.6658C3.96086 12.2907 4.46957 12.08 5 12.08H5.09C5.42099 12.0723 5.742 11.9651 6.0113 11.7725C6.28059 11.5799 6.48572 11.3107 6.6 11C6.73312 10.6984 6.77282 10.3638 6.714 10.0394C6.65519 9.71502 6.50054 9.41568 6.27 9.18L6.21 9.12C6.02405 8.93425 5.87653 8.71368 5.77588 8.47088C5.67523 8.22808 5.62343 7.96783 5.62343 7.705C5.62343 7.44217 5.67523 7.18192 5.77588 6.93912C5.87653 6.69632 6.02405 6.47575 6.21 6.29C6.39575 6.10405 6.61632 5.95653 6.85912 5.85588C7.10192 5.75523 7.36217 5.70343 7.625 5.70343C7.88783 5.70343 8.14808 5.75523 8.39088 5.85588C8.63368 5.95653 8.85425 6.10405 9.04 6.29L9.1 6.35C9.33568 6.58054 9.63502 6.73519 9.95941 6.794C10.2838 6.85282 10.6184 6.81312 10.92 6.68H11C11.2958 6.55324 11.548 6.34276 11.7257 6.07447C11.9034 5.80618 11.9987 5.49179 12 5.17V5C12 4.46957 12.2107 3.96086 12.5858 3.58579C12.9609 3.21071 13.4696 3 14 3C14.5304 3 15.0391 3.21071 15.4142 3.58579C15.7893 3.96086 16 4.46957 16 5V5.09C16.0013 5.41179 16.0966 5.72618 16.2743 5.99447C16.452 6.26276 16.7042 6.47324 17 6.6C17.3016 6.73312 17.6362 6.77282 17.9606 6.714C18.285 6.65519 18.5843 6.50054 18.82 6.27L18.88 6.21C19.0657 6.02405 19.2863 5.87653 19.5291 5.77588C19.7719 5.67523 20.0322 5.62343 20.295 5.62343C20.5578 5.62343 20.8181 5.67523 21.0609 5.77588C21.3037 5.87653 21.5243 6.02405 21.71 6.21C21.896 6.39575 22.0435 6.61632 22.1441 6.85912C22.2448 7.10192 22.2966 7.36217 22.2966 7.625C22.2966 7.88783 22.2448 8.14808 22.1441 8.39088C22.0435 8.63368 21.896 8.85425 21.71 9.04L21.65 9.1C21.4195 9.33568 21.2648 9.63502 21.206 9.95941C21.1472 10.2838 21.1869 10.6184 21.32 10.92V11C21.4468 11.2958 21.6572 11.548 21.9255 11.7257C22.1938 11.9034 22.5082 11.9987 22.83 12H23C23.5304 12 24.0391 12.2107 24.4142 12.5858C24.7893 12.9609 25 13.4696 25 14C25 14.5304 24.7893 15.0391 24.4142 15.4142C24.0391 15.7893 23.5304 16 23 16H22.91C22.5882 16.0013 22.2738 16.0966 22.0055 16.2743C21.7372 16.452 21.5268 16.7042 21.4 17Z" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
    </svg></a>
</h3>
</center>
<table class="table table-sm table-bordered sq-table"><thead><tr class="tr-sticky"><tbody></table>
<table class="pl-3">
    <tr>
    <td class="switch-pages">
    <a id="pageFirst" class="page-switch" onclick="doApplyFilters(-2)" style="display:none"><svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M13 19L8 14L13 9M20 19L15 14L20 9" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
    </svg></a>
    <td class="switch-pages">
    <a id="pagePrev" class="page-switch" onclick="doApplyFilters(-1)" style="display:none"><svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M17 20L11 14L17 8" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
    </svg></a>
    <td>
    <span class="page-count-from"></span><span class="page-count-to"></span><span class="page-count-recs"></span>
    <span class="total-count total-count-from"></span><span class="total-count total-count-num"></span>
    <td class="switch-pages">
    <a id="pageNext" class="page-switch" onclick="doApplyFilters(1)" style="display:none"><svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M11 20L17 14L11 8" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
    </svg></a>
    <td class="switch-pages">
    <a id="pageLast" class="page-switch" onclick="doApplyFilters(2)" style="display:none"><svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M15 19L20 14L15 9M8 19L13 14L8 9" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
    </svg></a>
    </tr>
</table>
<script>
const msLink='<span class="badge badge-pill badge-secondary-outline border border-secondary p-1 ml-1 mt-1 mb-0 mr-0">:text:'
        +'<a class="ms-link drop-ms ml-1" onclick="dropRef(this,\':text:\')">'
		     +'<svg width="12" height="12" viewBox="0 0 12 12" class="flex-none drop-svg ml-1">'
		     +'    <path fill-rule="evenodd" fill="currentColor" d="M7.41421356,6 L9.88226406,3.5319495 C10.0816659,3.33254771 10.0828664,3.01179862 9.88577489,2.81470708 L9.18529292,2.11422511 C8.97977275,1.90870494 8.66708101,1.91870543 8.4680505,2.11773594 L6,4.58578644 L3.5319495,2.11773594 C3.33254771,1.91833414 3.01179862,1.91713357 2.81470708,2.11422511 L2.11422511,2.81470708 C1.90870494,3.02022725 1.91870543,3.33291899 2.11773594,3.5319495 L4.58578644,6 L2.11773594,8.4680505 C1.91833414,8.66745229 1.91713357,8.98820138 2.11422511,9.18529292 L2.81470708,9.88577489 C3.02022725,10.0912951 3.33291899,10.0812946 3.5319495,9.88226406 L6,7.41421356 L8.4680505,9.88226406 C8.66745229,10.0816659 8.98820138,10.0828664 9.18529292,9.88577489 L9.88577489,9.18529292 C10.0912951,8.97977275 10.0812946,8.66708101 9.88226406,8.4680505 L7.41421356,6 L7.41421356,6 Z"></path>'
	       +'</svg>'
	    +'</a></span>'
    ,addTableReq='<a class="new-table-req position-absolute :base:" onclick="addRow(this)"><svg width="28" height="28" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">'
        +'<path d="M18 12.8572V23.1429M12.8571 18H23.1428M8.99999 6.42859H27C28.4201 6.42859 29.5714 7.57986 29.5714 9.00002V27C29.5714 28.4202 28.4201 29.5714 27 29.5714H8.99999C7.57983 29.5714 6.42856 28.4202 6.42856 27V9.00002C6.42856 7.57986 7.57983 6.42859 8.99999 6.42859Z" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>'
        +'</svg></a>'
    ,dubRecBtn='<a class="new-table-req position-absolute :base:" onmouseover="markGroup(this)" onmouseout="unMarkGroup()" onclick="dubRec(this)" title="'+t9n('[RU]Дублировать эту строку[EN]Duplicate the line')+'">'
        +'<svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">'
        +'    <path d="M7 17H6C5.46957 17 4.96086 16.7893 4.58579 16.4142C4.21071 16.0391 4 15.5304 4 15V6C4 5.46957 4.21071 4.96086 4.58579 4.58579C4.96086 4.21071 5.46957 4 6 4H15C15.5304 4 16.0391 4.21071 16.4142 4.58579C16.7893 4.96086 17 5.46957 17 6V7M13 11H22C23.1046 11 24 11.8954 24 13V22C24 23.1046 23.1046 24 22 24H13C11.8954 24 11 23.1046 11 22V13C11 11.8954 11.8954 11 13 11Z" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>'
        +'</svg></a>'
    ,delFile='<a class="mr-3" onclick="deleteFile(this)"><svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">'
            +'<path d="M5 8H23M10 8V6C10 5.46957 10.2107 4.96086 10.5858 4.58579C10.9609 4.21071 11.4696 4 12 4H16C16.5304 4 17.0391 4.21071 17.4142 4.58579C17.7893 4.96086 18 5.46957 18 6V8M21 8V22C21 22.5304 20.7893 23.0391 20.4142 23.4142C20.0391 23.7893 19.5304 24 19 24H9C8.46957 24 7.96086 23.7893 7.58579 23.4142C7.21071 23.0391 7 22.5304 7 22V8H21Z" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round">'
            +'</path></svg></a>';
var bt={3:'SHORT',8:'CHARS',9:'DATE',13:'NUMBER',14:'SIGNED',11:'BOOLEAN',12:'MEMO',4:'DATETIME',10:'FILE',2:'HTML',7:'BUTTON',6:'PWD',5:'GRANT',15:'CALCULATABLE',16:'REPORT_COLUMN',17:'PATH'};
var conf={order:0,page:1,total:undefined,totalsOn:undefined,columns:{},ids:{},arrs:{},metas:{},uniq:{},lastHead:undefined};
function unMarkGroup(){
    $('.dub-grouped').removeClass('dub-grouped');
}
function markGroup(el){
    const oid=$(el).closest('td').attr('obj-id');
    $('td[obj-id='+oid+']').closest('tr').addClass('dub-grouped');
}
function errMsgCard(err){
    $('.err-msg').html(err).show();
    setTimeout(()=>{$('.err-msg').hide()},9000);
}
var page=1,total,totalsOn,columns={},ids={},arrs={},metas={},uniq={},lastHead,baseType={},granted={};
function getRep(json){
    clearSubTotals();
    $('.ajax-wait').hide();
    var i,j,h,name,type,filters,base,value,curHead='';
    for(i in json.columns) // Remember the columns set
        curHead+=json.columns[i].name+i;
    if(lastHead!==curHead){ // No table header yet or columns added/removed
        columns={},ids={},arrs={},metas={};
        lastHead=curHead;
        for(i in json.columns)
            columns[json.columns[i].name]={type:json.columns[i].type,col:i};
        h='';
        filters='<tr class="no-padding filters">';
        for(i in json.columns)
            if(json.columns[i].id){
                name=json.columns[i].name;
                type=json.columns[i].type;
                if(name.substr(-2)==='ID'&&columns[name.substr(0,name.length-2)]){
                    ids[i]=0;
                    if(!metas[type]&&!json.columns[i].ref){
                        newApi('GET','metadata/'+type,'getMeta');
                        metas[type]=0;
                    }
                    if(json.columns[i].granted===1)
                        $('.new-req').show();
                }
                else{
                    if(columns[name+'ID'])
                        ids[i]=1;
                    h+='<th id="'+type+'"'+(ids[i]?' is-object="1"':'')+'><a sq-order desc col-id="'+json.columns[i].id+'" onclick="orderBy(this)">'
                        +'<span class="sq-order-num"></span><span class="sq-order-dir"></span> <span class="sq-col-name">'+name+'</span></a>'
                        +'<span class="resize-handle" onMouseDown="columnResize(this,'+id+')"></span>';
                    if(json.columns[i].granted===1)
                        granted[type]=1;
                    filters+='<td><input filter-id="'+type+'" base="'+json.columns[i].format+'" name="FR_'+name.replace(/ /g,'_')+'">';
                }
            }
        $('.sq-table thead tr').html(h);
        $('.sq-table tbody').html(filters);
        $('.filters input').keyup(()=>{applyFilters(event.target)});
        const urlParams = getFilterParams(); 
        if(!$.isEmptyObject(urlParams)){
            $('.clear-filters').show();
            $('.refr').removeClass('ml-2');
        }
        for(let key in urlParams)
            $('.filters input[name="'+key+'"]').val(urlParams[key]);
        i=-1;
        $('.sq-table').click(function(){if(event.target.tagName==='TD'&&event.ctrlKey)processSubTotals(event.target)});
    }
    else if(json.data[0].length===0){
        if(page===1){
            $('.page-switch,.total-count').hide();
            $('.page-count-from').html('');
            $('.page-count-to').html('0 ');
            $('.page-count-recs').html(t9n('[RU]записей[EN]records'));
            $('.sq-row').remove();
        }
        else{
            $('#pageNext,#pageLast').hide();
            $('.total-count').html('');
            total=page*limit-limit;
            page--;
        }
        drawFoot(json);
        return;
    }
    else
        $('.sq-row').remove();
    h='';
    for(i in json.data[0])
        h+=drawLine(json,i);
    $('.sq-table tbody').append(h);
    $('.sq-row td[req-id]').click(function(){inlineEdit(this)});
    if('totals' in json.columns[0])
        totalsOn=true;
    drawFoot(json);
    i++;
    if(i<defaultLimit){
        total=limit*page-limit+i;
        $('.total-count').hide();
    }
    if(i<defaultLimit&&page===1){
        $('.page-count-from').html(t9n('[RU]Всего [EN]Total: '));
        $('.page-count-to').html(i);
        $('.page-count-recs').html('');
    }
    else{
        $('.page-count-from').html((page*limit-limit+1)+'-');
        $('.page-count-to').html(page*limit-limit+i);
        $('.page-count-recs').html('');
        $('.total-count-from').html(t9n('[RU] из [EN] of ')).show();
        $('.total-count-num').html(total?total:'<a onclick="getCount()">?</a>').show();
    }
    if(i<defaultLimit)
        $('#pageNext,#pageLast').hide();
    else{
        if(!total||total!=page*limit-limit+i)
            $('#pageNext').show();
        else
            $('#pageNext').hide();
        if(total&&total!=page*limit-limit+i)
            $('#pageLast').show();
        else
            $('#pageLast').hide();
    }
    $('.sq-row').find('td[base="MEMO"]').each(function(){ // restore the line breaks
    	addBreaks(this);
    });
    if(page===1)
        $('#pagePrev,#pageFirst').hide();
    else
        $('#pagePrev').show();
    if(page>2)
        $('#pageFirst').show();
    $('.sq-row').find('td').each(function(){markDown(this)});
    let columnSizes = JSON.parse(localStorage.getItem(db+id+'smartq'));
    if (columnSizes) {
        var headers = $('.sq-table').find('th').toArray();
        if (headers.length == columnSizes?.length) {
          var sum = 0;
          headers.forEach( (header, index) => {
            setWidth(header,columnSizes[index]);
            sum += columnSizes[index];
          });
          setWidth($('.sq-table'), sum);
        } else localStorage.removeItem(db+id+'smartq');
    }
}
function addBreaks(el){
    $(el).attr('old-val',$(el).html());
    $(el).html($(el).html().replace(/[\t\ n]+$/gm,'').replace(/\n/gm,'<br />'));
}
function drawFoot(json,el){
    $('.sq-table tfoot').remove(); // Re-create the footer if any
    if('totals' in json.columns[0]){
        var h='<tfoot><tr>';
        for(j in json.columns)
            if(ids[j]!==0)
                h+='<th footer-id="'+json.columns[j].type+'" align="right">'+formatNum(json.columns[j].totals||'',2);
        $('.sq-table').append(h);
    }
}
function drawLine(json,i,cl){
    var base,j,h='<tr class="sq-row '+(cl||'')+'">';
    for(j in json.data){
        const col=json.columns[j];
        base='base="'+col.format+'"';
        if(isNumeric(col.format))
            value=formatNum(json.data[j][i],col.format);
        else
            value=json.data[j][i];
        if(col.type==='')
            h+='<td '+base+' class="calculable">'+value;
        else if(ids[j]===1)
            h+='<td req-id="'+col.type+'" is-object="1" class="position-relative" '+base
                +(granted[col.type]?' sq-granted="1" onmouseover="showAdd('+col.type+',this)"':'')
                +(col.ref?' ref-id="':' obj-id="')+json.data[columns[col.name+'ID'].col][i]+'">'+value;
        else if(ids[j]!==0)
            h+='<td req-id="'+col.type+'" class="position-relative" '+base
                +(granted[col.type]?' sq-granted="1" onmouseover="'+(col.ref?'showAdd('+col.type+',this)':'$(\'.new-table-req\').remove()')+'"':'')
                +'>'+value;
    }
    return h;
}
var order=0;
function orderSync(o){
    $('.sq-table th a').each(function(){
        const i=parseInt($(this).attr('sq-order'));
        if(i>o){
            $(this).attr('sq-order',i-1);
            $(this).find('.sq-order-num').html(i-1);
        }
    });
}
function orderBy(el){
    if($(el).attr('sq-order')===''){
        $(el).attr('sq-order',++order).attr('desc','');
        $(el).find('.sq-order-num').html(order);
        $(el).find('.sq-order-dir').html('&#9651;');
    }
    else if($(el).attr('desc')===''){
        $(el).attr('desc',1);
        $(el).find('.sq-order-dir').html('&#9661;');
    }
    else{
        orderSync(parseInt($(el).attr('sq-order')));
        $(el).attr('sq-order','');
        $(el).find('.sq-order-num,.sq-order-dir').html('');
        order--;
    }
    doApplyFilters();
}
function isNumeric(v){
    return ['NUMBER','SIGNED'].includes(v);
}
function showAdd(rid,el){
    if($(el).find('.new-table-req').length>0||$(el).hasClass('editing')||$(el).html().length==0)
        return;
    $('.new-table-req').remove();
    if(typeof metas[rid]==='object'&&!metas[rid].refId)
        return;
    const align=isNumeric($(el).attr('base'))?'NUMBER':'NO-NUMBER';
    var isRef;
    if(metas[rid]===0)
        return $(el).prepend(dubRecBtn.replace(':base:',align));
    if(typeof metas[rid]==='object'){ // This is a reference
        rid=metas[rid].id; // Get its parent
        isRef=true;
    }
    var parentId=$(el).closest('.sq-row').find('td[req-id='+metas[rid]+'][is-object=1]').attr('obj-id')
                    ||$(el).closest('.sq-row').find('td[req-id='+metas[rid]+'][is-object=1]').attr('ref-id');
    if(parentId>0&&($(el).attr('obj-id')>0||isRef))
        $(el).prepend(addTableReq.replace(':base:',align));
}
function dubRec(el){ // Duplicate the main record
    const td=$(el).closest('td');
    const tid=td.attr('req-id');
    const oid=td.attr('obj-id');
    const base=td.attr('base');
    if(uniq[tid]==='1'){
        $(el).remove();
        var val=td.html();
        if(base==="NUMBER")
            newApi('POST','object/'+tid+'?JSON&order_val=val&desc=1&LIMIT=1','dubRecUniqNum','',{td:td,oid:oid,tid:tid,val:val});
        else if(base==="SHORT"||base==="CHARS"){ 
            var fd=new FormData();
            var index=val.match(/ \((\d+)\)$/);
            if(index){
                index=parseInt(index[1])+1
                val=val.replace(/( \(\d+\)$)/,'');
            }
            else
                index=1;
            fd.append('F_'+tid,val+' ('+index+')');
            newApi('POST','object/'+tid+'?JSON','dubRecUniqText',fd,{td:td,oid:oid,tid:tid,val:val,index:index});
        }
        else if(base==="DATETIME") // Set current date&time and hope this is unique so far
            newApi('POST','_m_save/'+oid+'?JSON&t'+tid+'='+(Date.now()/1000),'dubRecDone','copybtn=1',td);
        else
            errMsgCard(t9n('[RU]Значение типа '+base+' уникально и не может быть продублировано[EN]Please duplicate the unique value of '+base+' another way'));
    }
    else
        newApi('POST','_m_save/'+oid+'?JSON','dubRecDone','copybtn=1',td);
    event.stopPropagation();
}
function dubRecUniqText(json,vars){ // Check for duplicates for uniques
    var fd=new FormData();
    if(json.object){
        vars.index++;
        fd.append('F_'+vars.tid,vars.val+' ('+vars.index+')');
        newApi('POST','object/'+vars.tid+'?JSON','dubRecUniqText',fd,{td:vars.td,oid:vars.oid,tid:vars.tid,val:vars.val,index:vars.index});
    }
    else{
        fd.append('t'+vars.tid,vars.val+' ('+vars.index+')');
        fd.append('copybtn',1);
        newApi('POST','_m_save/'+vars.oid+'?JSON','dubRecDone',fd,vars.td);
    }
}
function dubRecUniqNum(json,vars){ // Check for duplicates for uniques
    if(json.object&&json.object[0].val&&parseInt(json.object[0].val))
        newApi('POST','_m_save/'+vars.oid+'?JSON&t'+vars.tid+'='+(parseInt(json.object[0].val)+1),'dubRecDone','copybtn=1',vars.td);
    else
        errMsgCard(t9n('[RU]Ошибка вычисления уникального значения[EN]Failed to calculate the unique value'));
}
function dubRecDone(json,el){ // Duplicate done - get it via report
    var fd=new FormData();
    fd.append('FR_'+$('#'+$(el).attr('req-id')).find('.sq-col-name').html()+'ID',json.obj);
    newApi('POST','report/'+id+'?JSON','newRecGet',fd,{el:el});
}
function newRecGet(json,vars){ // Show the duplicate
    $('.dub-rec').removeClass('dub-rec');
    for(var i in json.data[0]){
        $(vars.el).closest('tr').before(drawLine(json,i,'dub-rec'));
        $(vars.el).closest('tr').prev().find('td[base="MEMO"]').each(function(){ // restore the line breaks
        	addBreaks(this);
        });
    }
    if(vars.mode){
        // Restore the subtotals class
        $('td[obj-id='+$(vars.el).attr('obj-id')+']').closest('tr:not(.dub-rec)').find('td').each(function(i){
            if($(this).hasClass('sub-totals'))
                $('td[obj-id='+$(vars.el).attr('obj-id')+']').closest('.dub-rec').find('td').eq(i).addClass('sub-totals');
        });
        try{
            $('td[obj-id='+$(vars.el).attr('obj-id')+']').closest('tr:not(.dub-rec)').remove();
        }
        catch {};
    }
    $('.dub-rec td[req-id]').click(function(){inlineEdit(this)});
    if(vars.mode==='edit')
        $('.dub-rec').removeClass('dub-rec');
    else{
        if(!vars.mode)
            $('.dub-rec td[req-id='+$(vars.el).attr('req-id')+']').first().click();
        setTimeout(()=>{$('.dub-rec').removeClass('dub-rec')},3000);
    }
    if($('.sub-totals').length>0)
        recalcSubTotals();
    doApplyFilters('TOTALS');
}
function addRow(el){
    event.stopPropagation();
    if($('.sq-new').length>0)
        return $('.sq-new').click();
    var i,j,reqId,td,h='';
    if(el)
        reqId=$(el).closest('td').attr('req-id');
    $('.sq-table thead tr th').each(function(){
        if(el&&(metas[this.id]===0))
            i=$(el).closest('.sq-row').find('td[req-id='+this.id+']').attr('obj-id');
        h+='<td req-id="'+this.id+'" '+(baseType[this.id]?'base="'+baseType[this.id]+'"':'')+' onclick="inlineEdit(this)"'
                +' class="position-relative '+(reqId===this.id||(!reqId&&metas[this.id]===0)?' sq-new':'')+(this.id?'':' calculable')+'"'
                +(this.id?' onmouseover="showAdd('+this.id+',this)"':'')
                +($(this).attr('is-object')?' is-object="1"':'')+'>';
    });
    if(reqId){
        $(el).closest('.sq-row').after('<tr class="sq-row" id="newRow">'+h);
        $('#newRow').find('td').each(function(){ // Fill in the upper fields
            const i=$(this).attr('req-id');
            if(metas[reqId].id===i)
                $(this).html('');
            else if(i&&reqId!==i)
                if(!isUnder(reqId,i)){
                    const td=$(el).closest('.sq-row').find('td[req-id='+i+']');
                    $(this).html(td.html());
                    if($(td).attr('obj-id'))
                        $(this).attr('obj-id',$(td).attr('obj-id'))
                    if($(td).attr('ref-id'))
                        $(this).attr('ref-id',$(td).attr('ref-id'))
                }
        });
        $('#newRow').removeAttr('id');
        $(el).remove();
    }
    else{
        $('.sq-table .filters').after('<tr class="sq-row">'+h);
        for(i in metas)
            if(metas[i]===0)
                if(uniq[i]==='1'&&baseType[i]==='NUMBER')
                    return newApi('POST','_m_new/'+i+'?JSON&up=1','createNumObj');
                else
                    break;
    }
    $('.sq-new').click();
}
function createNumObj(json){
    if(json.id){
        $('.sq-new').attr('obj-id',json.id);
        $('.sq-new').html(json.val);
        saveDone({},{el:$('.sq-new')});
    }
    $('.sq-new').click();
}
function isUnder(reqId,i){
    while(i)
        if(i===reqId||metas[i].id===reqId)
            return true;
        else
            i=metas[i].id||metas[i];
}
function navKey(el){
    if(event.keyCode===13&&!event.shiftKey){ // Enter
        $(el).closest('td').removeClass('last-edited');
        saveVal(el);
    }
    else if(event.keyCode===27){ // Escape
        el.value=$(el).closest('td').attr('old-val');
        $(el).closest('td').removeClass('last-edited');
        saveVal(el);
    }
    else if(event.keyCode===38&&$(el).prop("tagName")!=='MEMO'){ // Up arrow
        if(neigh=$(el).closest('tr').prev().find('td')[$(el).closest('td').prevAll('td').length])
            neigh.click();
    }
    else if(event.keyCode===40&&$(el).prop("tagName")!=='MEMO'){ // Down arrow
        if(neigh=$(el).closest('tr').next().find('td')[$(el).closest('td').prevAll('td').length])
            neigh.click();
    }
    else if(event.keyCode===9){ // Tab
        if(event.shiftKey)
            $(el).closest('td').prev().click();
        else
            $(el).closest('td').next().click();
        event.preventDefault();
    }
}
function clearSubTotals(){
    $('.sub-totals').removeClass('sub-totals sub-totals-left sub-totals-right sub-totals-top sub-totals-bottom');
    $('.sub-totals-tab').hide();
}
function processSubTotals(el){
    if($(el).hasClass('sub-totals'))
        $(el).removeClass('sub-totals-left sub-totals-right sub-totals-top sub-totals-bottom');
    $(el).toggleClass('sub-totals');
    recalcSubTotals();
}
function recalcSubTotals(){
    var sum=count=avg=min=max=0;
    $('.sub-totals').each(function(){
        const base=$(this).attr('base');
        if(base==='NUMBER')
            val=parseInt(unFormatNum($(this).html()))||0;
        else
            val=parseFloat(unFormatNum($(this).html()))||0;
        sum+=val;
        count++;
        if(min>val)
            min=val;
        if(max<val)
            max=val;
        // Recalc borders
        if($(this).prev().hasClass('sub-totals'))
            $(this).prev().removeClass('sub-totals-right');
        else
            $(this).addClass('sub-totals-left');
        if($(this).next().hasClass('sub-totals'))
            $(this).next().removeClass('sub-totals-left');
        else
            $(this).addClass('sub-totals-right');
        const i=$(this).closest('tr').find('td').index(this);
        if($(this).closest('tr').prev().find('td').eq(i).hasClass('sub-totals'))
            $(this).closest('tr').prev().find('td').eq(i).removeClass('sub-totals-bottom');
        else
            $(this).addClass('sub-totals-top');
        if($(this).closest('tr').next().find('td').eq(i).hasClass('sub-totals'))
            $(this).closest('tr').next().find('td').eq(i).removeClass('sub-totals-top');
        else
            $(this).addClass('sub-totals-bottom');
    });
    $('.sub-totals-sum').html(sum);
    $('.sub-totals-count').html(count);
    $('.sub-totals-min').html(min);
    $('.sub-totals-max').html(max);
    $('.sub-totals-avg').html((sum/count).toFixed(2).replace('.00',''));
    $('.sub-totals-tab').show();
}
function inlineEdit(el){
    event.stopPropagation();
    if(event&&event.ctrlKey)
        return processSubTotals(el);
    var reqType=$(el).attr('req-id')
        ,w=$(el).css('width');
    if(!granted[reqType])
        return;
    if($('#'+reqType).css('max-width')==='none')
        $('#'+reqType+',td[req-id='+reqType+']').css('max-width',w).css('min-width',w);
    if($(el).hasClass('editing')&&event.target&&event.target.tagName==='TD'&&metas[reqType].refId)
        return blurSelect($(el).find('select'));
    if($(el).hasClass('editing')||$(el).hasClass('saving')||!$(el).attr('req-id'))
        return;
    if($(el).hasClass('last-edited'))
        return $(el).removeClass('last-edited');
    if($(el).attr('base')!=='FILE' && ($(el).html().indexOf('<a target')!==-1||metas[reqType]===undefined)) // Interactive report or unknown rec type
        return;
    // For a requisite, check if the parent ID is known
    if(typeof metas[reqType]==='object'&&!$(el).closest('.sq-row').find('td[req-id='+metas[reqType].id+']').attr('is-object'))
        return;
    $('.new-table-req,input[type="file"]').remove();
    var i,val=$(el).html()
        ,parentType=parseInt(metas[reqType].id||metas[reqType]);
    const parentId=$(el).closest('.sq-row').find('td[req-id='+parentType+'][is-object=1]').attr('obj-id')
                ||$(el).closest('.sq-row').find('td[req-id='+parentType+'][is-object=1]').attr('ref-id');
    $('.select2.inline-edit').each(function(){blurSelect(this)});
    if(metas[reqType].ref){
        if(metas[reqType].multi){
            var h='',mult=val.split(',');
            for(i in mult)
                if(mult[i].length>0)
                    h+=msLink.replace(/:text:/g,escapeHtmls(mult[i]));
            $(el).html(h);
            $(el).append('<select multi="1" ref-id="'+reqType+'" class="select2 inline-edit ml-1 mt-1 w-100" onchange="saveRef(this)"><option> </option></select>');
            fillInDdl(el,mult);
        }
        else{
            $(el).html('<select ref-id="'+reqType+'" class="select2 inline-edit w-100" onchange="saveRef(this)">'
                            +'<option selected value="current">'+val+'</option></select>');
            fillInDdl(el,[val]);
        }
    }
    else if($(el).attr('base')==='MEMO')
        $(el).html('<textarea class="inline-edit w-100" onkeydown="navKey(this)" onblur="saveVal(this)" onchange="saveVal(this)" style="min-height:'+$(el).css('height')+';max-height:'+$(el).css('height')+'">');
    else if($(el).attr('base')==='DATE'){
        $(el).html('<input type="date" class="inline-edit w-100" onkeydown="navKey(this)" onblur="saveVal(this)" onfocusout="saveVal(this)">');
        val=moment.utc(val||new Date(),'DD.MM.YYYY');
    }
    else if($(el).attr('base')==='DATETIME'){
        $(el).html('<input type="datetime-local" class="inline-edit w-100" onkeydown="navKey(this)" onblur="saveVal(this)" onfocusout="saveVal(this)">');
        val=moment.utc(val||new Date(),'DD.MM.YYYY HH:mm:ss');
    }
    else if($(el).attr('base')==='FILE')
        $(el).html(($(el).find('a').length>0?delFile:'') + '<input type="file" class="inline-edit" onchange="saveInlineFile(this)">');
    else if(isNumeric($(el).attr('base'))){
        val=unFormatNum(val);
        $(el).html('<input type="number" class="inline-edit w-100" onkeydown="navKey(this)" onblur="saveVal(this)" onchange="saveVal(this)">');
    }
    else
        $(el).html('<input type="text" class="inline-edit w-100" onkeydown="navKey(this)" onblur="saveVal(this)" onchange="saveVal(this)">');

    $('.inline-edit').focus();
    $('.last-edited,.editing').removeClass('last-edited editing');
    $('.editing-text').removeClass('editing-text');
    $(el).addClass('editing last-edited');
    $(el).find('input,textarea').closest('td').addClass('editing-text');
    if($(el).attr('obj-id')&&$('td[obj-id='+$(el).attr('obj-id')+']').length>1) // Highlight the same objects in the table in case there are more than one
        if($(el).attr('obj-id'))
            $('td[obj-id='+$(el).attr('obj-id')+']').addClass('same-object');
        else if($(el).attr('ref-id'))
            $('td[ref-id='+$(el).attr('ref-id')+']').each(function(){
                if(parentId===$(this).closest('.sq-row').find('td[req-id='+parentType+'][is-object=1]').attr('obj-id'))
                    $(this).addClass('same-object');
            });
    if($(el).attr('base')==='DATE'){
        $(el).attr('old-val',$(el).hasClass('sq-new')?'':val.format("DD.MM.YYYY"));
        $(el).find('input').val(val.format("YYYY-MM-DD"));
    }
    else if($(el).attr('base')==='DATETIME'){
        $(el).attr('old-val',$(el).hasClass('sq-new')?'':val.format("DD.MM.YYYY"));
        $(el).find('input').val(val.format("YYYY-MM-DD HH:mm:ss"));
    }
    else if($(el).attr('base')==='MEMO')
        $(el).find('textarea').val($(el).attr('old-val'));
    else if($(el).attr('base')!=='FILE'){
        $(el).find('input,textarea').val(val);
        $(el).attr('old-val',val);
    }
}
function unFormatNum(v){
    return v.replace(/ /g,'').replace(',','.');
}
function delRefDone(json,el){
    $(el).closest('span').remove();
}
function getRef(json,vars){
    var v;
    if(json.reqs&&json.reqs[vars.id]&&json.reqs[vars.id].multiselect)
        for(var i in json.reqs[vars.id].multiselect.ref_val)
            if(json.reqs[vars.id].multiselect.ref_val[i]===vars.ref){
                $(vars.el).closest('span').addClass('bg-warning');
                newApi('POST','_m_del/'+json.reqs[vars.id].multiselect.id[i]+'?JSON','delRefDone','',vars.el);
                if($(vars.el).closest('td').attr('old-val')===vars.ref) // The last and only ref
                    v='';
                else
                    v=$(vars.el).closest('td').attr('old-val').replace(','+vars.ref+',',',')  // Among others
                                                        .replace(new RegExp(escapeRegex(','+vars.ref)+'$',''),'') // Last
                                                        .replace(new RegExp('^'+escapeRegex(vars.ref+','),''),''); // First
                $(vars.el).closest('td').attr('old-val',v);
            }
}
function dropRef(el,ref){
    var reqType=$(el).closest('td').attr('req-id')
        ,parentType=metas[reqType].id
        ,i=$(el).closest('.sq-row').find('td[req-id='+parentType+']').attr('obj-id');
    if(i)
        newApi('GET','edit_obj/'+i+'?JSON','getRef','',{el:el,id:reqType,ref:ref})
}
function blurSelect(el){
    $(el).closest('td').html($(el).closest('td').attr('old-val')).removeClass('editing').removeClass('last-edited');
    $('.same-object').removeClass('same-object');
}
function fillInDdlDo(json,vars){
    if(json){
        var i,ref=$(vars.el).find('select').attr('ref-id');
        const oid=findParent(vars.el);
        if(!ddList[oid])
            ddList[oid]={};
        ddList[oid][ref]={};
        for(i in json)
            ddList[oid][ref][i]=json[i];
        fillInDdl(vars.el,vars.vals);
    }
}
var ddList={},ddLLimit=50;
function fillInDdl(el,vals){
    var i,j=0,h='',ref=$(el).find('select').attr('ref-id')
        ,val=$(el).find('select option[selected]').html()
        ,oldId=$(el).find('select option[selected]').attr('value');
    const oid=findParent(el);
    if(ddList[oid]&&ddList[oid][ref]){
        for(i in ddList[oid][ref]){
            j++;
            if(vals.indexOf(ddList[oid][ref][i])===-1)
                h+='<option value="'+i+'">'+ddList[oid][ref][i]+'</option>';
        }
        $(el).find('select').append(h);
        $(el).find('select').attr('old-val',val).attr('old-id',oldId);
        if(j>=ddLLimit)
            $(el).find('select').attr('i-more',1)
        initSel2($(el).find('select'));
    }
    else
        newApi('GET','_ref_reqs/'+ref+'?JSON&id='+oid+'&LIMIT='+ddLLimit,'fillInDdlDo','',{el:el,vals:vals});
}
function findParent(el){
    var oid;
    $(el).closest('tr').find('td[is-object=1]').each(function(){
        if(metas[$(this).attr('req-id')]===0)
            oid=$(this).attr('obj-id');
    });
    return oid;
}
function initSel2(el){
    var curEl=el;
    $(el).select2({
        tags: true,
        createTag: function (params) {
            let term = $.trim(params.term);
            if (term === '') return null;
            return {
              id: '-1',
              text: term,
              newTag: true
            }
        },
        sorter: data => data.sort((a, b) => a.text.localeCompare(b.text)),
        placeholder: t9n('[RU]Выберите[EN]Select'),
        allowClear: true,
        ajax: $(curEl).attr('i-more') ? {
            url: function(params){
                return requestURL='/'+db+'/_ref_reqs/'+$(this).closest('td').attr('req-id')+'?JSON&id='+findParent(this);
            },
            processResults: function(data){
                let formattedData=[];
                if(data)
                    for(var i in data)
                        if($(curEl).closest('td').find('span[ref='+i+']').length===0)
                            formattedData.push({"id":i, "text":data[i]})
                return {results:formattedData};
            },
            dataType: 'json',
            cache: true,
            delay: 330
        } : undefined
    });
}
function refreshLine(json,el){
    $(el).closest('.sq-row').find('td[is-object=1]').each(function(){
        if(metas[$(this).attr('req-id')]===0){
            saveDone({},{el:this});
            return false;
        }
    });
}
function saveDone(json,vars){
    const reqId=$(vars.el).attr('req-id');
    $('.saving').removeClass('saving');
    if(vars.id)
        $(vars.el).attr('ref-id',vars.id);
    if($(vars.el).attr('obj-id'))
        parent=$(vars.el);
    else
        parent=$(vars.el).closest('.sq-row').find('td[req-id='+metas[reqId].id+']');
    const parentId=parent.attr('obj-id');
    const parentType=parent.attr('req-id');
    var fd=new FormData();
    fd.append('FR_'+$('#'+parentType).find('.sq-col-name').html()+'ID',parentId);
    if($('input[filter-id='+reqId+']').val().length>0&&$('th[footer-id='+reqId+']').html().length>0)
        $('th[footer-id='+reqId+']').css('color','red').prop('title', t9n('[RU]Возможно, значение неактуально из-за примененного фильтра[EN]The value might be not correct because of the filter applied'));
    else
        newApi('POST','report/'+id+'?JSON','newRecGet',fd,{el:parent,mode:'edit'});
}
function delDone(json,vars){
    if(json.id){
        $('.saving').removeClass('saving');
        doApplyFilters('TOTALS');
        if(metas[$(vars.el).attr('req-id')]===0){
            if(total)
                $('.total-count-num').html(--total);
            $('td[obj-id='+$(vars.el).attr('obj-id')+']').closest('.sq-row').remove();
            if($('.sq-row').length===0){
                $('.page-count-from').html('');
                $('.page-count-to').html(0);
            }
            else
                $('.page-count-to').html(parseInt($('.page-count-to').html())-1);
            return;
        }
        $(vars.el).html('').attr('obj-id','').attr('ref-id','');
        for(var i in metas)
            if(metas[i].id===$(vars.el).attr('req-id'))
                $(vars.el).closest('.sq-row').find('td[req-id='+i+']').html('').attr('obj-id','').attr('ref-id','');
    }
    else{
        if(isNumeric($(vars.el).attr('base')))
            dispVal = formatNum(vars.v,$(vars.el).attr('base'));
        else
            dispVal = vars.v;
        $(vars.el).html(dispVal).attr('old-val',vars.v);
        if($(vars.el).attr('base')==='MEMO')
            addBreaks(vars.el);
    }
}
function createDone(json,el){
    if(json.warning){
        errMsgCard(escapeHtmls(val)+': '+json.warning);
        $(el).closest('tr').remove();
        $('td[obj-id='+json.id+']').first().click();
        return;
    }
    $(el).removeClass('saving');
    $(el).attr('obj-id',json.id);
    $(el).html(json.val);
    if($(el).hasClass('sq-new')){
        $(el).removeClass('sq-new');
        if(total)
            $('.total-count-num').html(++total);
        $('.page-count-to').html(1+parseInt($('.page-count-to').html()));
    }
    var fd=new FormData();
    fd.append('FR_'+$('#'+$(el).attr('req-id')).find('.sq-col-name').html()+'ID',json.id);
    newApi('POST','report/'+id+'?JSON','newRecGet',fd,{el:el,mode:'new'});
}
function dropMsDone(json,i){
    $('#'+i).remove();
}
function addMsDone(json,el){
    $(el).removeClass('saving').removeClass('editing').removeClass('last-edited');
}
function createDicObj(json,el){
    if(json.id){
        $(el).find('option:selected').attr('value',json.id);
        ddList[findParent(el)][$(el).closest('td').attr('req-id')][json.id]=json.val;
        saveRef(el);
    }
    else
        errMsgCard(t9n('[RU]Ошибка создания справочного значения[EN]Failed to create the dictionary value'));
}
function saveRef(el){
    var td=$(el).closest('td')
        ,ref=$(el).attr('ref-id')
        ,pid=metas[td.attr('req-id')].id
        ,val=$(el).find('option:selected').text()||''
        ,i=$(el).closest('.sq-row').find('td[req-id='+pid+']').attr('obj-id');
    if(el.value==="-1"){ // New DDL item
        var fd=new FormData();
        const t=metas[$(el).attr('ref-id')].ref;
        fd.append('t'+t,val);
        newApi('POST','_m_new/'+t+'?JSON&up=1','createDicObj',fd,el);
        return;
    }
    if(parseInt(i)){
        if($(el).attr('multi')){
            newApi('POST','_m_set/'+i+'?JSON&t'+ref+'='+el.value,'addMsDone','',td);
            $(el).remove();
            val=td.attr('old-val')+(td.attr('old-val').length>0?',':'')+val;
            td.attr('old-val',val);
        }
        else{
            newApi('POST','_m_set/'+i+'?JSON&t'+ref+'='+(el.value||''),'saveDone','',{el:td,id:el.value||''});
            for(i in metas)
                if(metas[i].id===$(td).attr('req-id'))
                    $(td).closest('.sq-row').find('td[req-id='+i+']').html('').attr('obj-id','').attr('ref-id','');
        }
    }
    else{
        $(td).attr('value',el.value); // Save ref value in the cell, not the DB
        $(el).closest('.sq-row').find('td[req-id='+pid+']').click(); // then switch to fill in the first column
    }
    try{
        $(td).find('select.select2').select2('destroy');
    }
    catch {};
    td.removeClass('editing').html(val);
    $('.same-object').html(val).attr('old-val',val);
    $('.same-object').removeClass('same-object');
}
function saveVal(elem){
    var i,parent,req,val,digits=0,el=$(elem).closest('td'),dispVal;
    const type=$(el).attr('req-id');
    const base=$(el).attr('base');
    val=base==='NUMBER'&&elem.value!=''?Math.floor(elem.value):elem.value;
    if($(el).hasClass('saving')||!$(el).hasClass('editing')) // Blur and Change both might be triggered
        return;
    if($(el).hasClass('sq-new')&&val==='')
        return $(el).closest('.sq-row').remove();
    if(base==='DATE'){
        val=moment.utc(val).format("DD.MM.YYYY");
        if(!val.match(/^(\d\d\.\d\d\.\d\d\d\d)$/))
            val='';
    }
    else if(base==='DATETIME'){
        val=moment.utc(val).format("DD.MM.YYYY HH:mm:ss");
        if(!val.match(/^(\d\d\.\d\d\.\d\d\d\d \d\d:\d\d:\d\d)$/))
            val='';
    }
    if(val!=$(el).attr('old-val')){
    	var up=1,fd=new FormData();
        fd.append('t'+type,val);
        if($(el).attr('is-object')==="1"){
            if($(el).attr('obj-id')>0){
                if(val==='')
                    newApi('POST','_m_del/'+$(el).attr('obj-id')+'?JSON','delDone',fd,{el:el,v:$(el).attr('old-val')});
                else
                    newApi('POST','_m_save/'+$(el).attr('obj-id')+'?JSON','saveDone',fd,{el:el});
            }
            else{
                if(val===''){ // Delete the record
                    $(el).removeClass('editing').html(val).attr('old-val',val);
                    $('.same-object').removeClass('same-object');
                    return;
                }
                if(arrs[type])
                    up=$(el).closest('.sq-row').find('td[req-id='+arrs[type]+']').attr('obj-id')
                        ||$(el).closest('.sq-row').find('td[req-id='+arrs[type]+']').attr('ref-id');
                for(i in metas)
                    if(metas[i].id===type&&metas[i].refId)
                        if(req=el.closest('tr').find('td[req-id='+i+']').attr('value'))
                            fd.append('t'+i,req);
                newApi('POST','_m_new/'+type+'?JSON&up='+up,'createDone',fd,el);
            }
        }
        else{
            i=metas[type].id;
            i=$(el).closest('.sq-row').find('td[req-id='+i+'][is-object=1]').attr(metas[i].refId?'ref-id':'obj-id');
            if(i)
                newApi('POST','_m_save/'+i+'?JSON','saveDone',fd,{el:el});
            else{
                errMsgCard('Ошибка: Отсутствует ID. Возможно, стоит добавить колонку '+$('#'+type).find('.sq-col-name').html()+'ID.');
                return $(elem).addClass('bg-danger');
            }
        }
        $(el).addClass('saving');
    }
    $(el).removeClass('editing editing-text');
    if(isNumeric($(el).attr('base')))
        dispVal = formatNum(val,$(el).attr('base'));
    else
        dispVal = val;
    $(el).html(dispVal).attr('old-val',val);
    if(base==='MEMO')
        addBreaks(el);
    $('.same-object').html(dispVal).attr('old-val',val);
    $('.same-object').removeClass('same-object');
}
function formatNum(n,f){
    var digits = f === 'NUMBER' ? 0 : 2;
    value = n === '' ? '' : Intl.NumberFormat(undefined,{
        minimumFractionDigits: digits,
        maximumFractionDigits: digits,
        useGrouping:true
    }).format(parseFloat(n));
    return value.replace(/(\u00A0|&nbsp;)/g, ' ');
}
function saveInlineFileDone(json,el){
    const v='<a target="_blank" href="/'+json.args+'">'+$(el).find('input').get(0).files.item(0).name+'</a>';
    $(el).html(v);
    $(el).removeClass('editing');
    $(el).attr('v',v);
}
function saveInlineFile(el){
    var fd=new FormData(),td=$(el).closest('td');
    if(el.files[0].name){
    	fd.append('t'+$(el).closest('td').attr('req-id'),el.files[0],el.files[0].name);
        newApi('POST','_m_set/'+$(el).closest('tr').children(':first').attr('obj-id')+'?JSON','saveInlineFileDone',fd,td);
        $(el).removeClass('last-edited');
    }
    else
        $(el).closest('td').html($(el).closest('td').attr('v'));
}
function deleteFile(el){
    newApi('POST','_m_set/'+$(el).closest('tr').children(':first').attr('obj-id')+'?JSON','deleteFileDone','t'+$(el).closest('td').attr('req-id'),el);
}
function deleteFileDone(json,el){
    $(el).closest('td').html('');
}
function getMeta(json,refId){
    baseType[json.id]=bt[json.type];
    uniq[json.id]=json.unique;
    for(var i in json.reqs){
        baseType[json.reqs[i].id]=bt[json.reqs[i].type];
        metas[json.reqs[i].id]={id:refId||json.id
                                ,arrId:json.reqs[i].arr_id
                                ,refId:json.reqs[i].ref_id
                                ,ref:json.reqs[i].ref
                                ,multi:json.reqs[i].attrs&&json.reqs[i].attrs.indexOf(":MULTI:")!==-1
                                ,type:json.reqs[i].type};
        if(json.reqs[i].arr_id)
            arrs[json.reqs[i].arr_id]=metas[json.reqs[i].arr_id]=refId||json.id;
        // Get ref column's reqs in case we have those in the report
        if(json.reqs[i].ref_id&&$('#'+json.reqs[i].id).length>0&&json.reqs[i].ref!==json.id)
            newApi('GET','metadata/'+json.reqs[i].ref,'getMeta','',json.reqs[i].id);  // Set the Ref as parent for this req
    }
}
var limit,defaultLimit=20;
function getSmart(json){
    try{
        if(json.obj.typ!=='22')
            return errMsgCard('Ошибка: Неверный тип объекта '+json.obj.typ);
    }
    catch(e){
        return errMsgCard('Ошибка: '+e+' '+json);
    }
    $('.rep-header').html(json.obj.val);
    limit=defaultLimit=parseInt(json.reqs[134].value)||defaultLimit;
    doApplyFilters();
}
var timer,lastK;
function doApplyFilters(p){
	var fd=new FormData();
	filters={};
	lastK='';
    $('.filters input').each(function(){
        if(this.value!==''){
            $('.clear-filters').show();
            $('.refr').removeClass('ml-2');
            if(this.value==='%'||this.value==='!%'||this.value.substr(0,1)==='@'||this.value.substr(0,2)==='!@')
            	val=this.value;
            else
                switch($(this).attr('base')){
                    case "NUMBER":
                    case "SIGNED":
                    case "DATE":
                    case "DATETIME":
                    case "BOOLEAN":
                    	val=this.value;
                        break;
                    default:
                    	val=this.value.indexOf('%')===-1?'%'+this.value.replace(/ /g,'%')+'%':this.value;
                }
        	fd.append($(this).attr('name'),val);
        }
    });
    if(p==='RECORD_COUNT')
        newApi('POST','report/'+id+'?JSON&RECORD_COUNT','getCountDone',fd);
    else if(p==='TOTALS'){
        if($('.sq-table tfoot').length>0||totalsOn)
            newApi('POST','report/'+id+'?JSON','drawFoot',fd);
    }
    else{
        if(!p){
            const urlParams=getFilterParams();
            for(let key in urlParams)
                fd.append(key,urlParams[key]);
        }
        if(p===-2) // First page
            p=0,page=1;
        else if(p===2&&total) // Last page
            p=0,page=Math.ceil(total/limit);
        page+=p||0;
        $('.ajax-wait').show();
        newApi('POST','report/'+id+'?JSON&LIMIT='+(page===1?'':limit*(page-1)+',')+limit+collectOrder(),'getRep',fd);
    }
}
function getFilterParams(){
    let params = {};
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.forEach(function(value, key) {
        if(value!==''){
            if(value==='%'||value==='!%'||value.substr(0,1)==='@'||value.substr(0,2)==='!@')
                val=value;
            else {
                const prefix = key.split('_')[0];
                switch(prefix){
                    case "FR":
                    case "TO":
                        val=value;
                        break;
                    default:
                        val=value.indexOf('%')===-1?'%'+value.replace(/ /g,'%')+'%':value;
                }
            }
            params[key] = val;
        }
    });
    return params;
}
function collectOrder(){
    var o=[];
    $('.sq-table th a').each(function(){
        if($(this).attr('sq-order')!=='')
            o[$(this).attr('sq-order')-1]=($(this).attr('desc')===''?'':'-')+$(this).attr('col-id');
    });
    return o.length>0?'&ORDER='+o.join(','):'';
}
const waitGif='<svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">'
    +'<path d="M14 4V8M14 20V24M6.93 6.93L9.76 9.76M18.24 18.24L21.07 21.07M4 14H8M20 14H24M6.93 21.07L9.76 18.24M18.24 9.76L21.07 6.93" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>'
    +'</svg>';
function getCount(){
    $('.total-count-num').html(waitGif);
    doApplyFilters('RECORD_COUNT');
}
function getCountDone(json){
    total=json.count;
    $('.total-count-from').html(t9n('[RU] из [EN] of '));
    $('.total-count-num').html(total);
}
function applyFilters(el){
    if(lastK!==el.value||el.value===''){
        window.clearTimeout(timer); // Включить задержку, чтобы дать пользователю набрать текст поиска
        lastK=el.value;
        // Запустить поиск через XXXмс после последнего нажатия клавиши в поле поиска
        timer=setTimeout(()=>{
            page=1;
            total=undefined;
            doApplyFilters(-2);
        },333);
    }
}
function escapeHtmls(t){
    t=t||'';
    if(!search.full&&t.length>127)
        t=t.substr(0,127)+'...';
    return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function escapeRegex(string){
    return string.replace(/[/\-\\^$*+?.()|[\]{}]/g,'\\$&');
}
function getRoundedDecimalString(string) {
    var lastPartNum = +('0.' + string);
    return (Math.round((lastPartNum + Number.EPSILON) * 100) / 100).toFixed(2).slice(2,4);
}
function markDown(el){
	if(el&&el.innerHTML.indexOf('***')===-1&&el.innerHTML.indexOf('~~~')===-1&&el.innerHTML.indexOf('___')===-1)
		el.innerHTML=el.innerHTML.replace(/\*\*(.+?)\*\*(?!\*)/g,'<b>$1</b>')
		                        .replace(/__(.+?)__(?!\_)/g,'<i>$1</i>')
		                        .replace(/~~(.+?)~~(?!\~)/g,'<s>$1</s>');
}
var tHeader,tColumns,table,curColIndex;
function setWidth(el,value){
    $(el).css('max-width',value+'px');
    $(el).css('min-width',value+'px');
} 
function onMouseMove(event){
    if(curColIndex===undefined)
        return;
    var thOffset = 0;
    var obj = tHeader;
    while (obj != null) {
        thOffset += obj.offsetLeft;
        obj = obj.offsetParent;
    }
    var newWidth = 3 + document.documentElement.scrollLeft + event.clientX - thOffset;
    var delta = newWidth - tHeader.clientWidth;
    setWidth(table, table.clientWidth + delta);
    tColumns.forEach(item => setWidth(item.header, item.size));
    setWidth(tHeader, newWidth);
    tColumns[curColIndex].size = newWidth;
}
function onMouseUp(){
    if(curColIndex===undefined)
        return;
    var columnSizes = JSON.stringify(tColumns.map(item => item.size));
    localStorage.setItem(db+id+'smartq', columnSizes);
    curColIndex=undefined;
}
/** Change columns width by mouse and saves the state to localstorage
 * @param { HTMLElement } elem
 * @param { Number } id - identifier of current report
 * @modify localstorage[db+id+'smartq']
 */
window.addEventListener('mousemove', onMouseMove);
window.addEventListener('mouseup', onMouseUp);     
function columnResize(elem,id){
    tHeader = elem.parentNode;
    tColumns = [];
    table = $(elem).closest('table');
    let i=$(elem).closest('table').find('th').index(tHeader);
    if (elem) {
        $(elem).closest('table').find('th').each( function(index){ 
            tColumns.push({ header:this, size: this.clientWidth });
            setWidth(this, this.clientWidth);
            if (i == index) 
                curColIndex = index;
        });
    }
}
if(id>0)
    newApi('GET','edit_obj/'+id+'?JSON','getSmart');
else
    $('.rep-header').html(t9n('[RU]Не задан [EN]Choose ')+'<a href="/'+db+'/sql">'+t9n('[RU]запрос[EN]a query')+'</a>');
</script>