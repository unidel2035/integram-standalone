# HTTP VirtualHost для интеграм.рф - редирект на HTTPS
<VirtualHost *:80>
    ServerName интеграм.рф
    ServerAlias www.интеграм.рф
    ServerAlias xn--80afflxcxn.xn--p1ai
    ServerAlias www.xn--80afflxcxn.xn--p1ai

    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>

# HTTPS VirtualHost для интеграм.рф - гибридный режим (PHP Integram + Vue.js)
<VirtualHost *:443>
    ServerName интеграм.рф
    ServerAlias www.интеграм.рф
    ServerAlias xn--80afflxcxn.xn--p1ai
    ServerAlias www.xn--80afflxcxn.xn--p1ai

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/xn--80afflxcxn.xn--p1ai/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/xn--80afflxcxn.xn--p1ai/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf

    # Основной DocumentRoot - PHP Integram приложение
    DocumentRoot /var/www/html

    # PHP handler для .php файлов
    <FilesMatch \.php$>
        SetHandler "proxy:unix:/run/php-fpm/www.sock|fcgi://localhost"
    </FilesMatch>

    # Проксирование API v2 на Node.js backend (порт 3001)
    <Location /api/v2>
        ProxyPass http://localhost:3001/api/v2
        ProxyPassReverse http://localhost:3001/api/v2
    </Location>

    # Проксирование /app/api/v2 на Node.js backend (порт 3001)
    <Location /app/api/v2>
        ProxyPass http://localhost:3001/api/v2
        ProxyPassReverse http://localhost:3001/api/v2
    </Location>

    # Настройки для директории /var/www/html (PHP Integram)
    <Directory /var/www/html>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # .htaccess будет обрабатывать routing для /my, /a2025 и других эндпоинтов
        # RewriteRule ^(.*)$ index.php [L,QSA]
    </Directory>

    # Настройки для директории /app (Vue.js приложение)
    <Directory /var/www/html/app>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Fallback для Vue Router (SPA)
        RewriteEngine On
        RewriteBase /app/
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /app/index.html [L]
    </Directory>

    ErrorLog /var/log/httpd/integram-rf-error.log
    CustomLog /var/log/httpd/integram-rf-access.log combined
</VirtualHost>
