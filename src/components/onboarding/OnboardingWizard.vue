<template>
  <Dialog
    v-model:visible="showDialog"
    :modal="true"
    :closable="false"
    :draggable="false"
    :style="{ width: '60rem' }"
    :breakpoints="{ '1199px': '80vw', '575px': '95vw' }"
    class="onboarding-wizard"
  >
    <template #header>
      <div class="flex align-items-center gap-3 w-full">
        <i class="pi pi-sparkles text-4xl text-primary"></i>
        <div class="flex-1">
          <span class="font-bold text-2xl">{{ currentStepData.title }}</span>
          <p class="text-sm text-color-secondary mt-1 mb-0">{{ currentStepData.subtitle }}</p>
        </div>
      </div>
    </template>

    <!-- Step Progress Indicator -->
    <div class="flex justify-content-center gap-2 mb-5">
      <div
        v-for="n in totalSteps"
        :key="n"
        class="step-indicator"
        :class="{ active: currentStep >= n, current: currentStep === n }"
      />
    </div>

    <!-- Step 1: Welcome & Gift Tokens -->
    <div v-if="currentStep === 1" class="step-content">
      <div class="text-center mb-4">
        <div class="gift-icon mb-3">üéÅ</div>
        <h2 class="text-3xl font-bold text-primary mb-3">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π!</h2>
        <p class="text-xl mb-4">
          –í—ã –ø–æ–ª—É—á–∏–ª–∏ <strong class="text-primary">1 000 000 —Ç–æ–∫–µ–Ω–æ–≤</strong> –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å AI –º–æ–¥–µ–ª—è–º–∏
        </p>
      </div>

      <Card class="token-gift-card mb-4">
        <template #content>
          <div class="flex align-items-center gap-4">
            <i class="pi pi-gift text-6xl text-primary"></i>
            <div class="flex-1">
              <h3 class="text-2xl font-semibold mb-2">–ü–æ–¥–∞—Ä–æ—á–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã</h3>
              <p class="text-color-secondary mb-3">
                –≠—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è:
              </p>
              <ul class="token-usage-list">
                <li>‚úÖ –°–æ–∑–¥–∞–Ω–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è 10+ –∞–≥–µ–Ω—Ç–æ–≤</li>
                <li>‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∏ —Ç—ã—Å—è—á –∑–∞–ø—Ä–æ—Å–æ–≤</li>
                <li>‚úÖ –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã</li>
                <li>‚úÖ –†–∞–±–æ—Ç—ã —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ AI –º–æ–¥–µ–ª—è–º–∏</li>
              </ul>
            </div>
          </div>
        </template>
      </Card>

      <div class="info-boxes grid">
        <div class="col-12 md:col-6">
          <Card class="info-card h-full">
            <template #content>
              <i class="pi pi-clock text-3xl text-blue-500 mb-2"></i>
              <h4 class="font-semibold mb-2">–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç</h4>
              <p class="text-sm text-color-secondary">
                –ü—Ä–æ–π–¥–∏—Ç–µ –∫—Ä–∞—Ç–∫–∏–π —Ç—É—Ä –∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –∑–∞ 5 –º–∏–Ω—É—Ç
              </p>
            </template>
          </Card>
        </div>
        <div class="col-12 md:col-6">
          <Card class="info-card h-full">
            <template #content>
              <i class="pi pi-shield text-3xl text-green-500 mb-2"></i>
              <h4 class="font-semibold mb-2">–ë–µ–∑ —Ä–∏—Å–∫–æ–≤</h4>
              <p class="text-sm text-color-secondary">
                –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –¥–æ–∫—É–ø–∞–π—Ç–µ —Ç–æ–∫–µ–Ω—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
              </p>
            </template>
          </Card>
        </div>
      </div>
    </div>

    <!-- Step 2: Platform Overview -->
    <div v-if="currentStep === 2" class="step-content">
      <h3 class="text-2xl font-semibold mb-4 text-center">–ß—Ç–æ –≤—ã –º–æ–∂–µ—Ç–µ –¥–µ–ª–∞—Ç—å –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ?</h3>

      <div class="grid">
        <div
          v-for="feature in platformFeatures"
          :key="feature.id"
          class="col-12 md:col-6 mb-3"
        >
          <Card class="feature-card h-full cursor-pointer" @click="selectFeature(feature.id)">
            <template #content>
              <div class="flex flex-column align-items-center text-center gap-3">
                <div class="feature-icon">{{ feature.icon }}</div>
                <h4 class="font-semibold text-lg">{{ feature.title }}</h4>
                <p class="text-sm text-color-secondary">{{ feature.description }}</p>
                <div class="feature-badge">{{ feature.badge }}</div>
              </div>
            </template>
          </Card>
        </div>
      </div>
    </div>

    <!-- Step 3: Ready Solutions Catalog -->
    <div v-if="currentStep === 3" class="step-content">
      <h3 class="text-2xl font-semibold mb-3 text-center">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ç–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ</h3>
      <p class="text-center text-color-secondary mb-4">
        –ú—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ –≥–æ—Ç–æ–≤—ã–µ –ø–∞–∫–µ—Ç—ã –∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞
      </p>

      <div class="solutions-grid">
        <Card
          v-for="solution in readySolutions"
          :key="solution.id"
          class="solution-card cursor-pointer"
          :class="{ selected: selectedSolution === solution.id }"
          @click="selectSolution(solution.id)"
        >
          <template #content>
            <div class="solution-icon mb-3">{{ solution.icon }}</div>
            <h4 class="font-semibold mb-2">{{ solution.title }}</h4>
            <p class="text-sm text-color-secondary mb-3">{{ solution.description }}</p>
            <div class="solution-benefit">
              <span class="benefit-text">{{ solution.benefit }}</span>
            </div>
            <i
              v-if="selectedSolution === solution.id"
              class="pi pi-check-circle text-primary text-2xl mt-3"
            ></i>
          </template>
        </Card>
      </div>
    </div>

    <!-- Step 4: First Free Agent -->
    <div v-if="currentStep === 4" class="step-content">
      <div class="text-center mb-4">
        <div class="agent-icon mb-3">ü§ñ</div>
        <h2 class="text-3xl font-bold mb-3">–ü–æ–ª—É—á–∏—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –ë–ï–°–ü–õ–ê–¢–ù–û!</h2>
        <p class="text-xl text-color-secondary mb-4">
          –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω–æ–≥–æ –∏–∑ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏—è
        </p>
      </div>

      <div class="grid">
        <div
          v-for="agent in freeAgents"
          :key="agent.id"
          class="col-12 md:col-6 mb-3"
        >
          <Card
            class="agent-card cursor-pointer h-full"
            :class="{ selected: selectedAgent === agent.id }"
            @click="selectAgent(agent.id)"
          >
            <template #content>
              <div class="flex align-items-start gap-3">
                <div class="agent-avatar">{{ agent.icon }}</div>
                <div class="flex-1">
                  <h4 class="font-semibold mb-2">{{ agent.title }}</h4>
                  <p class="text-sm text-color-secondary mb-3">{{ agent.description }}</p>
                  <div class="agent-features">
                    <span
                      v-for="feature in agent.features"
                      :key="feature"
                      class="feature-tag"
                    >
                      {{ feature }}
                    </span>
                  </div>
                  <i
                    v-if="selectedAgent === agent.id"
                    class="pi pi-check-circle text-primary text-2xl mt-3"
                  ></i>
                </div>
              </div>
            </template>
          </Card>
        </div>
      </div>
    </div>

    <!-- Step 5: Tutorial Options -->
    <div v-if="currentStep === 5" class="step-content">
      <h3 class="text-2xl font-semibold mb-4 text-center">–ö–∞–∫ –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞—á–∞—Ç—å?</h3>

      <div class="grid">
        <div class="col-12 md:col-6 mb-3">
          <Card
            class="tutorial-option-card cursor-pointer h-full"
            :class="{ selected: tutorialChoice === 'guided' }"
            @click="tutorialChoice = 'guided'"
          >
            <template #content>
              <div class="text-center">
                <i class="pi pi-compass text-6xl text-primary mb-3"></i>
                <h4 class="font-semibold text-xl mb-3">–ü—Ä–æ–π—Ç–∏ —Ç—É—Ä –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ</h4>
                <p class="text-sm text-color-secondary mb-3">
                  –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ç—É—Ä –ø–æ–º–æ–∂–µ—Ç –∏–∑—É—á–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞ 5 –º–∏–Ω—É—Ç
                </p>
                <div class="tutorial-badge">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è</div>
              </div>
            </template>
          </Card>
        </div>

        <div class="col-12 md:col-6 mb-3">
          <Card
            class="tutorial-option-card cursor-pointer h-full"
            :class="{ selected: tutorialChoice === 'skip' }"
            @click="tutorialChoice = 'skip'"
          >
            <template #content>
              <div class="text-center">
                <i class="pi pi-forward text-6xl text-color-secondary mb-3"></i>
                <h4 class="font-semibold text-xl mb-3">–ù–∞—á–∞—Ç—å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ</h4>
                <p class="text-sm text-color-secondary mb-3">
                  –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ç—É—Ä –∏ —Å—Ä–∞–∑—É –ø–µ—Ä–µ–π—Ç–∏ –∫ —Ä–∞–±–æ—Ç–µ —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π
                </p>
                <div class="tutorial-badge-secondary">–î–ª—è –æ–ø—ã—Ç–Ω—ã—Ö</div>
              </div>
            </template>
          </Card>
        </div>
      </div>

      <Card class="help-card mt-4">
        <template #content>
          <div class="flex align-items-center gap-3">
            <i class="pi pi-info-circle text-3xl text-blue-500"></i>
            <div>
              <h4 class="font-semibold mb-1">–ù–µ –≤–æ–ª–Ω—É–π—Ç–µ—Å—å!</h4>
              <p class="text-sm text-color-secondary mb-0">
                –í—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç—É—Ä—É –ø–æ–∑–∂–µ —á–µ—Ä–µ–∑ –º–µ–Ω—é "–°–ø—Ä–∞–≤–∫–∞" ‚Üí "–ü—Ä–æ–π—Ç–∏ —Ç—É—Ä"
              </p>
            </div>
          </div>
        </template>
      </Card>
    </div>

    <!-- Footer with Navigation -->
    <template #footer>
      <div class="flex justify-content-between align-items-center w-full">
        <div>
          <Button
            v-if="currentStep > 1"
            label="–ù–∞–∑–∞–¥"
            icon="pi pi-arrow-left"
            text
            @click="previousStep"
          />
        </div>

        <div class="flex align-items-center gap-2">
          <span class="text-sm text-color-secondary mr-2">
            –®–∞–≥ {{ currentStep }} –∏–∑ {{ totalSteps }}
          </span>

          <Button
            label="–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å"
            severity="secondary"
            text
            @click="skipOnboarding"
          />

          <Button
            v-if="currentStep < totalSteps"
            label="–î–∞–ª–µ–µ"
            icon="pi pi-arrow-right"
            iconPos="right"
            @click="nextStep"
            :disabled="!canProceed"
          />

          <Button
            v-else
            label="–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É"
            icon="pi pi-check"
            @click="completeOnboarding"
            :disabled="!tutorialChoice"
          />
        </div>
      </div>
    </template>
  </Dialog>
</template>

<script setup>
/**
 * Onboarding Wizard Component
 *
 * Issue #4963: Comprehensive user onboarding flow with interactive wizard
 * Issue #4980: Fixed onboarding wizard not appearing for new users
 *
 * Triggers when:
 * - User logs in for the first time
 * - localStorage.getItem('onboarding_state').hasSeenWelcome is null or false
 * - User is redirected to /welcome route by router middleware
 * - User manually resets onboarding via developer mode
 *
 * Does NOT trigger when:
 * - User has completed onboarding before (hasSeenWelcome === true)
 * - User is on /auth/login or /auth/register routes
 * - User explicitly skipped or completed onboarding
 *
 * Redirect handling:
 * - Accepts ?redirect=<path> query parameter
 * - After onboarding completion, redirects to:
 *   1. User's chosen solution path (if selected)
 *   2. Agent constructor (if custom solution)
 *   3. Dashboard with tour (if guided tutorial selected)
 *   4. Original redirect URL (if provided)
 *   5. Dashboard (default fallback)
 *
 * Developer mode:
 * - Reset onboarding: localStorage.removeItem('onboarding_state'), then reload
 * - Toggle via Settings page or browser console
 */
import { ref, computed } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import { useOnboardingStore } from '@/stores/onboardingStore'

const router = useRouter()
const route = useRoute()
const onboardingStore = useOnboardingStore()

const showDialog = ref(true)
const currentStep = ref(1)
const totalSteps = 5

const selectedFeature = ref(null)
const selectedSolution = ref(null)
const selectedAgent = ref(null)
const tutorialChoice = ref(null)

// Platform features data
const platformFeatures = ref([
  {
    id: 'agents',
    icon: 'ü§ñ',
    title: 'AI-–∞–≥–µ–Ω—Ç—ã',
    description: '–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —É–º–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∑–∞–¥–∞—á',
    badge: '–ü–æ–ø—É–ª—è—Ä–Ω–æ'
  },
  {
    id: 'workflows',
    icon: '‚öôÔ∏è',
    title: '–ë–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã',
    description: '–ü—Ä–æ–µ–∫—Ç–∏—Ä—É–π—Ç–µ —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –≤–∏–∑—É–∞–ª—å–Ω–æ',
    badge: '–ú–æ—â–Ω–æ'
  },
  {
    id: 'analytics',
    icon: 'üìä',
    title: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞',
    description: '–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å',
    badge: '–ò–Ω—Å–∞–π—Ç—ã'
  },
  {
    id: 'integrations',
    icon: 'üîó',
    title: '–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏',
    description: '–ü–æ–¥–∫–ª—é—á–∞–π—Ç–µ –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã –∏ API',
    badge: '–†–∞—Å—à–∏—Ä—è–µ–º–æ'
  }
])

// Ready solutions data
const readySolutions = ref([
  {
    id: 'it-companies',
    icon: 'üíª',
    title: '–î–ª—è IT-–∫–æ–º–ø–∞–Ω–∏–π',
    description: '–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤, —Å–±–æ—Ä —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏',
    benefit: '-70% –∑–∞—Ç—Ä–∞—Ç –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É'
  },
  {
    id: 'micro-business',
    icon: 'üè™',
    title: '–î–ª—è –º–∞–ª–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞',
    description: '–ü—Ä–∏–µ–º –∑–∞–∫–∞–∑–æ–≤, –∑–∞–ø–∏—Å—å –∫–ª–∏–µ–Ω—Ç–æ–≤, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤',
    benefit: '150 000‚ÇΩ —ç–∫–æ–Ω–æ–º–∏–∏/–º–µ—Å'
  },
  {
    id: 'telecom',
    icon: 'üìû',
    title: '–î–ª—è —Ç–µ–ª–µ–∫–æ–º',
    description: '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞—è–≤–æ–∫, —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞',
    benefit: '-60% –∑–≤–æ–Ω–∫–æ–≤'
  },
  {
    id: 'custom',
    icon: 'üõ†Ô∏è',
    title: '–°–æ–±—Ä–∞—Ç—å —Å –Ω—É–ª—è',
    description: '–°–æ–∑–¥–∞–π—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø–æ–¥ –≤–∞—à—É –∑–∞–¥–∞—á—É',
    benefit: '–ü–æ–ª–Ω–∞—è –≥–∏–±–∫–æ—Å—Ç—å'
  }
])

// Free agents for trial
const freeAgents = ref([
  {
    id: 'support-agent',
    icon: 'üí¨',
    title: '–ê–≥–µ–Ω—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ 24/7',
    description: '–û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —Ç–∏–ø–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ –∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ',
    features: ['–ß–∞—Ç', 'FAQ', '–≠—Å–∫–∞–ª–∞—Ü–∏—è']
  },
  {
    id: 'lead-qualifier',
    icon: 'üéØ',
    title: '–ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è –ª–∏–¥–æ–≤',
    description: '–û—Ü–µ–Ω–∏–≤–∞–µ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –ø–æ–º–æ—â—å—é AI',
    features: ['–°–∫–æ—Ä–∏–Ω–≥', 'CRM', '–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è']
  },
  {
    id: 'appointment-bot',
    icon: 'üìÖ',
    title: '–ë–æ—Ç –∑–∞–ø–∏—Å–∏ –Ω–∞ –≤—Å—Ç—Ä–µ—á–∏',
    description: '–ü–ª–∞–Ω–∏—Ä—É–µ—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –∏ –≤—Å—Ç—Ä–µ—á–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏',
    features: ['–ö–∞–ª–µ–Ω–¥–∞—Ä—å', '–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è', '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è']
  },
  {
    id: 'analytics-agent',
    icon: 'üìà',
    title: '–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–≥–µ–Ω—Ç',
    description: '–°–æ–±–∏—Ä–∞–µ—Ç –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤',
    features: ['–î–∞—à–±–æ—Ä–¥—ã', '–û—Ç—á–µ—Ç—ã', '–ò–Ω—Å–∞–π—Ç—ã']
  }
])

// Current step data
const currentStepData = computed(() => {
  const steps = [
    { title: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', subtitle: '–ù–∞—á–Ω–∏—Ç–µ —Ä–∞–±–æ—Ç—É —Å Integram' },
    { title: '–û–±–∑–æ—Ä –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π', subtitle: '–£–∑–Ω–∞–π—Ç–µ, —á—Ç–æ —É–º–µ–µ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞' },
    { title: '–ì–æ—Ç–æ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è', subtitle: '–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–∞–∫–µ—Ç –∞–≥–µ–Ω—Ç–æ–≤' },
    { title: '–ü–µ—Ä–≤—ã–π –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∞–≥–µ–Ω—Ç', subtitle: '–ü–æ–ª—É—á–∏—Ç–µ –∞–≥–µ–Ω—Ç–∞ –¥–ª—è –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏—è' },
    { title: '–°–ø–æ—Å–æ–± –æ–±—É—á–µ–Ω–∏—è', subtitle: '–í—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫ –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É' }
  ]
  return steps[currentStep.value - 1] || steps[0]
})

// Can proceed to next step
const canProceed = computed(() => {
  switch (currentStep.value) {
    case 1:
      return true
    case 2:
      return true // Optional selection
    case 3:
      return selectedSolution.value !== null
    case 4:
      return selectedAgent.value !== null
    case 5:
      return tutorialChoice.value !== null
    default:
      return true
  }
})

// Functions
function selectFeature(featureId) {
  selectedFeature.value = featureId
  onboardingStore.trackFeatureInteraction(`feature_viewed_${featureId}`)
}

function selectSolution(solutionId) {
  selectedSolution.value = solutionId
  onboardingStore.trackFeatureInteraction(`solution_selected_${solutionId}`)
}

function selectAgent(agentId) {
  selectedAgent.value = agentId
  onboardingStore.trackFeatureInteraction(`agent_selected_${agentId}`)
}

function nextStep() {
  if (canProceed.value && currentStep.value < totalSteps) {
    currentStep.value++
    onboardingStore.trackFeatureInteraction(`onboarding_step_${currentStep.value}_viewed`)
  }
}

function previousStep() {
  if (currentStep.value > 1) {
    currentStep.value--
  }
}

function skipOnboarding() {
  onboardingStore.markWelcomeSeen()
  onboardingStore.trackFeatureInteraction('onboarding_skipped')
  showDialog.value = false

  // Redirect to original destination if provided, otherwise go to dashboard
  const redirectUrl = route.query.redirect || '/dashboard'
  router.push(redirectUrl)
}

function completeOnboarding() {
  onboardingStore.markWelcomeSeen()
  onboardingStore.trackFeatureInteraction('onboarding_completed')

  // Store selected preferences
  if (selectedSolution.value) {
    localStorage.setItem('preferred_solution', selectedSolution.value)
  }
  if (selectedAgent.value) {
    localStorage.setItem('selected_trial_agent', selectedAgent.value)
  }

  showDialog.value = false

  // Determine where to redirect based on user choices and original destination
  let targetUrl = route.query.redirect || '/dashboard'

  // Route based on tutorial choice
  if (tutorialChoice.value === 'guided') {
    // Start interactive tour on dashboard
    targetUrl = '/dashboard?startTour=true'
  } else if (selectedSolution.value === 'custom') {
    // User wants to build from scratch
    targetUrl = '/agents/constructor'
  } else if (selectedSolution.value && selectedSolution.value !== 'custom') {
    // User selected a specific solution
    targetUrl = `/organization/ready-solutions?solution=${selectedSolution.value}`
  }
  // Otherwise, use the redirect URL or default to dashboard

  router.push(targetUrl)
}
</script>

<style scoped>
.onboarding-wizard :deep(.p-dialog-header) {
  padding: 2rem;
  border-bottom: 1px solid var(--surface-border);
}

.onboarding-wizard :deep(.p-dialog-content) {
  padding: 2rem;
}

.onboarding-wizard :deep(.p-dialog-footer) {
  padding: 1.5rem 2rem;
  border-top: 1px solid var(--surface-border);
}

.step-indicator {
  width: 50px;
  height: 5px;
  background-color: var(--surface-300);
  border-radius: 3px;
  transition: all 0.3s ease;
}

.step-indicator.active {
  background-color: var(--primary-color);
}

.step-indicator.current {
  background-color: var(--primary-color);
  transform: scaleY(1.4);
}

.step-content {
  min-height: 450px;
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.gift-icon {
  font-size: 5rem;
}

.token-gift-card {
  background: linear-gradient(135deg, var(--primary-50) 0%, var(--surface-0) 100%);
  border: 2px solid var(--primary-200);
}

.token-usage-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.token-usage-list li {
  padding: 0.5rem 0;
  font-size: 1rem;
}

.info-card {
  text-align: center;
  transition: all 0.2s ease;
  border: 1px solid var(--surface-border);
}

.info-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.feature-card {
  transition: all 0.2s ease;
  border: 2px solid var(--surface-border);
}

.feature-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
  border-color: var(--primary-color);
}

.feature-icon {
  font-size: 3.5rem;
}

.feature-badge {
  display: inline-block;
  padding: 0.35rem 0.75rem;
  background: var(--primary-100);
  color: var(--primary-700);
  border-radius: 16px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
}

.solutions-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1rem;
}

.solution-card {
  text-align: center;
  transition: all 0.2s ease;
  border: 2px solid var(--surface-border);
}

.solution-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
  border-color: var(--primary-color);
}

.solution-card.selected {
  border-color: var(--primary-color);
  background: linear-gradient(135deg, var(--primary-50) 0%, var(--surface-0) 100%);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
}

.solution-icon {
  font-size: 3.5rem;
}

.solution-benefit {
  margin-top: 0.75rem;
  padding: 0.5rem;
  background: var(--green-100);
  color: var(--green-700);
  border-radius: 8px;
  font-weight: 600;
  font-size: 0.875rem;
}

.agent-icon {
  font-size: 5rem;
}

.agent-card {
  transition: all 0.2s ease;
  border: 2px solid var(--surface-border);
}

.agent-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
  border-color: var(--primary-color);
}

.agent-card.selected {
  border-color: var(--primary-color);
  background: linear-gradient(135deg, var(--primary-50) 0%, var(--surface-0) 100%);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
}

.agent-avatar {
  font-size: 3rem;
  flex-shrink: 0;
}

.agent-features {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.feature-tag {
  display: inline-block;
  padding: 0.25rem 0.6rem;
  background: var(--surface-100);
  color: var(--text-color);
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 500;
}

.tutorial-option-card {
  transition: all 0.2s ease;
  border: 2px solid var(--surface-border);
}

.tutorial-option-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
  border-color: var(--primary-color);
}

.tutorial-option-card.selected {
  border-color: var(--primary-color);
  background: linear-gradient(135deg, var(--primary-50) 0%, var(--surface-0) 100%);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
}

.tutorial-badge {
  display: inline-block;
  padding: 0.5rem 1rem;
  background: var(--primary-color);
  color: white;
  border-radius: 20px;
  font-size: 0.875rem;
  font-weight: 600;
}

.tutorial-badge-secondary {
  display: inline-block;
  padding: 0.5rem 1rem;
  background: var(--surface-200);
  color: var(--text-color);
  border-radius: 20px;
  font-size: 0.875rem;
  font-weight: 600;
}

.help-card {
  background: var(--blue-50);
  border: 1px solid var(--blue-200);
}

/* Responsive */
@media (max-width: 768px) {
  .solutions-grid {
    grid-template-columns: 1fr;
  }

  .step-content {
    min-height: 400px;
  }

  .gift-icon,
  .agent-icon {
    font-size: 4rem;
  }
}
</style>
